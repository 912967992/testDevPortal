<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•é—¨æˆ·å¼€å‘ç½‘ç«™</title>
    <link rel="stylesheet" href="/css/home.css">
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>

</head>
<body>
    <div class="home-container">
        <!-- èƒŒæ™¯åŠ¨ç”»æ•ˆæœ -->
        <div class="background-animation">
            <div class="circle circle-1"></div>
            <div class="circle circle-2"></div>
            <div class="circle circle-3"></div>
        </div>
        
        <!-- å·¦ä¾§ç”¨æˆ·åˆ‡æ¢é¢æ¿ï¼ˆä»…å¢å¥ç”¨æˆ·å¯è§ï¼‰ -->
        <div class="user-switch-panel" id="userSwitchPanel" style="display: none;">
            <div class="user-switch-header">
                <h3>åˆ‡æ¢ç”¨æˆ·</h3>
                <button class="close-panel-btn" onclick="toggleUserSwitchPanel()">Ã—</button>
            </div>
            <div class="user-switch-body">
                <div class="current-user-info">
                    <label>å½“å‰ç”¨æˆ·ï¼š</label>
                    <span id="currentUsernameDisplay">--</span>
                </div>
                <div class="user-select-group">
                    <label for="usernameSelect">é€‰æ‹©ç”¨æˆ·ï¼š</label>
                    <select id="usernameSelect" class="username-select">
                        <option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>
                    </select>
                </div>
                <button class="switch-user-btn" onclick="switchUsername()">åˆ‡æ¢ç”¨æˆ·</button>
            </div>
        </div>
        
        <!-- åˆ‡æ¢ç”¨æˆ·æŒ‰é’®ï¼ˆä»…å¢å¥ç”¨æˆ·å¯è§ï¼‰ -->
        <button class="toggle-user-switch-btn" id="toggleUserSwitchBtn" onclick="toggleUserSwitchPanel()" style="display: none;" title="åˆ‡æ¢ç”¨æˆ·">
            ğŸ‘¤
        </button>
        
        <!-- ä¸»è¦å†…å®¹åŒº -->
        <div class="content-wrapper">
            <div class="header-section">
                <h1 class="main-title">
                    <span class="title-text">æµ‹è¯•é—¨æˆ·</span>
                    <span class="title-subtext">å¼€å‘ç½‘ç«™</span>
                </h1>
                <p class="subtitle">æ¬¢è¿è®¿é—®æµ‹è¯•å¼€å‘é—¨æˆ·ç³»ç»Ÿ</p>
            </div>
            
            <!-- åŠŸèƒ½å¡ç‰‡ -->
            <div class="features-grid">
                <div class="feature-card card-1" onclick="goToReliabilityLab()" style="cursor: pointer;">
                    <div class="card-icon">ğŸŒ¡ï¸</div>
                    <h3 class="card-title">å¯é æ€§å®éªŒå®¤</h3>
                    <p class="card-description">ç‰©è”ç½‘æ¸©ç®±ç›‘æ§ç³»ç»Ÿ</p>
                </div>
                <div class="feature-card card-2 developing" onclick="showDevelopingMessage()" style="cursor: not-allowed; opacity: 0.6;">
                    <div class="card-icon">ğŸ“Š</div>
                    <h3 class="card-title">æ•°æ®ç®¡ç†</h3>
                    <p class="card-description">ğŸš§ è¿˜åœ¨å¼€å‘ä¸­...</p>
                </div>
                <div class="feature-card card-3">
                    <div class="card-icon">âš™ï¸</div>
                    <h3 class="card-title">ç³»ç»Ÿè®¾ç½®</h3>
                    <p class="card-description">é…ç½®ä¸ç®¡ç†åŠŸèƒ½</p>
                </div>
            </div>
            
            <!-- åº•éƒ¨ä¿¡æ¯ -->
            <div class="footer-section">
                <p class="footer-text">æµ‹è¯•å¼€å‘é—¨æˆ· Â· ä¸“ä¸šå¯é  Â· é«˜æ•ˆä¾¿æ·</p>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶ï¼Œä»URLå‚æ•°è·å–ç”¨æˆ·ä¿¡æ¯å¹¶ä¿å­˜åˆ°localStorage
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            const departmentName = urlParams.get('departmentName');
            
            if (username) {
                localStorage.setItem('username', username);
                console.log('âœ… ä»URLå‚æ•°ä¿å­˜usernameåˆ°æœ¬åœ°ç¼“å­˜:', username);
            }
            
            if (departmentName) {
                localStorage.setItem('departmentName', departmentName);
                console.log('âœ… ä»URLå‚æ•°ä¿å­˜departmentNameåˆ°æœ¬åœ°ç¼“å­˜:', departmentName);
            }
        })();

        function goToReliabilityLab() {
            // è·å–ç”¨æˆ·åå’Œéƒ¨é—¨åç§°ï¼ˆä»localStorageï¼‰
            const username = localStorage.getItem('username') || '';
            const departmentName = localStorage.getItem('departmentName') || '';
            
            // æ„å»ºå®Œæ•´çš„å¤–éƒ¨URLï¼ˆæ¸©ç®±ç›‘æ§é¡µé¢è·¯å¾„ï¼š/reliabilityIndexï¼‰
            const baseUrl = window.location.origin;
            let url = baseUrl + '/reliabilityIndex';
            
            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = [];
            if (username) {
                params.push('username=' + encodeURIComponent(username));
            }
            if (departmentName) {
                params.push('departmentName=' + encodeURIComponent(departmentName));
            }
            if (params.length > 0) {
                url += '?' + params.join('&');
            }
            
            // æ£€æŸ¥æ˜¯å¦åœ¨é’‰é’‰ç¯å¢ƒä¸­
            const isDingTalk = typeof dd !== 'undefined' && dd.env && dd.env.platform !== 'notInDingTalk';
            
            if (isDingTalk) {
                // åœ¨é’‰é’‰ç¯å¢ƒä¸­ï¼Œä½¿ç”¨ dd.openLink è·³è½¬åˆ°å¤–éƒ¨é“¾æ¥
                // è¿™æ ·è·³è½¬åå¯ä»¥ç›´æ¥çœ‹åˆ°æ¸©ç®±é¡µé¢ï¼Œå› ä¸ºsessionå·²ç»å­˜åœ¨ï¼Œä¸éœ€è¦é‡æ–°éªŒè¯
                dd.openLink({
                    url: url,
                    success: function() {
                        console.log('æˆåŠŸæ‰“å¼€å¯é æ€§å®éªŒå®¤');
                    },
                    fail: function(err) {
                        console.error('dd.openLink fail:', err);
                        alert('æ‰“å¼€é¡µé¢å¤±è´¥ï¼š' + JSON.stringify(err));
                        // å¦‚æœé’‰é’‰è·³è½¬å¤±è´¥ï¼Œä½¿ç”¨æ™®é€šè·³è½¬ä½œä¸ºå¤‡é€‰
                        window.location.href = url;
                    }
                });
            } else {
                // éé’‰é’‰ç¯å¢ƒä½¿ç”¨æ™®é€šè·³è½¬
                window.location.href = url;
            }
        }

        function showDevelopingMessage() {
            alert('ğŸš§ æ•°æ®ç®¡ç†åŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼');
        }

        // ç”¨æˆ·åˆ‡æ¢åŠŸèƒ½ï¼ˆä»…å¢å¥ç”¨æˆ·å¯è§ï¼‰
        let allUsernames = [];
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯å¢å¥ç”¨æˆ·ï¼Œå¦‚æœæ˜¯åˆ™æ˜¾ç¤ºåˆ‡æ¢åŠŸèƒ½
        function checkAndShowUserSwitch() {
            const username = localStorage.getItem('username') || '';
            if (username === 'å¢å¥') {
                document.getElementById('toggleUserSwitchBtn').style.display = 'block';
                document.getElementById('userSwitchPanel').style.display = 'none';
                loadAllUsernames();
                updateCurrentUsernameDisplay();
            } else {
                document.getElementById('toggleUserSwitchBtn').style.display = 'none';
                document.getElementById('userSwitchPanel').style.display = 'none';
            }
        }
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·å
        async function loadAllUsernames() {
            try {
                const response = await fetch('/api/getAllUsernames');
                const data = await response.json();
                
                if (data.success && data.usernames) {
                    allUsernames = data.usernames;
                    const select = document.getElementById('usernameSelect');
                    select.innerHTML = '<option value="">è¯·é€‰æ‹©ç”¨æˆ·</option>';
                    
                    allUsernames.forEach(username => {
                        const option = document.createElement('option');
                        option.value = username;
                        option.textContent = username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥:', error);
            }
        }
        
        // æ›´æ–°å½“å‰ç”¨æˆ·åæ˜¾ç¤º
        function updateCurrentUsernameDisplay() {
            const username = localStorage.getItem('username') || '--';
            document.getElementById('currentUsernameDisplay').textContent = username;
        }
        
        // åˆ‡æ¢ç”¨æˆ·é¢æ¿æ˜¾ç¤º/éšè—
        function toggleUserSwitchPanel() {
            const panel = document.getElementById('userSwitchPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                loadAllUsernames();
                updateCurrentUsernameDisplay();
            } else {
                panel.style.display = 'none';
            }
        }
        
        // åˆ‡æ¢ç”¨æˆ·å
        function switchUsername() {
            const select = document.getElementById('usernameSelect');
            const selectedUsername = select.value;
            
            if (!selectedUsername) {
                alert('è¯·é€‰æ‹©è¦åˆ‡æ¢çš„ç”¨æˆ·');
                return;
            }
            
            // æ›´æ–° localStorage
            localStorage.setItem('username', selectedUsername);
            updateCurrentUsernameDisplay();
            
            // æç¤ºç”¨æˆ·
            alert('å·²åˆ‡æ¢åˆ°ç”¨æˆ·: ' + selectedUsername + '\n\nåˆ·æ–°é¡µé¢åç”Ÿæ•ˆ');
            
            // å¯é€‰ï¼šè‡ªåŠ¨åˆ·æ–°é¡µé¢
            // window.location.reload();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥
        (function() {
            // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿ localStorage å·²è®¾ç½®
            setTimeout(() => {
                checkAndShowUserSwitch();
            }, 500);
        })();
    </script>
</body>
</html>

