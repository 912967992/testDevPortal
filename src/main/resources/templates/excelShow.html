<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报告编辑页面</title>

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/excelShowStyle.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>

</head>
<body>

<!-- 加载中提示 -->
<div id="startloading" style="display:none;">加载数据中，请稍等...</div>

<!-- 参数展示 -->
<h2 id="filepathDisplay"></h2>


<div class="sheetButtonContainer">
    <div id="sheetButtonContainer">
        <!-- 工作表按钮将动态添加到这里 -->
    </div>
</div>

<div id="headerContainer">
        <button class="saveBtn" id="saveBtn">保存<br>数据</button>
        <button class="functionBtn" id="functionBtn">功能<br>按钮</button>
        <button class="deviceListBtn" id="deviceListBtn">设备<br>清单</button>
        <button class="homeBtn" id="homeBtn">返回<br>主页</button>
</div>

<!-- 隐藏的功能容器 -->
<div id="functionContainer" class="bubble" style="display:none;">
    <button id="gapFillBtn">一键填空</button>
    <button id="replaceBtn">替换</button>
    <button id="colorChangeBtn">颜色切换</button>
    <button id="freezePaneBtn">冻结窗格</button>
</div>

<!-- 隐藏的填空容器 -->
<div id="gapFillContainer" class="bubble" style="display:none;">
    <input type="text" id="gapFillInput" placeholder="输入填充值">
    <div class="button-container">
        <button id="fillBtn">填空</button>
        <button id="cancelBtn">撤回</button>
    </div>
</div>

<div id="replaceContainer" class="bubble" style="display:none;">
    <input type="text" id="replaceInput" placeholder="替换前的值">
    <input type="text" id="replaceOutput" placeholder="替换后的值充值">
    <div class="button-container">
        <button id="startReplaceBtn">替换</button>
    </div>
</div>

<div id="colorContainer" class="bubble" style="display:none;">
    <div class="button-container">
        <!-- 红色按钮 -->
        <button id="setRedColorBtn" style="background-color: red; color: white;">红色字体</button>
        <!-- 黑色按钮 -->
        <button id="setBlackColorBtn" style="background-color: black; color: white;">黑色字体</button>
    </div>
</div>


<div id="freezePaneContainer" class="bubble" style="display:none;">
    <input type="number" id="freezeRowsInput" placeholder="冻结的行数" min="0">
    <input type="number" id="freezeColumnsInput" placeholder="冻结的列数" min="0">
    <div class="button-container">
        <button id="setFreezePaneBtn">设置冻结窗格</button>
    </div>
</div>

<!-- 设备选择 Modal -->
<div id="deviceModal" class="device_modal">
    <div class="device_modal-content">

        <div>
            <h3>已选择设备<span class="close">&times;</span></h3>
            <div id="selectedDevices" ></div>
            <button id="selectAllButton">全选复制</button>
            <button id="clearSelectionButton">清空选择</button>
        </div>
        <div>
            <input type="text" id="searchInput" placeholder="搜索设备...">
            <ul id="deviceList"></ul>
        </div>

        <div class="filter-section">
            <div id="regionContainer">
                <h3>选择区域</h3>
                <ul id="regionList"></ul>
            </div>
            <div id="typeContainer">
                <h3>选择类型</h3>
                <ul id="typeList"></ul>
            </div>
            <div id="brandContainer">
                <h3>选择品牌</h3>
                <ul id="brandList"></ul>
            </div>
            <div id="modelContainer">
                <h3>选择型号</h3>
                <ul id="modelList"></ul>
            </div>
        </div>

    </div>
</div>



<div id="sheetTableContainer"></div> <!-- 添加 contenteditable 属性 -->


<!--阴影遮罩，目前还没用到-->
<div class="loading-overlay" id="loadingOverlay">
    <!--    <div class="loading-spinner"></div>     //加载遮罩的加载样式-->
</div>

<script>
    // 创建一个全局的AbortController实例，用于返回主页按钮点击时候中止getSheetNames方法继续加载数据
    let fetchController = new AbortController();

    // 添加一个变量来存储当前选定的工作表名称和数据
    let selectedSheetName = '';
    let sheetData = [];
    let filePath = '';
    let allSheetData = [];
    //20240707优化新的操作方案，加文件锁以保证文件不冲突！
    let collectData = {}; //收集用户修改的全部单元格数据
    let saveTimer;  // 计时器
    const saveDelay = 3000;  // 3秒
    let isSaving = false;  // 保存操作标志
    const saveQueue = [];  // 保存队列
    let pendingCollectData = {}; // 用于记录新的输入数据

    let rowIsProcessing = false;//设置增一行核删一行按钮触发的时候每次执行一次，防止用户点击很多下触发很多次
    let saveButtonCooldown = false; //保存按钮限制用户频繁点击

    let storageKey;
    // let storageCollectData;
    let uuidStorage="";

    var username = sessionStorage.getItem("username");
    // var DQE = sessionStorage.getItem("DQE");
    // var Developer = sessionStorage.getItem("Developer");
    // var product_model = sessionStorage.getItem("model") + " " + sessionStorage.getItem("coding");
    // var sample_name = sessionStorage.getItem("sample_name");
    // var supplier = sessionStorage.getItem("supplier");
    // var tester = sessionStorage.getItem("tester");
    let DQE ;
    let Developer ;
    let product_model ;
    let sample_name ;
    let supplier;
    let tester;

    //  点击事件记录点击的位置
    let selectedRow = null;
    let selectedColumn = null;
    let selectedValue = null;

    function getLocalStoreSpecial(){
        DQE = localStorage.getItem(`DQE_`);
        Developer = localStorage.getItem(`Developer_`);
        product_model = localStorage.getItem(`model_`) + " " + localStorage.getItem(`coding_`);
        sample_name = localStorage.getItem(`sample_name_`);
        supplier = localStorage.getItem(`supplier_`);
        tester = localStorage.getItem(`tester_`);
    }


    function handleCellPaste(event) {
        // 粘贴事件可能会异步更新内容，使用setTimeout确保内容已更新
        setTimeout(() => handleCellInput(event), 0);
    }


   function handleUnloadEvent() {

       if (Object.keys(collectData).length > 0) {
           updateSheetData(allSheetData, sheetData, collectData); // 更新数据
           updateLocalStorage(); // 更新本地缓存

       }
    }

    function updateLocalStorage() {
        // const filepathKey = `sheetData_${filePath}`;
        const collectDataKey = `collectData_${filePath}`;

        // localStorage.setItem(filepathKey, JSON.stringify(allSheetData));
        localStorage.setItem(collectDataKey, JSON.stringify(collectData));

    }

    dd.ready(function () {
        // 在钉钉环境中运行的代码
        window.addEventListener('unload', function (event) {
            //PC端工作台关闭应用的时候触发,手机端切后台关闭不触发，手机端返回之后的关闭键X也没用
            handleUnloadEvent();
        });

        window.addEventListener('beforeunload', function (event) {
            handleUnloadEvent();

        });

        window.addEventListener('visibilitychange', function (event) {
            handleUnloadEvent();


        });

        window.addEventListener('onpopstate', function (event) {
            handleUnloadEvent();
        });

        window.addEventListener('popstate', function (event) {
            handleUnloadEvent();
        });

        window.addEventListener('pagehide', function (event) {
            handleUnloadEvent();
        });


    });



    function saveData() {
        if (Object.keys(collectData).length === 0) {
            return;
        }
        if (isSaving) {
            // 如果正在保存中，则将当前请求放入队列
            saveQueue.push({collectData: {...collectData}});
            return;
        }
        isSaving = true;

        const currentCollectData = {...collectData}; // 复制当前 collectData

        updateSheetData(allSheetData, sheetData, currentCollectData); // 更新数据
        updateLocalStorage(); // 更新本地缓存

        collectData = {}; // 清空已保存的数据

        fetch(`/saveEditedCell?filePath=${encodeURIComponent(filePath)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(currentCollectData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'locked') {
                    // 文件被锁定，放入队列等待
                    saveQueue.push({collectData: currentCollectData});
                    alert("文件正在保存中，已放进队列中等待...")
                } else if (data.status === 'saved') {
                    // updateSheetData(allSheetData, sheetData, currentCollectData); // 保存成功后更新数据
                    // //更新本地缓存
                    // updateLocalStorage();

                    alert("检测到保存动作或应用切换，数据已同步至云端。");
                } else {
                    console.error('保存失败:', data.message);
                    alert("保存失败!");
                }

                isSaving = false;
                // 处理队列中的下一个保存请求
                processNextSaveRequest();
            })
            .catch(error => {
                isSaving = false;
            });
    }



    function processNextSaveRequest() {
        // 处理队列中的下一个保存请求
        if (saveQueue.length > 0) {
            const nextRequest = saveQueue.shift();
            // 合并当前 collectData 和下一个请求的数据
            collectData = {...nextRequest.collectData, ...collectData};
            // 增加延迟以避免重复请求
            setTimeout(saveData, saveDelay);
        }
    }

    //禁止用户返回
    // 添加一个历史记录,因为手机端的物理返回键实在没办法做到完全监听，所以还是做此下策禁止返回！
    history.pushState(null, null, document.URL);
    // 监听 popstate 事件
    window.addEventListener('popstate', function (event) {
        // 再次添加一个历史记录，防止用户返回
        history.pushState(null, null, document.URL);
        // 弹出提示，或者进行其他操作
        alert('请使用应用内的返回按钮');
    });


    // 用户操作时更新 collectData
    function updateCollectData(sheetName, row, column, value, scrollHeight, rowspan, colspan, col_width, color) {
        const cellKey = `${sheetName}-${row}-${column}`;
        if(rowspan){
            collectData[cellKey] = {
                sheetName: sheetName,
                row: row,
                column: column,
                value: value,
                rowspan: rowspan,
                colspan: colspan,
                col_width: col_width,
                color: color

            };
        }else{
            collectData[cellKey] = {
                sheetName: sheetName,
                row: row,
                column: column,
                value: value,
                color: color
            };
            // 使用 alert 打印 collectData[cellKey] 的值
            // alert(JSON.stringify(collectData[cellKey], null, 2));
        }

        // 如果有 scrollHeight 并且超过默认行高，才添加到 collectData 和 pendingCollectData
        if (scrollHeight && scrollHeight > 100) {
            collectData[cellKey].scrollHeight = scrollHeight - 7;
            // pendingCollectData[cellKey].scrollHeight = scrollHeight - 7;
        } else {
            // 如果存在且小于等于默认行高，删除 scrollHeight 属性
            if (collectData[cellKey].hasOwnProperty('scrollHeight')) {
                delete collectData[cellKey].scrollHeight;
            }

        }
    }

    // 获取工作表名称并展示按钮
    function getSheetNames() {
        const sheetNameKey = `sheetNames_${filePath}`;
        const cachedSheetNames = localStorage.getItem(sheetNameKey);

        if (cachedSheetNames) {
            const sheetNames = JSON.parse(cachedSheetNames);
            renderSheetButtons(sheetNames);
        } else {
            fetch(`/sheets?filePath=${encodeURIComponent(filePath)}`)
                .then(response => response.json())
                .then(sheetNames => {
                    localStorage.setItem(sheetNameKey, JSON.stringify(sheetNames));
                    renderSheetButtons(sheetNames);
                })
                .catch(error => {
                    console.error('Error fetching sheet names:', error);
                });
        }
    }

    function renderSheetButtons(sheetNames) {
        const sheetButtonContainer = document.getElementById('sheetButtonContainer');
        sheetButtonContainer.innerHTML = ''; // 清空容器内容
        sheetNames.forEach(sheetName => {
            const button = document.createElement('button');
            button.className = 'sheetButton';
            button.textContent = sheetName;
            button.addEventListener('click', () => {
                // 获取所有工作表按钮
                const sheetButtons = document.querySelectorAll('.sheetButton');
                // 移除其他按钮的点击状态样式
                sheetButtons.forEach(btn => {
                    btn.classList.remove('clicked');
                });

                updateSheetData(allSheetData, sheetData, collectData); // 这一步是为了让你的数据切换工作表的时候数据不丢失

                // 更新当前选定的工作表名称
                selectedSheetName = sheetName;
                // 切换按钮的点击状态样式
                button.classList.add('clicked');
                // 获取当前选中的工作表数据
                const selectedSheet = allSheetData.find(sheetArray => {
                    // 在当前数组元素中查找符合条件的子元素
                    const innerSheet = sheetArray.find(innerArray =>
                        innerArray.some(sheet => sheet.sheetName === sheetName)
                    );
                    // 如果找到符合条件的子元素，则返回该子元素
                    return innerSheet !== undefined;
                });

                if (selectedSheet) {
                    sheetData = selectedSheet;
                    console.log("获取sheetData：" + JSON.stringify(sheetData, null, 2));
                    renderSheetTable();
                } else {
                    sheetData = "";
                    renderSheetTable();
                }

            });
            sheetButtonContainer.appendChild(button);
        });
    }


    function getAllSheetData() {
        // 每次调用getAllSheetData时，先检查是否有已存在的controller
        if (fetchController) {
            // 如果有，取消之前的请求
            fetchController.abort();
        }
        // 创建新的AbortController实例
        fetchController = new AbortController();
        const {signal} = fetchController;

        return new Promise((resolve, reject) => {
            fetch(`/getAllSheetData?filePath=${encodeURIComponent(filePath)}`, {signal})
                .then(response => {
                    if (signal.aborted) {
                        throw new Error('Fetch aborted by the user');
                    }
                    return response.json();
                })
                .then(data => {
                    if (signal.aborted) {
                        throw new Error('Processing aborted by the user');
                    }
                    // 整理数据
                    allSheetData = data;

                    updateSpecialCells(allSheetData); // 更新DQE单元格

                    getSheetNames();
                    // localStorage.setItem(storageKey, JSON.stringify(allSheetData));

                    // resetSaveTimer();
                    resolve(); // 数据加载完成，resolve Promise
                })
                .catch(error => {
                    // 如果请求被取消，会抛出AbortError
                    if (error.name === 'AbortError' || error.message.includes('aborted')) {
                        console.log('请求已中止或处理已中止');
                        reject('Fetch or processing was aborted');
                        return; // 中止后立即返回
                    } else {
                        console.error('Error fetching sheet data:', error);
                        reject(error); // 数据加载失败，reject Promise
                    }
                });
        });
    }

    //在获取xlsx全部数据后马上用这个方法，将每个工作表里的DQE，研发，测试人都改成对应的值存到collectData
    function updateSpecialCells(allSheetData) {
        getLocalStoreSpecial();
        allSheetData.forEach(sheet => {
            sheet.forEach(rowData => {
                rowData.forEach(cellData => {
                    if (cellData.value === "研发签名" && Developer !== "" && Developer !== null) {
                        cellData.value = Developer;
                        updateCollectData(cellData.sheetName, cellData.row, cellData.column, cellData.value);
                    } else if (cellData.value === "DQE签名" && DQE !== "" && DQE !== null) {
                        cellData.value = DQE;
                        updateCollectData(cellData.sheetName, cellData.row, cellData.column, cellData.value);
                    } else if (cellData.value === "测试人" && tester !== "" && tester !== null) {
                        cellData.value = tester;
                        updateCollectData(cellData.sheetName, cellData.row, cellData.column, cellData.value);
                    } else if (cellData.value === "产品型号签名" && product_model !== "" && product_model !== "null null") {
                        cellData.value = product_model;
                        updateCollectData(cellData.sheetName, cellData.row, cellData.column, cellData.value);
                    } else if (cellData.value === "产品名称签名" && sample_name !== "" && sample_name !== null) {
                        cellData.value = sample_name;
                        updateCollectData(cellData.sheetName, cellData.row, cellData.column, cellData.value);
                    } else if (cellData.value === "供应商签名" && supplier !== "" && supplier !== null) {
                        cellData.value = supplier;
                        updateCollectData(cellData.sheetName, cellData.row, cellData.column, cellData.value);
                    }

                });
            });
        });
    }


    // 渲染表格
    function renderSheetTable(freezeRows = 0, freezeColumns = 0) {
        const sheetTableContainer = document.getElementById('sheetTableContainer');
        sheetTableContainer.innerHTML = '';
        if (sheetData.length > 0) {
            const table = document.createElement('table');
            table.classList.add('sync-height-table');
            sheetData.forEach((rowData, rowIndex) => {
                const row = document.createElement('tr');
                row.classList.add('sync-height-row');
                rowData.forEach((cellData, columnIndex) => {
                    const cell = document.createElement('td');
                    cell.setAttribute('data-row', cellData.row);
                    cell.setAttribute('data-column', cellData.column);
                    cell.setAttribute('data-color', cellData.color);
                    cell.setAttribute('data-col_width', cellData.col_width);
                    cell.setAttribute('data-rowspan', cellData.rowspan || 1);
                    cell.setAttribute('data-colspan', cellData.colspan || 1);

                    cell.rowSpan = cellData.rowspan || 1;
                    cell.colSpan = cellData.colspan || 1;

                    if (cellData.value === "PASS" || cellData.value === "FAIL" || cellData.value === "N.A" || cellData.value === "PASS/FAIL") {
                        const selectContainer = createSelectWithOptions(["PASS", "FAIL", "N.A", "PASS/FAIL", "自定义输入"], "60px", cellData.value);
                        cell.appendChild(selectContainer);
                        cell.contentEditable = false;
                    } else if (cellData.value === "√" || cellData.value === "×" || cellData.value === "N/A") {
                        const selectContainer = createSelectWithOptions(["√", "×", "N/A", "自定义输入"], "40px", cellData.value);
                        cell.appendChild(selectContainer);
                        cell.contentEditable = false;
                    } else if (cellData.value === "OK" || cellData.value === "NG" || cellData.value === "NA" || cellData.value === "OK/NG") {
                        const selectContainer = createSelectWithOptions(["OK", "NG", "NA", "OK/NG", "自定义输入"], "50px", cellData.value);
                        cell.appendChild(selectContainer);
                        cell.contentEditable = false;
                    } else if ((cellData.value && cellData.value.includes('.png')) || (cellData.value && cellData.value.includes('上传图片'))) {
                        // 创建一个 div 容器来包裹文本和图片
                        const contentContainer = document.createElement('div');
                        contentContainer.style.display = 'flex';
                        contentContainer.style.flexDirection = 'column'; // 纵向排列

                        // 添加文本
                        const textNode = document.createElement('span');
                        textNode.textContent = cellData.value;
                        textNode.style.cursor = 'pointer';
                        textNode.style.overflow = 'hidden';
                        textNode.style.whiteSpace = 'nowrap';
                        textNode.style.textOverflow = 'ellipsis';

                        contentContainer.appendChild(textNode);

                        // 创建图片
                        const img = document.createElement('img');
                        img.src = cellData.value.replace(/#/g, '%23') + '?t=' + new Date().getTime(); // 添加时间戳
                        img.style.maxWidth = '25%'; // 将图片最大宽度设为单元格的 100%
                        img.style.maxHeight = '25%'; // 将图片最大高度设为单元格的 100%
                        img.style.objectFit = 'contain'; // 保持图片比例不失真，使用 'contain' 确保图片保持比例并适应单元格

                        contentContainer.appendChild(img);
                        cell.appendChild(contentContainer); // 将容器添加到单元格

                        cell.contentEditable = false;

                        cell.addEventListener('click', () => {
                            showModal(cellData.value, cellData.row, cellData.column, event);
                        });
                    } else if (cellData.value === "增一行") {
                        cell.contentEditable = false;
                        const buttonContainer = document.createElement('div');
                        const button = document.createElement('button');
                        button.textContent = '增一行';
                        button.classList.add('rounded-button', 'green-button');
                        button.addEventListener('click', () => {
                            if (!rowIsProcessing) {
                                rowIsProcessing = true;
                                saveData();
                                setTimeout(() => {
                                    insertRow(cellData.row);
                                    rowIsProcessing = false; // 重置标志变量
                                }, 5000); // 延时5秒
                            }
                        });
                        buttonContainer.style.display = 'flex';
                        buttonContainer.style.justifyContent = 'center';
                        buttonContainer.style.alignItems = 'center';
                        buttonContainer.style.height = '100%';
                        buttonContainer.appendChild(button);
                        cell.appendChild(buttonContainer);
                    } else if (cellData.value === "删一行") {
                        cell.contentEditable = false;
                        const buttonContainer = document.createElement('div');
                        const button = document.createElement('button');
                        button.textContent = '删一行';
                        button.classList.add('rounded-button', 'green-button');
                        button.addEventListener('click', () => {
                            if (!rowIsProcessing) {
                                rowIsProcessing = true;
                                saveData();
                                setTimeout(() => {
                                    deleteRow(cellData.row);
                                    rowIsProcessing = false; // 重置标志变量
                                }, 5000); // 延时5秒
                            }
                        });
                        buttonContainer.style.display = 'flex';
                        buttonContainer.style.justifyContent = 'center';
                        buttonContainer.style.alignItems = 'center';
                        buttonContainer.style.height = '100%';
                        buttonContainer.appendChild(button);
                        cell.appendChild(buttonContainer);
                    } else {

                        cell.innerText = cellData.value || '';
                        cell.contentEditable = true;
                        cell.classList.add('content-editable');

                        // 添加样式，设置居中靠左
                        cell.style.textAlign = 'left';       // 水平居左
                        cell.style.verticalAlign = 'middle'; // 垂直居中

                        // 单元格点击记录点击位置事件
                        cell.addEventListener('click', function() {
                            let cell = event.target;
                            // 记录当前点击单元格的行和列
                            // 获取单元格的 row 和 column 值
                            selectedRow = cell.getAttribute('data-row');
                            selectedColumn = cell.getAttribute('data-column');
                            selectedValue = cell.innerText;

                        });

                        cell.addEventListener('input', handleCellInput);
                        cell.addEventListener('paste', handleCellPaste);
                    }

                    // 冻结逻辑
                    if (columnIndex < freezeColumns) {
                        cell.classList.add('frozen-column');
                    }
                    if (rowIndex < freezeRows) {
                        cell.classList.add('frozen-row');
                    }
                    if (rowIndex < freezeRows && columnIndex < freezeColumns) {
                        cell.classList.add('frozen-corner');
                    }

                    let col_width = cell.getAttribute('data-col_width') - 15;

                    if (cellData.color === "black") {
                        cell.style.backgroundColor = "#f0f0f0";
                        // cell.style.whiteSpace = "nowrap";
                        // let col_width = cell.getAttribute('data-col_width') - 15;
                        cell.style.maxWidth = col_width + 'px';
                        cell.style.width = col_width + 'px';
                        cell.style.minWidth = col_width + 'px';
                    } else if (cellData.color === "red") {
                        if (cell.querySelector('select')) {
                            cell.style.backgroundColor = "#fff"; // 设置为白色
                        } else {
                            // cell.style.backgroundColor = "#f54646"; // 设置为红色
                            cell.style.color = "#f54646"; // 设置字体颜色为红色
                        }
                        // cell.style.backgroundColor = "#f54646";
                        // cell.style.whiteSpace = "nowrap";

                        cell.style.maxWidth = col_width + 'px';
                        cell.style.width = col_width + 'px';
                        cell.style.minWidth = col_width + 'px';
                    }
                    row.appendChild(cell);
                });
                table.appendChild(row);
            });
            sheetTableContainer.appendChild(table);

            const sheetButtonContainer = document.querySelector('.sheetButtonContainer');
            const tableWidth = table.clientWidth;
            sheetButtonContainer.style.width = `${tableWidth}px`;
        } else {
            sheetTableContainer.textContent = '此工作表没有标记颜色，所以没有数据展示.';
        }
    }


    window.onload = function () {
        function getJson(filepath) {
            return fetch(`/getJson`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filepath: filepath })
            })
                .then(response => response.json())
                .then(data => {
                    return data; // 返回获取到的uuid
                })
                .catch(error => {
                    return null; // 返回null以便处理错误
                });
        }

        function getUUID(filepath) {
            return fetch(`/getUUID`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filepath: filepath })
            })
                .then(response => response.text())
                .then(data => {
                    return data; // 返回获取到的uuid
                })
                .catch(error => {
                    alert('getUUID失败');
                    return null; // 返回null以便处理错误
                });
        }
        function updateUUID(filepath,uuid) {
            return fetch(`/updateUUID`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ filepath: filepath,uuid: uuid })
            })
                .then(response => response.text())
                .then(data => {
                    if(data==="1"){
                        console.log("更新UUID成功");
                    }else {
                        console.log("更新UUID失败");
                    }
                })
                .catch(error => {
                    alert("更新UUID出错");
                    return null; // 返回null以便处理错误
                });
        }

        function loadCollectData() {
            const storageCollectData = `collectData_${filePath}`;
            const storedData = localStorage.getItem(storageCollectData);
            if (storedData) {
                try {
                    collectData = JSON.parse(storedData);
                } catch (error) {
                    console.error('Error parsing stored collectData:', error);
                    collectData = {};
                }
            } else {
                collectData = {};
            }
        }

        // 获取返回按钮并添加点击事件监听器
        var saveBtn =  document.getElementById('saveBtn');
        document.getElementById('homeBtn').addEventListener('click', onHomeBtnClick);
        // document.getElementById('saveBtn').addEventListener('click', onSaveBtnClick);

        // 显示加载中提示
        var loadingElement = document.getElementById('startloading');
        loadingElement.style.display = 'block';

        filePath = getQueryParam('filePath');

        // 获取 filePath 参数并设置到 <h2> 元素中
        var fileName = filePath.substring(filePath.lastIndexOf('\\') + 1);
        // 更新 <h2> 元素的内容为文件名
        var filePathDisplayElement = document.getElementById('filepathDisplay');
        filePathDisplayElement.textContent = `当前文件：${fileName}`;

        uuidStorage = localStorage.getItem("uuid_");
        // storageKey = `sheetData_${filePath}`;

        // 使用getUUID方法并进行uuidStorage比较
        getUUID(filePath).then(uuidMysql => {
            if (uuidMysql) {
                if (uuidMysql === uuidStorage) {
                    getJson(filePath).then(jsonData => {
                        if (jsonData && jsonData.length > 0) {
                            // 如果 JSON 文件存在并且数据有效
                            allSheetData = jsonData;
                            loadCollectData();

                            updateSpecialCells(allSheetData);
                            getSheetNames();

                            loadingElement.style.display = 'none';
                            saveBtn.addEventListener('click', onSaveBtnClick);
                            functionBtnClick();
                            DeviceListBtnClick();
                        } else {
                            // 如果 JSON 文件不存在或数据无效
                            getAllSheetData().then(() => {
                                loadingElement.style.display = 'none';
                                saveBtn.addEventListener('click', onSaveBtnClick);
                                functionBtnClick();
                                DeviceListBtnClick();
                                updateUUID(filePath, uuidStorage);
                            }).catch(error => {
                                console.error('Error loading sheet data:', error);
                                loadingElement.style.display = 'none';
                            });
                        }
                    }).catch(error => {
                        console.error('Error checking JSON file:', error);
                        loadingElement.style.display = 'none';
                    });


                } else {
                    getAllSheetData().then(() => {
                        loadingElement.style.display = 'none';
                        saveBtn.addEventListener('click', onSaveBtnClick);
                        functionBtnClick();
                        DeviceListBtnClick();
                        updateUUID(filePath,uuidStorage);
                    }).catch(error => {
                        console.error('Error loading sheet data:', error);
                        loadingElement.style.display = 'none';

                    });
                }
            }else{
                getAllSheetData().then(() => {
                    loadingElement.style.display = 'none';
                    saveBtn.addEventListener('click', onSaveBtnClick);
                    functionBtnClick();
                    DeviceListBtnClick();
                    updateUUID(filePath,uuidStorage);
                }).catch(error => {
                    console.error('Error loading sheet data:', error);
                    loadingElement.style.display = 'none';

                });
            }
        });

        //配置jsapi
        var baseUrl = window.location.origin + window.location.pathname;
        // 使用 Fetch API 发送请求
        fetch(`/getJsapiConfig?url=${encodeURIComponent(baseUrl)}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(config => {
                dd.config({
                    agentId: config.agentId,
                    corpId: config.corpId,
                    timeStamp: config.timeStamp,
                    nonceStr: config.nonceStr,
                    signature: config.signature,
                    jsApiList: config.jsApiList
                });
            })
            .catch(error => {
                console.error('Fetch 请求失败:', error);
            });
    };



    // onHomeBtnClick 函数实现
    function onHomeBtnClick() {
        handleUnloadEvent();

        // 如果存在controller，则取消请求
        if (fetchController) {
            fetchController.abort();
            console.log('请求已中止，正在返回主页...');

            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
            if(isIOS){
                dd.closePage({
                    success: () => {},
                    fail: () => {},
                    complete: () => {},
                });
            }else{
                // 跳转到主页
                location.href = '/home';
            }

            return; // 确保在中止请求后不执行其他操作
        }

    }

    function onSaveBtnClick() {
        if (saveButtonCooldown) {
            if(isSaving===true){
                alert("上一次的保存还在执行中，请稍等15s再执行。");
            }
            alert("请不要频繁保存，本按钮的保存间隔为15s。");
            return;
        }

        saveButtonCooldown = true;
        saveData();

        // 禁用按钮15秒
        setTimeout(() => {
            saveButtonCooldown = false;
        }, 15000);
    }


    function getQueryParam(name) {
        var url = window.location.href;
        var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)');
        var results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, ' '));
    }

    function createSelectWithOptions(options, selectWidth, value, rowIndex, columnIndex) {
        const select = document.createElement('select');
        select.style.width = selectWidth;

        options.forEach(option => {
            const optionElement = document.createElement('option');
            optionElement.value = option;
            optionElement.text = option;
            select.appendChild(optionElement);
        });
        select.addEventListener('change', (event) => {
            handleSelectChange(event, rowIndex, columnIndex);
        });

        const selectContainer = document.createElement('div');
        selectContainer.style.display = 'flex';
        selectContainer.style.justifyContent = 'center'; // 水平居中
        selectContainer.style.alignItems = 'center'; // 垂直居中
        selectContainer.style.height = '100%'; // 占满单元格高度

        selectContainer.style.position = 'relative'; // 确保位置正确
        selectContainer.style.zIndex = '1'; // 确保在冻结行下方

        selectContainer.appendChild(select);
        select.value = value;
        if (value === "FAIL" || value === "NG" || value === "×") {
            select.style.background = '#f54646';
        } else {
            select.style.background = '#ffffff';
        }
        return selectContainer;
    }

    // 下拉框变化事件处理函数
    function handleSelectChange(event, row, column) {
        const selectElement = event.target;
        const tdElement = selectElement.parentNode.parentNode; // 获取 <select> 的父元素，即 <td>
        let newvalue = selectElement.value;
        const target_row = tdElement.getAttribute('data-row');
        const target_column = tdElement.getAttribute('data-column');

        const cell = event.target.closest('td'); // 获取包含当前下拉框的单元格
        const selectedValue = event.target.value;
        if (selectedValue === "自定义输入") {
            // 移除当前下拉框
            event.target.remove();
            // 清空单元格内容
            cell.textContent = "";
            // 使单元格恢复可编辑状态
            cell.contentEditable = true;
            newvalue = "";
            // 重新绑定单元格的输入事件处理函数
            cell.removeEventListener('input', handleSelectChange); // 移除之前的change事件监听（如果有的话）
            cell.addEventListener('input', handleCellInput); // 重新绑定input事件处理函数
            cell.addEventListener('paste', handleCellPaste);

        }

        // 如果选择值是 PASS、OK 或 √，将 <td> 背景颜色变为绿色
        if (newvalue === "FAIL" || newvalue === "×" || newvalue === "NG") {
            selectElement.style.backgroundColor = '#f54646';
        } else {
            selectElement.style.backgroundColor = '#f0f0f0'; // 恢复默认背景颜色
        }

        updateCollectData(selectedSheetName, parseInt(target_row, 10), parseInt(target_column, 10), newvalue);

    }


    // 创建并展示模态框
    function showModal(imageSrc, row, column, event) { // imageSrc:  images/image_1.外观检测_row_6_col_2.png
        showLoadingOverlay();
        // 创建模态框元素
        const modal = document.createElement('div');
        modal.className = 'modal';
        modal.style.position = 'fixed';
        modal.style.zIndex = '1000';
        modal.style.backgroundColor = 'white';
        modal.style.padding = '20px';
        modal.style.borderRadius = '8px';
        modal.style.boxShadow = '0 4px 8px rgba(0, 0, 0, 0.1)';
        modal.style.display = 'flex';
        modal.style.flexDirection = 'column';
        modal.style.alignItems = 'center';
        modal.style.zIndex = '9999';
        // 创建关闭按钮
        const closeButton = document.createElement('span');
        closeButton.className = 'close';
        closeButton.textContent = '×';
        closeButton.style.fontSize = '24px'; // 设置关闭按钮的字体大小为24像素
        closeButton.style.cursor = 'pointer';
        closeButton.style.alignSelf = 'flex-end';
        closeButton.onclick = () => {
            modal.remove(); // 点击关闭按钮时移除模态框
            hideLoadingOverlay();
        };
        // 创建图片容器
        const imgContainer = document.createElement('div');
        imgContainer.style.overflow = 'auto';
        imgContainer.style.maxWidth = '50vw'; // 设置图片容器的最大宽度为视口宽度的90%
        imgContainer.style.maxHeight = '50vh'; // 设置图片容器的最大高度为视口高度的70%
        // 创建图片元素
        const img = document.createElement('img');
        img.src =  imageSrc.replace(/#/g, '%23') + '?t=' + new Date().getTime(); // 添加时间戳
        img.className = 'modal-content';
        img.style.maxWidth = '100%'; // 设置图片的最大宽度为容器宽度的100%
        img.style.maxHeight = '100%'; // 设置图片的最大高度为容器高度的100%'
        img.style.transition = 'transform 0.3s'; // 设置缩放动画过渡效果
        imgContainer.appendChild(img);
        // 创建放大按钮
        const zoomInButton = document.createElement('button');
        zoomInButton.textContent = '放大';
        zoomInButton.onclick = () => {
            // 获取当前图片的缩放比例
            const currentScale = getComputedStyle(img).transform;

            // 如果没有缩放，或者当前缩放为1，则设置为150%
            if (currentScale === 'none' || currentScale === 'matrix(1, 0, 0, 1, 0, 0)') {
                img.style.transformOrigin = 'top left'; // 设置变换原点为左上角
                img.style.transform = 'scale(1.5)'; // 将图像放大 150%
            } else if (currentScale === 'matrix(1.5, 0, 0, 1.5, 0, 0)') {
                img.style.transformOrigin = 'top left'; // 设置变换原点为左上角
                img.style.transform = 'scale(2)'; // 将图像放大 200%
            } else {
                img.style.transformOrigin = 'top left'; // 设置变换原点为左上角
                img.style.transform = 'scale(1)'; // 将图像还原到 100%
            }
        };
        // 创建还原按钮
        const zoomOutButton = document.createElement('button');
        zoomOutButton.textContent = '还原';
        zoomOutButton.onclick = () => {
            img.style.transform = 'scale(1)'; // 将图像还原
        };

        // 创建文件输入框
        const inputFile = document.createElement('input');
        inputFile.type = 'file';
        inputFile.accept = 'image/*';
        inputFile.style.display = 'none'; // 隐藏输入框

        // 创建上传按钮
        const uploadButton = document.createElement('button');
        uploadButton.textContent = '上传新图片';
        uploadButton.onclick = () => {
            // 触发文件选择对话框
            inputFile.click();
        };
        // 绑定文件选择事件
        inputFile.onchange = (event) => {
            const file = event.target.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('image', file);
                formData.append('row', row);
                formData.append('column', column);
                formData.append('sheetName', selectedSheetName);
                formData.append('filepath', filePath);
                // 发送图片文件到后端静态文件夹
                fetch('/uploadImage', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => response.json())
                    .then(data => {
                        const imageUrl = data.imageUrl;
                        const error = data.error;

                        if (error) {
                            alert(error);
                        } else {
                            alert("图片正在上传，请稍等云端提示。");

                            // 查找并更新表格中的图片
                            const cell = document.querySelector(`[data-row="${row}"][data-column="${column}"]`); // 假设你使用 data-row 和 data-column 来标记单元格
                            if (cell) {
                                const cellImg = cell.querySelector('img');
                                if (cellImg) {
                                    cellImg.src = imageUrl.replace(/#/g, '%23') + '?t=' + new Date().getTime(); // 添加时间戳来确保图片刷新
                                }
                            }

                            const rowIndex = sheetData.findIndex(rowData => rowData.some(cell => cell.row === row));
                            if (rowIndex !== -1) {
                                const columnIndex = sheetData[rowIndex].findIndex(cell => cell.column === column);
                                if (columnIndex !== -1) {
                                    sheetData[rowIndex][columnIndex].value = imageUrl;
                                    syncSheetDataToAllSheetData();
                                }
                            }
                            img.src = imageUrl.replace(/#/g, '%23') + '?t=' + new Date().getTime();
                            updateCollectData(selectedSheetName, row, column, imageUrl);
                            saveData();
                            // renderSheetTable();
                        }
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        alert('Failed to upload image.');
                    });
            } else {
                alert("图片没有检查到，请联系卢健此处可能有bug")
            }
        };

// 添加input和button到页面
        document.body.appendChild(inputFile);
        document.body.appendChild(uploadButton);

        // 创建按钮容器
        const buttonContainer = document.createElement('div');
        buttonContainer.style.display = 'flex';
        buttonContainer.style.justifyContent = 'space-between';
        buttonContainer.style.width = '100%';
        buttonContainer.style.marginTop = '10px';

        // 将按钮添加到按钮容器中
        buttonContainer.appendChild(zoomInButton);
        buttonContainer.appendChild(zoomOutButton);
        buttonContainer.appendChild(uploadButton);

        // 将元素添加到模态框中
        modal.appendChild(closeButton);
        modal.appendChild(imgContainer);
        modal.appendChild(buttonContainer);

        // 将模态框添加到页面中
        document.body.appendChild(modal);

        // 获取窗口的尺寸
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        // 获取模态框的尺寸
        const modalRect = modal.getBoundingClientRect();

        // 计算模态框的位置，使其居中显示在窗口内，并向上移动模态框一半的高度
        const modalLeft = (windowWidth - modalRect.width) / 2;
        const modalTop = (windowHeight - modalRect.height) / 2 - (modalRect.height / 2);

        modal.style.left = `${modalLeft}px`;
        modal.style.top = `${modalTop}px`;
    }

    function handleCellInput(event) {
        let cell = event.target;

        // 设置默认行高
        // const defaultHeight = 100;  //设置单元格行高为70磅，在这里70磅也就是96这里，所以设个默认值100，超出100则需要加个scrollHeight进editedData然后接下来去增加xlsx行高
        const originalValue = cell.innerText;  // 获取单元格的新值
        const target_row = cell.getAttribute('data-row');
        const target_column = cell.getAttribute('data-column');
        const target_color = cell.getAttribute('data-color');

        //20240924新增设置红色和黑色的功能按钮
        selectedValue = originalValue;

        // 记录当前高度
        const currentHeight = cell.scrollHeight;

        // 更新 collectData，只记录最后一次的变化
        updateCollectData(selectedSheetName, parseInt(target_row, 10), parseInt(target_column, 10), originalValue, currentHeight ,null,null,null, target_color);

    }


    // // 显示加载遮罩
    function showLoadingOverlay() {
        document.getElementById('loadingOverlay').style.display = 'flex';
    }

    // // 隐藏加载遮罩
    function hideLoadingOverlay() {
        document.getElementById('loadingOverlay').style.display = 'none';
    }

    function insertRow(row) {
        // 使用 Fetch API 进行 AJAX 调用
        // 发送位置信息和值到后端保存
        fetch(`/insertRow?sheetName=${encodeURIComponent(selectedSheetName)}&filePath=${encodeURIComponent(filePath)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({row: row})  // 将 row 转换为 JSON 字符串
        })
            .then(response => response.text())
            .then(data => {
                // 这里可以添加一些成功保存后的处理逻辑
                if (data === "成功新增一行") {
                    insertRowBefore(row);

                } else {
                    alert(data);
                }

            })
            .catch(error => {
                console.error('Error saving data:', error);
                alert('Failed to save data.');
            });
    }



    function deleteRow(row) {
        // 检查当前行的所有单元格是否包含 "/imageDirectory/"
        const currentRowData = sheetData.find(rowData => rowData.some(cell => cell.row === row));

        if (currentRowData) {
            const hasImageDirectory = currentRowData.some(cell => cell.value.includes('/imageDirectory/'));

            if (hasImageDirectory) {
                alert("当前行包含图片数据，无法删除。");
                return; // 不能删除，直接返回
            }
        }
        // 使用 Fetch API 进行 AJAX 调用
        // 发送位置信息和值到后端保存
        fetch(`/deleteRow?sheetName=${encodeURIComponent(selectedSheetName)}&filePath=${encodeURIComponent(filePath)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({row: row})  // 将 row 转换为 JSON 字符串
        })
            .then(response => response.text())
            .then(data => {
                if (data === "成功删除一行") {
                    // 这里可以添加一些成功保存后的处理逻辑
                    deleteRowBefore(row);
                } else {
                    alert(data);
                }

            })
            .catch(error => {
                console.error('Error saving data:', error);
                alert('Failed to save data.');
            });
    }

    // 插入某个工作表的某行前一行
    function insertRowBefore(row) {
        // 遍历 sheetData 中的每一行数据
        sheetData.forEach(rowData => {
            // 如果当前行的 row 大于等于传入的 row 参数
            rowData.forEach(cell => {
                if (cell.row >= row) {
                    // 将当前行的 row 值加一
                    cell.row += 1;
                }
            });
        });

        // 在 sheetData 中找到指定行的数据
        const rowIndex = sheetData.findIndex(rowData => rowData.some(cell => cell.row === row + 1));

        if (rowIndex !== -1) {


            // 复制指定行的数据
            const newRowData = sheetData[rowIndex].map(cell => {
                // 创建新的单元格对象
                return {
                    ...cell,
                    row: row,
                    // 如果 value 不等于 "上传图片"，则将 value 设为空
                    // value: cell.value === '上传图片' ? cell.value : ''
                    value: cell.value.includes('/imageDirectory/') ? cell.value : ''
                };
            });

            // 处理原始行数据，将图片路径的单元格值设为空
            sheetData[rowIndex].forEach(cell => {
                if (cell.value.includes('/imageDirectory/')) {
                    cell.value = '上传图片'; // 清空原行的图片路径
                }
            });

            // 在 sheetData 中插入新行数据
            sheetData.splice(rowIndex, 0, newRowData);

        }
        sheetData.forEach(rowData => {
            rowData.forEach(cell => {
                const cellKey = `${cell.sheetName}-${cell.row}-${cell.column}`;
                collectData[cellKey] = {
                    sheetName: cell.sheetName,
                    row: cell.row,
                    column: cell.column,
                    value: cell.value,
                    rowspan: cell.rowspan,
                    colspan: cell.colspan,
                    col_width: cell.col_width,
                    color: cell.color,
                    insertRow: "是"

                };
            });
        });

        updatejsonIorD();

        syncSheetDataToAllSheetData();
        renderSheetTable();
    }

    // 删除指定行
    function deleteRowBefore(row) {
        // 查找指定行的上一行的数据
        const prevRowIndex = sheetData.findIndex(rowData => rowData.some(cell => cell.row === row - 1));

        if (prevRowIndex !== -1) {
            // 检查上一行的 value
            const prevRowData = sheetData[prevRowIndex];
            const canDelete = prevRowData.every(cell => cell.value === '' || cell.value === '上传图片');

            if (!canDelete) {
                alert("上一行有不允许删除的值，无法删除。");
                return; // 不能删除，直接返回
            }

            // 找到当前行的数据
            const rowIndex = sheetData.findIndex(rowData => rowData.some(cell => cell.row === row));
            if (rowIndex !== -1) {
                // 将当前行的数据移动到上一行的位置
                const currentRowData = sheetData[rowIndex].map(cell => ({...cell, row: row - 1}));

                // 更新上一行的数据，保留原来的单元格并添加当前行的数据
                sheetData[prevRowIndex] = prevRowData.map((cell, index) => {
                    return {
                        ...cell,
                        value: currentRowData[index] ? currentRowData[index].value : cell.value
                    };
                });

                // 删除当前行的数据
                sheetData.splice(rowIndex, 1);

                // 遍历 sheetData 中的每一行数据
                sheetData.forEach(rowData => {
                    // 如果当前行的 row 大于传入的 row 参数
                    rowData.forEach(cell => {
                        if (cell.row > row) {
                            // 将当前行的 row 值减一
                            cell.row -= 1;
                        }
                    });
                });

            }
        }

        sheetData.forEach(rowData => {
            rowData.forEach(cell => {
                const cellKey = `${cell.sheetName}-${cell.row}-${cell.column}`;
                collectData[cellKey] = {
                    sheetName: cell.sheetName,
                    row: cell.row,
                    column: cell.column,
                    value: cell.value,
                    rowspan: cell.rowspan,
                    colspan: cell.colspan,
                    col_width: cell.col_width,
                    color: cell.color,
                    insertRow: "是"

                };
            });
        });
        updatejsonIorD();


        syncSheetDataToAllSheetData();
        renderSheetTable();
    }

    //确保 sheetData 和 allSheetData 数据的同步
    function syncSheetDataToAllSheetData() {
        // 遍历 sheetData 中的每一个工作表数据
        sheetData.forEach(sheet => {
            // 找到当前工作表在 allSheetData 中的索引
            const sheetIndex = allSheetData.findIndex(data => data.sheetName === sheet[0].sheetName);

            if (sheetIndex !== -1) {
                // 更新当前工作表的数据
                allSheetData[sheetIndex] = sheet;
            }
        });
    }

    function updateSheetData(allSheetData, sheetData, collectData) {
        for (const key in collectData) {
            const {sheetName, row, column, value, color} = collectData[key];

            // 找到对应工作表数据
            const sheet = allSheetData.find(sheetArray =>
                sheetArray.some(innerArray =>
                    innerArray.some(cell => cell.sheetName === sheetName)
                )
            );

            if (!sheet) continue; // 如果找不到对应的工作表，跳过

            // 更新 allSheetData
            const allRowIndex = sheet.findIndex(rowData => rowData.some(cell => cell.row === row));
            if (allRowIndex !== -1) {
                const allColumnIndex = sheet[allRowIndex].findIndex(cell => cell.column === column);
                if (allColumnIndex !== -1) {
                    sheet[allRowIndex][allColumnIndex].value = value;
                    if (color) {
                        sheet[allRowIndex][allColumnIndex].color = color;
                    }
                }
            }

            // 更新 sheetData
            if (sheetName === selectedSheetName) { // 确保只更新当前选定的工作表数据
                const sheetRowIndex = sheetData.findIndex(rowData => rowData.some(cell => cell.row === row));
                if (sheetRowIndex !== -1) {
                    const sheetColumnIndex = sheetData[sheetRowIndex].findIndex(cell => cell.column === column);
                    if (sheetColumnIndex !== -1) {
                        sheetData[sheetRowIndex][sheetColumnIndex].value = value;
                        if (color) {
                            sheetData[sheetRowIndex][sheetColumnIndex].color = color;
                        }
                    }
                }
            }
        }
    }

    // 删一行和增一行的更新json方法,在执行完操作之后才进行更新json
    function updatejsonIorD() {
        fetch(`/updatejsonIorD?filePath=${encodeURIComponent(filePath)}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(collectData)  // 正确的结构
        })
            .then(response => response.json())
            .then(data => {
                if (data.status === "saved") {
                    collectData={};
                    alert("json文件更新成功");
                } else {
                    alert("更新失败？"+data.status);
                }

            })
            .catch(error => {
                console.error('Error saving data:', error);
                alert('Failed to save data.');
            });
    }

    function functionBtnClick(){
        var functionBtn = document.getElementById('functionBtn');
        var functionContainer = document.getElementById('functionContainer');
        var gapFillContainer = document.getElementById('gapFillContainer');
        var replaceContainer = document.getElementById('replaceContainer');
        var colorContainer = document.getElementById("colorContainer");
        var freezePaneContainer = document.getElementById("freezePaneContainer");
        functionBtn.addEventListener('click', function() {
            gapFillContainer.style.display = 'none';
            replaceContainer.style.display = 'none';
            colorContainer.style.display = 'none';
            freezePaneContainer.style.display = 'none';
            toggleFunctionContainer();
        });

        document.getElementById('gapFillBtn').addEventListener('click', function() {
            showGapFillContainer();
        });

        document.getElementById('replaceBtn').addEventListener('click', function() {
            // 在此处添加替换按钮的逻辑
            showReplaceContainer();
        });

        document.getElementById('colorChangeBtn').addEventListener('click', function() {
            // 在此处添加替换按钮的逻辑
            showColorContainer();
        });

        document.getElementById('freezePaneBtn').addEventListener('click', function() {
            // 在此处添加替换按钮的逻辑
            showfreezePaneContainer();
        });




        document.getElementById('cancelBtn').addEventListener('click', function() {
            var value = document.getElementById('gapFillInput').value;
            undoFillCells(value);
        });

        document.getElementById('fillBtn').addEventListener('click', function() {
            var value = document.getElementById('gapFillInput').value;
            fillEmptyCells(value);
        });

        function toggleFunctionContainer() {
            var button = document.getElementById('functionBtn');
            var rect = button.getBoundingClientRect();

            functionContainer.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            functionContainer.style.left = (rect.left + rect.width / 2) + 'px';
            functionContainer.style.transform = 'translateX(-50%)';
            functionContainer.style.display = functionContainer.style.display === 'none' ? 'block' : 'none';
        }

        function showGapFillContainer() {
            functionContainer.style.display = 'none';
            var button = document.getElementById('functionBtn'); // 使用 functionBtn 作为参考点
            var rect = button.getBoundingClientRect();

            gapFillContainer.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            gapFillContainer.style.left = (rect.left + rect.width / 2) + 'px';
            gapFillContainer.style.transform = 'translateX(-50%)';
            gapFillContainer.style.display = 'block';
        }

        function showReplaceContainer(){
            functionContainer.style.display = 'none';
            var button = document.getElementById('functionBtn'); // 使用 functionBtn 作为参考点
            var rect = button.getBoundingClientRect();

            replaceContainer.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            replaceContainer.style.left = (rect.left + rect.width / 2) + 'px';
            replaceContainer.style.transform = 'translateX(-50%)';
            replaceContainer.style.display = 'block';
        }

        function showColorContainer(){
            functionContainer.style.display = 'none';
            var button = document.getElementById('functionBtn'); // 使用 functionBtn 作为参考点
            var rect = button.getBoundingClientRect();

            colorContainer.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            colorContainer.style.left = (rect.left + rect.width / 2) + 'px';
            colorContainer.style.transform = 'translateX(-50%)';
            colorContainer.style.display = 'block';
        }
        function showfreezePaneContainer(){
            functionContainer.style.display = 'none';
            var button = document.getElementById('functionBtn'); // 使用 functionBtn 作为参考点
            var rect = button.getBoundingClientRect();

            freezePaneContainer.style.top = (rect.bottom + window.scrollY + 10) + 'px';
            freezePaneContainer.style.left = (rect.left + rect.width / 2) + 'px';
            freezePaneContainer.style.transform = 'translateX(-50%)';
            freezePaneContainer.style.display = 'block';
        }



        document.getElementById('startReplaceBtn').addEventListener('click', function() {
            var replaceInput = document.getElementById('replaceInput').value;
            var replaceOutput = document.getElementById('replaceOutput').value;
            replaceValues(replaceInput, replaceOutput);
            replaceContainer.style.display = 'none';
        });

        function replaceValues(oldValue, newValue) {
            updateSheetData(allSheetData,sheetData,collectData);
            sheetData.forEach(row => {
                row.forEach(cell => {
                    if (cell.value === oldValue) {
                        cell.value = newValue;
                        const target_row = cell.row;
                        const target_column = cell.column;
                        updateCollectData(selectedSheetName, parseInt(target_row, 10), parseInt(target_column, 10), newValue);
                    }
                });
            });
            renderSheetTable();
        }

        //撤回功能实际上是：根据输入框内容将本页工作表数据里value一致的改成""
        document.getElementById('cancelBtn').addEventListener('click', function() {
            var value = document.getElementById('gapFillInput').value;
            undoFillCells(value);

        });

        document.getElementById('fillBtn').addEventListener('click', function() {
            var value = document.getElementById('gapFillInput').value;
            // 在此处添加你的填空逻辑，例如将输入值应用到某些单元格
            fillEmptyCells(value);
            // document.getElementById('gapFillContainer').style.display = 'none';
        });

        document.getElementById('setRedColorBtn').addEventListener('click', function() {
            setRed();
            // replaceContainer.style.display = 'none';
        });

        document.getElementById('setBlackColorBtn').addEventListener('click', function() {
            setBlack();
            // replaceContainer.style.display = 'none';
        });

        function setRed() {
            // 确保已经选择了行、列和单元格的值
            if (selectedRow !== null && selectedColumn !== null && selectedValue !== null) {
                // 在 sheetData 中找到对应的单元格
                const targetRow = sheetData.find(row => row.some(cell => cell.row == selectedRow));

                if (targetRow) {
                    const targetCell = targetRow.find(cell => cell.column == selectedColumn);

                    if (targetCell) {
                        // 设置单元格的颜色为红色
                        targetCell.color = 'red';

                        // 更新 collectData 以保存变更
                        updateCollectData(selectedSheetName, parseInt(selectedRow, 10), parseInt(selectedColumn, 10), selectedValue, null, null, null,null, 'red');

                        // 更新 allSheetData 和 sheetData
                        updateSheetData(allSheetData, sheetData, collectData);

                        // 重新渲染表格
                        renderSheetTable();
                    } else {
                        console.log('找不到指定列的单元格');
                    }
                } else {
                    console.log('找不到指定行的单元格');
                }
            } else {
                console.log('尚未选择单元格');
            }
        }

        function setBlack() {
            // 确保已经选择了行、列和单元格的值
            if (selectedRow !== null && selectedColumn !== null && selectedValue !== null) {
                // 在 sheetData 中找到对应的单元格
                const targetRow = sheetData.find(row => row.some(cell => cell.row == selectedRow));

                if (targetRow) {
                    const targetCell = targetRow.find(cell => cell.column == selectedColumn);

                    if (targetCell) {
                        // 设置单元格的颜色为红色
                        targetCell.color = 'black';

                        // 更新 collectData 以保存变更
                        updateCollectData(selectedSheetName, parseInt(selectedRow, 10), parseInt(selectedColumn, 10), selectedValue, null, null, null,null, 'black');

                        // 更新 allSheetData 和 sheetData
                        updateSheetData(allSheetData, sheetData, collectData);

                        // 重新渲染表格
                        renderSheetTable();
                    } else {
                        console.log('找不到指定列的单元格');
                    }
                } else {
                    console.log('找不到指定行的单元格');
                }
            } else {
                console.log('尚未选择单元格');
            }
        }

        document.getElementById('setFreezePaneBtn').addEventListener('click', function() {
            // 获取输入框的值
            const freezeRows = document.getElementById('freezeRowsInput').value;
            const freezeColumns = document.getElementById('freezeColumnsInput').value;

            // 您可以在这里调用 renderSheetTable 函数来设置冻结窗格
            renderSheetTable(Number(freezeRows), Number(freezeColumns));
        });


        document.addEventListener('click', function(event) {
            var target = event.target;
            if (!functionContainer.contains(target) && !functionBtn.contains(target)) {
                functionContainer.style.display = 'none';
            }
            if (!gapFillContainer.contains(target) && !document.getElementById('gapFillBtn').contains(target)) {
                gapFillContainer.style.display = 'none';
            }
            if (!replaceContainer.contains(target) && !document.getElementById('replaceBtn').contains(target)) {
                replaceContainer.style.display = 'none';
            }
            // if (!colorContainer.contains(target) && !document.getElementById('colorChangeBtn').contains(target)) {
            //     colorContainer.style.display = 'none';
            // }
        });
    }


    function fillEmptyCells(value) {
        updateSheetData(allSheetData,sheetData, collectData);
        // 遍历 sheetData 找到所有 value 为空的单元格
        sheetData.forEach(row => {
            row.forEach(cell => {
                if (cell.value === "") {
                    cell.value = value; // 填充输入值

                    // 获取单元格的行和列
                    const target_row = cell.row;
                    const target_column = cell.column;

                    // 更新 collectData
                    updateCollectData(selectedSheetName, parseInt(target_row, 10), parseInt(target_column, 10), value);
                }
            });
        });

        // 重新渲染表格以反映填充后的变化
        renderSheetTable();
    }

    function undoFillCells(value) {
        // 遍历 sheetData 找到所有 value 等于输入值的单元格
        sheetData.forEach(row => {
            row.forEach(cell => {
                if (cell.value === value) {
                    cell.value = ""; // 撤回填充值

                    // 获取单元格的行和列
                    const target_row = cell.row;
                    const target_column = cell.column;

                    // 更新 collectData
                    updateCollectData(selectedSheetName, parseInt(target_row, 10), parseInt(target_column, 10), "");
                }
            });
        });

        // 重新渲染表格以反映撤回后的变化
        renderSheetTable();
    }


    function DeviceListBtnClick(){
        var deviceListBtn = document.getElementById('deviceListBtn');
        deviceListBtn.addEventListener('click',function(){
            document.getElementById('deviceModal').style.display = 'block';
        });

        document.getElementsByClassName('close')[0].addEventListener('click', function() {
            document.getElementById('deviceModal').style.display = 'none';
        });

        window.addEventListener('click', function(event) {
            if (event.target === document.getElementById('deviceModal')) {
                document.getElementById('deviceModal').style.display = 'none';
            }
        });

        fetch('/json/deviceList.json')
            .then(response => response.json())
            .then(data => {
                let regions = new Set(data.map(item => item.region));
                let types = {};
                let brands = {};
                let models = {};

                data.forEach(item => {
                    if (!types[item.region]) types[item.region] = new Set();
                    types[item.region].add(item.type);

                    if (!brands[item.region]) brands[item.region] = {};
                    if (!brands[item.region][item.type]) brands[item.region][item.type] = new Set();
                    brands[item.region][item.type].add(item.brand);

                    if (!models[item.region]) models[item.region] = {};
                    if (!models[item.region][item.type]) models[item.region][item.type] = {};
                    if (!models[item.region][item.type][item.brand]) models[item.region][item.type][item.brand] = new Set();
                    models[item.region][item.type][item.brand].add(item.model);
                });

                populateList(document.getElementById('regionList'), regions);

                document.getElementById('regionList').addEventListener('click', function (event) {
                    if (event.target.tagName === 'LI') {
                        let selectedRegion = event.target.textContent;
                        let selectedTypes = types[selectedRegion] || new Set();
                        populateList(document.getElementById('typeList'), selectedTypes);
                        document.getElementById('brandList').innerHTML = '';  // 清空品牌列表
                        document.getElementById('modelList').innerHTML = '';  // 清空型号列表

                        // Store the selected region
                        document.getElementById('typeList').dataset.selectedRegion = selectedRegion;
                    }
                });

                document.getElementById('typeList').addEventListener('click', function (event) {
                    if (event.target.tagName === 'LI') {
                        let selectedRegion = document.getElementById('typeList').dataset.selectedRegion;
                        let selectedType = event.target.textContent;
                        let selectedBrands = (brands[selectedRegion] && brands[selectedRegion][selectedType]) || new Set();
                        populateList(document.getElementById('brandList'), selectedBrands);
                        document.getElementById('modelList').innerHTML = '';  // 清空型号列表

                        // Store the selected type
                        document.getElementById('brandList').dataset.selectedRegion = selectedRegion;
                        document.getElementById('brandList').dataset.selectedType = selectedType;
                    }
                });

                document.getElementById('brandList').addEventListener('click', function (event) {
                    if (event.target.tagName === 'LI') {
                        let selectedRegion = document.getElementById('brandList').dataset.selectedRegion;
                        let selectedType = document.getElementById('brandList').dataset.selectedType;
                        let selectedBrand = event.target.textContent;
                        let selectedModels = (models[selectedRegion] && models[selectedRegion][selectedType] && models[selectedRegion][selectedType][selectedBrand]) || new Set();
                        populateList(document.getElementById('modelList'), selectedModels);

                        // Store the selected brand
                        document.getElementById('modelList').dataset.selectedRegion = selectedRegion;
                        document.getElementById('modelList').dataset.selectedType = selectedType;
                        document.getElementById('modelList').dataset.selectedBrand = selectedBrand;
                    }
                });

                document.getElementById('modelList').addEventListener('click', function (event) {
                    if (event.target.tagName === 'LI') {
                        let selectedRegion = document.getElementById('modelList').dataset.selectedRegion;
                        let selectedType = document.getElementById('modelList').dataset.selectedType;
                        let selectedBrand = document.getElementById('modelList').dataset.selectedBrand;
                        let selectedModel = event.target.textContent;
                        // let selectedDevice = `${selectedRegion} - ${selectedType} - ${selectedBrand} - ${selectedModel}`;
                        let selectedDevice = `${selectedModel}`;

                        // Update the selected devices input
                        updateSelectedDevices(selectedDevice);
                    }
                });

                document.getElementById('searchInput').addEventListener('input', function () {
                    let searchText = this.value.toLowerCase();
                    if (searchText.trim() === '') {
                        // 如果搜索输入框为空，清空设备列表
                        displayDevices([]);
                        return;
                    }
                    let filteredDevices = data.filter(item =>
                        item.model.toLowerCase().includes(searchText) ||
                        item.brand.toLowerCase().includes(searchText) ||
                        item.type.toLowerCase().includes(searchText) ||
                        item.region.toLowerCase().includes(searchText)
                    );
                    displayDevices(filteredDevices);
                });

                function populateList(listElement, items) {
                    listElement.innerHTML = '';
                    items.forEach(item => {
                        let li = document.createElement('li');
                        li.textContent = item;
                        listElement.appendChild(li);
                    });
                }

                function displayDevices(devices) {
                    let deviceList = document.getElementById('deviceList');
                    deviceList.innerHTML = '';
                    devices.forEach(device => {
                        let li = document.createElement('li');
                        li.textContent = `${device.model}`;
                        li.addEventListener('click', function () {
                            // Display the device information
                            updateSelectedDevices(li.textContent);
                        });
                        deviceList.appendChild(li);
                    });
                }

                function updateSelectedDevices(device) {
                    let selectedDevicesDiv = document.getElementById('selectedDevices');
                    let existingDevice = Array.from(selectedDevicesDiv.querySelectorAll('span'))
                        .find(span => span.textContent === device);

                    if (!existingDevice) {
                        // Add device if not already selected
                        let span = document.createElement('span');
                        span.textContent = device;
                        let button = document.createElement('button');
                        button.textContent = '删除';
                        button.addEventListener('click', function () {
                            selectedDevicesDiv.removeChild(span);
                            selectedDevicesDiv.removeChild(button);
                            if (selectedDevicesDiv.childNodes.length > 0 && selectedDevicesDiv.childNodes[selectedDevicesDiv.childNodes.length - 1].nodeName === 'BR') {
                                selectedDevicesDiv.removeChild(selectedDevicesDiv.childNodes[selectedDevicesDiv.childNodes.length - 1]); // Remove the last <br> element if it's there
                            }
                        });

                        selectedDevicesDiv.appendChild(span);
                        selectedDevicesDiv.appendChild(button);
                        selectedDevicesDiv.appendChild(document.createElement('br')); // Add line break after each device
                    }
                }
            });

        // 添加全选按钮事件监听器
        document.getElementById('selectAllButton').addEventListener('click', function() {
            let selectedDevicesDiv = document.getElementById('selectedDevices');
            let textToCopy = Array.from(selectedDevicesDiv.children)
                .filter(el => el.nodeName === 'SPAN') // 只选中设备名称，不包括删除按钮
                .map(el => el.textContent.trim())
                .join(', ');

            // 创建一个临时的 textarea 元素来执行复制操作
            let tempTextarea = document.createElement('textarea');
            tempTextarea.value = textToCopy;
            document.body.appendChild(tempTextarea);
            tempTextarea.select();
            document.execCommand('copy');
            document.body.removeChild(tempTextarea);

            alert('已全选并复制到剪贴板');
        });

        // 添加清空选择按钮事件监听器
        document.getElementById('clearSelectionButton').addEventListener('click', function() {
            let selectedDevicesDiv = document.getElementById('selectedDevices');
            selectedDevicesDiv.innerHTML = ''; // 清空文本框内容
        });
    }


</script>
</body>
</html>
