<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OEEåˆ†æ - è®¾å¤‡ç»¼åˆæ•ˆç‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 
                         'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-left a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .nav-left a:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .nav-center h1 {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-right {
            color: white;
            font-size: 14px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 8px;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* ç­›é€‰åŒºåŸŸ */
        .filter-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            position: relative;
        }
        
        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 13px;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .btn-refresh,
        .btn-help {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-help {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            position: relative;
        }
        
        .btn-refresh:hover,
        .btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* OEEè¯´æ˜æµ®åŠ¨é¢æ¿ */
        .help-popup {
            display: none;
            position: absolute;
            top: 80px;
            right: 24px;
            width: 420px;
            max-width: calc(100vw - 48px);
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            border: 2px solid #f59e0b;
            z-index: 1001;
            animation: popupFadeIn 0.3s ease-out;
        }
        
        .help-popup.active {
            display: block;
        }
        
        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* é®ç½©å±‚ */
        .help-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            animation: backdropFadeIn 0.3s ease-out;
        }
        
        .help-backdrop.active {
            display: block;
        }
        
        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .help-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 6px;
            color: #92400e;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .help-close:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .info-section-mini {
            margin-bottom: 16px;
        }
        
        .info-section-mini:last-child {
            margin-bottom: 0;
        }
        
        .info-title {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
        }
        
        .info-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .info-tags span {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .tag-world { background: #10b981; color: white; }
        .tag-excellent { background: #3b82f6; color: white; }
        .tag-good { background: #f59e0b; color: white; }
        .tag-improve { background: #ef4444; color: white; }
        
        .info-line {
            font-size: 12px;
            color: #92400e;
            margin-bottom: 4px;
            line-height: 1.5;
        }
        
        .info-line:last-child {
            margin-bottom: 0;
        }
        
        /* OEEæŒ‡æ ‡å¡ç‰‡åŒºåŸŸ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            font-size: 24px;
        }
        
        .metric-title {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
        }
        
        .metric-value {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .metric-card.primary .metric-value {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .metric-card.blue .metric-value { color: #3b82f6; }
        .metric-card.green .metric-value { color: #10b981; }
        .metric-card.orange .metric-value { color: #f59e0b; }
        
        .metric-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .badge-world { background: #10b981; color: white; }
        .badge-excellent { background: #3b82f6; color: white; }
        .badge-good { background: #f59e0b; color: white; }
        .badge-improve { background: #ef4444; color: white; }
        
        .metric-desc {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 12px;
        }
        
        .metric-details {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
        }
        
        .detail-row span {
            font-weight: 700;
            color: #111827;
        }
        
        /* å†å²æ•°æ®è¡¨æ ¼åŒºåŸŸ */
        .info-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        /* è¡¨æ ¼åŒºåŸŸ */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .btn-export {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
        }
        
        .record-count {
            font-size: 14px;
            color: #6b7280;
        }
        
        .record-count strong {
            color: #6366f1;
            font-weight: 700;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        
        th {
            padding: 14px 12px;
            text-align: left;
            color: white;
            font-weight: 700;
            font-size: 13px;
            white-space: nowrap;
        }
        
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        
        tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        
        tbody tr:hover {
            background: #f0f4ff;
        }
        
        td {
            padding: 12px;
            color: #374151;
            font-size: 13px;
        }
        
        td.no-data {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 16px;
        }
        
        .page-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-btn:hover:not(:disabled) {
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .top-nav {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }
            
            .nav-center h1 {
                font-size: 20px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-section {
                padding: 20px;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .btn-refresh,
            .btn-help {
                width: 100%;
            }
            
            .help-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                right: auto;
                width: calc(100% - 32px);
                max-width: 400px;
            }
            
            .help-popup.active {
                display: block;
                transform: translate(-50%, -50%);
            }
            
            @keyframes popupFadeIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, calc(-50% - 10px));
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
            }
            
            .table-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .btn-export {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .nav-center h1 {
                font-size: 18px;
            }
            
            .metric-value {
                font-size: 36px;
            }
            
            .info-title {
                font-size: 13px;
            }
            
            .info-line {
                font-size: 11px;
            }
            
            .help-popup {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- é®ç½©å±‚ -->
    <div class="help-backdrop" id="helpBackdrop" onclick="closeHelp()"></div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <div class="nav-left">
            <a href="/reliabilityIndex">â† è¿”å›ç›‘æ§é¦–é¡µ</a>
        </div>
        <div class="nav-center">
            <h1>ğŸ“Š è®¾å¤‡ç»¼åˆæ•ˆç‡åˆ†æ (OEE)</h1>
        </div>
        <div class="nav-right">
            <span id="currentTime">2025-11-14 10:00:00</span>
        </div>
    </div>

    <div class="container">
        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>è®¾å¤‡é€‰æ‹©</label>
                    <select id="deviceSelect" onchange="loadData()">
                        <option value="">å…¨éƒ¨è®¾å¤‡</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æ—¶é—´èŒƒå›´</label>
                    <select id="timeRange" onchange="handleTimeRangeChange()">
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month" selected>æœ¬æœˆ</option>
                        <option value="quarter">æœ¬å­£åº¦</option>
                        <option value="year">æœ¬å¹´</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="filter-group" id="customDates" style="display: none;">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group" id="customDates2" style="display: none;">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn-help" onclick="toggleHelp()">ğŸ“– OEEè¯´æ˜</button>
            </div>

            <!-- OEEè¯´æ˜æµ®åŠ¨é¢æ¿ -->
            <div class="help-popup" id="helpPopup">
                <button class="help-close" onclick="closeHelp()">Ã—</button>
                
                <div class="info-section-mini">
                    <div class="info-title">ğŸ† ä¸–ç•Œçº§OEEæ ‡å‡†</div>
                    <div class="info-tags">
                        <span class="tag-world">ä¸–ç•Œçº§ â‰¥85%</span>
                        <span class="tag-excellent">ä¼˜ç§€ 75%-85%</span>
                        <span class="tag-good">è‰¯å¥½ 65%-75%</span>
                        <span class="tag-improve">æ”¹å–„ &lt;65%</span>
                    </div>
                </div>
                
                <div class="info-section-mini">
                    <div class="info-title">ğŸ“Š å…­å¤§æŸå¤±è¯´æ˜</div>
                    <div class="info-line"><strong>è®¾å¤‡æ•…éšœã€è®¾ç½®è°ƒæ•´</strong> â†’ å½±å“å¯ç”¨ç‡</div>
                    <div class="info-line"><strong>ç©ºè½¬å°åœæœºã€é€Ÿåº¦é™ä½</strong> â†’ å½±å“æ€§èƒ½ç‡</div>
                    <div class="info-line"><strong>ä¸è‰¯è¿”å·¥ã€å¯åŠ¨æŸå¤±</strong> â†’ å½±å“åˆæ ¼ç‡</div>
                </div>
                
                <div class="info-section-mini">
                    <div class="info-title">ğŸ“ è®¡ç®—å…¬å¼</div>
                    <div class="info-line"><strong>ç»¼åˆOEE</strong> = å¯ç”¨ç‡ Ã— æ€§èƒ½ç‡ Ã— åˆæ ¼ç‡</div>
                    <div class="info-line"><strong>å¯ç”¨ç‡</strong> = å®é™…è¿è¡Œ / è®¡åˆ’è¿è¡Œ Ã— 100%</div>
                    <div class="info-line"><strong>æ€§èƒ½ç‡</strong> = å®é™…å¯åœæ¬¡æ•° / ç†è®ºäº§å‡º Ã— 100%</div>
                    <div class="info-line"><strong>è¯´æ˜</strong>ï¼š1æ¬¡åœæ­¢(0)+1æ¬¡å¯åŠ¨(1) = 1æ¬¡äº§å‡º</div>
                    <div class="info-line"><strong>åˆæ ¼ç‡</strong> = æœ‰æ•ˆäº§å‡º / æ€»äº§å‡º Ã— 100%</div>
                    <div class="info-line"><strong>è¯´æ˜</strong>ï¼šé…å¯¹æŒ‡ä»¤is_finishedéƒ½ä¸º1æ‰ç®—æœ‰æ•ˆ</div>
                </div>
            </div>
        </div>

        <!-- OEEæŒ‡æ ‡å¡ç‰‡ -->
        <div class="metrics-grid">
            <div class="metric-card primary">
                <div class="metric-header">
                    <span class="metric-icon">ğŸ¯</span>
                    <span class="metric-title">ç»¼åˆOEE</span>
                </div>
                <div class="metric-value" id="oeeValue">--</div>
                <div class="metric-badge" id="oeeBadge">è®¡ç®—ä¸­...</div>
                <div class="metric-desc">å¯ç”¨ç‡ Ã— æ€§èƒ½ç‡ Ã— åˆæ ¼ç‡</div>
            </div>

            <div class="metric-card blue">
                <div class="metric-header">
                    <span class="metric-icon">â°</span>
                    <span class="metric-title">å¯ç”¨ç‡</span>
                </div>
                <div class="metric-value" id="availValue">--</div>
                <div class="metric-desc">å®é™…è¿è¡Œ / è®¡åˆ’è¿è¡Œ</div>
                <div class="metric-details">
                    <div class="detail-row">è®¡åˆ’è¿è¡Œ <span id="plannedHours">--</span></div>
                    <div class="detail-row">å®é™…è¿è¡Œ <span id="actualHours">--</span></div>
                </div>
            </div>

            <div class="metric-card green">
                <div class="metric-header">
                    <span class="metric-icon">âš¡</span>
                    <span class="metric-title">æ€§èƒ½ç‡</span>
                </div>
                <div class="metric-value" id="perfValue">--</div>
                <div class="metric-desc">å®é™…å¯åœæ¬¡æ•° / ç†è®ºäº§å‡º</div>
                <div class="metric-details">
                    <div class="detail-row">ç†è®ºäº§å‡º <span id="theoryOutput">--</span></div>
                    <div class="detail-row">å®é™…å¯åœ <span id="realOutput">--</span></div>
                </div>
            </div>

            <div class="metric-card orange">
                <div class="metric-header">
                    <span class="metric-icon">âœ…</span>
                    <span class="metric-title">åˆæ ¼ç‡</span>
                </div>
                <div class="metric-value" id="qualValue">--</div>
                <div class="metric-desc">æœ‰æ•ˆäº§å‡º / æ€»äº§å‡º</div>
                <div class="metric-details">
                    <div class="detail-row">æ€»äº§å‡º <span id="totalTest">--</span></div>
                    <div class="detail-row">æœ‰æ•ˆäº§å‡º <span id="validTest">--</span></div>
                </div>
            </div>
        </div>


        <!-- å†å²æ•°æ®è¡¨æ ¼ -->
        <div class="info-section">
            <h3 class="section-title">ğŸ“‹ å†å²æ•°æ®è®°å½•</h3>
            <div class="table-header">
                <button class="btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡ºExcel</button>
                <div class="record-count">å…± <strong id="totalCount">0</strong> æ¡è®°å½•</div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>è®°å½•æ—¶é—´</th>
                            <th>è¿è¡ŒçŠ¶æ€</th>
                            <th>è¿è¡Œæ¨¡å¼</th>
                            <th>å½“å‰æ¸©åº¦(â„ƒ)</th>
                            <th>å½“å‰æ¹¿åº¦(%)</th>
                            <th>è®¾å®šæ¸©åº¦(â„ƒ)</th>
                            <th>è®¾å®šæ¹¿åº¦(%)</th>
                            <th>è¿è¡Œæ—¶é•¿(H)</th>
                            <th>ç¨‹å¼å·</th>
                            <th>æ€»æ®µæ•°</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <tr>
                            <td colspan="11" class="no-data">æ­£åœ¨åŠ è½½æ•°æ®...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="page-btn" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                <span class="page-info">ç¬¬ <span id="pageNum">1</span> / <span id="pageTotal">1</span> é¡µ</span>
                <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let pageSize = 20;
        let totalRecords = 0;
        let historyData = [];

        // çŠ¶æ€æ˜ å°„
        const STATUS_MAP = {
            '0': 'å·²åœæ­¢', '1': 'è¿è¡Œä¸­', '2': 'å·²æš‚åœ',
            'stopped': 'å·²åœæ­¢', 'running': 'è¿è¡Œä¸­', 'paused': 'å·²æš‚åœ'
        };

        // æ¨¡å¼æ˜ å°„
        const MODE_MAP = {
            '0': 'ç¨‹å¼æ¨¡å¼', '1': 'å®šå€¼æ¨¡å¼'
        };

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadDevices();
            loadData();
        });

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            const str = now.getFullYear() + '-' + 
                       pad(now.getMonth() + 1) + '-' + 
                       pad(now.getDate()) + ' ' +
                       pad(now.getHours()) + ':' + 
                       pad(now.getMinutes()) + ':' + 
                       pad(now.getSeconds());
            document.getElementById('currentTime').textContent = str;
        }

        function pad(n) {
            return String(n).padStart(2, '0');
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const res = await fetch('/iot/data/devices');
                const devices = await res.json();
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">å…¨éƒ¨è®¾å¤‡</option>';
                devices.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.device_id;
                    opt.textContent = d.device_id;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('åŠ è½½è®¾å¤‡å¤±è´¥:', err);
            }
        }

        // å¤„ç†æ—¶é—´èŒƒå›´å˜åŒ–
        function handleTimeRangeChange() {
            const range = document.getElementById('timeRange').value;
            const custom1 = document.getElementById('customDates');
            const custom2 = document.getElementById('customDates2');
            
            if (range === 'custom') {
                custom1.style.display = 'block';
                custom2.style.display = 'block';
            } else {
                custom1.style.display = 'none';
                custom2.style.display = 'none';
                loadData();
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const deviceId = document.getElementById('deviceSelect').value;
                const timeRange = document.getElementById('timeRange').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const params = new URLSearchParams();
                if (deviceId) params.append('device_id', deviceId);
                params.append('time_range', timeRange);
                if (timeRange === 'custom' && startDate && endDate) {
                    params.append('start_date', startDate);
                    params.append('end_date', endDate);
                }
                params.append('page', currentPage);
                params.append('page_size', pageSize);

                // è·å–å†å²æ•°æ®
                const res = await fetch('/iot/data/history?' + params.toString());
                const data = await res.json();

                historyData = data.records || [];
                totalRecords = data.total || 0;

                // è·å–è®¾å¤‡æŒ‡ä»¤æ•°æ®ç”¨äºæ€§èƒ½ç‡è®¡ç®—
                let commandData = [];
                try {
                    const commandParams = new URLSearchParams();
                    if (deviceId) commandParams.append('device_id', deviceId);
                    commandParams.append('time_range', timeRange);
                    if (timeRange === 'custom' && startDate && endDate) {
                        commandParams.append('start_date', startDate);
                        commandParams.append('end_date', endDate);
                    }
                    
                    const commandRes = await fetch('/iot/data/commands?' + commandParams.toString());
                    if (commandRes.ok) {
                        commandData = await commandRes.json();
                    } else {
                        console.warn('è·å–è®¾å¤‡æŒ‡ä»¤æ•°æ®å¤±è´¥ï¼Œå°†ä½¿ç”¨é»˜è®¤å€¼è®¡ç®—æ€§èƒ½ç‡');
                    }
                } catch (err) {
                    console.warn('è·å–è®¾å¤‡æŒ‡ä»¤æ•°æ®å¼‚å¸¸:', err);
                }

                calcOEE(historyData, commandData);
                renderTable(historyData);
                updatePagination();

            } catch (err) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
                alert('åŠ è½½æ•°æ®å¤±è´¥: ' + err.message);
            }
        }

        // è®¡ç®—OEE
        function calcOEE(records, commandData) {
            if (!records || records.length === 0) {
                updateMetrics(0, 0, 0, 0, 0, 0, 0, 0, 0);
                return;
            }

            // ç»Ÿè®¡è¿è¡Œæ—¶é—´
            let totalTime = 0;
            records.forEach(r => {
                const h = parseFloat(r.run_hours) || 0;
                const m = parseFloat(r.run_minutes) || 0;
                const s = parseFloat(r.run_seconds) || 0;
                totalTime += h + m/60 + s/3600;
            });

            // è®¡åˆ’æ—¶é—´
            const range = document.getElementById('timeRange').value;
            const planned = {
                'today': 24, 'week': 168, 'month': 720, 
                'quarter': 2160, 'year': 8760
            }[range] || 720;

            // å¯ç”¨ç‡
            const avail = (totalTime / planned) * 100;

            // æ€§èƒ½ç‡å’Œåˆæ ¼ç‡ - æ ¹æ®device_commandè¡¨ç»Ÿè®¡é…å¯¹çš„0->1æŒ‡ä»¤
            let actualOutput = 0;      // æ€»äº§å‡ºæ¬¡æ•°ï¼ˆæ‰€æœ‰é…å¯¹çš„0->1ï¼‰
            let validOutput = 0;       // æœ‰æ•ˆäº§å‡ºæ¬¡æ•°ï¼ˆis_finishedéƒ½ä¸º1çš„é…å¯¹ï¼‰
            
            if (commandData && commandData.length > 0) {
                console.log('[OEEè®¡ç®—] æ”¶åˆ°æŒ‡ä»¤æ•°æ®ï¼š', commandData.length, 'æ¡');
                
                // æŒ‰è®¾å¤‡IDå’Œæ—¶é—´æ’åº
                const sortedCommands = [...commandData].sort((a, b) => {
                    const timeA = new Date(a.created_at || a.command_time);
                    const timeB = new Date(b.created_at || b.command_time);
                    return timeA - timeB;
                });

                // ç»Ÿè®¡é…å¯¹çš„0->1æ¬¡æ•°
                let lastCmd = null;
                sortedCommands.forEach(cmd => {
                    const status = String(cmd.run_status);
                    
                    if (lastCmd && String(lastCmd.run_status) === '0' && status === '1') {
                        // æ‰¾åˆ°ä¸€å¯¹ 0->1 é…å¯¹
                        actualOutput++;
                        
                        // æ£€æŸ¥è¿™ä¸€å¯¹æŒ‡ä»¤çš„is_finishedæ˜¯å¦éƒ½æ˜¯1
                        const lastFinished = parseInt(lastCmd.is_finished) || 0;
                        const currentFinished = parseInt(cmd.is_finished) || 0;
                        
                        if (lastFinished === 1 && currentFinished === 1) {
                            validOutput++;
                            console.log('[OEEè®¡ç®—] æœ‰æ•ˆäº§å‡º #' + validOutput + 'ï¼šæŒ‡ä»¤' + lastCmd.id + '(0)â†’' + cmd.id + '(1)');
                        } else {
                            console.log('[OEEè®¡ç®—] æ— æ•ˆäº§å‡ºï¼šæŒ‡ä»¤' + lastCmd.id + '(finished=' + lastFinished + ')â†’' + cmd.id + '(finished=' + currentFinished + ')');
                        }
                    }
                    
                    lastCmd = cmd;
                });
                
                console.log('[OEEè®¡ç®—] æ€»äº§å‡ºæ¬¡æ•°ï¼š', actualOutput, 'æœ‰æ•ˆäº§å‡ºæ¬¡æ•°ï¼š', validOutput);
            } else {
                console.log('[OEEè®¡ç®—] æœªæ”¶åˆ°æŒ‡ä»¤æ•°æ®');
            }

            // ç†è®ºäº§å‡º - å‡è®¾æ ‡å‡†å‘¨æœŸä¸º24å°æ—¶ä¸€æ¬¡
            const stdCycle = 24;
            const theoryOutput = planned / stdCycle;
            const perf = theoryOutput > 0 ? (actualOutput / theoryOutput) * 100 : 0;

            // åˆæ ¼ç‡ - æœ‰æ•ˆäº§å‡º / æ€»äº§å‡º
            const qual = actualOutput > 0 ? (validOutput / actualOutput) * 100 : 100;

            // ç»¼åˆOEE
            const oee = (avail/100) * (perf/100) * (qual/100) * 100;

            updateMetrics(oee, avail, perf, qual, planned, totalTime, theoryOutput, actualOutput, validOutput);
        }

        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetrics(oee, avail, perf, qual, planned, actual, theory, output, valid) {
            document.getElementById('oeeValue').textContent = oee.toFixed(1) + '%';
            document.getElementById('availValue').textContent = avail.toFixed(1) + '%';
            document.getElementById('perfValue').textContent = perf.toFixed(1) + '%';
            document.getElementById('qualValue').textContent = qual.toFixed(1) + '%';

            // ç­‰çº§è¯„å®š
            const badge = document.getElementById('oeeBadge');
            if (oee >= 85) {
                badge.textContent = 'ğŸ† ä¸–ç•Œçº§æ°´å¹³';
                badge.className = 'metric-badge badge-world';
            } else if (oee >= 75) {
                badge.textContent = 'â­ ä¼˜ç§€æ°´å¹³';
                badge.className = 'metric-badge badge-excellent';
            } else if (oee >= 65) {
                badge.textContent = 'ğŸ‘ è‰¯å¥½æ°´å¹³';
                badge.className = 'metric-badge badge-good';
            } else {
                badge.textContent = 'âš ï¸ éœ€è¦æ”¹å–„';
                badge.className = 'metric-badge badge-improve';
            }

            document.getElementById('plannedHours').textContent = planned.toFixed(0) + ' å°æ—¶';
            document.getElementById('actualHours').textContent = actual.toFixed(1) + ' å°æ—¶';
            document.getElementById('theoryOutput').textContent = theory.toFixed(0) + ' æ¬¡';
            document.getElementById('realOutput').textContent = output.toFixed(0) + ' æ¬¡';
            document.getElementById('totalTest').textContent = output.toFixed(0) + ' æ¬¡';
            document.getElementById('validTest').textContent = valid.toFixed(0) + ' æ¬¡';
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(records) {
            const tbody = document.getElementById('dataTable');
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-data">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            records.forEach(r => {
                const tr = document.createElement('tr');
                
                const cells = [
                    r.device_id || '--',
                    formatTime(r.updated_at || r.created_at),
                    STATUS_MAP[r.run_status] || r.run_status || '--',
                    MODE_MAP[r.run_mode] || r.run_mode || '--',
                    safeNum(r.temperature, 2),
                    safeNum(r.humidity, 2),
                    safeNum(r.set_temperature, 1),
                    safeNum(r.set_humidity, 1),
                    calcHours(r.run_hours, r.run_minutes, r.run_seconds),
                    r.set_program_number || '--',
                    r.total_steps || '--'
                ];

                cells.forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            document.getElementById('totalCount').textContent = totalRecords;
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            document.getElementById('pageNum').textContent = currentPage;
            document.getElementById('pageTotal').textContent = totalPages;
        }

        // ç¿»é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadData();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                loadData();
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!historyData || historyData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            let csv = 'è®¾å¤‡ID,è®°å½•æ—¶é—´,è¿è¡ŒçŠ¶æ€,è¿è¡Œæ¨¡å¼,å½“å‰æ¸©åº¦,å½“å‰æ¹¿åº¦,è®¾å®šæ¸©åº¦,è®¾å®šæ¹¿åº¦,è¿è¡Œæ—¶é•¿,ç¨‹å¼å·,æ€»æ®µæ•°\n';
            
            historyData.forEach(r => {
                csv += [
                    r.device_id || '--',
                    formatTime(r.updated_at || r.created_at),
                    STATUS_MAP[r.run_status] || r.run_status || '--',
                    MODE_MAP[r.run_mode] || r.run_mode || '--',
                    safeNum(r.temperature, 2),
                    safeNum(r.humidity, 2),
                    safeNum(r.set_temperature, 1),
                    safeNum(r.set_humidity, 1),
                    calcHours(r.run_hours, r.run_minutes, r.run_seconds),
                    r.set_program_number || '--',
                    r.total_steps || '--'
                ].join(',') + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'OEEæ•°æ®_' + new Date().getTime() + '.csv';
            link.click();
            alert('å¯¼å‡ºæˆåŠŸï¼');
        }

        // å·¥å…·å‡½æ•°
        function safeNum(val, digits) {
            if (val == null || val === '') return '0';
            const n = Number(val);
            return isNaN(n) ? '0' : n.toFixed(digits);
        }

        function calcHours(h, m, s) {
            const hours = parseFloat(h) || 0;
            const mins = parseFloat(m) || 0;
            const secs = parseFloat(s) || 0;
            return (hours + mins/60 + secs/3600).toFixed(2);
        }

        function formatTime(time) {
            if (!time) return '--';
            if (typeof time === 'string') {
                return time.replace('T', ' ').split('.')[0];
            }
            return String(time);
        }

        // åˆ‡æ¢è¯´æ˜æµ®åŠ¨é¢æ¿
        function toggleHelp() {
            const popup = document.getElementById('helpPopup');
            const backdrop = document.getElementById('helpBackdrop');
            
            if (popup.classList.contains('active')) {
                popup.classList.remove('active');
                backdrop.classList.remove('active');
            } else {
                popup.classList.add('active');
                backdrop.classList.add('active');
            }
        }
        
        // å…³é—­è¯´æ˜é¢æ¿
        function closeHelp() {
            const popup = document.getElementById('helpPopup');
            const backdrop = document.getElementById('helpBackdrop');
            popup.classList.remove('active');
            backdrop.classList.remove('active');
        }
        
        // ESCé”®å…³é—­é¢æ¿
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHelp();
            }
        });
    </script>
</body>
</html>
