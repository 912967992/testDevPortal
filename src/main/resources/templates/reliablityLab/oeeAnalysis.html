<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OEEåˆ†æ - è®¾å¤‡ç»¼åˆæ•ˆç‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 
                         'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: #f3f4f6;
            min-height: 100vh;
        }
        
        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .top-nav {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            padding: 16px 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .nav-left a {
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            display: inline-block;
        }
        
        .nav-left a:hover {
            background: rgba(255,255,255,0.25);
        }
        
        .nav-center h1 {
            color: white;
            font-size: 24px;
            font-weight: 700;
            margin: 0;
        }
        
        .nav-right {
            color: white;
            font-size: 14px;
            background: rgba(255,255,255,0.15);
            padding: 8px 16px;
            border-radius: 8px;
        }
        
        /* ä¸»å®¹å™¨ */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        /* ç­›é€‰åŒºåŸŸ */
        .filter-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            position: relative;
        }
        
        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .filter-group {
            flex: 1;
            min-width: 150px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 13px;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #6366f1;
        }
        
        .btn-refresh,
        .btn-help {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }
        
        .btn-refresh {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-help {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            position: relative;
        }
        
        .btn-refresh:hover,
        .btn-help:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        /* OEEè¯´æ˜æµ®åŠ¨é¢æ¿ */
        .help-popup {
            display: none;
            position: absolute;
            top: 80px;
            right: 24px;
            width: 420px;
            max-width: calc(100vw - 48px);
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
            border: 2px solid #f59e0b;
            z-index: 1001;
            animation: popupFadeIn 0.3s ease-out;
        }
        
        .help-popup.active {
            display: block;
        }
        
        @keyframes popupFadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* é®ç½©å±‚ */
        .help-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            z-index: 999;
            animation: backdropFadeIn 0.3s ease-out;
        }
        
        .help-backdrop.active {
            display: block;
        }
        
        @keyframes backdropFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .help-close {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 28px;
            height: 28px;
            background: rgba(255,255,255,0.3);
            border: none;
            border-radius: 6px;
            color: #92400e;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .help-close:hover {
            background: rgba(255,255,255,0.5);
            transform: scale(1.1);
        }
        
        .info-section-mini {
            margin-bottom: 16px;
        }
        
        .info-section-mini:last-child {
            margin-bottom: 0;
        }
        
        .info-title {
            font-size: 14px;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 8px;
        }
        
        .info-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }
        
        .info-tags span {
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .tag-world { background: #10b981; color: white; }
        .tag-excellent { background: #3b82f6; color: white; }
        .tag-good { background: #f59e0b; color: white; }
        .tag-improve { background: #ef4444; color: white; }
        
        .info-line {
            font-size: 12px;
            color: #92400e;
            margin-bottom: 4px;
            line-height: 1.5;
        }
        
        .info-line:last-child {
            margin-bottom: 0;
        }
        
        /* OEEæŒ‡æ ‡å¡ç‰‡åŒºåŸŸ */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .metric-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        .metric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 16px;
        }
        
        .metric-icon {
            font-size: 24px;
        }
        
        .metric-title {
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
        }
        
        .metric-value {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .metric-card.primary .metric-value {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .metric-card.blue .metric-value { color: #3b82f6; }
        .metric-card.green .metric-value { color: #10b981; }
        .metric-card.orange .metric-value { color: #f59e0b; }
        
        .metric-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .badge-world { background: #10b981; color: white; }
        .badge-excellent { background: #3b82f6; color: white; }
        .badge-good { background: #f59e0b; color: white; }
        .badge-improve { background: #ef4444; color: white; }
        
        .metric-desc {
            font-size: 12px;
            color: #9ca3af;
            margin-bottom: 12px;
        }
        
        .metric-details {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
        }
        
        .detail-row {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 4px;
        }
        
        .detail-row:last-child {
            margin-bottom: 0;
        }
        
        .detail-row span {
            font-weight: 700;
            color: #111827;
        }
        
        /* å†å²æ•°æ®è¡¨æ ¼åŒºåŸŸ */
        .info-section {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
        }
        
        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f3f4f6;
        }
        
        /* è¡¨æ ¼åŒºåŸŸ */
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .btn-export {
            padding: 10px 20px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99,102,241,0.3);
        }
        
        .record-count {
            font-size: 14px;
            color: #6b7280;
        }
        
        .record-count strong {
            color: #6366f1;
            font-weight: 700;
        }
        
        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            border: 1px solid #e5e7eb;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }
        
        thead {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
        }
        
        th {
            padding: 14px 12px;
            text-align: left;
            color: white;
            font-weight: 700;
            font-size: 13px;
            white-space: nowrap;
        }
        
        tbody tr {
            border-bottom: 1px solid #e5e7eb;
        }
        
        tbody tr:nth-child(even) {
            background: #f9fafb;
        }
        
        tbody tr:hover {
            background: #f0f4ff;
        }
        
        td {
            padding: 12px;
            color: #374151;
            font-size: 13px;
        }
        
        td.no-data {
            text-align: center;
            padding: 40px;
            color: #9ca3af;
        }
        
        /* åˆ†é¡µ */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            margin-top: 16px;
        }
        
        .page-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            color: #374151;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .page-btn:hover:not(:disabled) {
            border-color: #6366f1;
            color: #6366f1;
        }
        
        .page-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .page-info {
            font-size: 14px;
            color: #6b7280;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 16px;
            }
            
            .top-nav {
                flex-direction: column;
                gap: 12px;
                padding: 16px;
            }
            
            .nav-center h1 {
                font-size: 20px;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-section {
                padding: 20px;
            }
            
            .filter-row {
                flex-direction: column;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .btn-refresh,
            .btn-help {
                width: 100%;
            }
            
            .help-popup {
                position: fixed;
                top: 50%;
                left: 50%;
                right: auto;
                width: calc(100% - 32px);
                max-width: 400px;
            }
            
            .help-popup.active {
                display: block;
                transform: translate(-50%, -50%);
            }
            
            @keyframes popupFadeIn {
                from {
                    opacity: 0;
                    transform: translate(-50%, calc(-50% - 10px));
                }
                to {
                    opacity: 1;
                    transform: translate(-50%, -50%);
                }
            }
            
            .table-header {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .btn-export {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .nav-center h1 {
                font-size: 18px;
            }
            
            .metric-value {
                font-size: 36px;
            }
            
            .info-title {
                font-size: 13px;
            }
            
            .info-line {
                font-size: 11px;
            }
            
            .help-popup {
                padding: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- é®ç½©å±‚ -->
    <div class="help-backdrop" id="helpBackdrop" onclick="closeHelp()"></div>

    <!-- é¡¶éƒ¨å¯¼èˆª -->
    <div class="top-nav">
        <div class="nav-left">
            <a href="/reliabilityIndex">â† è¿”å›ç›‘æ§é¦–é¡µ</a>
        </div>
        <div class="nav-center">
            <h1>ğŸ“Š è®¾å¤‡ç»¼åˆæ•ˆç‡åˆ†æ (OEE)</h1>
        </div>
        <div class="nav-right">
            <span id="currentTime">2025-11-14 10:00:00</span>
        </div>
    </div>

    <div class="container">
        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label>è®¾å¤‡é€‰æ‹©</label>
                    <select id="deviceSelect" onchange="loadData()">
                        <option value="">å…¨éƒ¨è®¾å¤‡</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æ—¶é—´èŒƒå›´</label>
                    <select id="timeRange" onchange="handleTimeRangeChange()">
                        <option value="today">ä»Šå¤©</option>
                        <option value="week">æœ¬å‘¨</option>
                        <option value="month" selected>æœ¬æœˆ</option>
                        <option value="quarter">æœ¬å­£åº¦</option>
                        <option value="year">æœ¬å¹´</option>
                        <option value="custom">è‡ªå®šä¹‰</option>
                    </select>
                </div>
                <div class="filter-group" id="customDates" style="display: none;">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="startDate">
                </div>
                <div class="filter-group" id="customDates2" style="display: none;">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="endDate">
                </div>
                <button class="btn-refresh" onclick="loadData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <button class="btn-help" onclick="toggleHelp()">ğŸ“– OEEè¯´æ˜</button>
            </div>

            <!-- OEEè¯´æ˜æµ®åŠ¨é¢æ¿ -->
            <div class="help-popup" id="helpPopup">
                <button class="help-close" onclick="closeHelp()">Ã—</button>
                
                <div class="info-section-mini">
                    <div class="info-title">ğŸ† ä¸–ç•Œçº§OEEæ ‡å‡†</div>
                    <div class="info-tags">
                        <span class="tag-world">ä¸–ç•Œçº§ â‰¥85%</span>
                        <span class="tag-excellent">ä¼˜ç§€ 75%-85%</span>
                        <span class="tag-good">è‰¯å¥½ 65%-75%</span>
                        <span class="tag-improve">æ”¹å–„ &lt;65%</span>
                    </div>
                </div>
                
                <div class="info-section-mini">
                    <div class="info-title">ğŸ“Š å…­å¤§æŸå¤±è¯´æ˜</div>
                    <div class="info-line"><strong>è®¾å¤‡æ•…éšœã€è®¾ç½®è°ƒæ•´</strong> â†’ å½±å“å¯ç”¨ç‡</div>
                    <div class="info-line"><strong>ç©ºè½¬å°åœæœºã€é€Ÿåº¦é™ä½</strong> â†’ å½±å“æ€§èƒ½ç‡</div>
                    <div class="info-line"><strong>ä¸è‰¯è¿”å·¥ã€å¯åŠ¨æŸå¤±</strong> â†’ å½±å“åˆæ ¼ç‡</div>
                </div>
                
                <div class="info-section-mini">
                    <div class="info-title">ğŸ“ è®¡ç®—å…¬å¼</div>
                    <div class="info-line"><strong>ç»¼åˆOEE</strong> = è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ / è®¾å¤‡æ€»æ—¶é—´ Ã— 100%</div>
                    <div class="info-line"><strong>è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´</strong>ï¼šç»Ÿè®¡æ‰€æœ‰è¿è¡Œå‘¨æœŸçš„æ—¶é—´æ€»å’Œï¼ˆä» run_status=1 å¼€å§‹åˆ° run_status=0 ç»“æŸï¼‰</div>
                    <div class="info-line"><strong>è®¾å¤‡æ€»æ—¶é—´</strong>ï¼šæ ¹æ®é€‰æ‹©çš„æ—¶é—´èŒƒå›´è®¡ç®—ï¼ˆä»Šå¤©24å°æ—¶ã€æœ¬å‘¨168å°æ—¶ã€æœ¬æœˆ720å°æ—¶ç­‰ï¼‰</div>
                    <div class="info-line"><strong>è¯´æ˜</strong>ï¼šæ ¹æ® run_status å­—æ®µåˆ¤æ–­ï¼Œ0=å·²åœæ­¢ï¼Œ1=è¿è¡Œä¸­ï¼Œ2=æš‚åœã€‚ä»è¿è¡Œä¸­(1)åˆ°å·²åœæ­¢(0)çš„æ—¶é—´æ®µç´¯åŠ ä¸ºä½¿ç”¨æ—¶é—´</div>
                </div>
            </div>
        </div>

        <!-- OEEæŒ‡æ ‡å¡ç‰‡ -->
        <div class="metrics-grid">
            <div class="metric-card primary">
                <div class="metric-header">
                    <span class="metric-icon">ğŸ¯</span>
                    <span class="metric-title">ç»¼åˆOEE</span>
                </div>
                <div class="metric-value" id="oeeValue">--</div>
                <div class="metric-badge" id="oeeBadge">è®¡ç®—ä¸­...</div>
                <div class="metric-desc">è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ / è®¾å¤‡æ€»æ—¶é—´</div>
                <div class="metric-details">
                    <div class="detail-row">è®¾å¤‡æ€»æ—¶é—´ <span id="totalTime">--</span></div>
                    <div class="detail-row">è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ <span id="totalUsedTime">--</span></div>
                    <div id="deviceTimeBreakdown" style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #e5e7eb; display: none;">
                        <div style="font-size: 11px; color: #9ca3af; margin-bottom: 4px;">å„è®¾å¤‡ä½¿ç”¨æ—¶é—´ï¼š</div>
                        <div id="deviceTimeList"></div>
                    </div>
                </div>
            </div>

            <div class="metric-card blue">
                <div class="metric-header">
                    <span class="metric-icon">â°</span>
                    <span class="metric-title">å¯ç”¨ç‡</span>
                </div>
                <div class="metric-value" id="availValue">--</div>
                <div class="metric-desc">å®é™…è¿è¡Œ / è®¡åˆ’è¿è¡Œ</div>
                <div class="metric-details">
                    <div class="detail-row">è®¡åˆ’è¿è¡Œ <span id="plannedHours">--</span></div>
                    <div class="detail-row">å®é™…è¿è¡Œ <span id="actualHours">--</span></div>
                </div>
            </div>

            <div class="metric-card green">
                <div class="metric-header">
                    <span class="metric-icon">âš¡</span>
                    <span class="metric-title">æ€§èƒ½ç‡</span>
                </div>
                <div class="metric-value" id="perfValue">--</div>
                <div class="metric-desc">å®é™…å¯åœæ¬¡æ•° / ç†è®ºäº§å‡º</div>
                <div class="metric-details">
                    <div class="detail-row">ç†è®ºäº§å‡º <span id="theoryOutput">--</span></div>
                    <div class="detail-row">å®é™…å¯åœ <span id="realOutput">--</span></div>
                </div>
            </div>

            <div class="metric-card orange">
                <div class="metric-header">
                    <span class="metric-icon">âœ…</span>
                    <span class="metric-title">åˆæ ¼ç‡</span>
                </div>
                <div class="metric-value" id="qualValue">--</div>
                <div class="metric-desc">åˆæ ¼æ ·å“ / æ€»æ ·å“</div>
                <div class="metric-details">
                    <div class="detail-row">æ€»æ ·å“ <span id="totalTest">--</span></div>
                    <div class="detail-row" style="color: #10b981;">âœ… åˆæ ¼ <span id="passTest">--</span></div>
                    <div class="detail-row" style="color: #f59e0b;">âš ï¸ éƒ¨åˆ†åˆæ ¼ <span id="partialTest">--</span></div>
                    <div class="detail-row" style="color: #ef4444;">âŒ ä¸åˆæ ¼ <span id="failTest">--</span></div>
                </div>
            </div>
        </div>


        <!-- å†å²æ•°æ®è¡¨æ ¼ -->
        <div class="info-section">
            <h3 class="section-title">ğŸ“‹ å†å²æ•°æ®è®°å½•</h3>
            <div class="table-header">
                <button class="btn-export" onclick="exportData()">ğŸ“¥ å¯¼å‡ºExcel</button>
                <div class="record-count">å…± <strong id="totalCount">0</strong> æ¡è®°å½•</div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>è®¾å¤‡ID</th>
                            <th>è®°å½•æ—¶é—´</th>
                            <th>è¿è¡ŒçŠ¶æ€</th>
                            <th>è¿è¡Œæ¨¡å¼</th>
                            <th>å½“å‰æ¸©åº¦(â„ƒ)</th>
                            <th>å½“å‰æ¹¿åº¦(%)</th>
                            <th>è®¾å®šæ¸©åº¦(â„ƒ)</th>
                            <th>è®¾å®šæ¹¿åº¦(%)</th>
                            <th>æ¸©åº¦åŠŸç‡(%)</th>
                            <th>æ¹¿åº¦åŠŸç‡(%)</th>
                            <th>è¿è¡Œæ—¶é•¿(H)</th>
                            <th>ç¨‹å¼å·</th>
                            <th>æ€»æ®µæ•°</th>
                        </tr>
                    </thead>
                    <tbody id="dataTable">
                        <tr>
                            <td colspan="13" class="no-data">æ­£åœ¨åŠ è½½æ•°æ®...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button class="page-btn" onclick="prevPage()">ä¸Šä¸€é¡µ</button>
                <span class="page-info">ç¬¬ <span id="pageNum">1</span> / <span id="pageTotal">1</span> é¡µ</span>
                <button class="page-btn" onclick="nextPage()">ä¸‹ä¸€é¡µ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let currentPage = 1;
        let pageSize = 20;
        let totalRecords = 0;
        let historyData = [];

        // çŠ¶æ€æ˜ å°„
        const STATUS_MAP = {
            '0': 'å·²åœæ­¢', '1': 'è¿è¡Œä¸­', '2': 'å·²æš‚åœ',
            'stopped': 'å·²åœæ­¢', 'running': 'è¿è¡Œä¸­', 'paused': 'å·²æš‚åœ'
        };

        // æ¨¡å¼æ˜ å°„
        const MODE_MAP = {
            '0': 'ç¨‹å¼æ¨¡å¼', '1': 'å®šå€¼æ¨¡å¼'
        };

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateTime();
            setInterval(updateTime, 1000);
            loadDevices();
            loadData();
        });

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            const str = now.getFullYear() + '-' + 
                       pad(now.getMonth() + 1) + '-' + 
                       pad(now.getDate()) + ' ' +
                       pad(now.getHours()) + ':' + 
                       pad(now.getMinutes()) + ':' + 
                       pad(now.getSeconds());
            document.getElementById('currentTime').textContent = str;
        }

        function pad(n) {
            return String(n).padStart(2, '0');
        }

        // åŠ è½½è®¾å¤‡åˆ—è¡¨
        async function loadDevices() {
            try {
                const res = await fetch('/iot/data/devices');
                const devices = await res.json();
                const select = document.getElementById('deviceSelect');
                select.innerHTML = '<option value="">å…¨éƒ¨è®¾å¤‡</option>';
                devices.forEach(d => {
                    const opt = document.createElement('option');
                    opt.value = d.device_id;
                    opt.textContent = d.device_id;
                    select.appendChild(opt);
                });
            } catch (err) {
                console.error('åŠ è½½è®¾å¤‡å¤±è´¥:', err);
            }
        }

        // å¤„ç†æ—¶é—´èŒƒå›´å˜åŒ–
        function handleTimeRangeChange() {
            const range = document.getElementById('timeRange').value;
            const custom1 = document.getElementById('customDates');
            const custom2 = document.getElementById('customDates2');
            
            if (range === 'custom') {
                custom1.style.display = 'block';
                custom2.style.display = 'block';
            } else {
                custom1.style.display = 'none';
                custom2.style.display = 'none';
                loadData();
            }
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            try {
                const deviceId = document.getElementById('deviceSelect').value;
                const timeRange = document.getElementById('timeRange').value;
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;

                const params = new URLSearchParams();
                if (deviceId) params.append('device_id', deviceId);
                params.append('time_range', timeRange);
                if (timeRange === 'custom' && startDate && endDate) {
                    params.append('start_date', startDate);
                    params.append('end_date', endDate);
                }
                params.append('page', currentPage);
                params.append('page_size', pageSize);

                // è·å–å†å²æ•°æ®
                const res = await fetch('/iot/data/history?' + params.toString());
                const data = await res.json();

                historyData = data.records || [];
                totalRecords = data.total || 0;

                // è·å–æ ·å“ä¿¡æ¯ç”¨äºåˆæ ¼ç‡è®¡ç®—
                // ä»å†å²è®°å½•ä¸­æ”¶é›†æ‰€æœ‰æ ·å“IDï¼Œç„¶åæ‰¹é‡æŸ¥è¯¢è¯¦ç»†ä¿¡æ¯
                let sampleInfoMap = new Map(); // æ ·å“ID -> æ ·å“ä¿¡æ¯
                try {
                    // æ”¶é›†æ‰€æœ‰æ¶‰åŠçš„æ ·å“IDï¼ˆä»å†å²è®°å½•çš„sample_idå­—æ®µï¼‰
                    const allSampleIds = new Set();
                    historyData.forEach(record => {
                        if (record.sample_id) {
                            const ids = String(record.sample_id).split(',').map(id => id.trim()).filter(id => id);
                            ids.forEach(id => allSampleIds.add(id));
                        }
                    });
                    
                    // æ‰¹é‡æŸ¥è¯¢æ ·å“ä¿¡æ¯
                    if (allSampleIds.size > 0) {
                        const sampleIdArray = Array.from(allSampleIds).map(id => parseInt(id)).filter(id => !isNaN(id));
                        
                        if (sampleIdArray.length > 0) {
                            const batchRes = await fetch('/iot/samples/batch', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    sample_ids: sampleIdArray
                                })
                            });
                            
                            if (batchRes.ok) {
                                const batchData = await batchRes.json();
                                if (batchData.samples && Array.isArray(batchData.samples)) {
                                    batchData.samples.forEach(sample => {
                                        if (sample.id) {
                                            sampleInfoMap.set(String(sample.id), sample);
                                        }
                                    });
                                }
                                console.log('[OEEè®¡ç®—] æ‰¹é‡æŸ¥è¯¢åˆ°æ ·å“ä¿¡æ¯ï¼š', sampleInfoMap.size, 'ä¸ª');
                            } else {
                                console.warn('[OEEè®¡ç®—] æ‰¹é‡æŸ¥è¯¢æ ·å“ä¿¡æ¯å¤±è´¥');
                            }
                        }
                    }
                } catch (err) {
                    console.warn('è·å–æ ·å“ä¿¡æ¯å¼‚å¸¸:', err);
                }

                // è°ƒç”¨OEEè®¡ç®—å‡½æ•°ï¼ˆtimeRangeã€startDateã€endDateå·²åœ¨ä¸Šé¢å£°æ˜ï¼‰
                calcOEE(historyData, sampleInfoMap, timeRange, startDate, endDate);
                renderTable(historyData);
                updatePagination();

            } catch (err) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', err);
                alert('åŠ è½½æ•°æ®å¤±è´¥: ' + err.message);
            }
        }

        // è®¡ç®—OEE
        function calcOEE(records, sampleInfoMap, timeRange, startDate, endDate) {
            // è®¡ç®—è®¾å¤‡æ€»æ—¶é—´ï¼ˆå°æ—¶ï¼‰- æ ¹æ®é€‰æ‹©çš„æ—¶é—´èŒƒå›´
            let totalTime = 0; // è®¾å¤‡æ€»æ—¶é—´ï¼ˆå°æ—¶ï¼‰
            let timeRangeStart = null; // æ—¶é—´èŒƒå›´å¼€å§‹æ—¶é—´
            let timeRangeEnd = null; // æ—¶é—´èŒƒå›´ç»“æŸæ—¶é—´
            
            const now = new Date();
            
            // å…ˆè®¡ç®—è®¾å¤‡æ€»æ—¶é—´ï¼ˆæ— è®ºæ˜¯å¦æœ‰è®°å½•éƒ½éœ€è¦è®¡ç®—ï¼‰
            if (timeRange === 'custom' && startDate && endDate) {
                // è‡ªå®šä¹‰æ—¶é—´èŒƒå›´
                timeRangeStart = new Date(startDate + ' 00:00:00');
                timeRangeEnd = new Date(endDate + ' 23:59:59');
                totalTime = (timeRangeEnd.getTime() - timeRangeStart.getTime()) / (1000 * 60 * 60);
            } else {
                // é¢„è®¾æ—¶é—´èŒƒå›´
                const rangeMap = {
                    'today': 24,
                    'week': 168,
                    'month': 720,
                    'quarter': 2160,
                    'year': 8760
                };
                totalTime = rangeMap[timeRange] || 720;
                
                // è®¡ç®—æ—¶é—´èŒƒå›´çš„å¼€å§‹å’Œç»“æŸæ—¶é—´
                switch(timeRange) {
                    case 'today':
                        timeRangeStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
                        timeRangeEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                        break;
                    case 'week':
                        const dayOfWeek = now.getDay();
                        const diff = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // å‘¨ä¸€ä¸º0
                        timeRangeStart = new Date(now);
                        timeRangeStart.setDate(now.getDate() - diff);
                        timeRangeStart.setHours(0, 0, 0, 0);
                        timeRangeEnd = new Date(timeRangeStart);
                        timeRangeEnd.setDate(timeRangeStart.getDate() + 6);
                        timeRangeEnd.setHours(23, 59, 59, 999);
                        break;
                    case 'month':
                        timeRangeStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                        timeRangeEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                        break;
                    case 'quarter':
                        const quarter = Math.floor(now.getMonth() / 3);
                        timeRangeStart = new Date(now.getFullYear(), quarter * 3, 1, 0, 0, 0);
                        timeRangeEnd = new Date(now.getFullYear(), (quarter + 1) * 3, 0, 23, 59, 59);
                        break;
                    case 'year':
                        timeRangeStart = new Date(now.getFullYear(), 0, 1, 0, 0, 0);
                        timeRangeEnd = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                        break;
                    default:
                        timeRangeStart = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
                        timeRangeEnd = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                }
            }
            
            if (!records || records.length === 0) {
                updateMetrics(0, 0, null, 0, 0, 0, 0, 0, 0, 0, 0, 0, totalTime, 0, new Map());
                return;
            }

            // æŒ‰è®¾å¤‡åˆ†ç»„è®¡ç®—ä½¿ç”¨æ—¶é—´
            const deviceStats = new Map(); // device_id -> { usedTime }
            let totalUsedTime = 0; // æ‰€æœ‰è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ï¼ˆå°æ—¶ï¼‰
            
            if (records && records.length > 0) {
                // æŒ‰è®¾å¤‡IDåˆ†ç»„
                const deviceRecords = new Map();
                records.forEach(record => {
                    const deviceId = record.device_id || 'æœªçŸ¥è®¾å¤‡';
                    if (!deviceRecords.has(deviceId)) {
                        deviceRecords.set(deviceId, []);
                    }
                    deviceRecords.get(deviceId).push(record);
                });
                
                // å¯¹æ¯ä¸ªè®¾å¤‡è®¡ç®—ä½¿ç”¨æ—¶é—´
                deviceRecords.forEach((deviceRecs, deviceId) => {
                    // æŒ‰æ—¶é—´æ’åºè¯¥è®¾å¤‡çš„è®°å½•
                    const sortedRecords = [...deviceRecs].sort((a, b) => {
                        const timeA = new Date(a.created_at);
                        const timeB = new Date(b.created_at);
                        return timeA - timeB;
                    });
                    
                    let deviceUsedTime = 0; // è¯¥è®¾å¤‡çš„ä½¿ç”¨æ—¶é—´
                    let runStartTime = null; // è¿è¡Œå¼€å§‹æ—¶é—´
                    let lastStatus = null;
                    
                    for (let i = 0; i < sortedRecords.length; i++) {
                        const record = sortedRecords[i];
                        const recordTime = new Date(record.created_at);
                        const currentStatus = String(record.run_status).trim();
                        
                        // æ£€æµ‹çŠ¶æ€å˜åŒ–
                        if (currentStatus === '1') {
                            // è¿è¡Œä¸­(1)
                            if (lastStatus !== '1') {
                                // ä»åœæ­¢(0)æˆ–æš‚åœ(2)å˜ä¸ºè¿è¡Œ(1)ï¼Œè®°å½•å¼€å§‹æ—¶é—´
                                if (timeRangeStart && recordTime < timeRangeStart) {
                                    runStartTime = timeRangeStart;
                                } else {
                                    runStartTime = recordTime;
                                }
                                console.log('[OEEè®¡ç®—] è®¾å¤‡ ' + deviceId + ' æ£€æµ‹åˆ°è¿è¡Œå¼€å§‹ï¼Œæ—¶é—´ï¼š', runStartTime);
                            }
                        } else if (currentStatus === '0') {
                            // å·²åœæ­¢(0)
                            if (lastStatus === '1' && runStartTime !== null) {
                                // ä»è¿è¡Œ(1)å˜ä¸ºåœæ­¢(0)ï¼Œè®¡ç®—è¿™æ®µæ—¶é—´å¹¶ç´¯åŠ 
                                let endTime = recordTime;
                                if (timeRangeEnd && recordTime > timeRangeEnd) {
                                    endTime = timeRangeEnd;
                                }
                                
                                if (endTime > runStartTime) {
                                    const runDuration = (endTime.getTime() - runStartTime.getTime()) / (1000 * 60 * 60);
                                    deviceUsedTime += Math.max(0, runDuration);
                                    console.log('[OEEè®¡ç®—] è®¾å¤‡ ' + deviceId + ' æ£€æµ‹åˆ°è¿è¡Œç»“æŸï¼ŒæŒç»­æ—¶é—´ï¼š', runDuration.toFixed(2), 'å°æ—¶');
                                }
                                runStartTime = null;
                            }
                        }
                        // æš‚åœ(2)çŠ¶æ€ä¸å¤„ç†ï¼Œä¿æŒå½“å‰çŠ¶æ€
                        
                        lastStatus = currentStatus;
                    }
                    
                    // å¦‚æœæœ€åä¸€æ¡è®°å½•è¿˜æ˜¯è¿è¡ŒçŠ¶æ€(1)ï¼Œéœ€è¦è®¡ç®—åˆ°æ—¶é—´èŒƒå›´ç»“æŸçš„æ—¶é—´
                    if (lastStatus === '1' && runStartTime !== null) {
                        let endTime = now;
                        if (timeRangeEnd) {
                            endTime = timeRangeEnd < now ? timeRangeEnd : now;
                        }
                        
                        if (endTime > runStartTime) {
                            const runDuration = (endTime.getTime() - runStartTime.getTime()) / (1000 * 60 * 60);
                            deviceUsedTime += Math.max(0, runDuration);
                            console.log('[OEEè®¡ç®—] è®¾å¤‡ ' + deviceId + ' æœ€åä¸€æ¡è®°å½•ä»ä¸ºè¿è¡ŒçŠ¶æ€ï¼ŒæŒç»­æ—¶é—´ï¼š', runDuration.toFixed(2), 'å°æ—¶');
                        }
                    }
                    
                    // ä¿å­˜è¯¥è®¾å¤‡çš„ç»Ÿè®¡ä¿¡æ¯
                    deviceStats.set(deviceId, {
                        usedTime: deviceUsedTime
                    });
                    
                    totalUsedTime += deviceUsedTime;
                    console.log('[OEEè®¡ç®—] è®¾å¤‡ ' + deviceId + ' ä½¿ç”¨æ—¶é—´ï¼š', deviceUsedTime.toFixed(2), 'å°æ—¶');
                });
                
                console.log('[OEEè®¡ç®—] æ‰€æœ‰è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ï¼š', totalUsedTime.toFixed(2), 'å°æ—¶');
            }

            // ç»¼åˆOEE = è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ / è®¾å¤‡æ€»æ—¶é—´ Ã— 100%
            const oee = totalTime > 0 ? (totalUsedTime / totalTime) * 100 : 0;
            // é™åˆ¶OEEä¸è¶…è¿‡100%
            const finalOEE = Math.min(oee, 100);

            // ä¿ç•™å…¶ä»–æŒ‡æ ‡çš„è®¡ç®—ï¼ˆå¯ç”¨ç‡ã€åˆæ ¼ç‡ï¼‰ç”¨äºæ˜¾ç¤ºï¼Œä½†ç»¼åˆOEEä½¿ç”¨æ–°å…¬å¼
            // ä¸ºäº†å…¼å®¹ç°æœ‰æ˜¾ç¤ºï¼Œæˆ‘ä»¬ä»ç„¶è®¡ç®—è¿™äº›æŒ‡æ ‡
            const planned = totalTime; // è®¡åˆ’æ—¶é—´ = è®¾å¤‡æ€»æ—¶é—´
            const actualRunTime = totalUsedTime; // å®é™…è¿è¡Œæ—¶é—´ = è®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´
            const availRate = finalOEE; // å¯ç”¨ç‡ = OEEï¼ˆå› ä¸ºæ–°å…¬å¼å°±æ˜¯å¯ç”¨ç‡çš„æ¦‚å¿µï¼‰
            
            // æ€§èƒ½ç‡æš‚ä¸è®¡ç®—
            let theoryOutput = 0;
            let actualOutput = 0;
            let perf = null; // nullè¡¨ç¤ºä¸è®¡ç®—

            // åˆæ ¼ç‡è®¡ç®—ï¼šæ ¹æ®æ ·å“çš„statuså’Œtest_resultåˆ¤æ–­
            let totalSamples = 0;
            let passSamples = 0;
            let partialSamples = 0;
            let failSamples = 0;
            
            if (records && records.length > 0) {
                const sampleIdSet = new Set();
                records.forEach(record => {
                    if (record.sample_id) {
                        const ids = String(record.sample_id).split(',').map(id => id.trim()).filter(id => id);
                        ids.forEach(id => sampleIdSet.add(id));
                    }
                });
                
                totalSamples = sampleIdSet.size;
                
                sampleIdSet.forEach(sampleId => {
                    const sampleInfo = sampleInfoMap.get(sampleId);
                    if (sampleInfo && sampleInfo.status === 'COMPLETED') {
                        const testResult = sampleInfo.test_result || '';
                        if (testResult === 'PASS') {
                            passSamples++;
                        } else if (testResult === 'PARTIAL_OK') {
                            partialSamples++;
                        } else if (testResult === 'FAIL') {
                            failSamples++;
                        } else {
                            failSamples++;
                        }
                    }
                });
            }
            
            const qual = totalSamples > 0 ? (passSamples / totalSamples) * 100 : 100;

            updateMetrics(finalOEE, availRate, perf, qual, planned, actualRunTime, theoryOutput, actualOutput, passSamples, partialSamples, failSamples, totalSamples, totalTime, totalUsedTime, deviceStats);
        }

        // æ›´æ–°æŒ‡æ ‡æ˜¾ç¤º
        function updateMetrics(oee, avail, perf, qual, planned, actual, theory, output, passSamples, partialSamples, failSamples, totalSamples, totalTime, totalUsedTime, deviceStats) {
            document.getElementById('oeeValue').textContent = oee.toFixed(1) + '%';
            document.getElementById('availValue').textContent = avail.toFixed(1) + '%';
            document.getElementById('perfValue').textContent = perf === null ? '--' : perf.toFixed(1) + '%';
            document.getElementById('qualValue').textContent = qual.toFixed(1) + '%';

            // ç­‰çº§è¯„å®š
            const badge = document.getElementById('oeeBadge');
            if (oee >= 85) {
                badge.textContent = 'ğŸ† ä¸–ç•Œçº§æ°´å¹³';
                badge.className = 'metric-badge badge-world';
            } else if (oee >= 75) {
                badge.textContent = 'â­ ä¼˜ç§€æ°´å¹³';
                badge.className = 'metric-badge badge-excellent';
            } else if (oee >= 65) {
                badge.textContent = 'ğŸ‘ è‰¯å¥½æ°´å¹³';
                badge.className = 'metric-badge badge-good';
            } else {
                badge.textContent = 'âš ï¸ éœ€è¦æ”¹å–„';
                badge.className = 'metric-badge badge-improve';
            }

            // æ˜¾ç¤ºè®¾å¤‡æ€»æ—¶é—´å’Œè®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´
            document.getElementById('totalTime').textContent = (totalTime || 0).toFixed(1) + ' å°æ—¶';
            const totalUsedTimeElement = document.getElementById('totalUsedTime');
            const deviceBreakdown = document.getElementById('deviceTimeBreakdown');
            const deviceList = document.getElementById('deviceTimeList');
            
            // æ˜¾ç¤ºè®¾å¤‡æ€»ä½¿ç”¨æ—¶é—´ï¼Œå¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œåœ¨æ‹¬å·ä¸­æ˜¾ç¤ºå„è®¾å¤‡æ—¶é—´
            if (deviceStats && deviceStats.size > 0) {
                let timeText = (totalUsedTime || 0).toFixed(1) + ' å°æ—¶';
                
                // å¦‚æœæœ‰å¤šä¸ªè®¾å¤‡ï¼Œæ˜¾ç¤ºå„è®¾å¤‡æ—¶é—´
                if (deviceStats.size > 1) {
                    const deviceTimeList = [];
                    deviceStats.forEach((stats, deviceId) => {
                        deviceTimeList.push(`${deviceId}: ${stats.usedTime.toFixed(1)}h`);
                    });
                    timeText += ' (' + deviceTimeList.join(', ') + ')';
                }
                
                totalUsedTimeElement.textContent = timeText;
                
                // æ˜¾ç¤ºå„è®¾å¤‡è¯¦ç»†åˆ—è¡¨
                if (deviceStats.size > 1) {
                    deviceBreakdown.style.display = 'block';
                    deviceList.innerHTML = '';
                    deviceStats.forEach((stats, deviceId) => {
                        const deviceItem = document.createElement('div');
                        deviceItem.style.cssText = 'font-size: 11px; color: #6b7280; margin-bottom: 2px;';
                        deviceItem.textContent = `${deviceId}: ${stats.usedTime.toFixed(1)} å°æ—¶`;
                        deviceList.appendChild(deviceItem);
                    });
                } else {
                    deviceBreakdown.style.display = 'none';
                }
            } else {
                totalUsedTimeElement.textContent = (totalUsedTime || 0).toFixed(1) + ' å°æ—¶';
                deviceBreakdown.style.display = 'none';
            }

            document.getElementById('plannedHours').textContent = planned.toFixed(0) + ' å°æ—¶';
            document.getElementById('actualHours').textContent = actual.toFixed(1) + ' å°æ—¶';
            // æ€§èƒ½ç‡æš‚ä¸è®¡ç®—ï¼Œæ˜¾ç¤ºä¸º--
            document.getElementById('theoryOutput').textContent = '--';
            document.getElementById('realOutput').textContent = '--';
            document.getElementById('totalTest').textContent = totalSamples.toFixed(0) + ' ä¸ª';
            document.getElementById('passTest').textContent = passSamples.toFixed(0) + ' ä¸ª';
            document.getElementById('partialTest').textContent = partialSamples.toFixed(0) + ' ä¸ª';
            document.getElementById('failTest').textContent = failSamples.toFixed(0) + ' ä¸ª';
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(records) {
            const tbody = document.getElementById('dataTable');
            if (!records || records.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" class="no-data">æš‚æ— æ•°æ®</td></tr>';
                return;
            }

            tbody.innerHTML = '';
            records.forEach(r => {
                const tr = document.createElement('tr');
                
                const cells = [
                    r.device_id || '--',
                    formatTime(r.created_at),
                    STATUS_MAP[r.run_status] || r.run_status || '--',
                    MODE_MAP[r.run_mode] || r.run_mode || '--',
                    safeNum(r.temperature, 2),
                    safeNum(r.humidity, 2),
                    safeNum(r.set_temperature, 1),
                    safeNum(r.set_humidity, 1),
                    formatPower(r.power_temperature),
                    formatPower(r.power_humidity),
                    calcHours(r.run_hours, r.run_minutes, r.run_seconds),
                    r.set_program_number || '--',
                    r.total_steps || '--'
                ];

                cells.forEach(text => {
                    const td = document.createElement('td');
                    td.textContent = text;
                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            document.getElementById('totalCount').textContent = totalRecords;
        }

        // æ›´æ–°åˆ†é¡µ
        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            document.getElementById('pageNum').textContent = currentPage;
            document.getElementById('pageTotal').textContent = totalPages;
        }

        // ç¿»é¡µ
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                loadData();
            }
        }

        function nextPage() {
            const totalPages = Math.ceil(totalRecords / pageSize);
            if (currentPage < totalPages) {
                currentPage++;
                loadData();
            }
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            if (!historyData || historyData.length === 0) {
                alert('æš‚æ— æ•°æ®å¯å¯¼å‡º');
                return;
            }

            let csv = 'è®¾å¤‡ID,è®°å½•æ—¶é—´,è¿è¡ŒçŠ¶æ€,è¿è¡Œæ¨¡å¼,å½“å‰æ¸©åº¦,å½“å‰æ¹¿åº¦,è®¾å®šæ¸©åº¦,è®¾å®šæ¹¿åº¦,æ¸©åº¦åŠŸç‡,æ¹¿åº¦åŠŸç‡,è¿è¡Œæ—¶é•¿,ç¨‹å¼å·,æ€»æ®µæ•°\n';
            
            historyData.forEach(r => {
                csv += [
                    r.device_id || '--',
                    formatTime(r.created_at),
                    STATUS_MAP[r.run_status] || r.run_status || '--',
                    MODE_MAP[r.run_mode] || r.run_mode || '--',
                    safeNum(r.temperature, 2),
                    safeNum(r.humidity, 2),
                    safeNum(r.set_temperature, 1),
                    safeNum(r.set_humidity, 1),
                    formatPower(r.power_temperature),
                    formatPower(r.power_humidity),
                    calcHours(r.run_hours, r.run_minutes, r.run_seconds),
                    r.set_program_number || '--',
                    r.total_steps || '--'
                ].join(',') + '\n';
            });

            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'OEEæ•°æ®_' + new Date().getTime() + '.csv';
            link.click();
            alert('å¯¼å‡ºæˆåŠŸï¼');
        }

        // å·¥å…·å‡½æ•°
        function safeNum(val, digits) {
            if (val == null || val === '') return '0';
            const n = Number(val);
            return isNaN(n) ? '0' : n.toFixed(digits);
        }

        function calcHours(h, m, s) {
            const hours = parseFloat(h) || 0;
            const mins = parseFloat(m) || 0;
            const secs = parseFloat(s) || 0;
            return (hours + mins/60 + secs/3600).toFixed(2);
        }

        function formatTime(time) {
            if (!time) return '--';
            if (typeof time === 'string') {
                return time.replace('T', ' ').split('.')[0];
            }
            return String(time);
        }

        // æ ¼å¼åŒ–åŠŸç‡å€¼ï¼ˆå¯èƒ½æ˜¯"50%"æˆ–"50"æ ¼å¼ï¼‰
        function formatPower(power) {
            if (!power || power === '') return '--';
            const str = String(power).trim();
            // å¦‚æœå·²ç»åŒ…å«ç™¾åˆ†å·ï¼Œç›´æ¥è¿”å›
            if (str.includes('%')) {
                return str;
            }
            // å¦‚æœæ²¡æœ‰ç™¾åˆ†å·ï¼Œå°è¯•è½¬æ¢ä¸ºæ•°å­—å¹¶æ·»åŠ ç™¾åˆ†å·
            const num = parseFloat(str);
            if (!isNaN(num)) {
                return num.toFixed(1) + '%';
            }
            return str;
        }

        // åˆ‡æ¢è¯´æ˜æµ®åŠ¨é¢æ¿
        function toggleHelp() {
            const popup = document.getElementById('helpPopup');
            const backdrop = document.getElementById('helpBackdrop');
            
            if (popup.classList.contains('active')) {
                popup.classList.remove('active');
                backdrop.classList.remove('active');
            } else {
                popup.classList.add('active');
                backdrop.classList.add('active');
            }
        }
        
        // å…³é—­è¯´æ˜é¢æ¿
        function closeHelp() {
            const popup = document.getElementById('helpPopup');
            const backdrop = document.getElementById('helpBackdrop');
            popup.classList.remove('active');
            backdrop.classList.remove('active');
        }
        
        // ESCé”®å…³é—­é¢æ¿
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeHelp();
            }
        });
    </script>
</body>
</html>
