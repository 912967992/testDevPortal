<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂèØÈù†ÊÄßÁâ©ËÅîÁΩëÊ∏©ÁÆ±ÁõëÊéßÁ≥ªÁªü</title>
    <link rel="stylesheet" href="/css/reliablityLab/styles.css">
    <style>
        #deviceMonitorPage {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .monitor-header { 
            position: relative; 
            z-index: 100;
            padding: 12px 20px;
            flex-shrink: 0;
        }
        .monitor-datetime {
            position: fixed;
            right: 200px;
            top: 20px;
            z-index: 1001;
            pointer-events: none;
            color: rgba(255, 255, 255, 0.95);
            font-size: 18px;
            font-weight: 500;
            white-space: nowrap;
        }
        .back-home {
            position: absolute;
            left: 12px;
            top: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
            color: #fff;
            text-decoration: none;
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            font-weight: 700;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            z-index: 1000;
            pointer-events: auto;
        }
        .back-home:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 1) 0%, rgba(29, 78, 216, 1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            border-color: rgba(255,255,255,0.5);
        }
        .back-home:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }
        .user-info {
            position: fixed;
            right: 20px;
            top: 20px;
            padding: 8px 16px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
            font-size: 14px;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 12px;
            z-index: 1001;
            pointer-events: auto;
            white-space: nowrap;
        }
        .user-info-username {
            font-weight: 700;
            font-size: 15px;
        }
        .user-info-job {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }
        .title-with-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        .monitor-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .send-command-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            white-space: nowrap;
        }
        .send-command-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .send-command-btn:active {
            transform: translateY(0) scale(1);
        }
        .refresh-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            white-space: nowrap;
        }
        .refresh-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .refresh-btn:active {
            transform: translateY(0) scale(1);
        }
        .data-management-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            white-space: nowrap;
            text-decoration: none;
            display: inline-block;
        }
        .data-management-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .data-management-btn:active {
            transform: translateY(0) scale(1);
        }
        .oee-analysis-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            white-space: nowrap;
            text-decoration: none;
            display: inline-block;
        }
        .oee-analysis-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .oee-analysis-btn:active {
            transform: translateY(0) scale(1);
        }
        .monitor-layout {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-top: 8px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .device-sidebar {
            width: 200px;
            background: linear-gradient(180deg, rgba(30,41,59,0.85) 0%, rgba(15,23,42,0.85) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px -16px rgba(15,23,42,0.8);
            backdrop-filter: blur(10px);
            color: #e2e8f0;
            position: sticky;
            top: 8px;
            max-height: calc(100vh - 100px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        .device-sidebar.hidden {
            width: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden;
            pointer-events: none;
        }
        .sidebar-toggle-btn {
            position: fixed;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(99, 102, 241, 0.9) 100%);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }
        .monitor-layout.sidebar-hidden .sidebar-toggle-btn {
            left: 12px;
        }
        .monitor-layout.sidebar-hidden .device-content {
            margin-left: 0;
        }
        @media (max-width: 780px) {
            .sidebar-toggle-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                left: 8px;
            }
        }
        .device-sidebar-inner {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px 14px;
            overflow-y: auto;
        }
        .sidebar-add-card {
            width: 100%;
            border-radius: 12px;
            border: 1px dashed rgba(129, 140, 248, 0.65);
            padding: 12px;
            background: rgba(79, 70, 229, 0.1);
            color: #c7d2fe;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .sidebar-add-card:hover {
            background: rgba(79, 70, 229, 0.18);
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -18px rgba(129, 140, 248, 0.9);
        }
        .sidebar-add-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(139, 92, 246, 1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #fff;
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        }
        .sidebar-add-hint {
            font-size: 11px;
            color: rgba(226, 232, 240, 0.85);
        }
        .device-sidebar h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #e2e8f0;
            letter-spacing: 0.4px;
        }
        .sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-item {
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(100, 116, 139, 0.2);
            color: #cbd5f5;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(79, 70, 229, 0.2);
            border-color: rgba(129, 140, 248, 0.35);
        }
        .sidebar-item.active {
            background: rgba(79, 70, 229, 0.28);
            border-color: rgba(129, 140, 248, 0.55);
            box-shadow: inset 0 0 0 1px rgba(129, 140, 248, 0.25);
        }
        .sidebar-item-mode {
            font-size: 12px;
            color: rgba(226, 232, 240, 0.7);
        }
        .sidebar-empty {
            padding: 14px 12px;
            font-size: 13px;
            color: rgba(226, 232, 240, 0.65);
            background: rgba(15, 23, 42, 0.35);
            border-radius: 12px;
            border: 1px dashed rgba(148, 163, 184, 0.2);
        }
        .device-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding-right: 4px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 120px);
        }
        .device-grid {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: visible;
        }
        .device-grid-inner {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            align-content: start;
            padding-bottom: 12px;
        }
        .device-card {
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 16px;
            box-shadow: 0 8px 20px -12px rgba(15, 23, 42, 0.6);
            background: rgba(255, 255, 255, 0.96);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            min-height: 280px;
            max-height: 350px;
        }
        @media (max-width: 960px) {
            .device-grid-inner {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 780px) {
            .monitor-layout {
                flex-direction: column;
            }
            .device-sidebar {
                position: static;
                width: 100%;
            }
            .device-name {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            .device-name-left {
                width: 100%;
            }
            .device-info-inline {
                width: 100%;
                gap: 6px;
                font-size: 12px;
            }
            .device-info-row {
                gap: 10px;
            }
            .device-info-item {
                font-size: 12px;
            }
            .device-info-label {
                font-size: 12px;
            }
            .device-info-value {
                font-size: 12px;
            }
            .edit-device-info-btn {
                font-size: 13px;
                padding: 4px 8px;
            }
            .data-row {
                grid-template-columns: 1fr 1fr;
                gap: 8px;
            }
            .data-item {
                padding: 8px 6px;
            }
            .data-label {
                font-size: 10px;
            }
            .data-value {
                font-size: 18px;
            }
            .data-value.time-value {
                font-size: 10px;
            }
            .time-label {
                font-size: 9px;
            }
            .device-waiting-samples {
                flex-direction: column;
                gap: 8px;
                padding: 8px 10px;
            }
            .waiting-samples-btn {
                width: 100%;
                padding: 8px 12px;
                font-size: 13px;
            }
            .waiting-samples-display {
                width: 100%;
                height: 32px;
                overflow-x: hidden;
                overflow-y: auto;
                flex-wrap: wrap;
                gap: 8px;
            }
            .waiting-sample-tag {
                flex: 1 1 calc((100% - 10px) / 2);
                max-width: calc((100% - 10px) / 2);
                min-width: 120px;
                padding: 6px 10px;
                font-size: 12px;
            }
            .info-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .data-value {
                font-size: 22px;
            }
            .time-value {
                font-size: 10px;
            }
            .info-value {
                font-size: 12px;
            }
            .sample-tag {
                flex: 1 1 calc((100% - 10px) / 2);
                max-width: calc((100% - 10px) / 2);
                min-width: 120px;
                padding: 6px 10px;
                font-size: 12px;
            }
            .device-samples-tags {
                gap: 8px;
            }
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -16px rgba(79, 70, 229, 0.4);
        }
        .device-card.active {
            border-color: rgba(99, 102, 241, 0.45);
            box-shadow: 0 16px 28px -18px rgba(99, 102, 241, 0.5);
        }
        /* ‰ºòÂåñËÆæÂ§áÂç°ÁâáÂÜÖÈÉ®Ê†∑Âºè - Á¥ßÂáëÂ∏ÉÂ±Ä */
        .device-card-header {
            padding: 12px 14px;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
            border-bottom: 2px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-height: 70px;
            max-height: 100px;
            overflow: hidden;
            gap: 12px;
        }
        .device-name {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
            min-width: 0;
            overflow: visible;
            max-width: calc(100% - 90px); /* ‰∏∫Âè≥‰æßÁä∂ÊÄÅÊåâÈíÆÈ¢ÑÁïôÁ©∫Èó¥ */
        }
        .device-name-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            flex-shrink: 0;
        }
        .device-name-left-top {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .device-info-inline {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            max-height: 90px;
        }
        .device-samples-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-start;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: 100%;
            height: 80px;
            padding-right: 4px;
        }
        .device-samples-tags::-webkit-scrollbar {
            width: 6px;
        }
        .device-samples-tags::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        .device-samples-tags::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .device-samples-tags::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .sample-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
            white-space: nowrap;
            flex: 0 0 calc((100% - 20px) / 3);
            width: calc((100% - 20px) / 3);
            max-width: calc((100% - 20px) / 3);
            min-width: 0;
            font-weight: 500;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sample-tag:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }
        .sample-tag:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.15);
        }
        .sample-tag-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }
        .device-info-row {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: nowrap;
            overflow: hidden;
            margin-top: 4px;
        }
        .device-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #1e293b;
            white-space: nowrap;
            font-weight: 500;
            flex-shrink: 0;
            min-width: 0;
        }
        .device-info-label {
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            font-size: 13px;
            flex-shrink: 0;
        }
        .device-info-value {
            color: #ffffff;
            font-weight: 600;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }
        .edit-device-info-btn {
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: 1.5px solid rgba(99, 102, 241, 0.3);
            color: #ffffff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
            flex-shrink: 0;
            margin-left: 0;
            letter-spacing: 0.3px;
        }
        .edit-device-info-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .edit-device-info-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.2);
        }
        .device-icon {
            font-size: 20px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }
        .device-id {
            font-size: 19px;
            font-weight: 700;
            color: #1e293b;
            text-shadow: none;
            letter-spacing: 0.5px;
        }
        .device-status {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px 4px 4px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 0;
            white-space: nowrap;
            max-width: 80px;
        }
        .device-status.running {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.7) 0%, rgba(16, 185, 129, 0.7) 100%);
            border-color: rgba(34, 197, 94, 1);
            color: #ffffff;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.6), inset 0 0 8px rgba(34, 197, 94, 0.3);
        }
        .device-status.stopped {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8) 0%, rgba(220, 38, 38, 0.8) 100%);
            border-color: rgba(239, 68, 68, 1);
            color: #ffffff;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.7), inset 0 0 8px rgba(239, 68, 68, 0.4);
        }
        .device-status.paused {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.7) 0%, rgba(234, 88, 12, 0.7) 100%);
            border-color: rgba(249, 115, 22, 1);
            color: #ffffff;
            box-shadow: 0 0 12px rgba(249, 115, 22, 0.6), inset 0 0 8px rgba(249, 115, 22, 0.3);
        }
        .device-status.warning {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .device-card-body {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            overflow: visible;
        }
        /* Á¨¨‰∏ÄË°åÔºöÊ∏©Â∫¶„ÄÅÊπøÂ∫¶„ÄÅËøêË°åÊó∂Èó¥„ÄÅÂâ©‰ΩôÊó∂Èó¥ÔºàÊï¥ÂêàÂú®‰∏ÄË°åÔºâ */
        .data-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr;
            gap: 8px;
        }
        .data-item {
            text-align: center;
            padding: 10px 6px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 10px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }
        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }
        .data-item.time-item {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: rgba(245, 158, 11, 0.3);
            box-shadow: 0 1px 4px rgba(245, 158, 11, 0.1);
        }
        .data-item.time-item:hover {
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }
        .data-label {
            font-size: 11px;
            color: #475569;
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .data-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e40af;
            line-height: 1.2;
        }
        .data-value.temp-value {
            color: #dc2626;
        }
        .data-value.humidity-value {
            color: #0284c7;
        }
        .data-value.time-value {
            font-size: 11px;
            font-weight: 700;
            color: #78350f;
        }
        .unit {
            font-size: 14px;
            margin-left: 2px;
            opacity: 0.85;
            font-weight: 500;
        }
        .time-label {
            font-size: 10px;
            color: #92400e;
            font-weight: 600;
            letter-spacing: 0.2px;
            margin-bottom: 4px;
        }
        /* Á¨¨‰∏âË°åÔºöÂΩìÂâçÊ®°Âºè„ÄÅÊ∏©Â∫¶ÂäüÁéáÂÄº„ÄÅÊπøÂ∫¶ÂäüÁéáÂÄº */
        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 6px;
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            text-align: center;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.1);
            transition: all 0.3s ease;
        }
        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .info-label {
            font-size: 10px;
            color: #6b21a8;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .info-value {
            font-size: 13px;
            font-weight: 700;
            color: #581c87;
            line-height: 1.3;
        }
        .info-value.mode {
            color: #667eea;
            font-weight: 700;
        }
        .device-card-footer {
            padding: 6px 12px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .last-update {
            font-size: 10px;
            color: #9e9e9e;
        }
        /* È¢ÑÁ∫¶Á≠âÂÄôÂå∫Âüü */
        .device-waiting-samples {
            padding: 10px 12px;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
            border-top: 1px solid #fbbf24;
            border-bottom: 1px solid #fbbf24;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }
        .waiting-samples-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border: 1.5px solid rgba(245, 158, 11, 0.3);
            color: #ffffff;
            font-size: 14px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.2);
        }
        .waiting-samples-btn:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        .waiting-samples-display {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: flex-start;
            overflow-y: auto;
            overflow-x: hidden;
            max-width: 100%;
            height: 35px;
            padding-right: 4px;
        }
        .waiting-samples-display::-webkit-scrollbar {
            width: 6px;
        }
        .waiting-samples-display::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        .waiting-samples-display::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .waiting-samples-display::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        .waiting-sample-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            border: 1px solid rgba(217, 119, 6, 0.4);
            border-radius: 8px;
            font-size: 13px;
            color: #78350f;
            white-space: nowrap;
            flex: 0 0 calc((100% - 20px) / 3);
            width: calc((100% - 20px) / 3);
            max-width: calc((100% - 20px) / 3);
            min-width: 0;
            font-weight: 500;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .waiting-sample-tag:hover {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            border-color: rgba(217, 119, 6, 0.6);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(217, 119, 6, 0.3);
        }
        .waiting-sample-tag:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(245, 158, 11, 0.15);
        }
        .waiting-sample-tag-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }
        .device-empty-state {
            padding: 60px 20px;
            border: 2px dashed rgba(148, 163, 184, 0.35);
            border-radius: 24px;
            text-align: center;
            color: #64748b;
            font-size: 16px;
            background: rgba(248, 250, 252, 0.6);
            backdrop-filter: blur(6px);
        }
        .device-form-content {
            max-width: 520px;
        }
        .device-form-body {
            padding: 32px 36px 36px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .device-form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .device-form-group label {
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
        }
        .device-form-group input,
        .device-form-group select {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #cbd5f5;
            font-size: 14px;
            background: #fff;
            transition: all 0.2s ease;
        }
        .device-form-group input:focus,
        .device-form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15), 0 2px 8px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        .toggle-group {
            display: flex;
            gap: 8px;
        }
        .toggle-btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
            background: #ffffff;
            color: #64748b;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 13px;
        }
        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
            background: #f8fafc;
        }
        .toggle-btn.active {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: #ffffff;
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        .toggle-btn.active:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5);
        }
        .device-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 0 36px 32px;
        }
        .device-form-btn {
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .device-form-btn.cancel {
            background: #e2e8f0;
            color: #475569;
        }
        .device-form-btn.cancel:hover {
            background: #cbd5e1;
        }
        .device-form-btn.submit {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
        }
        .device-form-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.25);
        }
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè - ÂÖ®Êñ∞Áé∞‰ª£ÂåñËÆæËÆ° */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            animation: fadeIn 0.25s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            margin: 2% auto;
            border-radius: 28px;
            width: 92%;
            max-width: 950px;
            max-height: none;
            height: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(0, 0, 0, 0.05),
                0 0 100px rgba(102, 126, 234, 0.15);
            animation: modalSlideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: visible;
            position: relative;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #4facfe 75%, 
                #667eea 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px) scale(0.96);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
        }
        .modal-header h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.8px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .modal-header h2::before {
            content: 'üì°';
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        .close {
            color: rgba(255, 255, 255, 0.95);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .modal-body {
            padding: 40px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            overflow: visible;
            flex: 1;
            min-height: 0;
        }
        .form-group {
            margin-bottom: 28px;
        }
        .form-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            font-weight: 700;
            color: #1e293b;
            font-size: 16px;
            letter-spacing: -0.3px;
        }
        .form-group label::before {
            content: 'üìù';
            font-size: 20px;
        }
        .json-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            resize: vertical;
            min-height: 520px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: #ffffff;
            color: #0f172a;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .json-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 
                0 0 0 5px rgba(102, 126, 234, 0.1),
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.15);
            background: #ffffff;
            transform: translateY(-1px);
        }
        .json-input::placeholder {
            color: #94a3b8;
            font-style: italic;
        }
        .form-input {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.5;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: #ffffff;
            color: #0f172a;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 
                0 0 0 5px rgba(102, 126, 234, 0.1),
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.15);
            background: #ffffff;
            transform: translateY(-1px);
        }
        .form-input::placeholder {
            color: #94a3b8;
            font-style: italic;
        }
        .form-actions {
            display: flex;
            gap: 14px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            min-width: 140px;
            letter-spacing: 0.2px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.4);
            position: relative;
        }
        .btn-primary::after {
            content: 'üöÄ';
            font-size: 18px;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                0 0 30px rgba(102, 126, 234, 0.5);
        }
        .btn-primary:active {
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #ffffff;
            color: #475569;
            border: 2px solid #e2e8f0;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .btn-secondary:nth-of-type(2)::after {
            content: '‚ú®';
            font-size: 16px;
        }
        .btn-secondary:nth-of-type(3)::after {
            content: 'üóëÔ∏è';
            font-size: 16px;
        }
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: #334155;
        }
        .result-message {
            padding: 18px 24px;
            border-radius: 12px;
            margin-top: 24px;
            display: none;
            font-weight: 500;
            font-size: 15px;
            animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            line-height: 1.6;
            position: relative;
            overflow: hidden;
        }
        .result-message::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 12px 0 0 12px;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .result-message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #6ee7b7;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }
        .result-message.success::before {
            background: #10b981;
        }
        .result-message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2);
        }
        .result-message.error::before {
            background: #ef4444;
        }
        .result-message.loading {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
        }
        .result-message.loading::before {
            background: #3b82f6;
        }
        /* Á®ãÂºèËØïÈ™åÈ°µÈù¢Áõ∏ÂØπÂÆö‰ΩçÔºåÁ°Æ‰øùÁªùÂØπÂÆö‰ΩçÁöÑÂ≠êÂÖÉÁ¥†Ê≠£Á°ÆÂÆö‰Ωç */
        #programPage {
            position: relative;
        }

        /* Á®ãÂºèËØïÈ™åÁä∂ÊÄÅ‰ø°ÊÅØÊ°ÜÊ†∑Âºè */
        .program-status-box {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 180px; /* ÂÆö‰ΩçÂú®ÂäüÁéáÂÄº‰∏ãÊñπ10px */
            z-index: 10;
            width: calc(100% - 48px); /* ‰∏éËØïÈ™åÂÆπÂô®(main-content)‰∏ÄÊ†∑ÂÆΩÔºåÂáèÂéªÂ∑¶Âè≥ËæπË∑ù */
            margin: 0 24px; /* Â∑¶Âè≥ËæπË∑ù24pxÔºå‰∏émain-content‰∏ÄËá¥ */
            padding: 16px 24px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            pointer-events: none; /* ‰∏çÂΩ±Âìç‰∏ãÈù¢ÁöÑÁÇπÂáª‰∫ã‰ª∂ */
        }

        .program-status-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 15px;
            font-weight: 600;
            pointer-events: auto; /* Áä∂ÊÄÅÊ°ÜÊú¨Ë∫´ÂèØ‰ª•ÁÇπÂáª */
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .status-item span:last-child {
            font-weight: 700;
            color: #1e3a8a;
        }

        /* Á®ãÂºèÂè∑ÂèØÁÇπÂáªÊ†∑Âºè */
        #programNumberDisplay.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 2px 8px;
        }
        
        #programNumberDisplay.clickable:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            transform: scale(1.05);
        }
        
        #programNumberDisplay.modified {
            color: #667eea !important;
            font-weight: 700 !important;
            position: relative;
        }
        
        #programNumberDisplay.modified::after {
            content: '‚úé';
            position: absolute;
            right: -18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #667eea;
        }
        
        /* ÂÆöÂÄºËØïÈ™åËÆæÂÆöÂÄº‰øÆÊîπÊ†áËØÜÊ†∑Âºè */
        #targetTempDisplay.modified,
        #targetHumidityDisplay.modified {
            color: #667eea !important;
            font-weight: 700 !important;
        }
        
        /* ÂÆöÊó∂ËøêË°åÂèÇÊï∞‰øÆÊîπÊ†áËØÜÊ†∑Âºè */
        #runTimeInput.modified {
            color: #667eea !important;
            font-weight: 700 !important;
            border-color: #667eea !important;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
        }
        
        #timerOff.modified,
        #timerOn.modified {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            font-weight: 700 !important;
        }
        
        /* ÈÄöÁî®ÊèêÁ§∫Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .alert-modal-content {
            max-width: 480px;
            margin: 15% auto;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .alert-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .alert-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .alert-modal-body {
            padding: 35px 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .alert-modal-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .alert-modal-message {
            font-size: 16px;
            color: #1e293b;
            line-height: 1.6;
            white-space: pre-line;
        }
        
        .alert-modal-footer {
            padding: 0 30px 30px;
            display: flex;
            justify-content: center;
        }
        
        .alert-modal-btn {
            padding: 12px 40px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            min-width: 120px;
        }
        
        .alert-modal-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }
        
        .alert-modal-btn:active {
            transform: translateY(0);
        }
        
        /* ‰∏çÂêåÁ±ªÂûãÁöÑÂõæÊ†áÈ¢úËâ≤ */
        .alert-modal-icon.info { color: #3b82f6; }
        .alert-modal-icon.success { color: #10b981; }
        .alert-modal-icon.warning { color: #f59e0b; }
        .alert-modal-icon.error { color: #ef4444; }
        
        /* ÂëΩ‰ª§ËØ¶ÊÉÖÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπÊ†∑ÂºèÔºàÂèØÂ§çÂà∂Ôºâ */
        #commandInfoContent {
            cursor: text;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
        }
        
        #commandInfoContent::-webkit-scrollbar {
            width: 8px;
        }
        
        #commandInfoContent::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        #commandInfoContent::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        #commandInfoContent::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        /* ÊâßË°å‰∏≠ÊåâÈíÆÊ†∑Âºè */
        .action-btn.executing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white !important;
            cursor: pointer !important;
            animation: pulse 1.5s ease-in-out infinite;
            position: relative;
        }
        
        .action-btn.executing::after {
            content: '‚è≥';
            margin-left: 6px;
            font-size: 16px;
        }
        
        .action-btn.executing:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* ÊöÇÂÅú‰∏≠ÊåâÈíÆÊ†∑ÂºèÔºàÊ©ôËâ≤Á≥ªÔºâ */
        .pause-btn.executing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white !important;
            cursor: pointer !important;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .pause-btn.executing::after {
            content: '‚è≥';
            margin-left: 6px;
            font-size: 16px;
        }
        
        .pause-btn.executing:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }
        
        /* Ê†∑ÂìÅÁÆ°ÁêÜÊ®°ÊÄÅÊ°ÜÂ¢ûÂº∫Ê†∑Âºè */
        #editDeviceInfoModal .modal-content {
            max-width: 900px;
        }
        
        .samples-list-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }
        
        .samples-list-container::-webkit-scrollbar {
            width: 8px;
        }
        
        .samples-list-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        .samples-list-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        
        .samples-list-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .sample-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 18px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: relative;
            overflow: hidden;
        }
        
        .sample-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }
        
        .sample-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            border-color: #c7d2fe;
        }
        
        .sample-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .sample-card-title {
            flex: 1;
        }
        
        .sample-card-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            font-size: 14px;
            margin-right: 10px;
            flex-shrink: 0;
        }
        
        .sample-card-name {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin: 0;
            line-height: 1.4;
        }
        
        .sample-card-body {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 14px;
        }
        
        .sample-info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .sample-info-label {
            font-size: 11px;
            font-weight: 600;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .sample-info-value {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            word-break: break-word;
        }
        
        .sample-info-value.empty {
            color: #94a3b8;
            font-style: italic;
        }
        
        .sample-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid #f1f5f9;
            margin-top: 12px;
        }
        
        .sample-card-time {
            font-size: 11px;
            color: #94a3b8;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .sample-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .sample-action-btn {
            padding: 6px 14px;
            border-radius: 8px;
            border: none;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .sample-action-btn.edit {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            color: #6366f1;
            border: 1.5px solid rgba(99, 102, 241, 0.3);
        }
        
        .sample-action-btn.edit:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(99, 102, 241, 0.2);
        }
        
        .sample-action-btn.edit:disabled {
            background: rgba(203, 213, 225, 0.3);
            color: #94a3b8;
            border-color: #cbd5e1;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .sample-action-btn.delete {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.1) 100%);
            color: #ef4444;
            border: 1.5px solid rgba(239, 68, 68, 0.3);
        }
        
        .sample-action-btn.delete:hover:not(:disabled) {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2) 0%, rgba(220, 38, 38, 0.2) 100%);
            border-color: rgba(239, 68, 68, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(239, 68, 68, 0.2);
        }
        
        .sample-action-btn.delete:disabled {
            background: rgba(203, 213, 225, 0.3);
            color: #94a3b8;
            border-color: #cbd5e1;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .sample-empty-state {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }
        
        .sample-empty-state-icon {
            font-size: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
        
        .sample-empty-state-text {
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .title-with-btn {
                flex-direction: column;
                gap: 10px;
            }
            .send-command-btn {
                font-size: 13px;
                padding: 8px 16px;
            }
            .program-status-content {
                gap: 12px;
                font-size: 13px;
            }
            .program-status-box {
                bottom: 100px; /* ÁßªÂä®Á´ØÂäüÁéáÂÄº‰∏ãÊñπ10px */
                width: calc(100% - 32px); /* ÁßªÂä®Á´ØË∞ÉÊï¥ÂÆΩÂ∫¶ */
                margin: 0 16px; /* ÁßªÂä®Á´ØË∞ÉÊï¥ËæπË∑ù */
                padding: 12px 18px;
            }
            .modal-content {
                width: 96%;
                margin: 1% auto;
                max-height: none;
                height: auto;
                border-radius: 24px;
                overflow: visible;
            }
            .modal-header {
                padding: 24px 28px;
            }
            .modal-header h2 {
                font-size: 22px;
            }
            .modal-header h2::before {
                font-size: 26px;
            }
            .modal-body {
                padding: 28px 24px;
            }
            .json-input {
                min-height: 450px;
                padding: 16px;
                font-size: 13px;
            }
            .form-actions {
                flex-direction: column;
                gap: 12px;
            }
            .btn {
                width: 100%;
                min-width: unset;
                padding: 14px 24px;
            }
            .samples-list-container {
                grid-template-columns: 1fr;
                max-height: 400px;
            }
            .sample-card-body {
                grid-template-columns: 1fr;
            }
            .user-info {
                right: 10px;
                top: 20px;
                padding: 6px 12px;
                font-size: 12px;
            }
            .user-info-username {
                font-size: 13px;
            }
            .user-info-job {
                font-size: 11px;
            }
            .monitor-datetime {
                font-size: 14px;
                right: 140px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- ÂÖ®Â±ÄÊó∂Èó¥ÊòæÁ§∫ÔºàÂõ∫ÂÆöÂú®Âè≥‰∏äËßíÔºåÊâÄÊúâÈ°µÈù¢ÂÖ±Áî®Ôºâ -->
    <div class="monitor-datetime" id="monitorDatetime">2025-10-28 13:41:04</div>
    
    <!-- ËÆæÂ§áÁõëÊéßÈ¶ñÈ°µ -->
    <div id="deviceMonitorPage" class="page active">
        <div class="monitor-header">
            <a class="back-home" href="/" id="backHomeBtn" onclick="handleBackHome(event)">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
            <div class="title-with-btn">
                <!-- <button class="send-command-btn" onclick="openCommandModal()">üì§ ÂèëÈÄÅÊâßË°åÂëΩ‰ª§</button> -->
                <button class="refresh-btn" id="refreshDataBtn" onclick="forceRefreshData()" title="Âº∫Âà∂‰ªéÊï∞ÊçÆÂ∫ìÂà∑Êñ∞Êï∞ÊçÆ">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
                <a class="data-management-btn" id="dataManagementBtn" href="/dataManagement" onclick="handleDataManagement(event)" title="Êï∞ÊçÆÁÆ°ÁêÜ">üìã Êï∞ÊçÆÁÆ°ÁêÜ</a>
                <a class="oee-analysis-btn" id="oeeAnalysisBtn" href="/reliabilityLab/oeeAnalysis" onclick="handleOEEAnalysis(event)" title="Êü•ÁúãOEEÂàÜÊûê">üìä OEEÂàÜÊûê</a>
                <h1 class="monitor-title" id="monitorTitle">ÂèØÈù†ÊÄßÁâ©ËÅîÁΩëÊ∏©ÁÆ±ÁõëÊéßÁ≥ªÁªü</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-info-username" id="userInfoUsername"></div>
                <div class="user-info-job" id="userInfoDepartment"></div>
            </div>
        </div>

        <div class="monitor-layout" id="monitorLayout">
            <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="ÊòæÁ§∫/ÈöêËóè‰æßËæπÊ†è">‚óÄ</button>
            <aside class="device-sidebar" id="deviceSidebar">
                <div class="device-sidebar-inner">
                    <div class="sidebar-add-card" onclick="openAddDeviceModal()">
                        <div class="sidebar-add-icon">+</div>
                        <div>Ê∑ªÂä†Êñ∞ËÆæÂ§á</div>
                        <div class="sidebar-add-hint">Ê≥®ÂÜåËÆæÂ§áIDÂà∞ÁõëÊéßÁ≥ªÁªü</div>
                    </div>
                    <div>
                        <h3>ËÆæÂ§áÂàóË°®</h3>
                        <div id="deviceSidebarList" class="sidebar-list"></div>
                    </div>
                </div>
            </aside>
            <div class="device-content">
                <div class="device-grid">
                    <div id="deviceGrid" class="device-grid-inner"></div>
                    <div id="deviceEmptyState" class="device-empty-state" style="display: none;">
                        ÂΩìÂâçÊ≤°ÊúâÁõëÊéß‰∏≠ÁöÑËÆæÂ§á
                        <br><br>
                        üí° ËØ∑ÁÇπÂáªÂ∑¶‰æß <strong>"Ê∑ªÂä†Êñ∞ËÆæÂ§á"</strong> ÊåâÈíÆÊ≥®ÂÜåËÆæÂ§áÂà∞ÁõëÊéßÁ≥ªÁªü
                    </div>
                </div>
            </div>
        </div>
    </div>
    <template id="deviceCardTemplate">
        <div class="device-card">
            <div class="device-card-header">
                <div class="device-name">
                    <div class="device-name-left">
                        <div class="device-name-left-top">
                            <span class="device-icon">üå°Ô∏è</span>
                            <span class="device-id" data-field="deviceId">--</span>
                        </div>
                        <button class="edit-device-info-btn" data-device-id="" title="ÊµãËØïÊ†∑ÂìÅ‰ø°ÊÅØ">
                            <span>‚úèÔ∏è</span>
                            <span>ÊµãËØïÊ†∑ÂìÅ</span>
                        </button>
                    </div>
                    <div class="device-info-inline">
                        <div class="device-samples-tags" data-field="samplesContainer">
                            <!-- Ê†∑ÂìÅÊ†áÁ≠æÂ∞ÜÂä®ÊÄÅÊèíÂÖ•ËøôÈáå -->
                        </div>
                    </div>
                </div>
                <div class="device-status" data-field="statusWrapper">
                    <span class="status-dot"></span>
                    <span class="status-text" data-field="statusText">--</span>
                </div>
            </div>
            <div class="device-card-body">
                <!-- Á¨¨‰∏ÄË°åÔºöÊ∏©Â∫¶„ÄÅÊπøÂ∫¶„ÄÅËøêË°åÊó∂Èó¥„ÄÅÂâ©‰ΩôÊó∂Èó¥ÔºàÊï¥ÂêàÂú®‰∏ÄË°åÔºâ -->
                <div class="data-row">
                    <div class="data-item">
                        <div class="data-label">üå°Ô∏è Ê∏©Â∫¶</div>
                        <div class="data-value temp-value" data-field="temperature">0<span class="unit">‚ÑÉ</span></div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">üíß ÊπøÂ∫¶</div>
                        <div class="data-value humidity-value" data-field="humidity">0<span class="unit">%</span></div>
                    </div>
                    <div class="data-item time-item">
                        <div class="time-label">‚è±Ô∏è ËøêË°åÊó∂Èó¥</div>
                        <div class="data-value time-value" data-field="runtime">0H 00M 00S</div>
                    </div>
                    <div class="data-item time-item">
                        <div class="time-label">‚è≥ Ââ©‰ΩôÊó∂Èó¥</div>
                        <div class="data-value time-value" data-field="remaining">--</div>
                    </div>
                </div>
                <!-- Á¨¨‰∫åË°åÔºöÂΩìÂâçÊ®°Âºè„ÄÅÊ∏©Â∫¶ÂäüÁéáÂÄº„ÄÅÊπøÂ∫¶ÂäüÁéáÂÄº -->
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">üìã ÂΩìÂâçÊ®°Âºè</span>
                        <span class="info-value mode" data-field="mode">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üî• Ê∏©Â∫¶ÂäüÁéá</span>
                        <span class="info-value" data-field="tempPower">0%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üí® ÊπøÂ∫¶ÂäüÁéá</span>
                        <span class="info-value" data-field="humidityPower">0%</span>
                    </div>
                </div>
            </div>
            <!-- È¢ÑÁ∫¶Á≠âÂÄôÂå∫Âüü -->
            <div class="device-waiting-samples" data-field="waitingSamplesContainer">
                <button class="waiting-samples-btn" data-field="waitingSamplesBtn">üìã È¢ÑÁ∫¶Á≠âÂÄô</button>
                <div class="waiting-samples-display" data-field="waitingSamplesDisplay">
                    <!-- È¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅÂ∞ÜÂä®ÊÄÅÊèíÂÖ•ËøôÈáå -->
                </div>
            </div>
            <div class="device-card-footer">
                <div class="connection-status" data-field="connectionWrapper">
                    <span class="connection-dot"></span>
                    <span data-field="connectionText">--</span>
                </div>
                <div class="last-update" data-field="lastUpdate">Êõ¥Êñ∞: --</div>
            </div>
        </div>
    </template>

    <!-- ‰∏ªËèúÂçïÈ°µÈù¢ (WK1) -->
    <div id="menuPage" class="page">
        <div class="menu-header">
            <div class="device-id">U680</div>
            <div class="menu-datetime" id="menuDatetime">2025-10-27 17:46:01</div>
        </div>

        <div class="menu-controls">
            <button class="menu-btn orange" onclick="backToMonitor()">ÁõÆÂΩï</button>
        </div>

        <div class="menu-grid">
            <button class="menu-item menu-item-yellow" onclick="navigateTo('constant')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M8 10h8"/>
                </svg>
                <span>ÂÆöÂÄºËØïÈ™å</span>
            </button>

            <button class="menu-item menu-item-red" onclick="navigateTo('program')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M8 8h8M8 12h8M8 16h8"/>
                </svg>
                <span>Á®ãÂºèËØïÈ™å</span>
            </button>

            <button class="menu-item menu-item-orange" onclick="navigateTo('settings')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M6 8h12M6 12h12M6 16h12"/>
                </svg>
                <span>Êìç‰ΩúËÆæÁΩÆ</span>
            </button>

            <button class="menu-item menu-item-green" onclick="navigateTo('communication')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>ÈÄöËÆØËÆæÁΩÆ</span>
            </button>

            <button class="menu-item menu-item-purple" onclick="navigateTo('appointment')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>È¢ÑÁ∫¶ËÆæÁΩÆ</span>
            </button>
        </div>

        <div class="menu-footer">
            <div class="error-message">Ê∏©ÊπøÂ∫¶Ê®°ÂùóËøûÊé•ÂºÇÂ∏∏</div>
            <div class="version">V1.9</div>
        </div>
    </div>

    <!-- ÂÆöÂÄºËØïÈ™åÈ°µÈù¢ (WK6/WK7) -->
    <div id="constantPage" class="page">
        <div class="header has-device-id">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <div class="device-id" id="constantDeviceId">--</div>
            <h1 class="header-title">ÂÆöÂÄºËØïÈ™å</h1>
            <div class="header-status">
                <div class="status-datetime" id="constantDatetime">2025-10-27 17:46:01</div>
                <div class="status-text" id="constantStatus">ËØïÈ™åÂÅúÊ≠¢</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-temp">
                <div class="panel-header">
                    <span class="panel-title">Ê∏©Â∫¶</span>
                    <span class="panel-unit">‚ÑÉ</span>
                </div>
                <div class="panel-value" id="currentTemp">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label">ËÆæÂÆöÂÄº</span>
                        <div class="control-input-clickable" id="targetTempDisplay">0.0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="tempPower">0.0%</div>
                    </div>
                </div>
            </div>

            <div class="panel panel-humidity">
                <div class="panel-header">
                    <span class="panel-title">ÊπøÂ∫¶</span>
                    <span class="panel-unit">%</span>
                </div>
                <div class="panel-value" id="currentHumidity">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label">ËÆæÂÆöÂÄº</span>
                        <div class="control-input-clickable" id="targetHumidityDisplay">0.0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="humidityPower">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="time-display">
                <div class="time-box">
                    <span class="time-label">ËøêË°åÊó∂Èó¥:</span>
                    <span class="time-value" id="runtime">0H 00M 00S</span>
                </div>
                <div class="time-box">
                    <span class="time-label">Ââ©‰ΩôÊó∂Èó¥:</span>
                    <span class="time-value" id="remainingTime">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="settingsBtn">ËÆæÁΩÆ</button>
                <button class="action-btn pause-btn" id="chartBtn">ÊöÇÂÅú</button>
                <button class="action-btn action-btn-primary" id="runBtn">ËøêË°å</button>
            </div>
        </div>
    </div>

    <!-- Á®ãÂºèËØïÈ™åÈ°µÈù¢ -->
    <div id="programPage" class="page">
        <div class="header has-device-id">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <div class="device-id" id="programDeviceId">--</div>
            <h1 class="header-title">Á®ãÂºèËØïÈ™å</h1>
            <div class="header-status">
                <div class="status-datetime" id="programDatetime">2025-10-27 17:46:01</div>
                <div class="status-text" id="programStatus">ËØïÈ™åÂÅúÊ≠¢</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-temp">
                <div class="panel-header">
                    <span class="panel-title">Ê∏©Â∫¶</span>
                    <span class="panel-unit">‚ÑÉ</span>
                </div>
                <div class="panel-value" id="programCurrentTemp">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label" id="programTempLabel">Á®ãÂºèÂè∑</span>
                        <div class="control-input-clickable" id="programNumberDisplay">0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="programTempPower">0.0%</div>
                    </div>
                </div>
            </div>

            <div class="panel panel-humidity">
                <div class="panel-header">
                    <span class="panel-title">ÊπøÂ∫¶</span>
                    <span class="panel-unit">%</span>
                </div>
                <div class="panel-value" id="programCurrentHumidity">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label" id="programHumLabel">ÊÄªÊÆµÊï∞</span>
                        <div class="control-display" id="totalSegmentsDisplay">0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="programHumidityPower">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á®ãÂºèËØïÈ™åÁä∂ÊÄÅ‰ø°ÊÅØÊ°Ü -->
        <div id="programStatusBox" class="program-status-box" style="display: none;">
            <div class="program-status-content">
                <span class="status-item">Á®ãÂºèÂè∑Ôºö<span id="programStatusNumber">0</span></span>
                <span class="status-item">ÊÆµÂè∑Ôºö<span id="programStatusSegment">01</span></span>
                <span class="status-item">Á®ãÂºèÂæ™ÁéØÔºö<span id="programStatusCycle">00/05</span></span>
                <span class="status-item">ÊÆµÂæ™ÁéØÔºö<span id="programStatusSegmentCycle">00/00</span></span>
                <span class="status-item">ÊÄªÊÆµÊï∞Ôºö<span id="programStatusTotalSegments">0</span></span>
            </div>
        </div>

        <div class="bottom-section">
            <div class="time-display">
                <div class="time-box">
                    <span class="time-label">ËøêË°åÊó∂Èó¥:</span>
                    <span class="time-value" id="programRuntime">0H 00M 00S</span>
                </div>
                <div class="time-box">
                    <span class="time-label">Ââ©‰ΩôÊó∂Èó¥:</span>
                    <span class="time-value" id="programRemainingTime">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="editBtn">ÁºñËæë</button>
                <button class="action-btn pause-btn" id="programChartBtn">ÊöÇÂÅú</button>
                <button class="action-btn action-btn-primary" id="programRunBtn">ËøêË°å</button>
            </div>
        </div>
    </div>

    <!-- Êìç‰ΩúËÆæÁΩÆÈ°µÈù¢ (WK8) -->
    <div id="settingsPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <h1 class="header-title">Êìç‰ΩúËÆæÁΩÆ1</h1>
        </div>

        <div class="settings-content">
            <div class="setting-row">
                <label class="setting-label">ËØ≠Ë®ÄÈÄâÊã©</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="langZh">‰∏≠Êñá</button>
                    <button class="toggle-btn" id="langEn">ENGLISH</button>
                </div>
            </div>

            <div class="setting-row">
                <label class="setting-label">ÂêØÂä®ÊñπÂºè</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="startStop">ÂÅúÊ≠¢</button>
                    <button class="toggle-btn" id="startCold">ÂÜ∑ÂêØ</button>
                    <button class="toggle-btn" id="startHot">ÁÉ≠ÂêØ</button>
                </div>
            </div>

            <div class="setting-row">
                <label class="setting-label">Â§öÂè∞ËøûÊé•‰ΩøËÉΩ</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="multiNo">Âê¶</button>
                    <button class="toggle-btn" id="multiYes">ÊòØ</button>
                </div>
            </div>

            <button class="input-settings-btn" onclick="navigateTo('menu')">ËæìÂÖ•ËÆæÁΩÆ</button>
        </div>
    </div>

    <!-- ÈÄöËÆØËÆæÁΩÆÈ°µÈù¢ (WK3) -->
    <div id="communicationPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <h1 class="header-title">ÈÄöËÆØËÆæÁΩÆ</h1>
        </div>

        <div class="communication-content">
            <div class="comm-row">
                <label class="comm-label">ÈÄö‰ø°ÂçèËÆÆ</label>
                <div class="protocol-toggle">
                    <button class="protocol-btn active" id="rtuBtn">RTU</button>
                    <button class="protocol-btn" id="tcpBtn">TCP</button>
                </div>
            </div>

            <!-- RTU ËÆæÁΩÆÁïåÈù¢ -->
            <div id="rtuSettings" class="protocol-settings">
                <div class="comm-row">
                    <label class="comm-label">Á´ØÂè£Âè∑</label>
                    <select class="comm-input" id="portNumber">
                        <option>COM12</option>
                        <option>COM1</option>
                        <option>COM2</option>
                    </select>
                    <label class="comm-label">Ê≥¢ÁâπÁéá</label>
                    <select class="comm-input" id="baudRate">
                        <option>9600</option>
                        <option>19200</option>
                        <option>38400</option>
                    </select>
                </div>

                <div class="comm-row">
                    <label class="comm-label">ÂÅúÊ≠¢‰Ωç</label>
                    <select class="comm-input" id="stopBit">
                        <option>1</option>
                        <option>2</option>
                    </select>
                    <label class="comm-label">Êï∞ÊçÆ‰Ωç</label>
                    <select class="comm-input" id="dataBit">
                        <option>8</option>
                        <option>7</option>
                    </select>
                </div>

                <div class="comm-row">
                    <label class="comm-label">Â•áÂÅ∂Ê†°È™å</label>
                    <select class="comm-input" id="parity">
                        <option>N</option>
                        <option>E</option>
                        <option>O</option>
                    </select>
                    <label class="comm-label">ÈÄö‰ø°Âú∞ÂùÄ</label>
                    <input type="number" class="comm-input" id="commAddress" value="1">
                    <button class="connect-btn" id="connectBtn">ËøûÊé•</button>
                </div>

                <div class="server-upload">
                    <label class="comm-label">‰∏ä‰º†ÊúçÂä°Âô®</label>
                    <input type="text" class="server-input" id="serverUrl" placeholder="ËæìÂÖ•ÊúçÂä°Âô®Âú∞ÂùÄ">
                    <button class="upload-btn" id="uploadBtn">‰∏ä‰º†</button>
                </div>
            </div>

            <!-- TCP ËÆæÁΩÆÁïåÈù¢ -->
            <div id="tcpSettings" class="protocol-settings" style="display: none;">
                <div class="comm-row">
                    <label class="comm-label">Â±èIPÂú∞ÂùÄ</label>
                    <input type="text" class="comm-input" id="screenIp" value="192.168.0.146">
                    <label class="comm-label">Á´ØÂè£Âè∑</label>
                    <input type="number" class="comm-input" id="tcpPort" value="8000">
                </div>

                <div class="comm-row">
                    <button class="connect-btn" id="tcpConnectBtn">ËøûÊé•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- È¢ÑÁ∫¶ËÆæÁΩÆÈ°µÈù¢ (WK5) -->
    <div id="appointmentPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <h1 class="header-title">È¢ÑÁ∫¶ËÆæÁΩÆ</h1>
        </div>

        <div class="appointment-content">
            <div class="time-section">
                <label class="time-label">Á≥ªÁªüÊó∂Èó¥</label>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="sysYear" value="0000">
                    <span class="time-unit">Âπ¥</span>
                    <input type="number" class="time-input" id="sysMonth" value="00">
                    <span class="time-unit">Êúà</span>
                    <input type="number" class="time-input" id="sysDay" value="00">
                    <span class="time-unit">Êó•</span>
                </div>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="sysHour" value="00">
                    <span class="time-unit">Êó∂</span>
                    <input type="number" class="time-input" id="sysMinute" value="00">
                    <span class="time-unit">ÂàÜ</span>
                    <input type="number" class="time-input" id="sysSecond" value="00">
                    <span class="time-unit">Áßí</span>
                </div>
            </div>

            <div class="time-section">
                <label class="time-label">È¢ÑÁ∫¶Êó∂Èó¥</label>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="resYear" value="0000">
                    <span class="time-unit">Âπ¥</span>
                    <input type="number" class="time-input" id="resMonth" value="00">
                    <span class="time-unit">Êúà</span>
                    <input type="number" class="time-input" id="resDay" value="00">
                    <span class="time-unit">Êó•</span>
                </div>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="resHour" value="00">
                    <span class="time-unit">Êó∂</span>
                    <input type="number" class="time-input" id="resMinute" value="00">
                    <span class="time-unit">ÂàÜ</span>
                    <input type="number" class="time-input" id="resSecond" value="00">
                    <span class="time-unit">Áßí</span>
                </div>
            </div>

            <div class="time-section">
                <label class="time-label">È¢ÑÁ∫¶ËÆæÁΩÆ</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="appointmentOff">ÂÖ≥</button>
                    <button class="toggle-btn" id="appointmentOn">ÂºÄ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÆöÂÄºËÆæÁΩÆÈ°µÈù¢ (WK2) -->
    <div id="valueSettingsPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('constant')">ËøîÂõû</button>
            <h1 class="header-title">ÂÆöÂÄºËÆæÁΩÆ</h1>
            <button class="menu-btn orange" onclick="resetTimerSettingsToDefault()">ËøòÂéü</button>
        </div>

        <div class="value-settings-content">
            <div class="value-setting-row">
                <label class="value-setting-label">ÂÆöÊó∂ËøêË°å</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="timerOff">ÂÖ≥</button>
                    <button class="toggle-btn" id="timerOn">ÂºÄ</button>
                </div>
                <input type="text" class="value-input" id="runTimeInput" value="0.00" placeholder="H.M" maxlength="6">
                <span class="value-unit">H.M</span>
            </div>
        </div>
    </div>

    <!-- Á®ãÂºèÁºñËæëÈ°µÈù¢ (WK4) -->
    <div id="programEditPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('program')">ËøîÂõû</button>
            <h1 class="header-title">Á®ãÂºèÁºñËæë</h1>
            <button class="menu-btn orange" onclick="navigateTo('standby')">ÂæÖÊú∫</button>
        </div>

        <div class="program-edit-content">
            <div class="program-info-row">
                <label class="program-info-label">Á®ãÂºèÁºñÂè∑</label>
                <input type="number" class="program-info-input" id="progNumber" value="0">
                <label class="program-info-label">Âæ™ÁéØ</label>
                <input type="number" class="program-info-input" id="progCycle" value="0">
                <label class="program-info-label">ËøûÊé•</label>
                <input type="number" class="program-info-input" id="progConnect" value="0">
            </div>

            <div class="program-table-container">
                <table class="program-table">
                    <thead>
                    <tr>
                        <th>No.</th>
                        <th>Ê∏©Â∫¶(‚ÑÉ)</th>
                        <th>ÊπøÂ∫¶(%)</th>
                        <th>Êó∂Èó¥(H.M)</th>
                        <th>TS1</th>
                        <th>TS2</th>
                        <th>TS3</th>
                        <th>TS4</th>
                    </tr>
                    </thead>
                    <tbody id="programTableBody">
                    <tr>
                        <td>01</td>
                        <td><input type="number" class="table-input" value="0.0"></td>
                        <td><input type="number" class="table-input" value="0.0"></td>
                        <td><input type="number" class="table-input" value="0.00"></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- ËøêË°åÁ°ÆËÆ§Á™óÂè£ -->
<div id="runConfirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Á°ÆËÆ§Êìç‰Ωú</h3>
        </div>
        <div class="modal-body">
            <div class="confirm-message" id="modalMessage">
                Á°ÆÂÆöË¶ÅÊâßË°åÊ≠§Êìç‰ΩúÂêóÔºü<br>
                <small>ÂëΩ‰ª§Â∞ÜÂèëÈÄÅËá≥ËÆæÂ§áÔºåÊâßË°åÂêéÂ∞ÜÂú®30ÁßíÂêéËá™Âä®Âà∑Êñ∞Áä∂ÊÄÅ„ÄÇ</small>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-no" id="modalNo">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-yes" id="modalYes">Á°ÆËÆ§</button>
        </div>
    </div>
</div>

<!-- Êï∞ÂÄºËæìÂÖ•ÂØπËØùÊ°Ü -->
<div id="valueInputModal" class="modal">
    <div class="value-input-content">
        <div class="value-input-header">
            <div class="value-input-label" id="valueInputLabel">ËÆæÂÆöÂÄº</div>
            <div class="value-input-range" id="valueInputRange">[-200.00 - 400.00]</div>
            <div class="value-input-field">
                <input type="text" id="valueInput" placeholder="ËØ∑ËæìÂÖ•Êï∞ÂÄº">
            </div>
        </div>
        <div class="value-keypad">
            <div class="keypad-row">
                <button class="keypad-btn" data-value="0">0</button>
                <button class="keypad-btn" data-value="1">1</button>
                <button class="keypad-btn" data-value="2">2</button>
                <button class="keypad-btn" data-value="3">3</button>
                <button class="keypad-btn" data-value="4">4</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn" data-value="5">5</button>
                <button class="keypad-btn" data-value="6">6</button>
                <button class="keypad-btn" data-value="7">7</button>
                <button class="keypad-btn" data-value="8">8</button>
                <button class="keypad-btn" data-value="9">9</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn" id="keypadSign">+/-</button>
                <button class="keypad-btn" id="keypadBackspace">‚Üê</button>
                <button class="keypad-btn" id="keypadExit">ÈÄÄÂá∫</button>
                <button class="keypad-btn" data-value=".">.</button>
                <button class="keypad-btn" id="keypadClear">Ê∏ÖÈô§</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn keypad-confirm" id="keypadConfirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>
</div>

<!-- Ê∑ªÂä†ËÆæÂ§áË°®Âçï -->
<div id="deviceFormModal" class="modal">
    <div class="modal-content device-form-content">
        <div class="modal-header">
            <h2 id="deviceFormTitle">üì° Ê∑ªÂä†Êñ∞ËÆæÂ§á</h2>
            <span class="close" onclick="closeAddDeviceModal()">&times;</span>
        </div>
        <div class="device-form-body">
            <div class="device-form-group">
                <label for="deviceIdInput">ËÆæÂ§áÂêçÁß∞ *</label>
                <input type="text" id="deviceIdInput" placeholder="ËØ∑ËæìÂÖ•ËÆæÂ§áÂêçÁß∞Ôºå‰æãÂ¶ÇÔºöDEVICE001„ÄÅU680-05">
            </div>
            
            <!-- ËÆæÂ§áÁÆ°ÁêÜÂàóË°®Ôºà‰ªÖÂç¢ÂÅ•ÂíåÊà¥ÊùèÂçéÂèØËßÅÔºâ -->
            <div id="deviceManageSection" class="device-form-group" style="display: none;">
                <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span>üîß</span>
                    <span>ËÆæÂ§áÁÆ°ÁêÜ</span>
                </label>
                <div style="padding: 16px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 1px solid #fbbf24;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 12px; font-size: 14px;">ËÆæÂ§áÂàóË°®ÔºàÂèØÂà†Èô§‰ªªÊÑèËÆæÂ§áÔºâ</div>
                    <div id="deviceManageList" style="max-height: 300px; overflow-y: auto; border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 12px; background: rgba(255, 255, 255, 0.5);">
                        <div style="text-align: center; padding: 20px; color: #78350f; opacity: 0.7;">Âä†ËΩΩ‰∏≠...</div>
                    </div>
                    <div style="font-size: 12px; color: #78350f; opacity: 0.7; padding-top: 8px; margin-top: 12px; border-top: 1px solid rgba(251, 191, 36, 0.3);">
                        üí° ÊèêÁ§∫ÔºöÁÇπÂáªËÆæÂ§áÂè≥‰æßÁöÑÂà†Èô§ÊåâÈíÆÂèØ‰ª•Âà†Èô§ËØ•ËÆæÂ§áÔºåÂà†Èô§ÂêéÂ∞Ü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§
                    </div>
                </div>
            </div>
            
            <div style="padding: 12px 14px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border: 1px solid #93c5fd; font-size: 13px; color: #1e40af; line-height: 1.6;">
                <div style="font-weight: 600; margin-bottom: 6px;">üí° Êìç‰ΩúËØ¥ÊòéÔºö</div>
                <div>1. ËæìÂÖ•ËÆæÂ§áÂêçÁß∞ÂêéÁÇπÂáª"Ê∑ªÂä†ËÆæÂ§á"ÔºåÁ≥ªÁªüÂ∞ÜÂú®Êï∞ÊçÆÂ∫ì‰∏≠ÂàõÂª∫ÂàùÂßãËÆ∞ÂΩï</div>
                <div>2. ËÆæÂ§áÂêØÂä®Âêé‰ºöËá™Âä®ÈÄöËøáÊé•Âè£‰∏äÊä•Êï∞ÊçÆÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ</div>
                <div>3. Ê∑ªÂä†ÊàêÂäüÂêéËÆæÂ§áÂ∞ÜÂá∫Áé∞Âú®ÁõëÊéßÂàóË°®‰∏≠</div>
                <div>4. Ê†∑ÂìÅ‰ø°ÊÅØÂèØÂú®ËÆæÂ§áÊ∑ªÂä†ÂêéÈÄöËøá"ÊµãËØïÊ†∑ÂìÅ"ÂäüËÉΩËøõË°åÊ∑ªÂä†ÂíåÁÆ°ÁêÜ</div>
            </div>
        </div>
        <div class="device-form-actions">
            <button class="device-form-btn cancel" type="button" onclick="closeAddDeviceModal()">ÂèñÊ∂à</button>
            <button class="device-form-btn submit" type="button" onclick="submitAddDevice()">Ê∑ªÂä†ËÆæÂ§á</button>
        </div>
    </div>
</div>

<!-- Ê†∑ÂìÅÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü -->
<div id="editDeviceInfoModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="editDeviceInfoTitle">üìù ÊµãËØïÊ†∑ÂìÅ‰ø°ÊÅØ</h2>
            <span class="close" onclick="closeEditDeviceInfoModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="device-form-group">
                <label>ËÆæÂ§áID</label>
                <input type="text" id="editDeviceInfoId" readonly style="background: #f1f5f9; cursor: not-allowed;">
            </div>
            
            <!-- Ê†∑ÂìÅÂàóË°® -->
            <div class="device-form-group">
                <label style="font-size: 16px; font-weight: 700; color: #1e293b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                    <span>üì¶</span>
                    <span>Ê†∑ÂìÅÂàóË°®</span>
                    <span id="samplesCount" style="font-size: 14px; font-weight: 600; color: #6366f1; background: rgba(99, 102, 241, 0.1); padding: 2px 8px; border-radius: 12px; margin-left: auto;">0 ‰∏™Ê†∑ÂìÅ</span>
                </label>
                <div id="samplesListContainer" class="samples-list-container">
                    <!-- Ê†∑ÂìÅÂàóË°®Â∞ÜÂä®ÊÄÅÊèíÂÖ•ËøôÈáå -->
                </div>
            </div>
            
            <!-- Ê∑ªÂä†Êñ∞Ê†∑ÂìÅË°®Âçï -->
            <div style="border-top: 2px dashed #e2e8f0; padding-top: 16px; margin-top: 16px;">
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 12px; padding: 14px; border: 1px solid #bae6fd; box-shadow: 0 2px 8px rgba(14, 165, 233, 0.08);">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                        <span style="font-size: 16px;">‚ûï</span>
                        <span style="font-weight: 600; font-size: 15px; color: #1e293b;">Ê∑ªÂä†Êñ∞Ê†∑ÂìÅ</span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px 12px;">
                        <div class="device-form-group" style="margin: 0; grid-column: 1;">
                            <label for="editModelInput" style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #3b82f6;">üì±</span>
                                <span>ÂûãÂè∑</span>
                            </label>
                            <input type="text" id="editModelInput" placeholder="‰æãÂ¶ÇÔºöiPhone 15" style="background: #ffffff; border: 2px solid #e2e8f0; transition: all 0.3s ease; padding: 8px 10px; font-size: 13px;">
                        </div>
                        <div class="device-form-group" style="margin: 0; grid-column: 2;">
                            <label for="editCategoryInput" style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #8b5cf6;">üè∑Ô∏è</span>
                                <span>ÂìÅÁ±ª</span>
                            </label>
                            <input type="text" id="editCategoryInput" placeholder="‰æãÂ¶ÇÔºöÊâãÊú∫" style="background: #ffffff; border: 2px solid #e2e8f0; transition: all 0.3s ease; padding: 8px 10px; font-size: 13px;">
                        </div>
                        <div class="device-form-group" style="margin: 0; grid-column: 1;">
                            <label for="editTesterInput" style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #10b981;">üë§</span>
                                <span>ÊµãËØï‰∫∫Âëò</span>
                            </label>
                            <input type="text" id="editTesterInput" placeholder="ÈªòËÆ§ÂΩìÂâçÁî®Êà∑" style="background: #ffffff; border: 2px solid #e2e8f0; transition: all 0.3s ease; padding: 8px 10px; font-size: 13px;">
                        </div>
                        <div class="device-form-group" style="margin: 0; grid-column: 2;">
                            <label style="display: flex; align-items: center; gap: 4px; margin-bottom: 6px; font-size: 13px;">
                                <span style="color: #f59e0b;">‚è∞</span>
                                <span>ÊµãËØïÊñπÂºè</span>
                            </label>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button type="button" class="toggle-btn active" id="sampleAppointmentOff" style="flex: 1; padding: 8px 10px; border-radius: 8px; font-weight: 600; font-size: 12px; transition: all 0.3s ease;">üöÄ Áõ¥Êé•ÊµãËØï</button>
                                <button type="button" class="toggle-btn" id="sampleAppointmentOn" style="flex: 1; padding: 8px 10px; border-radius: 8px; font-weight: 600; font-size: 12px; transition: all 0.3s ease;">‚è≥ È¢ÑÁ∫¶Á≠âÂÄô</button>
                            </div>
                        </div>
                    </div>
                    <div style="font-size: 11px; color: #64748b; margin-top: 8px; padding: 6px 10px; background: #f1f5f9; border-radius: 6px; border-left: 3px solid #3b82f6;">
                        <span id="sampleAppointmentStatus">ÂΩìÂâçÔºöÁõ¥Êé•ÊµãËØïÔºàÁä∂ÊÄÅÔºöTESTINGÔºâ</span>
                    </div>
                </div>
            </div>
            
            <div style="padding: 12px 14px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 1px solid #fbbf24; font-size: 13px; color: #92400e; line-height: 1.6; margin-top: 16px;">
                <div style="font-weight: 600; margin-bottom: 6px;">üí° ÊèêÁ§∫Ôºö</div>
                <div>‰∏ÄÂè∞ËÆæÂ§áÂèØ‰ª•Ê∑ªÂä†Â§ö‰∏™ÊµãËØïÊ†∑ÂìÅÔºåÊØè‰∏™Ê†∑ÂìÅÂèØ‰ª•Êúâ‰∏çÂêåÁöÑÂìÅÁ±ª„ÄÅÂûãÂè∑ÂíåÊµãËØï‰∫∫Âëò</div>
                <div style="margin-top: 4px;">ÊµãËØï‰∫∫ÂëòÈªòËÆ§‰ΩøÁî®ÂΩìÂâçÁôªÂΩïÁî®Êà∑Ôºà<span id="currentUserDisplay" style="font-weight: 600;"></span>ÔºâÔºåÂèØÊâãÂä®‰øÆÊîπ</div>
            </div>
        </div>
        <div class="device-form-actions">
            <button class="device-form-btn cancel" type="button" onclick="closeEditDeviceInfoModal()">ÂÖ≥Èó≠</button>
            <button class="device-form-btn submit" type="button" onclick="submitAddSample()">Ê∑ªÂä†Ê†∑ÂìÅ</button>
        </div>
    </div>
</div>

<!-- ÈÄöÁî®ÊèêÁ§∫Ê®°ÊÄÅÊ°Ü -->
<div id="alertModal" class="modal">
    <div class="modal-content alert-modal-content">
        <div class="alert-modal-header">
            <h3 id="alertModalTitle">ÊèêÁ§∫</h3>
            <span class="close" onclick="closeAlertModal()">&times;</span>
        </div>
        <div class="alert-modal-body">
            <div class="alert-modal-icon" id="alertModalIcon">‚ÑπÔ∏è</div>
            <div class="alert-modal-message" id="alertModalMessage">ËøôÊòØ‰∏ÄÊù°ÊèêÁ§∫‰ø°ÊÅØ</div>
        </div>
        <div class="alert-modal-footer">
            <button class="alert-modal-btn" onclick="closeAlertModal()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- ÂëΩ‰ª§ËØ¶ÊÉÖÊ®°ÊÄÅÊ°ÜÔºàÂèØÂ§çÂà∂Ôºâ -->
<div id="commandInfoModal" class="modal">
    <div class="modal-content alert-modal-content" style="max-width: 600px;">
        <div class="alert-modal-header">
            <h3>‚è≥ Ê≠£Âú®ÊâßË°åÂëΩ‰ª§</h3>
            <span class="close" onclick="closeCommandInfoModal()">&times;</span>
        </div>
        <div class="alert-modal-body" style="text-align: left; align-items: flex-start; padding: 25px 30px;">
            <div id="commandInfoContent" style="width: 100%; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.8; color: #1e293b; white-space: pre-wrap; word-wrap: break-word; user-select: text; -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; max-height: 400px; overflow-y: auto;"></div>
        </div>
        <div class="alert-modal-footer" style="display: flex; gap: 10px; justify-content: center;">
            <button class="alert-modal-btn" onclick="refreshCommandStatus()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">üîÑ Âà∑Êñ∞Áä∂ÊÄÅ</button>
            <button class="alert-modal-btn" onclick="closeCommandInfoModal()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- Ê†∑ÂìÅ‰ø°ÊÅØËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div id="sampleInfoModal" class="modal">
    <div class="modal-content alert-modal-content" style="max-width: 500px;">
        <div class="alert-modal-header">
            <h3>üì¶ Ê†∑ÂìÅ‰ø°ÊÅØËØ¶ÊÉÖ</h3>
            <span class="close" onclick="closeSampleInfoModal()">&times;</span>
        </div>
        <div class="alert-modal-body" style="text-align: left; align-items: flex-start;">
            <div style="width: 100%;">
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border: 1px solid #bae6fd;">
                    <div style="font-weight: 600; color: #0369a1; margin-bottom: 8px; font-size: 14px;">ÊµãËØï‰∫∫Âëò</div>
                    <div style="font-size: 16px; color: #0c4a6e; font-weight: 600;" id="sampleInfoTester">--</div>
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #fcd34d;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 14px;">ÂûãÂè∑</div>
                    <div style="font-size: 16px; color: #78350f; font-weight: 600;" id="sampleInfoModel">--</div>
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-radius: 8px; border: 1px solid #c4b5fd;">
                    <div style="font-weight: 600; color: #6b21a8; margin-bottom: 8px; font-size: 14px;">ÂìÅÁ±ª</div>
                    <div style="font-size: 16px; color: #581c87; font-weight: 600;" id="sampleInfoCategory">--</div>
                </div>
            </div>
        </div>
        <div class="alert-modal-footer" style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
            <button class="alert-modal-btn" id="startTestingBtn" onclick="startTestingSample()" style="display: none; background: linear-gradient(135deg, #10b981 0%, #059669 100%); border: none; color: white; font-weight: 600;">üöÄ ËΩ¨ÂÖ•ÊµãËØï</button>
            <button class="alert-modal-btn" id="cancelWaitingBtn" onclick="cancelTestingSample()" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; font-weight: 600;">‚ùå ÂèñÊ∂àÈ¢ÑÁ∫¶</button>
            <button class="alert-modal-btn" id="completeTestingBtn" onclick="completeTestingSample()" style="display: none; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; color: white; font-weight: 600;">‚úÖ Â∑≤ÂÆåÊàêÊµãËØï</button>
            <button class="alert-modal-btn" id="cancelTestingBtn" onclick="cancelTestingSampleForTesting()" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border: none; color: white; font-weight: 600;">‚ùå ÂèñÊ∂àÊµãËØï</button>
            <button class="alert-modal-btn" onclick="closeSampleInfoModal()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- ÂèëÈÄÅÂëΩ‰ª§Ê®°ÊÄÅÊ°Ü -->
<div id="commandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ÂèëÈÄÅËÆæÂ§áÊâßË°åÂëΩ‰ª§</h2>
            <span class="close" onclick="closeCommandModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="jsonInput">JSON Êï∞ÊçÆ</label>
                <textarea id="jsonInput" class="json-input" rows="28" placeholder='ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆÔºå‰æãÂ¶ÇÔºö&#10;{&#10;  "device_id": "DEVICE001",&#10;  "valueorprogram": "1",&#10;  "fixed_temp_set": "25.0",&#10;  "fixed_hum_set": "60.0",&#10;  "set_program_number": "001",&#10;  "set_run_status": "1",&#10;  "set_program_no": "001",&#10;  "create_by": "admin"&#10;}&#10;&#10;Â≠óÊÆµËØ¥ÊòéÔºö&#10;- valueorprogram: ÂÆöÂÄºÊàñÁ®ãÂºèËØïÈ™åÂà§Êñ≠Ôºà0=Á®ãÂºèËØïÈ™åÔºå1=ÂÆöÂÄºËØïÈ™åÔºâ&#10;- fixed_temp_set: ÂÆöÂÄºÊ∏©Â∫¶&#10;- fixed_hum_set: ÂÆöÂÄºÊπøÂ∫¶&#10;- set_program_number: ËÆæÂÆöËøêË°åÁ®ãÂºèÂè∑&#10;- set_run_status: ËøêË°åÁä∂ÊÄÅÔºà0=ÂÅúÊ≠¢Ôºå1=ËøêË°åÔºå2=ÊöÇÂÅúÔºâ&#10;- set_program_no: ËÆæÁΩÆÁ®ãÂºèÂè∑&#10;- create_by: ÂàõÂª∫ËÄÖ'></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="sendCommand()">ÂèëÈÄÅÊâßË°åÂëΩ‰ª§</button>
                <button class="btn btn-secondary" onclick="formatJson()">Ê†ºÂºèÂåñ</button>
                <button class="btn btn-secondary" onclick="clearJson()">Ê∏ÖÁ©∫</button>
            </div>
            <div id="resultMessage" class="result-message"></div>
        </div>
    </div>
</div>

<!-- È¢ÑÁ∫¶Á≠âÂÄôÊ†∑ÂìÅË°®ÂçïÊ®°ÊÄÅÊ°Ü -->
<div id="waitingSampleFormModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h2>üìã È¢ÑÁ∫¶ÊéíÈòüÊ†∑ÂìÅ‰ø°ÊÅØ</h2>
            <span class="close" onclick="closeWaitingSampleFormModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="waitingSampleForm" onsubmit="submitWaitingSample(event)">
                <div class="form-group">
                    <label for="waitingSampleModel">ÂûãÂè∑</label>
                    <input type="text" id="waitingSampleModel" class="form-input" placeholder="ËØ∑ËæìÂÖ•Ê†∑ÂìÅÂûãÂè∑" />
                </div>
                <div class="form-group">
                    <label for="waitingSampleCategory">ÂìÅÁ±ª</label>
                    <input type="text" id="waitingSampleCategory" class="form-input" placeholder="ËØ∑ËæìÂÖ•Ê†∑ÂìÅÂìÅÁ±ª" />
                </div>
                <div class="form-group">
                    <label for="waitingSampleTester">ÊµãËØï‰∫∫Âëò</label>
                    <input type="text" id="waitingSampleTester" class="form-input" placeholder="ËØ∑ËæìÂÖ•ÊµãËØï‰∫∫ÂëòÂßìÂêç" />
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Êèê‰∫§È¢ÑÁ∫¶</button>
                    <button type="button" class="btn btn-secondary" onclick="closeWaitingSampleFormModal()">ÂèñÊ∂à</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="/css/reliablityLab/app.js"></script>
<script>
// Êâ©Â±ïÊï∞ÂÄºËæìÂÖ•ÂØπËØùÊ°ÜÁöÑÁ°ÆËÆ§ÊåâÈíÆÔºåÊîØÊåÅÁ®ãÂºèÂè∑ËæìÂÖ•
document.addEventListener('DOMContentLoaded', function() {
    const keypadConfirm = document.getElementById('keypadConfirm');
    const valueInputModal = document.getElementById('valueInputModal');
    const valueInput = document.getElementById('valueInput');
    const keypadExit = document.getElementById('keypadExit');
    
    if (keypadConfirm && valueInputModal && valueInput) {
        // ‰∏∫Á°ÆËÆ§ÊåâÈíÆÊ∑ªÂä†È¢ùÂ§ñÁöÑÂ§ÑÁêÜÈÄªËæëÔºà‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÔºå‰ºòÂÖàÊâßË°åÔºâ
        keypadConfirm.addEventListener('click', function(e) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ®ãÂºèÂè∑ËæìÂÖ•
            if (valueInputModal.dataset.inputType === 'programNumber') {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶Âèë app.js ÁöÑ onclick ‰∫ã‰ª∂
                e.stopPropagation();
                e.preventDefault();
                
                const inputValue = valueInput.value.trim();
                if (inputValue !== '') {
                    const success = confirmProgramNumberInput(inputValue);
                    if (success) {
                        valueInputModal.style.display = 'none';
                        valueInputModal.dataset.inputType = '';
                    }
                } else {
                    showAlert('ËØ∑ËæìÂÖ•Á®ãÂºèÂè∑', 'ËæìÂÖ•ÈîôËØØ', 'warning');
                }
                return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            }
            // Â¶ÇÊûú‰∏çÊòØÁ®ãÂºèÂè∑ËæìÂÖ•ÔºåËÆ© app.js ÁöÑ onclick Â§ÑÁêÜ
        }, true); // ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµ
    }
    
    if (keypadExit && valueInputModal) {
        // ÈÄÄÂá∫ÊåâÈíÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        keypadExit.addEventListener('click', function() {
            if (valueInputModal.dataset.inputType === 'programNumber') {
                valueInputModal.style.display = 'none';
                valueInputModal.dataset.inputType = '';
            }
        });
    }
    
    // Êã¶Êà™navigateToÂáΩÊï∞ÔºåÂú®ËøîÂõûÁõÆÂΩïÊó∂ÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπ
    if (typeof window.navigateTo === 'function') {
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = function(pageName) {
            // Â¶ÇÊûúÊòØËøîÂõûÁõÆÂΩïÔºåÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπÔºàÈúÄË¶ÅËé∑ÂèñÂΩìÂâçËÆæÂ§áIDÔºâ
            if (pageName === 'menu') {
                const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                       (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
                resetAllTemporaryModifications(currentDeviceId);
            }
            // Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞
            return originalNavigateTo.apply(this, arguments);
        };
    }
    
    // Êã¶Êà™backToMonitorÂáΩÊï∞ÔºåÂú®ËøîÂõûÁõëÊéßÈ¶ñÈ°µÊó∂ÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπ
    if (typeof window.backToMonitor === 'function') {
        const originalBackToMonitor = window.backToMonitor;
        window.backToMonitor = function() {
            const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                   (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
            resetAllTemporaryModifications(currentDeviceId);
            // Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞
            return originalBackToMonitor.apply(this, arguments);
        };
    }
});

// ËøîÂõû‰∏ªÈ°µÊåâÈíÆÂ§ÑÁêÜÂáΩÊï∞ÔºàÂÖ®Â±ÄÂáΩÊï∞ÔºåÂèØÁõ¥Êé•Ë¢´ onclick Ë∞ÉÁî®Ôºâ
function handleBackHome(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('üîÑ ËøîÂõû‰∏ªÈ°µÊåâÈíÆË¢´ÁÇπÂáª');
    
    try {
        // Ê∏ÖÁêÜÂÆöÊó∂Âô®
        if (typeof stopDeviceListAutoRefresh === 'function') {
            stopDeviceListAutoRefresh();
            console.log('‚úÖ Â∑≤ÂÅúÊ≠¢ËÆæÂ§áËá™Âä®Âà∑Êñ∞');
        }
        
        // Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÁöÑ username Âíå departmentName
        const username = localStorage.getItem('username');
        const departmentName = localStorage.getItem('departmentName');
        
        if (username) {
            // ÊúâÊú¨Âú∞ÁºìÂ≠òÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÂÖ¨ÂºÄ‰∏ªÈ°µÔºà‰∏çÈúÄË¶ÅÈ™åËØÅÔºâ
            console.log('‚úÖ Ê£ÄÊµãÂà∞Êú¨Âú∞Áî®Êà∑‰ø°ÊÅØ: ' + username + 'ÔºåÁõ¥Êé•Ë∑≥ËΩ¨Âà∞ÂÖ¨ÂºÄ‰∏ªÈ°µ');
            // Â∞ÜÁî®Êà∑‰ø°ÊÅØ‰Ωú‰∏∫URLÂèÇÊï∞‰º†ÈÄíÔºåÊñπ‰æøÊñ∞È°µÈù¢‰ΩøÁî®
            const params = new URLSearchParams({
                username: username
            });
            if (departmentName) {
                params.append('departmentName', departmentName);
            }
            window.location.href = '/home?' + params.toString();
        } else {
            // Ê≤°ÊúâÊú¨Âú∞ÁºìÂ≠òÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
            console.log('‚ö†Ô∏è Êú™ÊâæÂà∞Êú¨Âú∞Áî®Êà∑‰ø°ÊÅØÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ');
            window.location.href = '/index.html';
        }
        
    } catch (err) {
        console.error('ËøîÂõû‰∏ªÈ°µËøáÁ®ã‰∏≠Âá∫Èîô:', err);
        // Âá∫ÈîôÊó∂Ë∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
        window.location.href = '/index.html';
    }
    
    return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
}

// Êï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆÂ§ÑÁêÜÂáΩÊï∞ÔºàÂÖ®Â±ÄÂáΩÊï∞ÔºåÂèØÁõ¥Êé•Ë¢´ onclick Ë∞ÉÁî®Ôºâ
function handleDataManagement(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('üîÑ Êï∞ÊçÆÁÆ°ÁêÜÊåâÈíÆË¢´ÁÇπÂáª');
    
    try {
        // Ê∏ÖÁêÜÂÆöÊó∂Âô®
        if (typeof stopDeviceListAutoRefresh === 'function') {
            stopDeviceListAutoRefresh();
            console.log('‚úÖ Â∑≤ÂÅúÊ≠¢ËÆæÂ§áËá™Âä®Âà∑Êñ∞');
        }
        
        // Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÁöÑ username Âíå departmentName
        const username = localStorage.getItem('username');
        const departmentName = localStorage.getItem('departmentName');
        
        const baseUrl = window.location.origin;
        let url = baseUrl + '/dataManagement';
        
        // ÊûÑÂª∫Êü•ËØ¢ÂèÇÊï∞
        const params = [];
        if (username) {
            params.push('username=' + encodeURIComponent(username));
        }
        if (departmentName) {
            params.push('departmentName=' + encodeURIComponent(departmentName));
        }
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Âú®ÈíâÈíâÁéØÂ¢É‰∏≠
        const isDingTalk = typeof dd !== 'undefined' && dd.env && dd.env.platform !== 'notInDingTalk';
        
        if (isDingTalk) {
            // Âú®ÈíâÈíâÁéØÂ¢É‰∏≠Ôºå‰ΩøÁî® dd.openLink Ë∑≥ËΩ¨
            dd.openLink({
                url: url,
                success: function() {
                    console.log('‚úÖ ÊàêÂäüÊâìÂºÄÊï∞ÊçÆÁÆ°ÁêÜÈ°µÈù¢');
                },
                fail: function(err) {
                    console.error('‚ùå dd.openLink fail:', err);
                    window.location.href = url;
                }
            });
        } else {
            window.location.href = url;
        }
        
    } catch (err) {
        console.error('‚ùå Ë∑≥ËΩ¨Êï∞ÊçÆÁÆ°ÁêÜÈ°µÈù¢ËøáÁ®ã‰∏≠Âá∫Èîô:', err);
        window.location.href = '/dataManagement';
    }
    
    return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
}

// OEEÂàÜÊûêÊåâÈíÆÂ§ÑÁêÜÂáΩÊï∞ÔºàÂÖ®Â±ÄÂáΩÊï∞ÔºåÂèØÁõ¥Êé•Ë¢´ onclick Ë∞ÉÁî®Ôºâ
function handleOEEAnalysis(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('üîÑ OEEÂàÜÊûêÊåâÈíÆË¢´ÁÇπÂáª');
    
    try {
        // Ê∏ÖÁêÜÂÆöÊó∂Âô®
        if (typeof stopDeviceListAutoRefresh === 'function') {
            stopDeviceListAutoRefresh();
            console.log('‚úÖ Â∑≤ÂÅúÊ≠¢ËÆæÂ§áËá™Âä®Âà∑Êñ∞');
        }
        
        // Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÁöÑ username Âíå departmentName
        const username = localStorage.getItem('username');
        const departmentName = localStorage.getItem('departmentName');
        
        const baseUrl = window.location.origin;
        let url = baseUrl + '/reliabilityLab/oeeAnalysis';
        
        // ÊûÑÂª∫Êü•ËØ¢ÂèÇÊï∞
        const params = [];
        if (username) {
            params.push('username=' + encodeURIComponent(username));
        }
        if (departmentName) {
            params.push('departmentName=' + encodeURIComponent(departmentName));
        }
        if (params.length > 0) {
            url += '?' + params.join('&');
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Âú®ÈíâÈíâÁéØÂ¢É‰∏≠
        const isDingTalk = typeof dd !== 'undefined' && dd.env && dd.env.platform !== 'notInDingTalk';
        
        if (isDingTalk) {
            // Âú®ÈíâÈíâÁéØÂ¢É‰∏≠Ôºå‰ΩøÁî® dd.openLink Ë∑≥ËΩ¨
            dd.openLink({
                url: url,
                success: function() {
                    console.log('‚úÖ ÊàêÂäüÊâìÂºÄOEEÂàÜÊûêÈ°µÈù¢');
                },
                fail: function(err) {
                    console.error('‚ùå dd.openLink fail:', err);
                    window.location.href = url;
                }
            });
        } else {
            window.location.href = url;
        }
        
    } catch (err) {
        console.error('‚ùå Ë∑≥ËΩ¨OEEÂàÜÊûêÈ°µÈù¢ËøáÁ®ã‰∏≠Âá∫Èîô:', err);
        window.location.href = '/reliabilityLab/oeeAnalysis';
    }
    
    return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
}

// È°µÈù¢Âä†ËΩΩÊó∂ÔºåÂÖà‰ªélocalStorageËé∑ÂèñusernameÂíådepartmentNameÔºåÂ¶ÇÊûúÊ≤°ÊúâÂÜç‰ªéURLÂèÇÊï∞Ëé∑Âèñ
(function() {
    // ÂÖà‰ªélocalStorageËé∑Âèñ
    let username = localStorage.getItem('username') || '';
    let departmentName = localStorage.getItem('departmentName') || '';
    
    // Â¶ÇÊûúlocalStorage‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªéURLÂèÇÊï∞Ëé∑Âèñ
    if (!username) {
        const urlParams = new URLSearchParams(window.location.search);
        const urlUsername = urlParams.get('username');
        
        // Â¶ÇÊûúURL‰∏≠ÊúâÂÄºÔºå‰ΩøÁî®URLÁöÑÂÄºÂπ∂‰øùÂ≠òÂà∞localStorage
        if (urlUsername) {
            username = urlUsername;
            localStorage.setItem('username', username);
            console.log('‰ªéURLËé∑ÂèñÂπ∂‰øùÂ≠òusernameÂà∞Êú¨Âú∞ÁºìÂ≠ò:', username);
        }
    }
    
    // departmentName ÊòØÂèØÈÄâÁöÑÔºåÂ¶ÇÊûúURL‰∏≠ÊúâÂàô‰ΩøÁî®
    if (!departmentName) {
        const urlParams = new URLSearchParams(window.location.search);
        const urlDepartmentName = urlParams.get('departmentName');
        if (urlDepartmentName) {
            departmentName = urlDepartmentName;
            localStorage.setItem('departmentName', departmentName);
            console.log('‰ªéURLËé∑ÂèñÂπ∂‰øùÂ≠òdepartmentNameÂà∞Êú¨Âú∞ÁºìÂ≠ò:', departmentName);
        }
    }
    
    if (username) {
        console.log('‰ªéÊú¨Âú∞ÁºìÂ≠òËØªÂèñÁî®Êà∑‰ø°ÊÅØ:', { username: username, departmentName: departmentName || 'Êú™ËÆæÁΩÆ' });
    }
    
    // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØÂà∞Âè≥‰∏äËßí
    const userInfoDiv = document.getElementById('userInfo');
    const usernameDiv = document.getElementById('userInfoUsername');
    const departmentDiv = document.getElementById('userInfoDepartment');
    
    if (username) {
        if (userInfoDiv && usernameDiv && departmentDiv) {
            // ÊòæÁ§∫Áî®Êà∑ÂêçÂíåÈóÆÂÄôËØ≠
            usernameDiv.textContent = (username || 'Êú™Áü•Áî®Êà∑') + 'Ôºå‰Ω†Â•Ω';
            
            // ÂºÇÊ≠•Ëé∑ÂèñÈÉ®Èó®ÂêçÁß∞
            fetchUserDepartment(username).then(departmentName => {
                if (departmentName) {
                    departmentDiv.textContent = 'ÈÉ®Èó®Ôºö' + departmentName;
                } else {
                    departmentDiv.textContent = '';
                }
                userInfoDiv.style.display = 'flex';
            }).catch(error => {
                console.error('Ëé∑ÂèñÈÉ®Èó®‰ø°ÊÅØÂ§±Ë¥•:', error);
                departmentDiv.textContent = '';
                userInfoDiv.style.display = 'flex';
            });
        }
        console.log('Áî®Êà∑‰ø°ÊÅØÂ∑≤Âä†ËΩΩ:', { username: username });
    } else {
        console.warn('Êú™Ëé∑ÂèñÂà∞Áî®Êà∑‰ø°ÊÅØÔºàusernameÔºâÔºåÊüê‰∫õÂäüËÉΩÂèØËÉΩÂèóÈôê');
        // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÊèêÁ§∫ÊàñË∑≥ËΩ¨ÈÄªËæë
        // alert('ËØ∑ÂÖàÁôªÂΩï');
        // window.location.href = '/';
    }
    
    // Ëé∑ÂèñÁî®Êà∑ÈÉ®Èó®ÂêçÁß∞ÁöÑÂáΩÊï∞
    async function fetchUserDepartment(username) {
        try {
            const response = await fetch('/api/getUserDepartment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ username: username })
            });
            
            if (!response.ok) {
                console.error('Ëé∑ÂèñÈÉ®Èó®‰ø°ÊÅØÂ§±Ë¥•:', response.status);
                return '';
            }
            
            const data = await response.json();
            if (data.success && data.departmentName) {
                return data.departmentName;
            } else {
                console.warn('Êú™ÊâæÂà∞ÈÉ®Èó®‰ø°ÊÅØ:', data.message);
                return '';
            }
        } catch (error) {
            console.error('Ëé∑ÂèñÈÉ®Èó®‰ø°ÊÅØÊó∂ÂèëÁîüÈîôËØØ:', error);
            return '';
        }
    }
})();

// ËÆæÂ§áÊ®°ÂùóÊï∞ÊçÆ‰∏éÊ∏≤ÊüìÈÄªËæë
const DEVICE_STATUS_TEXT = {
    running: 'ËøêË°å',
    stopped: 'ÂÅúÊ≠¢',
    paused: 'ÊöÇÂÅú',
    warning: 'Ë≠¶Âëä'
};

let deviceList = [];
let activeDeviceId = null;
// autoFetchTimerId Â∑≤ÁßªÈô§ÔºåÂõ†‰∏∫‰∏çÂÜç‰ΩøÁî® scheduleAutoFetch
let deviceListRefreshTimerId = null; // ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®
let refreshCountdownTimerId = null; // Âà∑Êñ∞ÂÄíËÆ°Êó∂ÂÆöÊó∂Âô®
let refreshCountdown = 20; // Âà∑Êñ∞ÂÄíËÆ°Êó∂ÔºàÁßíÔºâ

// ÂÖÅËÆ∏Âà†Èô§ËÆæÂ§áÁöÑÁî®Êà∑ÂêçÂçï
const ALLOWED_DELETE_USERS = ['Âç¢ÂÅ•', 'Êà¥ÊùèÂçé'];

// Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶ÊúâÂà†Èô§ËÆæÂ§áÁöÑÊùÉÈôê
function hasDeletePermission() {
    const username = localStorage.getItem('username');
    return username && ALLOWED_DELETE_USERS.includes(username);
}

// Á®ãÂºèÂè∑‰∏¥Êó∂Â≠òÂÇ®ÔºàÁî®‰∫éÁ®ãÂºèËØïÈ™åÈ°µÈù¢ÁöÑ‰∏¥Êó∂‰øÆÊîπÔºâ
// ‰ΩøÁî®windowÂØπË±°Á°Æ‰øùÂÖ®Â±ÄÂèØËÆøÈóÆ
window.tempProgramNumber = null;
window.isProgramNumberModified = false;

// ÂÆöÂÄºËØïÈ™åËÆæÂÆöÂÄº‰∏¥Êó∂Â≠òÂÇ®ÔºàÁî®‰∫éÂÆöÂÄºËØïÈ™åÈ°µÈù¢ÁöÑ‰∏¥Êó∂‰øÆÊîπÔºâ
window.tempTargetTemp = null;
window.tempTargetHumidity = null;
window.isTargetTempModified = false;
window.isTargetHumidityModified = false;

// ÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏¥Êó∂Â≠òÂÇ®ÔºàÊåâËÆæÂ§áIDÂ≠òÂÇ®ÔºåÁî®‰∫éÂÆöÂÄºËÆæÁΩÆÈ°µÈù¢ÁöÑ‰∏¥Êó∂‰øÆÊîπÔºâ
// ÁªìÊûÑÔºö{ deviceId: { timerEnabled: 0/1, timerTime: 'H.M', isTimerEnabledModified: bool, isTimerTimeModified: bool } }
window.deviceTimerSettings = window.deviceTimerSettings || {};

// Ëé∑ÂèñÊåáÂÆöËÆæÂ§áÁöÑÂÆöÊó∂ËøêË°åÂèÇÊï∞
function getDeviceTimerSettings(deviceId) {
    if (!deviceId) return null;
    if (!window.deviceTimerSettings[deviceId]) {
        window.deviceTimerSettings[deviceId] = {
            timerEnabled: null,
            timerTime: null,
            isTimerEnabledModified: false,
            isTimerTimeModified: false
        };
    }
    return window.deviceTimerSettings[deviceId];
}

// ËÆæÁΩÆÊåáÂÆöËÆæÂ§áÁöÑÂÆöÊó∂ËøêË°åÂèÇÊï∞
function setDeviceTimerSettings(deviceId, settings) {
    if (!deviceId) return;
    if (!window.deviceTimerSettings[deviceId]) {
        window.deviceTimerSettings[deviceId] = {};
    }
    Object.assign(window.deviceTimerSettings[deviceId], settings);
}

function safeNumber(value, fractionDigits = 2) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const num = Number(value);
    if (Number.isNaN(num)) {
        return 0;
    }
    return typeof fractionDigits === 'number'
        ? Number(num.toFixed(fractionDigits))
        : num;
}

function toInt(value) {
    const num = parseInt(value, 10);
    return Number.isNaN(num) ? 0 : num;
}

function formatDuration(hours, minutes, seconds, fallback) {
    const hasValue = [hours, minutes, seconds].some(v => v !== null && v !== undefined && v !== '');
    if (!hasValue) {
        return fallback;
    }
    const h = Math.max(0, toInt(hours));
    const m = Math.max(0, toInt(minutes));
    const s = Math.max(0, toInt(seconds));
    return `${h}H ${String(m).padStart(2, '0')}M ${String(s).padStart(2, '0')}S`;
}

function formatRuntime(hours, minutes, seconds) {
    return formatDuration(hours, minutes, seconds, '0H 00M 00S');
}

function formatRemaining(hours, minutes, seconds) {
    return formatDuration(hours, minutes, seconds, '--');
}

function normalizeStatus(runStatus) {
    // Â§ÑÁêÜÁ©∫ÂÄº
    if (runStatus === null || runStatus === undefined || runStatus === '') {
        return 'stopped';
    }
    
    // ‰ºòÂÖàÂ§ÑÁêÜÊï∞Â≠óÊ†ºÂºèÔºö0=ÂÅúÊ≠¢, 1=ËøêË°å, 2=ÊöÇÂÅú
    const numValue = Number(runStatus);
    if (!isNaN(numValue)) {
        if (numValue === 0) return 'stopped';
        if (numValue === 1) return 'running';
        if (numValue === 2) return 'paused';
    }
    
    // ÂÖºÂÆπÊñáÊú¨Ê†ºÂºè
    const text = String(runStatus).toLowerCase();
    if (text.includes('Ë≠¶') || text.includes('warn') || text.includes('ÂºÇÂ∏∏') || text.includes('alarm')) {
        return 'warning';
    }
    if (text.includes('ÂÅú') || text.includes('stop') || text.includes('ÂæÖÊú∫') || text.includes('standby')) {
        return 'stopped';
    }
    if (text.includes('ÊöÇÂÅú') || text.includes('pause')) {
        return 'paused';
    }
    if (text.includes('ËøêË°å') || text.includes('run')) {
        return 'running';
    }
    
    // ÈªòËÆ§ËøîÂõûÂÅúÊ≠¢
    return 'stopped';
}

function formatRunMode(runMode) {
    if (runMode === null || runMode === undefined) return '--';
    const modeValue = String(runMode).trim();
    
    // ÊîØÊåÅÊï∞Â≠óÂíåÊñáÊú¨‰∏§ÁßçÊ†ºÂºè
    if (modeValue === '0' || modeValue === 'Á®ãÂºè' || modeValue === 'Á®ãÂºèÊ®°Âºè') return 'Á®ãÂºèÊ®°Âºè';
    if (modeValue === '1' || modeValue === 'ÂÆöÂÄº' || modeValue === 'ÂÆöÂÄºÊ®°Âºè') return 'ÂÆöÂÄºÊ®°Âºè';
    
    console.warn(`[formatRunMode] Êú™ËØÜÂà´ÁöÑËøêË°åÊ®°Âºè: ${modeValue}`);
    return modeValue; // Â¶ÇÊûú‰∏çÊòØÂ∑≤Áü•Ê†ºÂºèÔºåÊòæÁ§∫ÂéüÂßãÂÄº
}

// Ê†πÊçÆÂ≠óÊÆµÂÄºËÆæÁΩÆÈ¢úËâ≤ÂíåÊñáÊú¨
function formatConnectionStatus(serialStatus) {
    if (serialStatus === null || serialStatus === undefined || serialStatus === '') {
        return { connection: 'unknown', connectionText: 'Êú™Áü•', colorClass: 'status-unknown' };
    }

    const statusValue = String(serialStatus).trim();
    if (statusValue === 'Âú®Á∫ø') {
        return { connection: 'online', connectionText: 'Âú®Á∫ø', colorClass: 'status-online' };
    } else if (statusValue === 'Á¶ªÁ∫ø') {
        return { connection: 'offline', connectionText: 'Á¶ªÁ∫ø', colorClass: 'status-offline' };
    } else {
        return { connection: 'unknown', connectionText: statusValue, colorClass: 'status-unknown' };
    }
}

function formatModuleConnection(moduleConnection) {
    if (moduleConnection === null || moduleConnection === undefined || moduleConnection === '') {
        return { status: 'unknown', message: 'Ê∏©ÊπøÂ∫¶Ê®°ÂùóÁä∂ÊÄÅÊú™Áü•', colorClass: 'module-unknown' };
    }

    // Áõ¥Êé•‰ΩøÁî®Êï∞ÊçÆÂ∫ìÁöÑÂÄºÔºå‰∏çÈúÄË¶ÅËΩ¨Êç¢
    const statusValue = String(moduleConnection).trim();
    const message = statusValue; // Áõ¥Êé•‰ΩøÁî®ÂéüÂßãÂÄº
    
    // Ê†πÊçÆÂÄºËÆæÁΩÆ CSS Á±ªÂêçÔºàÁî®‰∫éÊ†∑ÂºèÊòæÁ§∫Ôºâ
    let status = 'unknown';
    let colorClass = 'module-unknown';
    
    if (statusValue === 'ËøûÊé•Ê≠£Â∏∏') {
        status = 'normal';
        colorClass = 'module-normal';
    } else if (statusValue === 'ËøûÊé•ÂºÇÂ∏∏') {
        status = 'error';
        colorClass = 'module-error';
    }
    
    return { status, message, colorClass };
}

function formatPowerValue(value) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const numeric = Number(value);
    if (Number.isFinite(numeric)) {
        return Number(numeric.toFixed(0));
    }
    return String(value);
}

function formatLastUpdate(timestamp) {
    if (!timestamp) {
        return 'ÂàöÂàö';
    }
    if (timestamp instanceof Date) {
        return `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}:${String(timestamp.getSeconds()).padStart(2, '0')}`;
    }
    if (typeof timestamp === 'string') {
        const sanitized = timestamp.replace('T', ' ').split('.')[0];
        return sanitized;
    }
    try {
        const date = new Date(timestamp);
        if (!Number.isNaN(date.getTime())) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        }
    } catch (err) {
        // ignore
    }
    return 'ÂàöÂàö';
}

function transformDeviceRecord(record, index) {
    const deviceId = record.device_id || record.deviceId || `device-${Date.now()}-${index}`;
    const connectionStatus = formatConnectionStatus(record.serial_status || record.serialStatus);
    const moduleConnectionStatus = formatModuleConnection(record.module_connection || record.moduleConnection);

    // ‰ªé samples Êï∞ÁªÑ‰∏≠ÂàÜÁ¶ªÂá∫Ê≠£Âú®ÊµãËØïÁöÑÊ†∑ÂìÅÂíåÈ¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅ
    const allSamples = record.samples || [];
    const testingSamples = allSamples.filter(sample => sample.status === 'TESTING');
    const waitingSamples = allSamples.filter(sample => sample.status === 'WAITING');

    return {
        id: deviceId,
        name: record.device_id || record.deviceId || 'Êú™ÂëΩÂêçËÆæÂ§á',
        status: normalizeStatus(record.run_status || record.runStatus),
        mode: formatRunMode(record.run_mode || record.runMode),
        temperature: safeNumber(record.temperature),
        humidity: safeNumber(record.humidity),
        runtime: formatRuntime(record.run_hours || record.runHours, record.run_minutes || record.runMinutes, record.run_seconds || record.runSeconds),
        remaining: formatRemaining(record.step_remaining_hours || record.stepRemainingHours, record.step_remaining_minutes || record.stepRemainingMinutes, record.step_remaining_seconds || record.stepRemainingSeconds),
        tempPower: formatPowerValue(record.power_temperature || record.powerTemperature),
        humidityPower: formatPowerValue(record.power_humidity || record.powerHumidity),
        connection: connectionStatus.connection,
        connectionText: connectionStatus.connectionText,
        connectionColorClass: connectionStatus.colorClass,
        moduleConnection: moduleConnectionStatus.status,
        moduleConnectionText: moduleConnectionStatus.message,
        moduleConnectionColorClass: moduleConnectionStatus.colorClass,
        lastUpdate: formatLastUpdate(record.updated_at || record.updatedAt || record.created_at || record.createdAt),
        programNumber: safeNumber(record.set_program_number || record.programNumber),
        totalSteps: safeNumber(record.total_steps || record.totalSteps),
        category: record.category || null,
        model: record.model || null,
        tester: record.tester || null,
        samples: testingSamples, // Âè™ÂåÖÂê´Ê≠£Âú®ÊµãËØïÁöÑÊ†∑ÂìÅ
        waitingSamples: waitingSamples, // È¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅ
        waitId: record.wait_id || record.waitId || null, // ‰øùÂ≠òÂéüÂßãÁöÑ wait_id ÂÄº
        autoFetch: false,
        raw: record
    };
}

async function refreshDevicesFromServer() {
    const previousActiveId = activeDeviceId;
    const emptyState = document.getElementById('deviceEmptyState');
    if (emptyState) {
        emptyState.textContent = 'Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆ...';
        emptyState.style.display = 'block';
    }
    try {
        // Ê∑ªÂä†Êó∂Èó¥Êà≥ÂèÇÊï∞ÔºåÁ°Æ‰øùËé∑ÂèñÊúÄÊñ∞Êï∞ÊçÆÔºàÈÅøÂÖçÁºìÂ≠òÔºâ
        const response = await fetch('/iot/data/devices?t=' + Date.now(), { cache: 'no-store' });
        if (!response.ok) {
            throw new Error(`ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å ${response.status}`);
        }
        const payload = await response.json();
        if (!Array.isArray(payload)) {
            throw new Error('Êé•Âè£ËøîÂõûÊ†ºÂºèÂºÇÂ∏∏ÔºåÈ¢ÑÊúü‰∏∫Êï∞ÁªÑ');
        }
        const transformed = payload.map((item, index) => {
            return transformDeviceRecord(item, index);
        });
        if (!transformed.length) {
            deviceList = [];
            activeDeviceId = null;
            renderDevices();
            const emptyState = document.getElementById('deviceEmptyState');
            if (emptyState) {
                emptyState.innerHTML = 'ÂΩìÂâçÊ≤°ÊúâÁõëÊéß‰∏≠ÁöÑËÆæÂ§á<br><br>üí° ËØ∑ÁÇπÂáªÂ∑¶‰æß <strong>"Ê∑ªÂä†Êñ∞ËÆæÂ§á"</strong> ÊåâÈíÆÊ≥®ÂÜåËÆæÂ§áÂà∞ÁõëÊéßÁ≥ªÁªü';
            }
            return;
        }
        // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊó©ÂàõÂª∫ÁöÑÂú®ÊúÄÂâçÈù¢ÔºåÊñ∞ËÆæÂ§áÂú®ÊúÄÂêéÔºâ
        transformed.sort((a, b) => {
            const timeA = a.raw.created_at || a.raw.createdAt || '9999-12-31 23:59:59';
            const timeB = b.raw.created_at || b.raw.createdAt || '9999-12-31 23:59:59';
            // ÂçáÂ∫èÊéíÂ∫èÔºöÊó©ÁöÑÊó∂Èó¥Âú®ÂâçÔºåÊôöÁöÑÊó∂Èó¥Âú®Âêé
            if (timeA < timeB) return -1;
            if (timeA > timeB) return 1;
            return 0;
        });
        console.log('[ËÆæÂ§áÊéíÂ∫è] ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÂÆåÊàêÔºåËÆæÂ§áÈ°∫Â∫è:', transformed.map(d => {
            const createdAt = d.raw.created_at || d.raw.createdAt || 'Êó†ÂàõÂª∫Êó∂Èó¥';
            return `${d.id}(${createdAt})`;
        }));
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËÆæÂ§áÁº∫Â∞ëcreated_at
        const missingCreatedAt = transformed.filter(d => !d.raw.created_at && !d.raw.createdAt);
        if (missingCreatedAt.length > 0) {
            console.warn('[ËÆæÂ§áÊéíÂ∫è] ‚ö†Ô∏è ‰ª•‰∏ãËÆæÂ§áÁº∫Â∞ëcreated_atÂ≠óÊÆµÔºåÂ∞ÜË¢´ÊéíÂú®ÊúÄÂêé:', missingCreatedAt.map(d => d.id));
        }
        deviceList = transformed;
        if (previousActiveId && deviceList.some(device => device.id === previousActiveId)) {
            activeDeviceId = previousActiveId;
        } else {
            activeDeviceId = deviceList[0].id;
        }
        renderDevices();
    } catch (error) {
        console.error('Âä†ËΩΩËÆæÂ§áÂàóË°®Â§±Ë¥•Ôºö', error);
        if (emptyState) {
            emptyState.innerHTML = '‚ùå ËÆæÂ§áÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•<br><br>üí° ËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØïÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•';
            emptyState.style.display = 'block';
        }
    } finally {
        // scheduleAutoFetch Â∑≤ÁßªÈô§ÔºåÂõ†‰∏∫ refreshDevicesFromServerQuietly Â∑≤Áªè‰ºöÊõ¥Êñ∞ÊâÄÊúâËÆæÂ§áÁöÑÊï∞ÊçÆ
    }
}

// ËÆæÂ§áÂç°ÁâáÁºìÂ≠òÔºåÁî®‰∫éÂ¢ûÈáèÊõ¥Êñ∞
const deviceCardCache = new Map();

function renderDevices() {
    const grid = document.getElementById('deviceGrid');
    const emptyState = document.getElementById('deviceEmptyState');
    const template = document.getElementById('deviceCardTemplate');
    if (!grid || !emptyState || !template) {
        return;
    }

    if (!deviceList.length) {
        // Ê∏ÖÁ©∫ÁºìÂ≠ò
        deviceCardCache.clear();
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        renderSidebar();
        activeDeviceId = null;
        updateActiveIndicators();
        return;
    }

    emptyState.style.display = 'none';

    // Ëé∑ÂèñÁé∞ÊúâÁöÑËÆæÂ§áÂç°ÁâáIDÈõÜÂêà
    const existingCardIds = new Set();
    const existingCards = grid.querySelectorAll('.device-card');
    existingCards.forEach(card => {
        const deviceId = card.dataset.deviceId;
        if (deviceId) {
            existingCardIds.add(deviceId);
        }
    });

    // Ëé∑ÂèñÈúÄË¶ÅÊ∏≤ÊüìÁöÑËÆæÂ§áIDÈõÜÂêà
    const neededDeviceIds = new Set(deviceList.map(d => d.id));

    // Âà†Èô§‰∏çÂÜçÂ≠òÂú®ÁöÑËÆæÂ§áÂç°Áâá
    existingCards.forEach(card => {
        const deviceId = card.dataset.deviceId;
        if (deviceId && !neededDeviceIds.has(deviceId)) {
            card.remove();
            deviceCardCache.delete(deviceId);
        }
    });

    // ÂàõÂª∫ÊàñÊõ¥Êñ∞ËÆæÂ§áÂç°Áâá
    deviceList.forEach((device, index) => {
        let card = grid.querySelector(`.device-card[data-device-id="${device.id}"]`);
        
        if (!card) {
            // ÂàõÂª∫Êñ∞Âç°Áâá
            const fragment = template.content.cloneNode(true);
            card = fragment.querySelector('.device-card');
            card.dataset.deviceId = device.id;
            
            // ÊèíÂÖ•Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
            const nextCard = Array.from(grid.children).find(child => {
                const nextDevice = deviceList.find(d => d.id === child.dataset.deviceId);
                return nextDevice && deviceList.indexOf(nextDevice) > index;
            });
            if (nextCard) {
                grid.insertBefore(card, nextCard);
            } else {
                grid.appendChild(card);
            }
            
            deviceCardCache.set(device.id, card);
        }
        
        // Êõ¥Êñ∞Âç°ÁâáÂÜÖÂÆπÔºàÂ¢ûÈáèÊõ¥Êñ∞Ôºâ
        updateDeviceCard(card, device);
    });

    if (!deviceList.some(device => device.id === activeDeviceId)) {
        activeDeviceId = deviceList[0]?.id || null;
    }

    renderSidebar();
    updateActiveIndicators();
    
    // Â¶ÇÊûúÂ§Ñ‰∫éÂè™ËØªÊ®°ÂºèÔºåÈáçÊñ∞Â∫îÁî®ÊùÉÈôêËÆæÁΩÆÔºàÁ°Æ‰øùÂä®ÊÄÅÂàõÂª∫ÁöÑÂÖÉÁ¥†‰πüË¢´Á¶ÅÁî®Ôºâ
    if (isReadOnlyMode) {
        setTimeout(() => {
            applyPermissionSettings();
        }, 100);
    }
}

// Êõ¥Êñ∞Âçï‰∏™ËÆæÂ§áÂç°ÁâáÔºàÂ¢ûÈáèÊõ¥Êñ∞ÔºåÈÅøÂÖçÈáçÊñ∞ÂàõÂª∫DOMÔºâ
function updateDeviceCard(card, device) {
    if (!card || !device) return;

    // Âè™Âú®È¶ñÊ¨°ÂàõÂª∫Êó∂ÁªëÂÆö‰∫ã‰ª∂ÔºåÈÅøÂÖçÈáçÂ§çÁªëÂÆö
    if (!card.dataset.eventsBound) {
        // ÁªëÂÆöÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂ÔºàÂè™ËØªÊ®°Âºè‰∏ãÁ¶ÅÁî®Ôºâ
        if (!isReadOnlyMode) {
            card.addEventListener('click', function(e) {
                if (e.target.closest('.edit-device-info-btn')) return; // ÁÇπÂáªÁºñËæëÊåâÈíÆÊó∂‰∏çËß¶Âèë
                e.stopPropagation();
                setActiveDevice(device.id);
                if (typeof window.enterDevice === 'function') {
                    window.enterDevice(device.id);
                }
            });
        } else {
            // Âè™ËØªÊ®°Âºè‰∏ãÁ¶ÅÁî®Âç°ÁâáÁÇπÂáª
            card.style.pointerEvents = 'none';
            card.style.opacity = '0.7';
            card.style.cursor = 'not-allowed';
            // Ê∑ªÂä†ËßÜËßâÊèêÁ§∫
            card.title = 'Âè™ËØªÊ®°ÂºèÔºöÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÁÇπÂáªËÆæÂ§á';
        }
        
        // ÁªëÂÆöÁºñËæëÊåâÈíÆ‰∫ã‰ª∂ÔºàÂè™ËØªÊ®°Âºè‰∏ãÁ¶ÅÁî®Ôºâ
        const editBtn = card.querySelector('.edit-device-info-btn');
        if (editBtn) {
            editBtn.dataset.deviceId = device.id;
            if (isReadOnlyMode) {
                editBtn.disabled = true;
                editBtn.style.opacity = '0.5';
                editBtn.style.cursor = 'not-allowed';
                editBtn.style.pointerEvents = 'none';
            } else {
                // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
                const newEditBtn = editBtn.cloneNode(true);
                editBtn.parentNode.replaceChild(newEditBtn, editBtn);
                // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
                const currentEditBtn = card.querySelector('.edit-device-info-btn');
                if (currentEditBtn) {
                    currentEditBtn.dataset.deviceId = device.id;
                    currentEditBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        openEditDeviceInfoModal(e);
                    });
                }
            }
        }
        
        // ÁªëÂÆöÈ¢ÑÁ∫¶Á≠âÂÄôÊåâÈíÆ‰∫ã‰ª∂ÔºàÂè™ËØªÊ®°Âºè‰∏ãÁ¶ÅÁî®Ôºâ
        const waitingSamplesBtn = card.querySelector('[data-field="waitingSamplesBtn"]');
        if (waitingSamplesBtn) {
            waitingSamplesBtn.dataset.deviceId = device.id;
            if (isReadOnlyMode) {
                waitingSamplesBtn.disabled = true;
                waitingSamplesBtn.style.opacity = '0.5';
                waitingSamplesBtn.style.cursor = 'not-allowed';
                waitingSamplesBtn.style.pointerEvents = 'none';
            } else {
                waitingSamplesBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openWaitingSampleFormModal(device.id);
                });
            }
        }
        
        card.dataset.eventsBound = 'true';
    }

    // Êõ¥Êñ∞ËÆæÂ§áID
    const idSpan = card.querySelector('[data-field="deviceId"]');
    if (idSpan && idSpan.textContent !== (device.name || device.id)) {
        idSpan.textContent = device.name || device.id;
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅ
    const statusWrapper = card.querySelector('[data-field="statusWrapper"]');
    if (statusWrapper) {
        const newClassName = `device-status ${device.status || 'running'}`;
        if (statusWrapper.className !== newClassName) {
            statusWrapper.className = newClassName;
        }
    }
    const statusText = card.querySelector('[data-field="statusText"]');
    if (statusText) {
        const newStatusText = DEVICE_STATUS_TEXT[device.status] || 'ËøêË°å';
        if (statusText.textContent !== newStatusText) {
            statusText.textContent = newStatusText;
        }
    }

    // Êõ¥Êñ∞Ê∏©Â∫¶ÔºàÂè™Âú®ÂÄºÂèòÂåñÊó∂Êõ¥Êñ∞Ôºâ
    const tempField = card.querySelector('[data-field="temperature"]');
    if (tempField) {
        const tempValue = Number(device.temperature || 0).toFixed(2);
        const newTempHtml = `${tempValue}<span class="unit">‚ÑÉ</span>`;
        if (tempField.innerHTML !== newTempHtml) {
            tempField.innerHTML = newTempHtml;
        }
    }
    
    // Êõ¥Êñ∞ÊπøÂ∫¶ÔºàÂè™Âú®ÂÄºÂèòÂåñÊó∂Êõ¥Êñ∞Ôºâ
    const humidityField = card.querySelector('[data-field="humidity"]');
    if (humidityField) {
        const humidityValue = Number(device.humidity || 0).toFixed(2);
        const newHumidityHtml = `${humidityValue}<span class="unit">%</span>`;
        if (humidityField.innerHTML !== newHumidityHtml) {
            humidityField.innerHTML = newHumidityHtml;
        }
    }

    // Êõ¥Êñ∞ËøêË°åÊó∂Èó¥
    const runtimeField = card.querySelector('[data-field="runtime"]');
    if (runtimeField && runtimeField.textContent !== device.runtime) {
        runtimeField.textContent = device.runtime || '0H 00M 00S';
    }
    
    // Êõ¥Êñ∞Ââ©‰ΩôÊó∂Èó¥
    const remainingField = card.querySelector('[data-field="remaining"]');
    if (remainingField && remainingField.textContent !== device.remaining) {
        remainingField.textContent = device.remaining || '--';
    }
    
    // Êõ¥Êñ∞Ê®°Âºè
    const modeField = card.querySelector('[data-field="mode"]');
    if (modeField && modeField.textContent !== device.mode) {
        modeField.textContent = device.mode || 'ÂÆöÂÄºËØïÈ™å';
    }

    // Êõ¥Êñ∞Ê∏©Â∫¶ÂäüÁéá
    const tempPowerField = card.querySelector('[data-field="tempPower"]');
    if (tempPowerField) {
        const newTempPower = `${device.tempPower ?? 0}%`;
        if (tempPowerField.textContent !== newTempPower) {
            tempPowerField.textContent = newTempPower;
        }
    }
    
    // Êõ¥Êñ∞ÊπøÂ∫¶ÂäüÁéá
    const humidityPowerField = card.querySelector('[data-field="humidityPower"]');
    if (humidityPowerField) {
        const newHumidityPower = `${device.humidityPower ?? 0}%`;
        if (humidityPowerField.textContent !== newHumidityPower) {
            humidityPowerField.textContent = newHumidityPower;
        }
    }

    // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
    const connectionWrapper = card.querySelector('[data-field="connectionWrapper"]');
    if (connectionWrapper) {
        const newConnectionClass = `connection-status ${device.moduleConnection || 'unknown'} ${device.moduleConnectionColorClass || ''}`;
        if (connectionWrapper.className !== newConnectionClass) {
            connectionWrapper.className = newConnectionClass;
        }
    }
    const connectionText = card.querySelector('[data-field="connectionText"]');
    if (connectionText && connectionText.textContent !== device.moduleConnectionText) {
        connectionText.textContent = device.moduleConnectionText || 'Áä∂ÊÄÅÊú™Áü•';
    }
    
    // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
    const lastUpdate = card.querySelector('[data-field="lastUpdate"]');
    if (lastUpdate) {
        const newLastUpdate = `Êõ¥Êñ∞: ${device.lastUpdate || 'ÂàöÂàö'}`;
        if (lastUpdate.textContent !== newLastUpdate) {
            lastUpdate.textContent = newLastUpdate;
        }
    }
    
    // Êõ¥Êñ∞È¢ÑÁ∫¶Á≠âÂÄôÂå∫ÂüüÔºàÈªòËÆ§ÂßãÁªàÊòæÁ§∫Ôºâ
    const waitingSamplesContainer = card.querySelector('[data-field="waitingSamplesContainer"]');
    const waitingSamplesDisplay = card.querySelector('[data-field="waitingSamplesDisplay"]');
    if (waitingSamplesContainer && waitingSamplesDisplay) {
        // Á°Æ‰øùÂå∫ÂüüÂßãÁªàÊòæÁ§∫
        waitingSamplesContainer.style.display = 'flex';
        
        const waitingSamples = device.waitingSamples || device.raw?.waitingSamples || [];
        
        if (waitingSamples && waitingSamples.length > 0) {
            // ÊúâÈ¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅÔºåÊõ¥Êñ∞ÂàóË°®
            waitingSamplesDisplay.innerHTML = '';
            
            waitingSamples.forEach((sample, index) => {
                const tag = document.createElement('span');
                tag.className = 'waiting-sample-tag';
                
                // ÊûÑÂª∫ÊòæÁ§∫ÊñáÊú¨Ôºà‰∏éÊµãËØïÊ†∑ÂìÅÂ±ïÁ§∫‰∏ÄÊ†∑Ôºâ
                const tester = sample.tester || '';
                const model = sample.model || '';
                const category = sample.category || '';
                
                let displayText = '';
                if (tester) {
                    displayText = tester;
                    if (model) {
                        displayText += `-${model}`;
                    }
                    if (category) {
                        displayText += `-${category}`;
                    }
                } else if (model) {
                    displayText = model;
                    if (category) {
                        displayText += `-${category}`;
                    }
                } else if (category) {
                    displayText = category;
                } else {
                    displayText = 'Êú™ÂëΩÂêçÊ†∑ÂìÅ';
                }
                
                tag.innerHTML = `<span class="waiting-sample-tag-text">${displayText}</span>`;
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÊòæÁ§∫Ê†∑ÂìÅËØ¶ÊÉÖ
                tag.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (typeof showSampleInfo === 'function') {
                        showSampleInfo(sample);
                    }
                });
                
                waitingSamplesDisplay.appendChild(tag);
            });
        } else {
            // Ê≤°ÊúâÈ¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅÔºåÊòæÁ§∫ÊèêÁ§∫‰ø°ÊÅØ
            waitingSamplesDisplay.innerHTML = '<span style="color: #94a3b8; font-size: 11px; font-style: italic;">ÊöÇÊó†È¢ÑÁ∫¶Á≠âÂÄôÊ†∑ÂìÅ</span>';
        }
    }
    
    // Êõ¥Êñ∞Ê†∑ÂìÅÊ†áÁ≠æÊòæÁ§∫
    const samplesContainer = card.querySelector('[data-field="samplesContainer"]');
    if (samplesContainer) {
        const samples = device.samples || [];
        samplesContainer.innerHTML = '';
        
        if (samples.length === 0) {
            // Â¶ÇÊûúÊ≤°ÊúâÊ†∑ÂìÅÔºåÊòæÁ§∫ÊèêÁ§∫
            const emptyTag = document.createElement('span');
            emptyTag.className = 'sample-tag';
            emptyTag.style.opacity = '0.6';
            emptyTag.style.cursor = 'default';
            emptyTag.textContent = 'ÊöÇÊó†Ê†∑ÂìÅ';
            samplesContainer.appendChild(emptyTag);
        } else {
            // ÊòæÁ§∫ÊâÄÊúâÊ†∑ÂìÅÊ†áÁ≠æÔºåÊ®™ÂêëÊéíÂàó
            samples.forEach((sample, index) => {
                const tag = document.createElement('span');
                tag.className = 'sample-tag';
                
                // ÊòæÁ§∫È°∫Â∫èÔºöÊµãËØï‰∫∫Âëò -> ÂûãÂè∑ -> ÂìÅÁ±ª
                const tester = sample.tester || '';
                const model = sample.model || '';
                const category = sample.category || '';
                
                let displayText = '';
                if (tester) {
                    displayText = tester;
                    if (model) {
                        displayText += `-${model}`;
                    }
                    if (category) {
                        displayText += `-${category}`;
                    }
                } else if (model) {
                    displayText = model;
                    if (category) {
                        displayText += `-${category}`;
                    }
                } else if (category) {
                    displayText = category;
                } else {
                    displayText = 'Êú™ÂëΩÂêçÊ†∑ÂìÅ';
                }
                
                tag.innerHTML = `<span class="sample-tag-text">${displayText}</span>`;
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÊòæÁ§∫Ê†∑ÂìÅËØ¶ÊÉÖ
                tag.addEventListener('click', function(e) {
                    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂç°ÁâáÁÇπÂáª
                    showSampleInfo(sample);
                });
                
                // Â≠òÂÇ®ÂÆåÊï¥ÁöÑÊ†∑ÂìÅÊï∞ÊçÆÂà∞Ê†áÁ≠æ‰∏äÔºåÊñπ‰æøÁÇπÂáªÊó∂‰ΩøÁî®
                tag.dataset.sampleData = JSON.stringify(sample);
                
                samplesContainer.appendChild(tag);
            });
        }
    }
    
    // Êõ¥Êñ∞ÁºñËæëÊåâÈíÆÁöÑËÆæÂ§áID
    const editBtn = card.querySelector('.edit-device-info-btn');
    if (editBtn) {
        editBtn.dataset.deviceId = device.id;
    }
}

function removeDevice(deviceId) {
    // Ê£ÄÊü•Áî®Êà∑ÊùÉÈôê
    if (!hasDeletePermission()) {
        const username = localStorage.getItem('username') || 'ÂΩìÂâçÁî®Êà∑';
        showAlert(
            `Êä±Ê≠âÔºåÊÇ®Ôºà${username}ÔºâÊ≤°ÊúâÂà†Èô§ËÆæÂ§áÁöÑÊùÉÈôêÔºÅ\n\nÂ¶ÇÈúÄÂà†Èô§ËÆæÂ§áÔºåËØ∑ËÅîÁ≥ªÁ≥ªÁªüÁÆ°ÁêÜÂëò„ÄÇ`, 
            'ÊùÉÈôê‰∏çË∂≥', 
            'warning'
        );
        return;
    }
    
    const device = deviceList.find(d => d.id === deviceId);
    const deviceName = device ? (device.name || device.id) : deviceId;
    
    // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËÆæÂ§á "${deviceName}" ÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞Ü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§Ê≠§ËÆæÂ§áÔºå‰ΩÜÂéÜÂè≤Êï∞ÊçÆ‰ºö‰øùÁïô„ÄÇ\n\nÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`)) {
        return;
    }
    
    // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂêçÔºà‰ªéÊú¨Âú∞ÁºìÂ≠òÔºâ
    const currentUsername = localStorage.getItem('username') || '';
    
    // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
    fetch('/iot/device/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            username: currentUsername  // ‰º†ÈÄíÁî®Êà∑ÂêçÁî®‰∫éÂêéÁ´ØÊùÉÈôêÈ™åËØÅ
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(
                `ËÆæÂ§á "${deviceName}" Â∑≤ÊàêÂäü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§ÔºÅ\n\n- Â∑≤‰ªéÊï∞ÊçÆÂ∫ìÂà†Èô§\n- Â∑≤Ê∏ÖÈô§RedisÁºìÂ≠ò\n\nÈ°µÈù¢Â∞ÜÁ´ãÂç≥Âà∑Êñ∞`, 
                'Âà†Èô§ÊàêÂäü', 
                'success'
            );
            
            // Á´ãÂç≥Âà∑Êñ∞ËÆæÂ§áÂàóË°®Ôºà‰∏çÂª∂ËøüÔºåÁ°Æ‰øùÂà†Èô§ÁöÑËÆæÂ§áÁ´ãÂç≥‰ªéÂàóË°®‰∏≠ÁßªÈô§Ôºâ
            refreshDevicesFromServer();
        } else {
            showAlert(
                'Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ') + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
                'Âà†Èô§Â§±Ë¥•', 
                'error'
            );
        }
    })
    .catch(error => {
        console.error('Âà†Èô§ËÆæÂ§áÂ§±Ë¥•:', error);
        showAlert(
            'Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
            'Âà†Èô§Â§±Ë¥•', 
            'error'
        );
    });
}

// ÊâìÂºÄÊ∑ªÂä†ËÆæÂ§áÊ®°ÊÄÅÊ°Ü
function openAddDeviceModal() {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏ÊâìÂºÄ
    if (isReadOnlyMode) {
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÊ∑ªÂä†ËÆæÂ§á', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const modal = document.getElementById('deviceFormModal');
    const deviceIdInput = document.getElementById('deviceIdInput');
    const deviceManageSection = document.getElementById('deviceManageSection');
    
    if (!modal || !deviceIdInput) return;
    
    // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
    deviceIdInput.value = '';
    
    // Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶‰∏∫Âç¢ÂÅ•ÊàñÊà¥ÊùèÂçéÔºåÂÜ≥ÂÆöÊòØÂê¶ÊòæÁ§∫ËÆæÂ§áÁÆ°ÁêÜÂå∫Âüü
    const username = localStorage.getItem('username') || '';
    if (deviceManageSection) {
        if (hasDeletePermission()) {
            deviceManageSection.style.display = 'block';
            // Âä†ËΩΩËÆæÂ§áÂàóË°®
            loadDeviceManageList();
        } else {
            deviceManageSection.style.display = 'none';
        }
    }
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    
    // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
    setTimeout(() => deviceIdInput.focus(), 100);
}

// Âä†ËΩΩËÆæÂ§áÁÆ°ÁêÜÂàóË°®
function loadDeviceManageList() {
    const deviceManageList = document.getElementById('deviceManageList');
    if (!deviceManageList) return;
    
    deviceManageList.innerHTML = '<div style="text-align: center; padding: 20px; color: #78350f; opacity: 0.7;">Âä†ËΩΩ‰∏≠...</div>';
    
    // ‰ªéÂÖ®Â±ÄËÆæÂ§áÂàóË°®Ëé∑ÂèñÊï∞ÊçÆÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ªéÊúçÂä°Âô®Ëé∑Âèñ
    if (deviceList && deviceList.length > 0) {
        renderDeviceManageList(deviceList);
    } else {
        // ‰ªéÊúçÂä°Âô®Ëé∑ÂèñËÆæÂ§áÂàóË°®
        fetch('/iot/data/devices', { cache: 'no-store' })
            .then(response => response.json())
            .then(data => {
                if (Array.isArray(data) && data.length > 0) {
                    const transformed = data.map((item, index) => transformDeviceRecord(item, index));
                    renderDeviceManageList(transformed);
                } else {
                    deviceManageList.innerHTML = '<div style="text-align: center; padding: 20px; color: #78350f; opacity: 0.7;">ÊöÇÊó†ËÆæÂ§á</div>';
                }
            })
            .catch(error => {
                console.error('Âä†ËΩΩËÆæÂ§áÂàóË°®Â§±Ë¥•:', error);
                deviceManageList.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444; opacity: 0.7;">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div>';
            });
    }
}

// Ê∏≤ÊüìËÆæÂ§áÁÆ°ÁêÜÂàóË°®
function renderDeviceManageList(devices) {
    const deviceManageList = document.getElementById('deviceManageList');
    if (!deviceManageList) return;
    
    if (!devices || devices.length === 0) {
        deviceManageList.innerHTML = '<div style="text-align: center; padding: 20px; color: #78350f; opacity: 0.7;">ÊöÇÊó†ËÆæÂ§á</div>';
        return;
    }
    
    deviceManageList.innerHTML = '';
    
    devices.forEach((device, index) => {
        const deviceItem = document.createElement('div');
        deviceItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: rgba(255, 255, 255, 0.8); border-radius: 8px; border: 1px solid rgba(251, 191, 36, 0.3); transition: all 0.2s ease;';
        
        deviceItem.innerHTML = `
            <div style="flex: 1;">
                <div style="font-weight: 600; color: #92400e; margin-bottom: 4px; font-size: 14px;">${device.name || device.id}</div>
                <div style="font-size: 12px; color: #78350f; opacity: 0.7;">
                    Áä∂ÊÄÅ: ${DEVICE_STATUS_TEXT[device.status] || 'Êú™Áü•'} | Ê®°Âºè: ${device.mode || '--'}
                </div>
            </div>
            <button class="device-manage-delete-btn" data-device-id="${device.id}" style="padding: 6px 14px; border-radius: 6px; border: 1.5px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #ef4444; font-weight: 600; cursor: pointer; font-size: 12px; transition: all 0.2s ease; white-space: nowrap;">
                üóëÔ∏è Âà†Èô§
            </button>
        `;
        
        // Ê∑ªÂä†ÊÇ¨ÂÅúÊïàÊûú
        deviceItem.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 8px rgba(251, 191, 36, 0.2)';
        });
        deviceItem.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = 'none';
        });
        
        // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
        const deleteBtn = deviceItem.querySelector('.device-manage-delete-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                const deviceId = this.dataset.deviceId;
                if (deviceId) {
                    deleteDeviceFromManageList(deviceId);
                }
            });
            
            // Âà†Èô§ÊåâÈíÆÊÇ¨ÂÅúÊïàÊûú
            deleteBtn.addEventListener('mouseenter', function() {
                this.style.background = 'rgba(239, 68, 68, 0.2)';
                this.style.borderColor = '#ef4444';
                this.style.transform = 'scale(1.05)';
            });
            deleteBtn.addEventListener('mouseleave', function() {
                this.style.background = 'rgba(239, 68, 68, 0.1)';
                this.style.borderColor = '#ef4444';
                this.style.transform = 'scale(1)';
            });
        }
        
        deviceManageList.appendChild(deviceItem);
    });
}

// ‰ªéÁÆ°ÁêÜÂàóË°®‰∏≠Âà†Èô§ËÆæÂ§á
function deleteDeviceFromManageList(deviceId) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏Âà†Èô§
    if (isReadOnlyMode) {
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÂà†Èô§ËÆæÂ§á', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const device = deviceList.find(d => d.id === deviceId);
    const deviceName = device ? (device.name || device.id) : deviceId;
    
    // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËÆæÂ§á "${deviceName}" ÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞Ü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§Ê≠§ËÆæÂ§áÔºå‰ΩÜÂéÜÂè≤Êï∞ÊçÆ‰ºö‰øùÁïô„ÄÇ\n\nÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`)) {
        return;
    }
    
    // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂêçÔºà‰ªéÊú¨Âú∞ÁºìÂ≠òÔºâ
    const currentUsername = localStorage.getItem('username') || '';
    
    // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
    fetch('/iot/device/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            username: currentUsername  // ‰º†ÈÄíÁî®Êà∑ÂêçÁî®‰∫éÂêéÁ´ØÊùÉÈôêÈ™åËØÅ
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(
                `ËÆæÂ§á "${deviceName}" Â∑≤ÊàêÂäü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§ÔºÅ\n\n- Â∑≤‰ªéÊï∞ÊçÆÂ∫ìÂà†Èô§\n- Â∑≤Ê∏ÖÈô§RedisÁºìÂ≠ò`, 
                'Âà†Èô§ÊàêÂäü', 
                'success'
            );
            
            // ÈáçÊñ∞Âä†ËΩΩËÆæÂ§áÁÆ°ÁêÜÂàóË°®
            loadDeviceManageList();
            
            // Âà∑Êñ∞‰∏ªËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert(
                'Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ') + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
                'Âà†Èô§Â§±Ë¥•', 
                'error'
            );
        }
    })
    .catch(error => {
        console.error('Âà†Èô§ËÆæÂ§áÂ§±Ë¥•:', error);
        showAlert(
            'Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
            'Âà†Èô§Â§±Ë¥•', 
            'error'
        );
    });
}

// ÂÖ≥Èó≠Ê∑ªÂä†ËÆæÂ§áÊ®°ÊÄÅÊ°Ü
function closeAddDeviceModal() {
    const modal = document.getElementById('deviceFormModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ÂΩìÂâçÊ≠£Âú®ÁÆ°ÁêÜÁöÑËÆæÂ§áID
let currentManagingDeviceId = null;

// ÊâìÂºÄÁºñËæëËÆæÂ§á‰ø°ÊÅØÊ®°ÊÄÅÊ°ÜÔºàÊ†∑ÂìÅÁÆ°ÁêÜÔºâ
function openEditDeviceInfoModal(event) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏ÊâìÂºÄ
    if (isReadOnlyMode) {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÁºñËæëËÆæÂ§á‰ø°ÊÅØ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    if (event) {
        event.stopPropagation();
    }
    
    const modal = document.getElementById('editDeviceInfoModal');
    const deviceIdInput = document.getElementById('editDeviceInfoId');
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    const samplesListContainer = document.getElementById('samplesListContainer');
    
    if (!modal || !deviceIdInput) return;
    
    // Ëé∑ÂèñËÆæÂ§áIDÔºà‰ªéÊåâÈíÆÁöÑdataÂ±ûÊÄßÊàñ‰∫ã‰ª∂ÁõÆÊ†áËé∑ÂèñÔºâ
    let deviceId = null;
    if (event && event.currentTarget) {
        deviceId = event.currentTarget.dataset.deviceId;
    } else if (event && event.target) {
        const btn = event.target.closest('.edit-device-info-btn');
        if (btn) {
            deviceId = btn.dataset.deviceId;
        }
    }
    
    if (!deviceId) {
        showAlert('Êó†Ê≥ïËé∑ÂèñËÆæÂ§áID', 'ÈîôËØØ', 'error');
        return;
    }
    
    currentManagingDeviceId = deviceId;
    
    // Â°´ÂÖÖËÆæÂ§áID
    deviceIdInput.value = deviceId;
    
    // Ê∏ÖÁ©∫Ê∑ªÂä†Ë°®Âçï
    if (categoryInput) categoryInput.value = '';
    if (modelInput) modelInput.value = '';
    
    // Ëá™Âä®Â°´ÂÖÖÊµãËØï‰∫∫ÂëòÂ≠óÊÆµÔºà‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òÁöÑusernameÔºå‰ΩÜÂÖÅËÆ∏Áî®Êà∑‰øÆÊîπÔºâ
    const username = localStorage.getItem('username') || '';
    if (testerInput) {
        testerInput.value = username;
        testerInput.readOnly = false; // ÂÖÅËÆ∏Áî®Êà∑‰øÆÊîπ
    }
    
    // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑ÊòæÁ§∫
    const currentUserDisplay = document.getElementById('currentUserDisplay');
    if (currentUserDisplay) {
        currentUserDisplay.textContent = username || 'Êú™ÁôªÂΩï';
    }
    
    // ËÅöÁÑ¶Âà∞ÂûãÂè∑ËæìÂÖ•Ê°ÜÔºàÁ¨¨‰∏Ä‰∏™Â≠óÊÆµÔºâ
    if (modelInput) {
        setTimeout(() => {
            modelInput.focus();
        }, 100);
    }
    
    // Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
    loadSamplesList(deviceId, samplesListContainer);
    
    // ÂàùÂßãÂåñÈ¢ÑÁ∫¶ËÆæÁΩÆÊåâÈíÆ
    const appointmentOff = document.getElementById('sampleAppointmentOff');
    const appointmentOn = document.getElementById('sampleAppointmentOn');
    const appointmentStatus = document.getElementById('sampleAppointmentStatus');
    
    // ÁßªÈô§‰πãÂâçÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
    if (appointmentOff && appointmentOn) {
        // ÈáçÁΩÆ‰∏∫ÈªòËÆ§Áä∂ÊÄÅÔºàÁõ¥Êé•ÊµãËØïÔºâ
        appointmentOff.classList.add('active');
        appointmentOn.classList.remove('active');
        if (appointmentStatus) {
            appointmentStatus.textContent = 'ÂΩìÂâçÔºöÁõ¥Êé•ÊµãËØïÔºàÁä∂ÊÄÅÔºöTESTINGÔºâ';
        }
        
        // ÁªëÂÆö‰∫ã‰ª∂
        appointmentOff.onclick = () => {
            appointmentOff.classList.add('active');
            appointmentOn.classList.remove('active');
            if (appointmentStatus) {
                appointmentStatus.textContent = 'ÂΩìÂâçÔºöÁõ¥Êé•ÊµãËØïÔºàÁä∂ÊÄÅÔºöTESTINGÔºâ';
            }
        };
        
        appointmentOn.onclick = () => {
            appointmentOn.classList.add('active');
            appointmentOff.classList.remove('active');
            if (appointmentStatus) {
                appointmentStatus.textContent = 'ÂΩìÂâçÔºöÈ¢ÑÁ∫¶Á≠âÂÄôÔºàÁä∂ÊÄÅÔºöWAITINGÔºâ';
            }
        };
    }
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    
    // ËÅöÁÑ¶Á¨¨‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
    setTimeout(() => {
        if (categoryInput) categoryInput.focus();
    }, 100);
}

// Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
function loadSamplesList(deviceId, container) {
    if (!container) return;
    
    container.innerHTML = `
        <div class="sample-empty-state">
            <div class="sample-empty-state-icon">‚è≥</div>
            <div class="sample-empty-state-text">Âä†ËΩΩ‰∏≠...</div>
        </div>
    `;
    
    // Êõ¥Êñ∞Ê†∑ÂìÅÊï∞ÈáèÊòæÁ§∫
    const samplesCount = document.getElementById('samplesCount');
    if (samplesCount) {
        samplesCount.textContent = 'Âä†ËΩΩ‰∏≠...';
    }
    
    fetch(`/iot/device/samples?device_id=${encodeURIComponent(deviceId)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.samples) {
                renderSamplesList(data.samples, container);
            } else {
                renderSamplesList([], container);
            }
        })
        .catch(error => {
            console.error('Âä†ËΩΩÊ†∑ÂìÅÂàóË°®Â§±Ë¥•:', error);
            container.innerHTML = `
                <div class="sample-empty-state">
                    <div class="sample-empty-state-icon">‚ùå</div>
                    <div class="sample-empty-state-text">Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑ÈáçËØï</div>
                </div>
            `;
            // Êõ¥Êñ∞Ê†∑ÂìÅÊï∞ÈáèÊòæÁ§∫
            const samplesCount = document.getElementById('samplesCount');
            if (samplesCount) {
                samplesCount.textContent = 'Âä†ËΩΩÂ§±Ë¥•';
            }
        });
}

// Ê†ºÂºèÂåñÊó∂Èó¥ÊòæÁ§∫
function formatSampleTime(timestamp) {
    if (!timestamp) return 'Êú™Áü•';
    try {
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) {
            return 'Êú™Áü•';
        }
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    } catch (e) {
        return 'Êú™Áü•';
    }
}

// Ëé∑ÂèñÁä∂ÊÄÅÊòæÁ§∫ÊñáÊú¨
function getStatusDisplay(status) {
    if (!status) {
        return '<span style="color: #64748b;">Êú™Áü•</span>';
    }
    switch (status) {
        case 'WAITING':
            return '<span style="color: #f59e0b; font-weight: 600;">‚è≥ È¢ÑÁ∫¶Á≠âÂÄô</span>';
        case 'TESTING':
            return '<span style="color: #10b981; font-weight: 600;">üîÑ ÊµãËØï‰∏≠</span>';
        case 'COMPLETED':
            return '<span style="color: #64748b; font-weight: 600;">‚úÖ ÊµãËØïÂÆåÊàê</span>';
        case 'CANCELLED':
            return '<span style="color: #ef4444; font-weight: 600;">‚ùå Â∑≤ÂèñÊ∂à</span>';
        default:
            return `<span style="color: #64748b;">${status}</span>`;
    }
}

// Ê∏≤ÊüìÊ†∑ÂìÅÂàóË°®
function renderSamplesList(samples, container) {
    if (!samples || samples.length === 0) {
        container.innerHTML = `
            <div class="sample-empty-state">
                <div class="sample-empty-state-icon">üì¶</div>
                <div class="sample-empty-state-text">ÊöÇÊó†Ê†∑ÂìÅÔºåËØ∑Âú®‰∏ãÊñπÊ∑ªÂä†</div>
            </div>
        `;
        // Êõ¥Êñ∞Ê†∑ÂìÅÊï∞ÈáèÊòæÁ§∫
        const samplesCount = document.getElementById('samplesCount');
        if (samplesCount) {
            samplesCount.textContent = '0 ‰∏™Ê†∑ÂìÅ';
        }
        return;
    }
    
    // Ê†πÊçÆ status Â≠óÊÆµËøáÊª§Ê†∑ÂìÅÔºöÂè™ÊòæÁ§∫ÊµãËØï‰∏≠(TESTING)ÂíåÈ¢ÑÁ∫¶Á≠âÂÄô(WAITING)ÁöÑÊ†∑ÂìÅÔºå‰∏çÊòæÁ§∫ÊµãËØïÂÆåÊàê(COMPLETED)ÂíåÂ∑≤ÂèñÊ∂à(CANCELLED)ÁöÑÊ†∑ÂìÅ
    const activeSamples = samples.filter(sample => {
        const status = sample.status;
        
        // Â¶ÇÊûúÊ≤°Êúâ status Â≠óÊÆµÔºåÂèØËÉΩÊòØÊóßÊï∞ÊçÆÔºå‰øùÁïôÔºàÂêëÂêéÂÖºÂÆπÔºâ
        if (!status) {
            return true;
        }
        
        // Âè™ÊòæÁ§∫ TESTINGÔºàÊµãËØï‰∏≠ÔºâÂíå WAITINGÔºàÈ¢ÑÁ∫¶Á≠âÂÄôÔºâÁöÑÊ†∑ÂìÅ
        // ‰∏çÊòæÁ§∫ COMPLETEDÔºàÊµãËØïÂÆåÊàêÔºâÂíå CANCELLEDÔºàÂ∑≤ÂèñÊ∂àÔºâÁöÑÊ†∑ÂìÅ
        return status === 'TESTING' || status === 'WAITING';
    });
    
    // ÊåâÂàõÂª∫Êó∂Èó¥Ê≠£Â∫èÊéíÂ∫èÔºà‰ªéÊó©Âà∞ÊôöÔºâ
    const sortedSamples = [...activeSamples].sort((a, b) => {
        const timeA = a.created_at || a.createdAt || '';
        const timeB = b.created_at || b.createdAt || '';
        
        if (!timeA && !timeB) return 0;
        if (!timeA) return 1; // Ê≤°ÊúâÂàõÂª∫Êó∂Èó¥ÁöÑÊéíÂú®ÂêéÈù¢
        if (!timeB) return -1; // Ê≤°ÊúâÂàõÂª∫Êó∂Èó¥ÁöÑÊéíÂú®ÂêéÈù¢
        
        // ÂçáÂ∫èÊéíÂ∫èÔºöÊó©ÁöÑÊó∂Èó¥Âú®ÂâçÔºåÊôöÁöÑÊó∂Èó¥Âú®Âêé
        if (timeA < timeB) return -1;
        if (timeA > timeB) return 1;
        return 0;
    });
    
    container.innerHTML = '';
    
    // Êõ¥Êñ∞Ê†∑ÂìÅÊï∞ÈáèÊòæÁ§∫
    const samplesCount = document.getElementById('samplesCount');
    if (samplesCount) {
        samplesCount.textContent = `${sortedSamples.length} ‰∏™Ê†∑ÂìÅ`;
    }
    
    // Ê£ÄÊü•ÊµãËØï‰∫∫ÂëòÊòØÂê¶‰∏éÂΩìÂâçÁôªÂΩïÁî®Êà∑‰∏ÄËá¥
    const currentUsername = localStorage.getItem('username') || '';
    
    sortedSamples.forEach((sample, index) => {
        const sampleCard = document.createElement('div');
        sampleCard.className = 'sample-card';
        sampleCard.setAttribute('data-sample-id', sample.id); // Ê∑ªÂä†Ê†∑ÂìÅIDÂ±ûÊÄßÔºåÊñπ‰æøÂà†Èô§Êó∂ÂÆö‰Ωç
        
        const sampleTester = sample.tester || '';
        const canEdit = currentUsername && sampleTester && currentUsername === sampleTester;
        
        // ÊûÑÂª∫Ê†∑ÂìÅÂêçÁß∞
        const category = sample.category || 'Êú™ÂàÜÁ±ª';
        const model = sample.model || 'Êú™ËÆæÁΩÆ';
        const sampleName = category && model ? `${category} - ${model}` : (category || model || 'Êú™ÂëΩÂêçÊ†∑ÂìÅ');
        
        // Ê†ºÂºèÂåñÊó∂Èó¥
        const createdAt = formatSampleTime(sample.created_at || sample.createdAt);
        const updatedAt = formatSampleTime(sample.updated_at || sample.updatedAt);
        
        sampleCard.innerHTML = `
            <div class="sample-card-header">
                <div class="sample-card-title">
                    <span class="sample-card-number">${String(index + 1).padStart(2, '0')}</span>
                    <h3 class="sample-card-name">${sampleName}</h3>
                </div>
            </div>
            <div class="sample-card-body">
                <div class="sample-info-item">
                    <div class="sample-info-label">üì¶ ÂìÅÁ±ª</div>
                    <div class="sample-info-value ${!sample.category ? 'empty' : ''}">${sample.category || 'Êú™ËÆæÁΩÆ'}</div>
                </div>
                <div class="sample-info-item">
                    <div class="sample-info-label">üîß ÂûãÂè∑</div>
                    <div class="sample-info-value ${!sample.model ? 'empty' : ''}">${sample.model || 'Êú™ËÆæÁΩÆ'}</div>
                </div>
                <div class="sample-info-item">
                    <div class="sample-info-label">üë§ ÊµãËØï‰∫∫Âëò</div>
                    <div class="sample-info-value ${!sample.tester ? 'empty' : ''}">${sample.tester || 'Êú™ËÆæÁΩÆ'}</div>
                </div>
                <div class="sample-info-item">
                    <div class="sample-info-label">üÜî Ê†∑ÂìÅID</div>
                    <div class="sample-info-value" style="font-size: 12px; font-family: monospace; color: #64748b;">${sample.id || 'N/A'}</div>
                </div>
                <div class="sample-info-item">
                    <div class="sample-info-label">üìä Áä∂ÊÄÅ</div>
                    <div class="sample-info-value">
                        ${getStatusDisplay(sample.status)}
                    </div>
                </div>
            </div>
            <div class="sample-card-footer">
                <div class="sample-card-time">
                    <div>üìÖ ÂàõÂª∫: ${createdAt}</div>
                    <div>üîÑ Êõ¥Êñ∞: ${updatedAt}</div>
                </div>
                <div class="sample-card-actions">
                    <button class="sample-action-btn edit" ${!canEdit ? 'disabled' : ''} title="${!canEdit ? 'Âè™ËÉΩÁºñËæëËá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅ' : 'ÁºñËæëÊ†∑ÂìÅ'}">
                        ‚úèÔ∏è ÁºñËæë
                    </button>
                    <button class="sample-action-btn delete" ${!canEdit ? 'disabled' : ''} title="${!canEdit ? 'Âè™ËÉΩÂà†Èô§Ëá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅ' : 'Âà†Èô§Ê†∑ÂìÅ'}">
                        üóëÔ∏è Âà†Èô§
                    </button>
                </div>
            </div>
        `;
        
        // ÁªëÂÆöÁºñËæëÊåâÈíÆ‰∫ã‰ª∂
        const editBtn = sampleCard.querySelector('.sample-action-btn.edit');
        if (editBtn) {
            if (canEdit) {
                editBtn.onclick = () => editSample(sample);
            } else {
                editBtn.onclick = () => {
                    showAlert(`ÊÇ®Âè™ËÉΩÁºñËæëËá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅÔºÅ\n\nÂΩìÂâçÊ†∑ÂìÅÊµãËØï‰∫∫ÂëòÔºö${sampleTester || 'Êú™ËÆæÁΩÆ'}\nÂΩìÂâçÁôªÂΩïÁî®Êà∑Ôºö${currentUsername || 'Êú™ÁôªÂΩï'}`, 'ÊùÉÈôê‰∏çË∂≥', 'warning');
                };
            }
        }
        
        // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
        const deleteBtn = sampleCard.querySelector('.sample-action-btn.delete');
        if (deleteBtn) {
            if (canEdit) {
                deleteBtn.onclick = () => deleteSample(sample.id, currentManagingDeviceId, sample);
            } else {
                deleteBtn.onclick = () => {
                    showAlert(`ÊÇ®Âè™ËÉΩÂà†Èô§Ëá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅÔºÅ\n\nÂΩìÂâçÊ†∑ÂìÅÊµãËØï‰∫∫ÂëòÔºö${sampleTester || 'Êú™ËÆæÁΩÆ'}\nÂΩìÂâçÁôªÂΩïÁî®Êà∑Ôºö${currentUsername || 'Êú™ÁôªÂΩï'}`, 'ÊùÉÈôê‰∏çË∂≥', 'warning');
                };
            }
        }
        
        container.appendChild(sampleCard);
    });
}

// ÁºñËæëÊ†∑ÂìÅ
function editSample(sample) {
    // Ê£ÄÊü•ÊùÉÈôêÔºöÂè™ÊúâÊµãËØï‰∫∫Âëò‰∏éÂΩìÂâçÁôªÂΩïÁî®Êà∑‰∏ÄËá¥ÁöÑÊ†∑ÂìÅÊâçËÉΩÁºñËæë
    const currentUsername = localStorage.getItem('username') || '';
    const sampleTester = sample.tester || '';
    
    if (!currentUsername) {
        showAlert('ËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºÅ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    if (sampleTester && sampleTester !== currentUsername) {
        showAlert(`ÊÇ®Âè™ËÉΩÁºñËæëËá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅÔºÅ\n\nÂΩìÂâçÊ†∑ÂìÅÊµãËØï‰∫∫ÂëòÔºö${sampleTester}\nÂΩìÂâçÁôªÂΩïÁî®Êà∑Ôºö${currentUsername}`, 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    
    if (categoryInput) categoryInput.value = sample.category || '';
    if (modelInput) modelInput.value = sample.model || '';
    
    // Ëá™Âä®Â°´ÂÖÖÊµãËØï‰∫∫ÂëòÂ≠óÊÆµÔºà‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òÁöÑusernameÔºå‰ΩÜÂÖÅËÆ∏Áî®Êà∑‰øÆÊîπÔºâ
    const username = localStorage.getItem('username') || '';
    if (testerInput) {
        testerInput.value = username;
        testerInput.readOnly = false; // ÂÖÅËÆ∏Áî®Êà∑‰øÆÊîπ
    }
    
    // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÊ†∑ÂìÅIDÂíåÂéüÂßãÊµãËØï‰∫∫ÂëòÔºàÁî®‰∫éÂêéÁª≠È™åËØÅÔºâ
    window.currentEditingSampleId = sample.id;
    window.currentEditingSampleTester = sampleTester; // ‰øùÂ≠òÂéüÂßãÊµãËØï‰∫∫ÂëòÔºåÁî®‰∫éÊèê‰∫§Êó∂È™åËØÅ
    
    // ÊªöÂä®Âà∞Ê∑ªÂä†Ë°®Âçï
    const addForm = document.querySelector('#editDeviceInfoModal .device-form-body > div[style*="border-top"]');
    if (addForm) {
        addForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    if (submitBtn) {
        submitBtn.textContent = 'Êõ¥Êñ∞Ê†∑ÂìÅ';
        submitBtn.onclick = submitUpdateSample;
    }
}

// Âà†Èô§Ê†∑ÂìÅÔºàÂ∏¶Áä∂ÊÄÅËØ¢ÈóÆÔºâ
async function deleteSample(sampleId, deviceId, sampleInfo = null) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ÊúâÊµãËØï‰∫∫Âëò‰∏éÂΩìÂâçÁôªÂΩïÁî®Êà∑‰∏ÄËá¥ÁöÑÊ†∑ÂìÅÊâçËÉΩÂà†Èô§
    const currentUsername = localStorage.getItem('username') || '';
    let sampleTester = '';
    
    // Â¶ÇÊûú‰º†ÂÖ•‰∫ÜÊ†∑ÂìÅ‰ø°ÊÅØÔºåÁõ¥Êé•‰ΩøÁî®ÔºõÂê¶ÂàôÈúÄË¶Å‰ªéDOM‰∏≠Ëé∑Âèñ
    if (sampleInfo && sampleInfo.tester) {
        sampleTester = sampleInfo.tester;
    } else {
        // ‰ªéDOM‰∏≠Ëé∑ÂèñÊ†∑ÂìÅ‰ø°ÊÅØ
        const samplesListContainer = document.getElementById('samplesListContainer');
        if (samplesListContainer) {
            const sampleCard = samplesListContainer.querySelector(`[data-sample-id="${sampleId}"]`);
            if (sampleCard) {
                const testerElement = sampleCard.querySelector('.sample-info-value');
                // Êü•ÊâæÊµãËØï‰∫∫Âëò‰ø°ÊÅØÔºàÂú®Ê†∑ÂìÅÂç°Áâá‰∏≠Ôºâ
                const infoItems = sampleCard.querySelectorAll('.sample-info-item');
                infoItems.forEach(item => {
                    const label = item.querySelector('.sample-info-label');
                    if (label && label.textContent.includes('ÊµãËØï‰∫∫Âëò')) {
                        const value = item.querySelector('.sample-info-value');
                        if (value) {
                            sampleTester = value.textContent.trim();
                        }
                    }
                });
            }
        }
    }
    
    // ÊùÉÈôêÈ™åËØÅ
    if (!currentUsername) {
        showAlert('ËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºÅ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    if (sampleTester && sampleTester !== currentUsername) {
        showAlert(`ÊÇ®Âè™ËÉΩÂà†Èô§Ëá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅÔºÅ\n\nÂΩìÂâçÊ†∑ÂìÅÊµãËØï‰∫∫ÂëòÔºö${sampleTester}\nÂΩìÂâçÁôªÂΩïÁî®Êà∑Ôºö${currentUsername}`, 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    // ÊòæÁ§∫Ëá™ÂÆö‰πâËØ¢ÈóÆÂØπËØùÊ°Ü
    const userChoice = await showDeleteConfirmDialog();
    
    if (userChoice === null) {
        // Áî®Êà∑ÁÇπÂáª‰∫Ü"ÁÇπÈîô‰∫Ü"ÊàñÂÖ≥Èó≠ÂØπËØùÊ°ÜÔºå‰∏çÊâßË°å‰ªª‰ΩïÊìç‰Ωú
        return;
    }
    
    // userChoice Â∫îËØ•ÊòØ 'COMPLETED' Êàñ 'CANCELLED'
    if (userChoice !== 'COMPLETED' && userChoice !== 'CANCELLED') {
        console.warn('Êó†ÊïàÁöÑÈÄâÊã©:', userChoice);
        return;
    }
    
    // ÂÖàÁ´ãÂç≥‰ªéDOM‰∏≠ÁßªÈô§ËØ•Ê†∑ÂìÅÂç°ÁâáÔºà‰πêËßÇÊõ¥Êñ∞Ôºâ
    const samplesListContainer = document.getElementById('samplesListContainer');
    if (samplesListContainer) {
        const sampleCard = samplesListContainer.querySelector(`[data-sample-id="${sampleId}"]`);
        if (sampleCard) {
            // Ê∑ªÂä†Ê∑°Âá∫Âä®Áîª
            sampleCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            sampleCard.style.opacity = '0';
            sampleCard.style.transform = 'scale(0.95)';
            
            // Âä®ÁîªÁªìÊùüÂêéÁßªÈô§ÂÖÉÁ¥†
            setTimeout(() => {
                sampleCard.remove();
                
                // Êõ¥Êñ∞Ê†∑ÂìÅÊï∞ÈáèÊòæÁ§∫
                const samplesCount = document.getElementById('samplesCount');
                if (samplesCount) {
                    const remainingCards = samplesListContainer.querySelectorAll('.sample-card');
                    samplesCount.textContent = `${remainingCards.length} ‰∏™Ê†∑ÂìÅ`;
                }
                
                // Â¶ÇÊûúÊ≤°ÊúâÊ†∑ÂìÅ‰∫ÜÔºåÊòæÁ§∫Á©∫Áä∂ÊÄÅ
                if (samplesListContainer.querySelectorAll('.sample-card').length === 0) {
                    samplesListContainer.innerHTML = `
                        <div class="sample-empty-state">
                            <div class="sample-empty-state-icon">üì¶</div>
                            <div class="sample-empty-state-text">ÊöÇÊó†Ê†∑ÂìÅÔºåËØ∑Âú®‰∏ãÊñπÊ∑ªÂä†</div>
                        </div>
                    `;
                    const samplesCount = document.getElementById('samplesCount');
                    if (samplesCount) {
                        samplesCount.textContent = '0 ‰∏™Ê†∑ÂìÅ';
                    }
                }
            }, 300);
        }
    }
    
    // Ëé∑ÂèñÂΩìÂâçÁôªÂΩïÁî®Êà∑Âêç
    const username = localStorage.getItem('username') || '';
    
    fetch('/iot/device/sample/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id: sampleId,
            status: userChoice,  // ‰º†ÈÄíÁä∂ÊÄÅÔºöCOMPLETED Êàñ CANCELLED
            username: username  // ‰º†ÈÄíÁî®Êà∑ÂêçÁî®‰∫éÂêéÁ´ØÊùÉÈôêÈ™åËØÅ
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const statusText = userChoice === 'COMPLETED' ? 'Â∑≤ÂÆåÊàê' : 'Â∑≤ÂèñÊ∂à';
            showAlert(`Ê†∑ÂìÅÂ∑≤Ê†áËÆ∞‰∏∫${statusText}ÔºÅ`, 'Êìç‰ΩúÊàêÂäü', 'success');
            
            // ÈáçÊñ∞Âä†ËΩΩÊ†∑ÂìÅÂàóË°®‰ª•Á°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºàÂª∂Ëøü‰∏ÄÁÇπÔºåËÆ©Áî®Êà∑ÁúãÂà∞Âà†Èô§Âä®ÁîªÔºâ
            if (samplesListContainer && deviceId) {
                setTimeout(() => {
                    loadSamplesList(deviceId, samplesListContainer);
                }, 500);
            }
            
            // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Êìç‰ΩúÂ§±Ë¥•', 'error');
            // Â¶ÇÊûúÂà†Èô§Â§±Ë¥•ÔºåÈáçÊñ∞Âä†ËΩΩÂàóË°®‰ª•ÊÅ¢Â§çÁä∂ÊÄÅ
            if (samplesListContainer && deviceId) {
                loadSamplesList(deviceId, samplesListContainer);
            }
        }
    })
    .catch(error => {
        console.error('Âà†Èô§Ê†∑ÂìÅÂ§±Ë¥•:', error);
        showAlert('Êìç‰ΩúÂ§±Ë¥•Ôºö' + error.message, 'Êìç‰ΩúÂ§±Ë¥•', 'error');
        // Â¶ÇÊûúÂà†Èô§Â§±Ë¥•ÔºåÈáçÊñ∞Âä†ËΩΩÂàóË°®‰ª•ÊÅ¢Â§çÁä∂ÊÄÅ
        if (samplesListContainer && deviceId) {
            loadSamplesList(deviceId, samplesListContainer);
        }
    });
}

// ÊòæÁ§∫Âà†Èô§Á°ÆËÆ§ÂØπËØùÊ°ÜÔºàËøîÂõû 'COMPLETED'„ÄÅ'CANCELLED' Êàñ nullÔºâ
function showDeleteConfirmDialog() {
    return new Promise((resolve) => {
        // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
        const modal = document.createElement('div');
        modal.className = 'delete-confirm-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        `;
        
        modal.innerHTML = `
            <div style="
                background: white;
                border-radius: 16px;
                padding: 30px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease-out;
            ">
                <h2 style="
                    margin: 0 0 20px 0;
                    font-size: 20px;
                    color: #1e293b;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <span>ËØ∑ÈÄâÊã©Êìç‰ΩúÂéüÂõ†</span>
                </h2>
                <p style="
                    margin: 0 0 25px 0;
                    color: #64748b;
                    font-size: 14px;
                    line-height: 1.6;
                ">ËØ∑ÈÄâÊã©Âà†Èô§Ê≠§Ê†∑ÂìÅÁöÑÂéüÂõ†Ôºö</p>
                <div style="
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    margin-bottom: 25px;
                ">
                    <button class="delete-option-btn" data-action="COMPLETED" style="
                        padding: 14px 20px;
                        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: left;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="font-size: 18px;">‚úÖ</span>
                        <span>Â∑≤ÂÆåÊàêÊµãËØï</span>
                    </button>
                    <button class="delete-option-btn" data-action="CANCELLED" style="
                        padding: 14px 20px;
                        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: left;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="font-size: 18px;">‚ùå</span>
                        <span>ÂèñÊ∂àÊµãËØï</span>
                    </button>
                    <button class="delete-option-btn" data-action="cancel" style="
                        padding: 14px 20px;
                        background: #f1f5f9;
                        color: #64748b;
                        border: 2px solid #e2e8f0;
                        border-radius: 10px;
                        font-size: 15px;
                        font-weight: 600;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        text-align: left;
                        display: flex;
                        align-items: center;
                        gap: 10px;
                    ">
                        <span style="font-size: 18px;">‚Ü©Ô∏è</span>
                        <span>ÁÇπÈîô‰∫ÜÔºå‰∏çÂà†Èô§</span>
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ÁªëÂÆöÊåâÈíÆ‰∫ã‰ª∂
        const buttons = modal.querySelectorAll('.delete-option-btn');
        buttons.forEach(btn => {
            btn.addEventListener('mouseenter', function() {
                if (this.dataset.action === 'COMPLETED') {
                    this.style.transform = 'translateX(5px)';
                    this.style.boxShadow = '0 4px 12px rgba(16, 185, 129, 0.4)';
                } else if (this.dataset.action === 'CANCELLED') {
                    this.style.transform = 'translateX(5px)';
                    this.style.boxShadow = '0 4px 12px rgba(245, 158, 11, 0.4)';
                } else {
                    this.style.transform = 'translateX(5px)';
                    this.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.1)';
                }
            });
            
            btn.addEventListener('mouseleave', function() {
                this.style.transform = 'translateX(0)';
                this.style.boxShadow = 'none';
            });
            
            btn.addEventListener('click', function() {
                const action = this.dataset.action;
                document.body.removeChild(modal);
                
                if (action === 'cancel') {
                    resolve(null); // Áî®Êà∑ÁÇπÈîô‰∫ÜÔºå‰∏çÂà†Èô§
                } else {
                    resolve(action); // ËøîÂõû COMPLETED Êàñ CANCELLED
                }
            });
        });
        
        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                document.body.removeChild(modal);
                resolve(null);
            }
        });
    });
}

// ÂÖ≥Èó≠ÁºñËæëËÆæÂ§á‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
function closeEditDeviceInfoModal() {
    const modal = document.getElementById('editDeviceInfoModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Ê∏ÖÁ©∫ÁºñËæëÁä∂ÊÄÅ
    window.currentEditingSampleId = null;
    window.currentEditingSampleTester = null; // Ê∏ÖÈô§‰øùÂ≠òÁöÑÂéüÂßãÊµãËØï‰∫∫Âëò
    currentManagingDeviceId = null;
    
    // ÊÅ¢Â§çÊåâÈíÆÊñáÊú¨
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    if (submitBtn) {
        submitBtn.textContent = 'Ê∑ªÂä†Ê†∑ÂìÅ';
        submitBtn.onclick = submitAddSample;
    }
    
    // Ê∏ÖÁ©∫Ë°®ÂçïÔºàÊµãËØï‰∫∫ÂëòÂ≠óÊÆµ‰øùÊåÅ‰∏∫usernameÔºâ
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    if (categoryInput) categoryInput.value = '';
    if (modelInput) modelInput.value = '';
    if (testerInput) {
        const username = localStorage.getItem('username') || '';
        testerInput.value = username;
    }
}

// Ê∑ªÂä†Ê†∑ÂìÅ
function submitAddSample() {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏Êèê‰∫§
    if (isReadOnlyMode) {
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÊ∑ªÂä†Ê†∑ÂìÅ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const deviceIdInput = document.getElementById('editDeviceInfoId');
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    
    if (!deviceIdInput || !submitBtn) return;
    
    const deviceId = deviceIdInput.value.trim();
    if (!deviceId) {
        showAlert('ËÆæÂ§áID‰∏çËÉΩ‰∏∫Á©∫ÔºÅ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        return;
    }
    
    const category = categoryInput ? categoryInput.value.trim() : '';
    const model = modelInput ? modelInput.value.trim() : '';
    // ÊµãËØï‰∫∫Âëò‰ΩøÁî®ËæìÂÖ•Ê°ÜÁöÑÂÄºÔºàÂ¶ÇÊûú‰∏∫Á©∫Âàô‰ΩøÁî®ÈªòËÆ§ÁöÑusernameÔºâ
    const tester = testerInput ? testerInput.value.trim() : (localStorage.getItem('username') || '');
    
    // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ê∑ªÂä†‰∏≠...';
    
    // Ê£ÄÊü•È¢ÑÁ∫¶ËÆæÁΩÆ
    const appointmentOn = document.getElementById('sampleAppointmentOn');
    const isWaiting = appointmentOn && appointmentOn.classList.contains('active');
    
    // ÂèëÈÄÅÊ∑ªÂä†Ê†∑ÂìÅËØ∑Ê±Ç
    fetch('/iot/device/sample/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            category: category || null,
            model: model || null,
            tester: tester || null,
            is_waiting: isWaiting  // ‰º†ÈÄíÈ¢ÑÁ∫¶ËÆæÁΩÆÔºötrue=È¢ÑÁ∫¶Á≠âÂÄô(WAITING)Ôºåfalse=Áõ¥Êé•ÊµãËØï(TESTING)
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('Ê†∑ÂìÅÊ∑ªÂä†ÊàêÂäüÔºÅ', 'Ê∑ªÂä†ÊàêÂäü', 'success');
            
            // Ê∏ÖÁ©∫Ë°®ÂçïÔºàÊµãËØï‰∫∫ÂëòÂ≠óÊÆµ‰øùÊåÅ‰∏∫usernameÔºâ
            if (categoryInput) categoryInput.value = '';
            if (modelInput) modelInput.value = '';
            if (testerInput) {
                const username = localStorage.getItem('username') || '';
                testerInput.value = username;
            }
            
            // ÈáçÊñ∞Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
            const samplesListContainer = document.getElementById('samplesListContainer');
            if (samplesListContainer && deviceId) {
                loadSamplesList(deviceId, samplesListContainer);
            }
            
            // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert('Ê∑ªÂä†Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Ê∑ªÂä†Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Ê∑ªÂä†Ê†∑ÂìÅÂ§±Ë¥•:', error);
        showAlert('Ê∑ªÂä†Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + error.message, 'Ê∑ªÂä†Â§±Ë¥•', 'error');
    })
    .finally(() => {
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ê∑ªÂä†Ê†∑ÂìÅ';
    });
}

// Êõ¥Êñ∞Ê†∑ÂìÅ
function submitUpdateSample() {
    const deviceIdInput = document.getElementById('editDeviceInfoId');
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    
    if (!deviceIdInput || !submitBtn) return;
    
    const sampleId = window.currentEditingSampleId;
    if (!sampleId) {
        showAlert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁºñËæëÁöÑÊ†∑ÂìÅ', 'ÈîôËØØ', 'warning');
        return;
    }
    
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ÊúâÊµãËØï‰∫∫Âëò‰∏éÂΩìÂâçÁôªÂΩïÁî®Êà∑‰∏ÄËá¥ÁöÑÊ†∑ÂìÅÊâçËÉΩÊõ¥Êñ∞
    const currentUsername = localStorage.getItem('username') || '';
    const originalTester = window.currentEditingSampleTester || '';
    
    if (!currentUsername) {
        showAlert('ËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªüÔºÅ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    if (originalTester && originalTester !== currentUsername) {
        showAlert(`ÊÇ®Âè™ËÉΩÊõ¥Êñ∞Ëá™Â∑±ÂàõÂª∫ÁöÑÊ†∑ÂìÅÔºÅ\n\nÂΩìÂâçÊ†∑ÂìÅÊµãËØï‰∫∫ÂëòÔºö${originalTester}\nÂΩìÂâçÁôªÂΩïÁî®Êà∑Ôºö${currentUsername}`, 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const category = categoryInput ? categoryInput.value.trim() : '';
    const model = modelInput ? modelInput.value.trim() : '';
    // ÊµãËØï‰∫∫Âëò‰ΩøÁî®ËæìÂÖ•Ê°ÜÁöÑÂÄºÔºàÂ¶ÇÊûú‰∏∫Á©∫Âàô‰ΩøÁî®ÈªòËÆ§ÁöÑusernameÔºâ
    const tester = testerInput ? testerInput.value.trim() : (localStorage.getItem('username') || '');
    
    // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    submitBtn.disabled = true;
    submitBtn.textContent = 'Êõ¥Êñ∞‰∏≠...';
    
    // ÂèëÈÄÅÊõ¥Êñ∞Ê†∑ÂìÅËØ∑Ê±Ç
    fetch('/iot/device/sample/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id: sampleId,
            category: category || null,
            model: model || null,
            tester: tester || null
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('Ê†∑ÂìÅÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'Êõ¥Êñ∞ÊàêÂäü', 'success');
            
            // Ê∏ÖÁ©∫Ë°®ÂçïÂíåÁºñËæëÁä∂ÊÄÅÔºàÊµãËØï‰∫∫ÂëòÂ≠óÊÆµ‰øùÊåÅ‰∏∫usernameÔºâ
            if (categoryInput) categoryInput.value = '';
            if (modelInput) modelInput.value = '';
            if (testerInput) {
                const username = localStorage.getItem('username') || '';
                testerInput.value = username;
            }
            window.currentEditingSampleId = null;
            window.currentEditingSampleTester = null; // Ê∏ÖÈô§‰øùÂ≠òÁöÑÂéüÂßãÊµãËØï‰∫∫Âëò
            
            // ÊÅ¢Â§çÊåâÈíÆÊñáÊú¨
            submitBtn.textContent = 'Ê∑ªÂä†Ê†∑ÂìÅ';
            submitBtn.onclick = submitAddSample;
            
            // ÈáçÊñ∞Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
            const samplesListContainer = document.getElementById('samplesListContainer');
            const deviceId = deviceIdInput.value.trim();
            if (samplesListContainer && deviceId) {
                loadSamplesList(deviceId, samplesListContainer);
            }
            
            // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert('Êõ¥Êñ∞Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Êõ¥Êñ∞Ê†∑ÂìÅÂ§±Ë¥•:', error);
        showAlert('Êõ¥Êñ∞Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + error.message, 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
    })
    .finally(() => {
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
        submitBtn.disabled = false;
    });
}

// Êèê‰∫§Ê∑ªÂä†ËÆæÂ§á
function submitAddDevice() {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏Êèê‰∫§
    if (isReadOnlyMode) {
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÊ∑ªÂä†ËÆæÂ§á', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const deviceIdInput = document.getElementById('deviceIdInput');
    const submitBtn = document.querySelector('.device-form-btn.submit');
    
    if (!deviceIdInput || !submitBtn) return;
    
    const deviceId = deviceIdInput.value.trim();
    
    // È™åËØÅËÆæÂ§áÂêçÁß∞
    if (!deviceId) {
        showAlert('ËØ∑ËæìÂÖ•ËÆæÂ§áÂêçÁß∞ÔºÅ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        deviceIdInput.focus();
        return;
    }
    
    // È™åËØÅËÆæÂ§áÂêçÁß∞Ê†ºÂºèÔºàÂèØÈÄâÔºöÂè™ÂÖÅËÆ∏Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏≠ÂàíÁ∫ø„ÄÅ‰∏ãÂàíÁ∫øÔºâ
    const deviceIdPattern = /^[a-zA-Z0-9\-_\u4e00-\u9fa5]+$/;
    if (!deviceIdPattern.test(deviceId)) {
        showAlert('ËÆæÂ§áÂêçÁß∞Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºÅ\nÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏≠ÂàíÁ∫ø„ÄÅ‰∏ãÂàíÁ∫øÂíå‰∏≠Êñá', 'Ê†ºÂºèÈîôËØØ', 'warning');
        deviceIdInput.focus();
        return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
    if (deviceList.some(device => device.id === deviceId)) {
        showAlert(`ËÆæÂ§á "${deviceId}" Â∑≤Â≠òÂú®‰∫éÁõëÊéßÂàóË°®‰∏≠ÔºÅ\nËØ∑Ê£ÄÊü•ËÆæÂ§áÂàóË°®Êàñ‰ΩøÁî®ÂÖ∂‰ªñËÆæÂ§áÂêçÁß∞`, 'ËÆæÂ§áÂ∑≤Â≠òÂú®', 'warning');
        return;
    }
    
    // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ê∑ªÂä†‰∏≠...';
    
    // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂêçÔºàÁî®‰∫éËÆ∞ÂΩïÂàõÂª∫ËÄÖÔºâ
    const username = localStorage.getItem('username') || 'Á≥ªÁªüÁÆ°ÁêÜÂëò';
    
    // ÂèëÈÄÅÊ∑ªÂä†ËÆæÂ§áËØ∑Ê±Ç
    fetch('/iot/device/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            create_by: username
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(
                `ËÆæÂ§á "${deviceId}" Ê∑ªÂä†ÊàêÂäüÔºÅ\n\nËÆæÂ§áÂ∞ÜÂá∫Áé∞Âú®ÁõëÊéßÂàóË°®‰∏≠\nËØ∑ÂêØÂä®ËÆæÂ§áÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Êé•Êî∂Âπ∂ÊòæÁ§∫ËÆæÂ§áÊï∞ÊçÆ`, 
                'Ê∑ªÂä†ÊàêÂäü', 
                'success'
            );
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeAddDeviceModal();
            
            // Á´ãÂç≥Âà∑Êñ∞ËÆæÂ§áÂàóË°®Ôºà‰∏çÂª∂ËøüÔºåÁ°Æ‰øùÊñ∞Â¢ûËÆæÂ§áÁ´ãÂç≥ÊòæÁ§∫Ôºâ
            refreshDevicesFromServer();
        } else {
            showAlert(
                'Ê∑ªÂä†ËÆæÂ§áÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ') + '\n\nËØ∑Ê£ÄÊü•ËÆæÂ§áIDÊòØÂê¶Ê≠£Á°ÆÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
                'Ê∑ªÂä†Â§±Ë¥•', 
                'error'
            );
        }
    })
    .catch(error => {
        console.error('Ê∑ªÂä†ËÆæÂ§áÂ§±Ë¥•:', error);
        showAlert(
            'Ê∑ªÂä†ËÆæÂ§áÂ§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
            'Ê∑ªÂä†Â§±Ë¥•', 
            'error'
        );
    })
    .finally(() => {
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ê∑ªÂä†ËÆæÂ§á';
    });
}

// scheduleAutoFetch ÂáΩÊï∞Â∑≤ÁßªÈô§
// ÂéüÂõ†ÔºörefreshDevicesFromServerQuietly Â∑≤ÁªèÊØè20ÁßíÂà∑Êñ∞ÊâÄÊúâËÆæÂ§áÊï∞ÊçÆÔºå‰∏çÈúÄË¶ÅÂçïÁã¨ÁöÑ autoFetch Êú∫Âà∂
// Â¶ÇÊûúÂ∞ÜÊù•ÈúÄË¶ÅÂçïÁã¨Âà∑Êñ∞Êüê‰∫õËÆæÂ§áÔºåÂèØ‰ª•ÈáçÊñ∞ÂêØÁî®Ê≠§ÂáΩÊï∞

function initializeDeviceModule() {
    deviceList = [];
    activeDeviceId = null;
    const emptyState = document.getElementById('deviceEmptyState');
    if (emptyState) {
        emptyState.innerHTML = 'üîÑ Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆ...';
    }
    renderDevices();
    refreshDevicesFromServer();
    
    // ÂêØÂä®ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÔºàÊØè20ÁßíÔºâ
    window.startDeviceListAutoRefresh();
}

// Êõ¥Êñ∞Âà∑Êñ∞ÊåâÈíÆÂÄíËÆ°Êó∂ÊòæÁ§∫
function updateRefreshButtonCountdown() {
    const refreshBtn = document.getElementById('refreshDataBtn');
    if (refreshBtn) {
        if (refreshCountdown > 0) {
            refreshBtn.textContent = `üîÑ Âà∑Êñ∞Êï∞ÊçÆ (ËøòÂ∑Æ${refreshCountdown}Áßí)`;
            refreshCountdown--;
        } else {
            refreshBtn.textContent = 'üîÑ Âà∑Êñ∞Êï∞ÊçÆ';
            refreshCountdown = 20; // ÈáçÁΩÆÂÄíËÆ°Êó∂
        }
    }
}

// ÂêØÂä®Âà∑Êñ∞ÂÄíËÆ°Êó∂
function startRefreshCountdown() {
    // Ê∏ÖÈô§Â∑≤ÊúâÁöÑÂÄíËÆ°Êó∂ÂÆöÊó∂Âô®
    if (refreshCountdownTimerId) {
        clearInterval(refreshCountdownTimerId);
        refreshCountdownTimerId = null;
    }
    
    // ÈáçÁΩÆÂÄíËÆ°Êó∂
    refreshCountdown = 20;
    
    // Á´ãÂç≥Êõ¥Êñ∞‰∏ÄÊ¨°ÊòæÁ§∫
    updateRefreshButtonCountdown();
    
    // ÊØèÁßíÊõ¥Êñ∞‰∏ÄÊ¨°ÂÄíËÆ°Êó∂
    refreshCountdownTimerId = setInterval(updateRefreshButtonCountdown, 1000);
}

// ÂÅúÊ≠¢Âà∑Êñ∞ÂÄíËÆ°Êó∂
function stopRefreshCountdown() {
    if (refreshCountdownTimerId) {
        clearInterval(refreshCountdownTimerId);
        refreshCountdownTimerId = null;
    }
    const refreshBtn = document.getElementById('refreshDataBtn');
    if (refreshBtn) {
        refreshBtn.textContent = 'üîÑ Âà∑Êñ∞Êï∞ÊçÆ';
    }
}

// ÂêØÂä®ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÔºàÊö¥Èú≤Âà∞windowÂØπË±°Ôºâ
window.startDeviceListAutoRefresh = function() {
    // Ê∏ÖÈô§Â∑≤ÊúâÁöÑÂÆöÊó∂Âô®
    if (deviceListRefreshTimerId) {
        clearInterval(deviceListRefreshTimerId);
        deviceListRefreshTimerId = null;
    }
    
    // ÂêØÂä®Âà∑Êñ∞ÂÄíËÆ°Êó∂
    startRefreshCountdown();
    
    // Âà∑Êñ∞Âæ™ÁéØÂáΩÊï∞
    const refreshLoop = () => {
        // Âè™Âú®ËÆæÂ§áÁõëÊéßÈ¶ñÈ°µ‰∏îÈ°µÈù¢ÂèØËßÅÊó∂Âà∑Êñ∞
        const deviceMonitorPage = document.getElementById('deviceMonitorPage');
        if (deviceMonitorPage && deviceMonitorPage.classList.contains('active') && !document.hidden) {
            refreshDevicesFromServerQuietly();
            // Âà∑Êñ∞ÂêéÈáçÁΩÆÂÄíËÆ°Êó∂
            refreshCountdown = 20;
            updateRefreshButtonCountdown();
        }
    };
    
    // ÊØè20ÁßíÂà∑Êñ∞‰∏ÄÊ¨°ËÆæÂ§áÂàóË°®Ôºà‰ªéRedisÁºìÂ≠òËé∑ÂèñÔºâ
    deviceListRefreshTimerId = setInterval(refreshLoop, 20000);
};

// Èò≤ÊäñÊ†áÂøóÔºåÈÅøÂÖçÂπ∂ÂèëËØ∑Ê±Ç
let isRefreshing = false;

// ÈùôÈªòÂà∑Êñ∞ËÆæÂ§áÂàóË°®Ôºà‰∏çÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫Ôºâ
async function refreshDevicesFromServerQuietly() {
    // Â¶ÇÊûúÊ≠£Âú®Âà∑Êñ∞ÔºåË∑≥ËøáÊú¨Ê¨°Âà∑Êñ∞
    if (isRefreshing) {
        return;
    }
    
    isRefreshing = true;
    const previousActiveId = activeDeviceId;
    
    try {
        const response = await fetch('/iot/data/devices', { cache: 'no-store' });
        if (!response.ok) {
            return;
        }
        const payload = await response.json();
        if (!Array.isArray(payload)) {
            return;
        }
        
        const transformed = payload.map((item, index) => {
            return transformDeviceRecord(item, index);
        });
        
        // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊó©ÂàõÂª∫ÁöÑÂú®ÊúÄÂâçÈù¢ÔºåÊñ∞ËÆæÂ§áÂú®ÊúÄÂêéÔºâ
        transformed.sort((a, b) => {
            const timeA = a.raw.created_at || a.raw.createdAt || '9999-12-31 23:59:59';
            const timeB = b.raw.created_at || b.raw.createdAt || '9999-12-31 23:59:59';
            if (timeA < timeB) return -1;
            if (timeA > timeB) return 1;
            return 0;
        });
        
        // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÊúâÂèòÂåñÔºàÂè™Âú®ÊúâÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Ôºâ
        const changeResult = hasDeviceListChanged(deviceList, transformed);
        
        if (changeResult.changed) {
            // ÊúâÂèòÂåñÔºåÊâìÂç∞ÂèòÂåñËØ¶ÊÉÖ
            console.log('[ËÆæÂ§áÂàóË°®Ê£ÄÊü•] ËÆæÂ§áÊï∞ÊçÆÊúâÂèòÂåñ:');
            if (changeResult.changes && changeResult.changes.length > 0) {
                changeResult.changes.forEach(change => {
                    console.log(`  - ${change}`);
                });
            } else {
                console.log('  - Ê£ÄÊµãÂà∞ÂèòÂåñÔºå‰ΩÜÂèòÂåñËØ¶ÊÉÖ‰∏∫Á©∫');
            }
            console.log(`[ËÆæÂ§áÂàóË°®Ê£ÄÊü•] ÂÖ±Ê£ÄÊµãÂà∞ ${changeResult.changes ? changeResult.changes.length : 0} È°πÂèòÂåñ`);
            
            deviceList = transformed;
            
            // ‰øùÊåÅÂΩìÂâçÈÄâ‰∏≠ÁöÑËÆæÂ§á
            if (previousActiveId && deviceList.some(device => device.id === previousActiveId)) {
                activeDeviceId = previousActiveId;
            } else if (deviceList.length > 0) {
                activeDeviceId = deviceList[0].id;
            } else {
                activeDeviceId = null;
            }
            
            // ‰ΩøÁî® requestAnimationFrame ‰ºòÂåñÊ∏≤ÊüìÊÄßËÉΩ
            if (window.requestAnimationFrame) {
                requestAnimationFrame(() => {
                    renderDevices();
                });
            } else {
                renderDevices();
            }
        }
        // Ê≤°ÊúâÂèòÂåñÊó∂‰∏çËæìÂá∫Êó•ÂøóÔºåÂáèÂ∞ëÊéßÂà∂Âè∞ËæìÂá∫
    } catch (error) {
        // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çËæìÂá∫Êó•Âøó
    } finally {
        isRefreshing = false;
    }
}

// Ê£ÄÊü•ËÆæÂ§áÂàóË°®ÊòØÂê¶ÊúâÂèòÂåñÔºà‰ºòÂåñÁâàÊú¨Ôºå‰ΩøÁî®MapÊèêÈ´òÊü•ÊâæÊïàÁéáÔºâ
// ËøîÂõû { changed: boolean, changes: string[] } ÂØπË±°ÔºåÂåÖÂê´ÂèòÂåñËØ¶ÊÉÖ
function hasDeviceListChanged(oldList, newList) {
    const changes = [];
    
    if (!oldList || !newList) {
        changes.push('ËÆæÂ§áÂàóË°®‰∏∫Á©∫ÊàñÊú™ÂàùÂßãÂåñ');
        return { changed: true, changes };
    }
    
    if (oldList.length !== newList.length) {
        changes.push(`ËÆæÂ§áÊï∞ÈáèÂèòÂåñ: ${oldList.length} ‚Üí ${newList.length}`);
        return { changed: true, changes };
    }
    
    // È¶ñÂÖàÊ£ÄÊü•ËÆæÂ§áIDÈõÜÂêàÊòØÂê¶Áõ∏ÂêåÔºàÊ£ÄÊµãÊñ∞Â¢ûÊàñÂà†Èô§Ôºâ
    const oldDeviceIds = new Set(oldList.map(d => d.id));
    const newDeviceIds = new Set(newList.map(d => d.id));
    
    // Â¶ÇÊûúËÆæÂ§áIDÈõÜÂêà‰∏çÂêåÔºåËØ¥ÊòéÊúâËÆæÂ§áÊñ∞Â¢ûÊàñÂà†Èô§
    if (oldDeviceIds.size !== newDeviceIds.size) {
        changes.push(`ËÆæÂ§áIDÈõÜÂêàÂ§ßÂ∞èÂèòÂåñ: ${oldDeviceIds.size} ‚Üí ${newDeviceIds.size}`);
        return { changed: true, changes };
    }
    
    // Ê£ÄÊü•ÊòØÂê¶ÊúâÊñ∞Â¢ûÊàñÂà†Èô§ÁöÑËÆæÂ§á
    const addedDevices = [];
    const removedDevices = [];
    
    for (const deviceId of newDeviceIds) {
        if (!oldDeviceIds.has(deviceId)) {
            addedDevices.push(deviceId);
        }
    }
    for (const deviceId of oldDeviceIds) {
        if (!newDeviceIds.has(deviceId)) {
            removedDevices.push(deviceId);
        }
    }
    
    if (addedDevices.length > 0) {
        changes.push(`Êñ∞Â¢ûËÆæÂ§á: ${addedDevices.join(', ')}`);
    }
    if (removedDevices.length > 0) {
        changes.push(`Âà†Èô§ËÆæÂ§á: ${removedDevices.join(', ')}`);
    }
    
    if (addedDevices.length > 0 || removedDevices.length > 0) {
        return { changed: true, changes };
    }
    
    // ‰ΩøÁî®MapÊèêÈ´òÊü•ÊâæÊïàÁéá
    const newDeviceMap = new Map();
    newList.forEach(device => {
        newDeviceMap.set(device.id, device);
    });
    
    // ÊØîËæÉÊØè‰∏™ËÆæÂ§áÁöÑÂÖ≥ÈîÆÂ≠óÊÆµ
    for (let i = 0; i < oldList.length; i++) {
        const oldDevice = oldList[i];
        const newDevice = newDeviceMap.get(oldDevice.id);
        
        if (!newDevice) {
            changes.push(`ËÆæÂ§á ${oldDevice.id} ‰∏çÂ≠òÂú®‰∫éÊñ∞ÂàóË°®‰∏≠`);
            return { changed: true, changes };
        }
        
        // Ê£ÄÊü•ÊØè‰∏™ÂÖ≥ÈîÆÂ≠óÊÆµÁöÑÂèòÂåñ
        const deviceChanges = [];
        
        if (oldDevice.temperature !== newDevice.temperature) {
            deviceChanges.push(`Ê∏©Â∫¶: ${oldDevice.temperature} ‚Üí ${newDevice.temperature}`);
        }
        if (oldDevice.humidity !== newDevice.humidity) {
            deviceChanges.push(`ÊπøÂ∫¶: ${oldDevice.humidity} ‚Üí ${newDevice.humidity}`);
        }
        if (oldDevice.status !== newDevice.status) {
            deviceChanges.push(`Áä∂ÊÄÅ: ${oldDevice.status} ‚Üí ${newDevice.status}`);
        }
        if (oldDevice.mode !== newDevice.mode) {
            deviceChanges.push(`Ê®°Âºè: ${oldDevice.mode} ‚Üí ${newDevice.mode}`);
        }
        if (oldDevice.runtime !== newDevice.runtime) {
            deviceChanges.push(`ËøêË°åÊó∂Èó¥: ${oldDevice.runtime} ‚Üí ${newDevice.runtime}`);
        }
        if (oldDevice.remaining !== newDevice.remaining) {
            deviceChanges.push(`Ââ©‰ΩôÊó∂Èó¥: ${oldDevice.remaining} ‚Üí ${newDevice.remaining}`);
        }
        if (oldDevice.tempPower !== newDevice.tempPower) {
            deviceChanges.push(`Ê∏©Â∫¶ÂäüÁéá: ${oldDevice.tempPower} ‚Üí ${newDevice.tempPower}`);
        }
        if (oldDevice.humidityPower !== newDevice.humidityPower) {
            deviceChanges.push(`ÊπøÂ∫¶ÂäüÁéá: ${oldDevice.humidityPower} ‚Üí ${newDevice.humidityPower}`);
        }
        if (oldDevice.moduleConnection !== newDevice.moduleConnection) {
            deviceChanges.push(`Ê®°ÂùóËøûÊé•: ${oldDevice.moduleConnection} ‚Üí ${newDevice.moduleConnection}`);
        }
        
        if (deviceChanges.length > 0) {
            changes.push(`ËÆæÂ§á ${oldDevice.id}: ${deviceChanges.join(', ')}`);
        }
    }
    
    return {
        changed: changes.length > 0,
        changes
    };
}

// ÂÅúÊ≠¢ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞
function stopDeviceListAutoRefresh() {
    if (deviceListRefreshTimerId) {
        clearInterval(deviceListRefreshTimerId);
        deviceListRefreshTimerId = null;
        console.log('[Ëá™Âä®Âà∑Êñ∞] ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
    }
    // ÂÅúÊ≠¢Âà∑Êñ∞ÂÄíËÆ°Êó∂
    stopRefreshCountdown();
}

function renderSidebar() {
    const list = document.getElementById('deviceSidebarList');
    if (!list) return;

    list.innerHTML = '';

    if (!deviceList.length) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'sidebar-empty';
        emptyDiv.textContent = 'ÊöÇÊó†ËÆæÂ§áÔºåËØ∑ÁÇπÂáª‰∏äÊñπÊ∑ªÂä†';
        list.appendChild(emptyDiv);
        return;
    }

    deviceList.forEach(device => {
        const item = document.createElement('div');
        item.className = 'sidebar-item';
        item.dataset.deviceId = device.id;
        item.innerHTML = `
            <span>${device.name || device.id}</span>
            <span class="sidebar-item-mode">${device.mode || 'ÂÆöÂÄºËØïÈ™å'}</span>
        `;
        // Âè™ËØªÊ®°Âºè‰∏ãÁ¶ÅÁî®‰æßËæπÊ†èËÆæÂ§áÂàóË°®È°πÁöÑÁÇπÂáª
        if (!isReadOnlyMode) {
            item.addEventListener('click', () => {
                setActiveDevice(device.id);
                scrollToDeviceCard(device.id);
                // Ë∞ÉÁî®ËøõÂÖ•ËÆæÂ§áÁöÑÂáΩÊï∞ÔºåÂíåÂè≥‰æßËÆæÂ§áÂç°ÁâáÁÇπÂáªË°å‰∏∫‰∏ÄËá¥
                if (typeof window.enterDevice === 'function') {
                    window.enterDevice(device.id);
                }
            });
        } else {
            // Âè™ËØªÊ®°Âºè‰∏ãÁ¶ÅÁî®ÁÇπÂáª
            item.style.pointerEvents = 'none';
            item.style.opacity = '0.5';
            item.style.cursor = 'not-allowed';
            item.title = 'Âè™ËØªÊ®°ÂºèÔºöÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÁÇπÂáªËÆæÂ§á';
        }
        list.appendChild(item);
    });
}

function setActiveDevice(deviceId) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏ÂàáÊç¢ËÆæÂ§á
    if (isReadOnlyMode) {
        return;
    }
    
    activeDeviceId = deviceId;
    updateActiveIndicators();
}

function updateActiveIndicators() {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
        if (item.dataset.deviceId === activeDeviceId) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    const cards = document.querySelectorAll('.device-card');
    cards.forEach(card => {
        if (card.dataset.deviceId === activeDeviceId) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
}

function scrollToDeviceCard(deviceId) {
    const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// fetchTemperature ÂáΩÊï∞Â∑≤ÁßªÈô§ÔºåÂõ†‰∏∫ refreshDevicesFromServerQuietly Â∑≤Áªè‰ºöÊõ¥Êñ∞ÊâÄÊúâËÆæÂ§áÁöÑÊï∞ÊçÆ
// Á®ãÂºèÂè∑ÁÇπÂáªËÆæÁΩÆÂäüËÉΩÔºàÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆöÔºâ
let programNumberHandlerInitialized = false;
function initProgramNumberClickHandler() {
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    if (!programNumberDisplay) return;
    
    // Â¶ÇÊûúÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåÂÖàÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
    if (programNumberHandlerInitialized) {
        const newDisplay = programNumberDisplay.cloneNode(true);
        programNumberDisplay.parentNode.replaceChild(newDisplay, programNumberDisplay);
    }
    
    // ÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÊñ∞ÂÖãÈöÜÁöÑÔºâ
    const currentProgramNumberDisplay = document.getElementById('programNumberDisplay');
    if (!currentProgramNumberDisplay) return;
    
    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
    currentProgramNumberDisplay.addEventListener('click', function() {
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÁ®ãÂºèËØïÈ™åÈ°µÈù¢
        const programPage = document.getElementById('programPage');
        if (!programPage || !programPage.classList.contains('active')) {
            return;
        }
        
        // Ëé∑ÂèñÂΩìÂâçÊ¥ªÂä®ËÆæÂ§áÁöÑÊï∞ÊçÆ
        const activeDevice = deviceList.find(d => d.id === activeDeviceId);
        if (!activeDevice || !activeDevice.raw) {
            console.warn('Êú™ÊâæÂà∞Ê¥ªÂä®ËÆæÂ§áÊï∞ÊçÆ');
            return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÂÅúÊ≠¢Áä∂ÊÄÅ
        const runStatus = activeDevice.raw.run_status;
        const isRunning = runStatus === 'ËøêË°å' || runStatus === '1' || runStatus === 1 || 
                         (typeof runStatus === 'string' && runStatus.includes('ËøêË°å'));
        
        if (isRunning) {
            showAlert('ËÆæÂ§áÊ≠£Âú®ËøêË°å‰∏≠ÔºåÊó†Ê≥ï‰øÆÊîπÁ®ãÂºèÂè∑ÔºÅËØ∑ÂÖàÂÅúÊ≠¢ËØïÈ™å„ÄÇ', 'Êó†Ê≥ï‰øÆÊîπ', 'warning');
            return;
        }
        
        // ÊâìÂºÄÊï∞ÂÄºËæìÂÖ•ÂØπËØùÊ°Ü
        openProgramNumberInput();
    });
    
    programNumberHandlerInitialized = true;
}

// Êõ¥Êñ∞Á®ãÂºèÂè∑ÊòæÁ§∫ÁöÑÂèØÁÇπÂáªÁä∂ÊÄÅ
function updateProgramNumberClickableState(isRunning) {
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    const programTempLabel = document.getElementById('programTempLabel');
    
    if (!programNumberDisplay || !programTempLabel) return;
    
    // Âè™ÊúâÂú®ÂÅúÊ≠¢Áä∂ÊÄÅ‰∏îÊòæÁ§∫Á®ãÂºèÂè∑Êó∂ÊâçÂèØÁÇπÂáª
    const isShowingProgramNumber = programTempLabel.textContent === 'Á®ãÂºèÂè∑';
    
    if (!isRunning && isShowingProgramNumber) {
        programNumberDisplay.classList.add('clickable');
    } else {
        programNumberDisplay.classList.remove('clickable');
    }
}

// ÊâìÂºÄÁ®ãÂºèÂè∑ËæìÂÖ•ÂØπËØùÊ°Ü
function openProgramNumberInput() {
    const modal = document.getElementById('valueInputModal');
    const label = document.getElementById('valueInputLabel');
    const range = document.getElementById('valueInputRange');
    const input = document.getElementById('valueInput');
    
    if (!modal || !label || !range || !input) return;
    
    // ËÆæÁΩÆÂØπËØùÊ°ÜÊ†áÈ¢òÂíåËåÉÂõ¥
    label.textContent = 'ËÆæÂÆöÁ®ãÂºèÂè∑';
    range.textContent = '[0 - 999]';
    
    // Ëé∑ÂèñÂΩìÂâçÁ®ãÂºèÂè∑
    const currentValue = window.tempProgramNumber !== null ? window.tempProgramNumber : 
                        (document.getElementById('programNumberDisplay').textContent || '0');
    input.value = parseInt(currentValue) || 0;
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    modal.dataset.inputType = 'programNumber'; // Ê†áËÆ∞ËæìÂÖ•Á±ªÂûã
    
    // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
    setTimeout(() => input.focus(), 100);
}

// Á°ÆËÆ§Á®ãÂºèÂè∑ËæìÂÖ•
function confirmProgramNumberInput(value) {
    const numValue = parseInt(value);
    
    // È™åËØÅËåÉÂõ¥
    if (isNaN(numValue) || numValue < 0 || numValue > 999) {
        showAlert('Á®ãÂºèÂè∑ÂøÖÈ°ªÂú® 0 Âà∞ 999 ‰πãÈó¥ÔºÅ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        return false;
    }
    
    // ‰øùÂ≠ò‰∏¥Êó∂Á®ãÂºèÂè∑
    window.tempProgramNumber = numValue;
    window.isProgramNumberModified = true;
    
    // Êõ¥Êñ∞ÊòæÁ§∫ÔºàÁõ¥Êé•ÊòæÁ§∫Êï¥Êï∞Ôºå‰∏çË°•Èõ∂Ôºâ
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    if (programNumberDisplay) {
        programNumberDisplay.textContent = String(numValue);
        programNumberDisplay.classList.add('modified');
    }
    
    console.log('Á®ãÂºèÂè∑Â∑≤‰∏¥Êó∂ËÆæÁΩÆ‰∏∫:', numValue);
    return true;
}

// ÈáçÁΩÆÁ®ãÂºèÂè∑‰∏¥Êó∂‰øÆÊîπ
function resetProgramNumberModification() {
    window.tempProgramNumber = null;
    window.isProgramNumberModified = false;
    
    // ÊÅ¢Â§çÊòæÁ§∫Ê†∑Âºè
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    if (programNumberDisplay) {
        programNumberDisplay.classList.remove('modified');
        programNumberDisplay.style.color = '';
        programNumberDisplay.style.fontWeight = '';
    }
    
    console.log('Á®ãÂºèÂè∑‰∏¥Êó∂‰øÆÊîπÂ∑≤ÈáçÁΩÆ');
}

// ÈáçÁΩÆÂÆöÂÄºËØïÈ™åËÆæÂÆöÂÄº‰∏¥Êó∂‰øÆÊîπ
function resetConstantValueModification() {
    window.tempTargetTemp = null;
    window.tempTargetHumidity = null;
    window.isTargetTempModified = false;
    window.isTargetHumidityModified = false;
    
    // ÊÅ¢Â§çÊòæÁ§∫Ê†∑Âºè
    const targetTempDisplay = document.getElementById('targetTempDisplay');
    const targetHumidityDisplay = document.getElementById('targetHumidityDisplay');
    
    if (targetTempDisplay) {
        targetTempDisplay.classList.remove('modified');
        targetTempDisplay.style.color = '';
        targetTempDisplay.style.fontWeight = '';
    }
    
    if (targetHumidityDisplay) {
        targetHumidityDisplay.classList.remove('modified');
        targetHumidityDisplay.style.color = '';
        targetHumidityDisplay.style.fontWeight = '';
    }
    
    console.log('ÂÆöÂÄºËÆæÂÆöÂÄº‰∏¥Êó∂‰øÆÊîπÂ∑≤ÈáçÁΩÆ');
}

// ÈáçÁΩÆÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏¥Êó∂‰øÆÊîπÔºàÈíàÂØπÂΩìÂâçËÆæÂ§áÔºâ
function resetTimerModification(deviceId) {
    if (!deviceId) return;
    
    const settings = getDeviceTimerSettings(deviceId);
    if (settings) {
        settings.timerEnabled = null;
        settings.timerTime = null;
        settings.isTimerEnabledModified = false;
        settings.isTimerTimeModified = false;
    }
    
    // ÊÅ¢Â§çÊòæÁ§∫Ê†∑Âºè
    const runTimeInput = document.getElementById('runTimeInput');
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    
    if (runTimeInput) {
        runTimeInput.classList.remove('modified');
        runTimeInput.style.color = '';
        runTimeInput.style.fontWeight = '';
    }
    
    if (timerOff && timerOn) {
        timerOff.classList.remove('modified');
        timerOn.classList.remove('modified');
        // ÊÅ¢Â§çÈªòËÆ§Áä∂ÊÄÅÔºàÂÖ≥Èó≠Ôºâ
        timerOff.classList.add('active');
        timerOn.classList.remove('active');
    }
    
    console.log(`ÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏¥Êó∂‰øÆÊîπÂ∑≤ÈáçÁΩÆ: ${deviceId}`);
}

// ËøòÂéüÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏∫ÂàùÂßãÂÄºÔºà0Âíå0.00Ôºâ
function resetTimerSettingsToDefault() {
    // Ëé∑ÂèñÂΩìÂâçËÆæÂ§áIDÔºà‰ºòÂÖà‰ªéwindowÂØπË±°Ëé∑ÂèñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ªéÈ°µÈù¢ÂÖÉÁ¥†Ëé∑ÂèñÔºâ
    let currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : null;
    
    // Â¶ÇÊûúwindowÂØπË±°‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªéÈ°µÈù¢ÊòæÁ§∫ÁöÑËÆæÂ§áIDÂÖÉÁ¥†Ëé∑Âèñ
    if (!currentDeviceId) {
        const constantDeviceIdElement = document.getElementById('constantDeviceId');
        const programDeviceIdElement = document.getElementById('programDeviceId');
        
        if (constantDeviceIdElement && constantDeviceIdElement.textContent && constantDeviceIdElement.textContent !== '--') {
            currentDeviceId = constantDeviceIdElement.textContent.trim();
        } else if (programDeviceIdElement && programDeviceIdElement.textContent && programDeviceIdElement.textContent !== '--') {
            currentDeviceId = programDeviceIdElement.textContent.trim();
        }
    }
    
    // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÔºåÂ∞ùËØï‰ªéactiveDeviceIdËé∑Âèñ
    if (!currentDeviceId && typeof activeDeviceId !== 'undefined' && activeDeviceId) {
        currentDeviceId = activeDeviceId;
    }
    
    if (!currentDeviceId) {
        // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÊòæÁ§∫ÊèêÁ§∫
        return;
    }
    
    // ÈáçÁΩÆËÆæÂ§áËÆæÁΩÆ
    const settings = getDeviceTimerSettings(currentDeviceId);
    if (settings) {
        settings.timerEnabled = 0; // ËÆæÁΩÆ‰∏∫ÂÖ≥Èó≠
        settings.timerTime = '0.00'; // ËÆæÁΩÆ‰∏∫0.00
        settings.isTimerEnabledModified = true; // Ê†áËÆ∞‰∏∫Â∑≤‰øÆÊîπÔºàËøôÊ†∑‰ºö‰øùÂ≠òÂà∞ÂëΩ‰ª§‰∏≠Ôºâ
        settings.isTimerTimeModified = true;
    }
    
    // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
    const runTimeInput = document.getElementById('runTimeInput');
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    
    if (runTimeInput) {
        runTimeInput.value = '0.00';
        runTimeInput.classList.remove('modified');
    }
    
    if (timerOff && timerOn) {
        timerOff.classList.add('active');
        timerOff.classList.remove('modified');
        timerOn.classList.remove('active', 'modified');
    }
    
    console.log(`ÂÆöÊó∂ËøêË°åÂèÇÊï∞Â∑≤ËøòÂéü‰∏∫ÂàùÂßãÂÄº: ${currentDeviceId}`);
}

// Âä†ËΩΩÊåáÂÆöËÆæÂ§áÁöÑÂÆöÊó∂ËøêË°åÂèÇÊï∞Âà∞È°µÈù¢ÔºàÊö¥Èú≤Âà∞windowÂØπË±°‰æõapp.jsË∞ÉÁî®Ôºâ
window.loadDeviceTimerSettings = function(deviceId) {
    if (!deviceId) return;
    
    const settings = getDeviceTimerSettings(deviceId);
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    const runTimeInput = document.getElementById('runTimeInput');
    
    // Âä†ËΩΩÂÆöÊó∂ËøêË°åÂºÄÂÖ≥
    if (timerOff && timerOn) {
        if (settings.isTimerEnabledModified && settings.timerEnabled !== null) {
            // ‰ΩøÁî®‰øùÂ≠òÁöÑÂÄº
            if (settings.timerEnabled === 0) {
                timerOff.classList.add('active', 'modified');
                timerOn.classList.remove('active', 'modified');
            } else {
                timerOn.classList.add('active', 'modified');
                timerOff.classList.remove('active', 'modified');
            }
        } else {
            // ‰ΩøÁî®ÈªòËÆ§ÂÄºÔºàÂÖ≥Èó≠Ôºâ
            timerOff.classList.add('active');
            timerOn.classList.remove('active');
            timerOff.classList.remove('modified');
            timerOn.classList.remove('modified');
        }
    }
    
    // Âä†ËΩΩÂÆöÊó∂ËøêË°åÊó∂Èó¥
    if (runTimeInput) {
        if (settings.isTimerTimeModified && settings.timerTime !== null) {
            runTimeInput.value = settings.timerTime;
            runTimeInput.classList.add('modified');
        } else {
            runTimeInput.value = '0.00';
            runTimeInput.classList.remove('modified');
        }
    }
    
    console.log(`Â∑≤Âä†ËΩΩËÆæÂ§áÂÆöÊó∂ËøêË°åÂèÇÊï∞: ${deviceId}`, settings);
};

// ÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπÔºàÈúÄË¶Å‰º†ÂÖ•ÂΩìÂâçËÆæÂ§áIDÔºâ
function resetAllTemporaryModifications(deviceId) {
    resetProgramNumberModification();
    resetConstantValueModification();
    if (deviceId) {
        resetTimerModification(deviceId);
    }
}

// ÂàùÂßãÂåñÂÆöÊó∂ËøêË°åËÆæÁΩÆÔºàÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆöÔºâ
let timerSettingsInitialized = false;
function initTimerSettings() {
    // Â¶ÇÊûúÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåÂÖàÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
    if (timerSettingsInitialized) {
        const timerOff = document.getElementById('timerOff');
        const timerOn = document.getElementById('timerOn');
        const runTimeInput = document.getElementById('runTimeInput');
        
        if (timerOff) {
            const newTimerOff = timerOff.cloneNode(true);
            timerOff.parentNode.replaceChild(newTimerOff, timerOff);
        }
        if (timerOn) {
            const newTimerOn = timerOn.cloneNode(true);
            timerOn.parentNode.replaceChild(newTimerOn, timerOn);
        }
        if (runTimeInput) {
            const newRunTimeInput = runTimeInput.cloneNode(true);
            runTimeInput.parentNode.replaceChild(newRunTimeInput, runTimeInput);
        }
    }
    
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    const runTimeInput = document.getElementById('runTimeInput');
    
    // ÂÆöÊó∂ËøêË°åÂºÄÂÖ≥ÁÇπÂáªÂ§ÑÁêÜ
    if (timerOff && timerOn) {
        timerOff.addEventListener('click', function() {
            timerOff.classList.add('active', 'modified');
            timerOn.classList.remove('active', 'modified');
            // ‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπÂà∞ÂΩìÂâçËÆæÂ§á
            const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                   (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
            if (currentDeviceId) {
                setDeviceTimerSettings(currentDeviceId, {
                    timerEnabled: 0,
                    isTimerEnabledModified: true
                });
                console.log(`ÂÆöÊó∂ËøêË°åÂ∑≤ËÆæÁΩÆ‰∏∫ÔºöÂÖ≥Èó≠ (ËÆæÂ§á: ${currentDeviceId})`);
            }
        });
        
        timerOn.addEventListener('click', function() {
            timerOn.classList.add('active', 'modified');
            timerOff.classList.remove('active', 'modified');
            // ‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπÂà∞ÂΩìÂâçËÆæÂ§á
            const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                   (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
            if (currentDeviceId) {
                setDeviceTimerSettings(currentDeviceId, {
                    timerEnabled: 1,
                    isTimerEnabledModified: true
                });
                console.log(`ÂÆöÊó∂ËøêË°åÂ∑≤ËÆæÁΩÆ‰∏∫ÔºöÊâìÂºÄ (ËÆæÂ§á: ${currentDeviceId})`);
            }
        });
    }
    
    // ÂÆöÊó∂ËøêË°åÊó∂Èó¥ËæìÂÖ•È™åËØÅ
    if (runTimeInput) {
        runTimeInput.addEventListener('input', function(e) {
            validateTimerTimeInput(e.target);
        });
        
        runTimeInput.addEventListener('blur', function(e) {
            validateAndFormatTimerTime(e.target);
        });
    }
    
    timerSettingsInitialized = true;
}

// È™åËØÅÂÆöÊó∂ËøêË°åÊó∂Èó¥ËæìÂÖ•ÔºàÂÆûÊó∂È™åËØÅÔºâ
function validateTimerTimeInput(input) {
    let value = input.value.trim();
    
    // Âè™ÂÖÅËÆ∏Êï∞Â≠óÂíåÂ∞èÊï∞ÁÇπ
    value = value.replace(/[^\d.]/g, '');
    
    // Á°Æ‰øùÂè™Êúâ‰∏Ä‰∏™Â∞èÊï∞ÁÇπ
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    input.value = value;
}

// È™åËØÅÂπ∂Ê†ºÂºèÂåñÂÆöÊó∂ËøêË°åÊó∂Èó¥
function validateAndFormatTimerTime(input) {
    let value = input.value.trim();
    
    if (value === '') {
        input.value = '0.00';
        return;
    }
    
    // Ëß£ÊûêH.MÊ†ºÂºè
    const parts = value.split('.');
    let hours = 0;
    let minutes = 0;
    
    if (parts.length === 1) {
        // Âè™ÊúâÂ∞èÊó∂ÔºåÊ≤°ÊúâÂàÜÈíü
        hours = parseInt(parts[0]) || 0;
        minutes = 0;
    } else if (parts.length === 2) {
        // ÊúâÂ∞èÊó∂ÂíåÂàÜÈíü
        hours = parseInt(parts[0]) || 0;
        let minutesStr = parts[1];
        
        // Â¶ÇÊûúÂàÜÈíüÈÉ®ÂàÜË∂ÖËøá2‰ΩçÔºåÂè™ÂèñÂâç2‰Ωç
        if (minutesStr.length > 2) {
            minutesStr = minutesStr.substring(0, 2);
        }
        
        minutes = parseInt(minutesStr) || 0;
        
        // È™åËØÅÂàÜÈíü‰∏çËÉΩË∂ÖËøá60
        if (minutes > 60) {
            showAlert('ÂàÜÈíüÊï∞‰∏çËÉΩË∂ÖËøá60ÔºÅËØ∑ËæìÂÖ•0-60‰πãÈó¥ÁöÑÂàÜÈíüÊï∞„ÄÇ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
            input.value = hours + '.00';
            return;
        }
    } else {
        // Ê†ºÂºèÈîôËØØÔºåÈáçÁΩÆ‰∏∫0.00
        showAlert('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊ†ºÂºèÔºàH.MÔºâÔºå‰æãÂ¶ÇÔºö2.30 Ë°®Á§∫2Â∞èÊó∂30ÂàÜÈíü', 'Ê†ºÂºèÈîôËØØ', 'warning');
        input.value = '0.00';
        return;
    }
    
    // Ê†ºÂºèÂåñÊòæÁ§∫ÔºàÂàÜÈíüÈÉ®ÂàÜË°•Èõ∂Âà∞2‰ΩçÔºâ
    const formattedValue = hours + '.' + String(minutes).padStart(2, '0');
    input.value = formattedValue;
    
    // ‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπÂà∞ÂΩìÂâçËÆæÂ§á
    const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                           (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
    if (currentDeviceId) {
        setDeviceTimerSettings(currentDeviceId, {
            timerTime: formattedValue,
            isTimerTimeModified: true
        });
        console.log(`ÂÆöÊó∂ËøêË°åÊó∂Èó¥Â∑≤ËÆæÁΩÆ‰∏∫: ${formattedValue} (ËÆæÂ§á: ${currentDeviceId})`);
    }
    
    input.classList.add('modified');
}

// Â∞ÜH.MÊ†ºÂºèËΩ¨Êç¢‰∏∫H*100+MÊ†ºÂºèÔºàÁî®‰∫é‰º†ÂèÇÔºâ
function convertTimerTimeToParam(timeStr) {
    if (!timeStr || timeStr === '') {
        return 0;
    }
    
    const parts = timeStr.split('.');
    let hours = 0;
    let minutes = 0;
    
    if (parts.length === 1) {
        hours = parseInt(parts[0]) || 0;
        minutes = 0;
    } else if (parts.length === 2) {
        hours = parseInt(parts[0]) || 0;
        minutes = parseInt(parts[1]) || 0;
    } else {
        return 0;
    }
    
    // È™åËØÅÂàÜÈíü‰∏çËÉΩË∂ÖËøá60
    if (minutes > 60) {
        console.warn('ÂÆöÊó∂ËøêË°åÊó∂Èó¥ÂàÜÈíüÊï∞Ë∂ÖËøá60ÔºåÂ∑≤ÈáçÁΩÆ‰∏∫60');
        minutes = 60;
    }
    
    // ËΩ¨Êç¢‰∏∫H*100+MÊ†ºÂºè
    return hours * 100 + minutes;
}

// ‰æßËæπÊ†èÊòæÁ§∫/ÈöêËóèÊéßÂà∂
function toggleSidebar() {
    const sidebar = document.getElementById('deviceSidebar');
    const layout = document.getElementById('monitorLayout');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    
    if (!sidebar || !layout || !toggleBtn) return;
    
    const isHidden = sidebar.classList.contains('hidden');
    
    if (isHidden) {
        // ÊòæÁ§∫‰æßËæπÊ†è
        sidebar.classList.remove('hidden');
        layout.classList.remove('sidebar-hidden');
        toggleBtn.textContent = '‚óÄ';
        toggleBtn.title = 'ÈöêËóè‰æßËæπÊ†è';
        localStorage.setItem('sidebarHidden', 'false');
    } else {
        // ÈöêËóè‰æßËæπÊ†è
        sidebar.classList.add('hidden');
        layout.classList.add('sidebar-hidden');
        toggleBtn.textContent = '‚ñ∂';
        toggleBtn.title = 'ÊòæÁ§∫‰æßËæπÊ†è';
        localStorage.setItem('sidebarHidden', 'true');
    }
}

// ÂàùÂßãÂåñ‰æßËæπÊ†èÁä∂ÊÄÅÔºà‰ªélocalStorageËØªÂèñÁî®Êà∑ÂÅèÂ•ΩÔºâ
function initSidebarState() {
    const sidebar = document.getElementById('deviceSidebar');
    const layout = document.getElementById('monitorLayout');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    
    if (!sidebar || !layout || !toggleBtn) return;
    
    const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
    
    if (sidebarHidden) {
        sidebar.classList.add('hidden');
        layout.classList.add('sidebar-hidden');
        toggleBtn.textContent = '‚ñ∂';
        toggleBtn.title = 'ÊòæÁ§∫‰æßËæπÊ†è';
    } else {
        sidebar.classList.remove('hidden');
        layout.classList.remove('sidebar-hidden');
        toggleBtn.textContent = '‚óÄ';
        toggleBtn.title = 'ÈöêËóè‰æßËæπÊ†è';
    }
}

// ÂÖ®Â±ÄÂèòÈáèÔºöÁî®Êà∑ÊùÉÈôêÁä∂ÊÄÅ
let hasEditPermission = false;
let isReadOnlyMode = false;

// Ê£ÄÊü•Áî®Êà∑ÁºñËæëÊùÉÈôê
async function checkEditPermission() {
    try {
        // È¶ñÂÖàÊ£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÁöÑÁî®Êà∑ÂêçÂíåÈÉ®Èó®ÂêçÁß∞Ôºà‰ºòÂÖàÊ£ÄÊü•Ôºâ
        const localUsername = localStorage.getItem('username') || '';
        const localDepartmentName = localStorage.getItem('departmentName') || '';
        const allowedUsers = ['Âç¢ÂÅ•', 'Êà¥ÊùèÂçé'];
        
        // Â¶ÇÊûúÊú¨Âú∞ÁºìÂ≠òÁöÑÁî®Êà∑ÂêçÊòØÂÖÅËÆ∏ÁöÑÁî®Êà∑ÔºåÊàñËÄÖÈÉ®Èó®ÂêçÁß∞ÊòØ"ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§"ÔºåÁõ¥Êé•Êéà‰∫àÁºñËæëÊùÉÈôê
        const isAllowedUser = localUsername && allowedUsers.includes(localUsername);
        const isReliabilityLab = localDepartmentName === 'ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§';
        
        if (isAllowedUser || isReliabilityLab) {
            hasEditPermission = true;
            isReadOnlyMode = false;
            
            console.log('ÊùÉÈôêÊ£ÄÊü•ÁªìÊûúÔºàÊú¨Âú∞ÁºìÂ≠òÔºâ:', {
                hasEditPermission: hasEditPermission,
                username: localUsername,
                departmentName: localDepartmentName,
                source: 'localStorage',
                message: isAllowedUser ? 'ÈÄöËøáÊú¨Âú∞ÁºìÂ≠òÁî®Êà∑ÂêçËé∑ÂæóÁºñËæëÊùÉÈôê' : 'ÈÄöËøáÊú¨Âú∞ÁºìÂ≠òÈÉ®Èó®ÂêçÁß∞Ëé∑ÂæóÁºñËæëÊùÉÈôê'
            });
            
            // Â∫îÁî®ÊùÉÈôêËÆæÁΩÆ
            applyPermissionSettings();
            
            return hasEditPermission;
        }
        
        // Â¶ÇÊûúÊú¨Âú∞ÁºìÂ≠ò‰∏≠Ê≤°ÊúâÂÖÅËÆ∏ÁöÑÁî®Êà∑ÔºåÂàôË∞ÉÁî®APIÊ£ÄÊü•
        const response = await fetch('/api/checkEditPermission', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            console.error('ÊùÉÈôêÊ£ÄÊü•Â§±Ë¥•:', response.status);
            // APIÂ§±Ë¥•Êó∂ÔºåÂÜçÊ¨°Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÔºàÁî®Êà∑ÂêçÊàñÈÉ®Èó®ÂêçÁß∞Ôºâ
            const isAllowedUser = localUsername && allowedUsers.includes(localUsername);
            const isReliabilityLab = localDepartmentName === 'ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§';
            
            if (isAllowedUser || isReliabilityLab) {
                hasEditPermission = true;
                isReadOnlyMode = false;
                applyPermissionSettings();
                return true;
            }
            return false;
        }
        
        const data = await response.json();
        hasEditPermission = data.hasEditPermission === true;
        
        // Â¶ÇÊûúAPIËøîÂõûÁöÑÁî®Êà∑Âêç‰πüÂú®ÂÖÅËÆ∏ÂàóË°®‰∏≠Ôºå‰πüÊéà‰∫àÁºñËæëÊùÉÈôê
        const apiUsername = data.username || '';
        if (apiUsername && allowedUsers.includes(apiUsername)) {
            hasEditPermission = true;
        }
        
        // Â¶ÇÊûúAPIËøîÂõûÁöÑÈÉ®Èó®ÂêçÁß∞ÊòØ"ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§"Ôºå‰πüÊéà‰∫àÁºñËæëÊùÉÈôê
        const apiDepartmentName = data.departmentName || '';
        if (apiDepartmentName === 'ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§') {
            hasEditPermission = true;
        }
        
        // ÂÜçÊ¨°Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÁöÑÈÉ®Èó®ÂêçÁß∞Ôºà‰Ωú‰∏∫Â§áÁî®Ê£ÄÊü•Ôºâ
        if (localDepartmentName === 'ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§') {
            hasEditPermission = true;
        }
        
        isReadOnlyMode = !hasEditPermission;
        
        console.log('ÊùÉÈôêÊ£ÄÊü•ÁªìÊûú:', {
            hasEditPermission: hasEditPermission,
            username: data.username || localUsername,
            localUsername: localUsername,
            departmentName: data.departmentName,
            message: data.message,
            source: 'API'
        });
        
        // Â∫îÁî®ÊùÉÈôêËÆæÁΩÆ
        applyPermissionSettings();
        
        return hasEditPermission;
    } catch (error) {
        console.error('Ê£ÄÊü•ÊùÉÈôêÊó∂ÂèëÁîüÈîôËØØ:', error);
        
        // ÂèëÁîüÈîôËØØÊó∂ÔºåÊ£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÔºàÁî®Êà∑ÂêçÊàñÈÉ®Èó®ÂêçÁß∞Ôºâ
        const localUsername = localStorage.getItem('username') || '';
        const localDepartmentName = localStorage.getItem('departmentName') || '';
        const allowedUsers = ['Âç¢ÂÅ•', 'Êà¥ÊùèÂçé'];
        
        const isAllowedUser = localUsername && allowedUsers.includes(localUsername);
        const isReliabilityLab = localDepartmentName === 'ÂèØÈù†ÊÄßÂÆûÈ™åÂÆ§';
        
        if (isAllowedUser || isReliabilityLab) {
            hasEditPermission = true;
            isReadOnlyMode = false;
            applyPermissionSettings();
            return true;
        }
        
        // ÈªòËÆ§ËÆæÁΩÆ‰∏∫Âè™ËØªÊ®°Âºè
        hasEditPermission = false;
        isReadOnlyMode = true;
        applyPermissionSettings();
        return false;
    }
}

// Â∫îÁî®ÊùÉÈôêËÆæÁΩÆÔºàÁ¶ÅÁî®/ÂêØÁî®ÊâÄÊúâÊåâÈíÆÂíåÂèØ‰∫§‰∫íÂÖÉÁ¥†Ôºâ
function applyPermissionSettings() {
    if (isReadOnlyMode) {
        // Âè™ËØªÊ®°ÂºèÔºöÁ¶ÅÁî®ÊâÄÊúâÊåâÈíÆÂíåÂèØ‰∫§‰∫íÂÖÉÁ¥†
        disableAllInteractiveElements();
        showReadOnlyModeIndicator();
    } else {
        // ÁºñËæëÊ®°ÂºèÔºöÂêØÁî®ÊâÄÊúâÊåâÈíÆÂíåÂèØ‰∫§‰∫íÂÖÉÁ¥†
        enableAllInteractiveElements();
        hideReadOnlyModeIndicator();
    }
}

// Á¶ÅÁî®ÊâÄÊúâÂèØ‰∫§‰∫íÂÖÉÁ¥†
function disableAllInteractiveElements() {
    // ÂÖÅËÆ∏ÁöÑÊåâÈíÆÂíåÈìæÊé•IDÂàóË°®ÔºàÂè™ËØªÊ®°Âºè‰∏ã‰ªçÁÑ∂ÂèØÁî®Ôºâ
    const allowedIds = ['backHomeBtn', 'refreshDataBtn', 'dataManagementBtn', 'oeeAnalysisBtn'];
    
    // Á¶ÅÁî®ÊâÄÊúâÊåâÈíÆÔºàÊéíÈô§ÂÖÅËÆ∏ÁöÑÊåâÈíÆÔºâ
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        if (!btn.id || !allowedIds.includes(btn.id)) {
            btn.disabled = true;
            btn.style.opacity = '0.5';
            btn.style.cursor = 'not-allowed';
            btn.style.pointerEvents = 'none';
        }
    });
    
    // Á¶ÅÁî®ÊâÄÊúâÈìæÊé•ÔºàÊéíÈô§ÂÖÅËÆ∏ÁöÑÈìæÊé•Ôºâ
    const links = document.querySelectorAll('a');
    links.forEach(link => {
        if (!link.id || !allowedIds.includes(link.id)) {
            link.style.pointerEvents = 'none';
            link.style.opacity = '0.5';
            link.style.cursor = 'not-allowed';
            // ÈòªÊ≠¢ÁÇπÂáª‰∫ã‰ª∂
            link.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }, true);
        }
    });
    
    // Á¶ÅÁî®ÊâÄÊúâËæìÂÖ•Ê°Ü
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.disabled = true;
        input.readOnly = true;
        input.style.opacity = '0.5';
        input.style.cursor = 'not-allowed';
    });
    
    // Á¶ÅÁî®ÊâÄÊúâÂèØÁÇπÂáªÁöÑÂÖÉÁ¥†ÔºàÂ¶ÇËÆæÂ§áÂç°Áâá„ÄÅ‰æßËæπÊ†èÊ∑ªÂä†ÊåâÈíÆ„ÄÅ‰æßËæπÊ†èËÆæÂ§áÂàóË°®È°πÁ≠âÔºâ
    const clickableElements = document.querySelectorAll('.sidebar-add-card, .device-card, .sidebar-item, .control-input-clickable, .menu-item, .menu-btn');
    clickableElements.forEach(el => {
        el.style.pointerEvents = 'none';
        el.style.opacity = '0.5';
        el.style.cursor = 'not-allowed';
    });
    
    // Á¶ÅÁî®ÊâÄÊúâ onclick ‰∫ã‰ª∂ÔºàÊéíÈô§ÂÖÅËÆ∏ÁöÑÊåâÈíÆÔºâ
    const elementsWithOnclick = document.querySelectorAll('[onclick]');
    elementsWithOnclick.forEach(el => {
        // Ê£ÄÊü•ÊòØÂê¶ÊòØÂÖÅËÆ∏ÁöÑÊåâÈíÆ
        const isAllowed = el.id && allowedIds.includes(el.id);
        if (!isAllowed) {
            const originalOnclick = el.getAttribute('onclick');
            el.setAttribute('data-original-onclick', originalOnclick);
            el.removeAttribute('onclick');
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
            el.style.cursor = 'not-allowed';
        }
    });
}

// ÂêØÁî®ÊâÄÊúâÂèØ‰∫§‰∫íÂÖÉÁ¥†
function enableAllInteractiveElements() {
    // ÂêØÁî®ÊâÄÊúâÊåâÈíÆ
    const buttons = document.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.disabled = false;
        btn.style.opacity = '';
        btn.style.cursor = '';
        btn.style.pointerEvents = '';
    });
    
    // ÂêØÁî®ÊâÄÊúâÈìæÊé•
    const links = document.querySelectorAll('a');
    links.forEach(link => {
        link.style.pointerEvents = '';
        link.style.opacity = '';
        link.style.cursor = '';
    });
    
    // ÂêØÁî®ÊâÄÊúâËæìÂÖ•Ê°Ü
    const inputs = document.querySelectorAll('input, textarea, select');
    inputs.forEach(input => {
        input.disabled = false;
        input.readOnly = false;
        input.style.opacity = '';
        input.style.cursor = '';
    });
    
    // ÂêØÁî®ÊâÄÊúâÂèØÁÇπÂáªÁöÑÂÖÉÁ¥†
    const clickableElements = document.querySelectorAll('.sidebar-add-card, .device-card, .control-input-clickable, .menu-item, .menu-btn');
    clickableElements.forEach(el => {
        el.style.pointerEvents = '';
        el.style.opacity = '';
        el.style.cursor = '';
    });
    
    // ÊÅ¢Â§çÊâÄÊúâ onclick ‰∫ã‰ª∂
    const elementsWithOnclick = document.querySelectorAll('[data-original-onclick]');
    elementsWithOnclick.forEach(el => {
        const originalOnclick = el.getAttribute('data-original-onclick');
        if (originalOnclick) {
            el.setAttribute('onclick', originalOnclick);
            el.removeAttribute('data-original-onclick');
        }
        el.style.pointerEvents = '';
        el.style.opacity = '';
        el.style.cursor = '';
    });
}

// ÊòæÁ§∫Âè™ËØªÊ®°ÂºèÊåáÁ§∫Âô®
function showReadOnlyModeIndicator() {
    // ÂàõÂª∫Âè™ËØªÊ®°ÂºèÊèêÁ§∫
    let indicator = document.getElementById('readOnlyModeIndicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'readOnlyModeIndicator';
        indicator.style.cssText = `
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            pointer-events: none;
        `;
        indicator.innerHTML = 'üîí Âè™ËØªÊ®°Âºè - ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôê';
        document.body.appendChild(indicator);
    }
    indicator.style.display = 'block';
}

// ÈöêËóèÂè™ËØªÊ®°ÂºèÊåáÁ§∫Âô®
function hideReadOnlyModeIndicator() {
    const indicator = document.getElementById('readOnlyModeIndicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // È¶ñÂÖàÊ£ÄÊü•Áî®Êà∑ÊùÉÈôê
    checkEditPermission().then(() => {
        // ÊùÉÈôêÊ£ÄÊü•ÂÆåÊàêÂêéÂÜçÂàùÂßãÂåñÂÖ∂‰ªñÂäüËÉΩ
        initializeDeviceModule();
        // ÂàùÂßãÂåñ‰æßËæπÊ†èÁä∂ÊÄÅ
        initSidebarState();
        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆÔºåÁ°Æ‰øùËé∑ÂèñÊúÄÊñ∞Â≠óÊÆµ
        setTimeout(() => {
            refreshDevicesFromServer();
        }, 1000);
        
        // ÂàùÂßãÂåñÁ®ãÂºèÂè∑ÁÇπÂáªÂ§ÑÁêÜ
        setTimeout(() => {
            initProgramNumberClickHandler();
        }, 1500);
        
        // ÂàùÂßãÂåñÂÆöÊó∂ËøêË°åËÆæÁΩÆ
        setTimeout(() => {
            initTimerSettings();
        }, 1500);
    });
});

// È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®ÂíåËµÑÊ∫ê
window.addEventListener('beforeunload', function() {
    // Ê∏ÖÁêÜËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®
    if (deviceListRefreshTimerId) {
        clearInterval(deviceListRefreshTimerId);
        deviceListRefreshTimerId = null;
    }
    // ÂÅúÊ≠¢Âà∑Êñ∞ÂÄíËÆ°Êó∂
    stopRefreshCountdown();
    
    // Ê∏ÖÁêÜËá™Âä®Ëé∑ÂèñÂÆöÊó∂Âô®ÔºàÂ∑≤ÁßªÈô§Ôºå‰∏çÂÜçÈúÄË¶ÅÔºâ
    
    // Ê∏ÖÁêÜËÆæÂ§áÂç°ÁâáÁºìÂ≠ò
    deviceCardCache.clear();
    
    // ÂèñÊ∂àÊ≠£Âú®ËøõË°åÁöÑËØ∑Ê±Ç
    if (isRefreshing) {
        isRefreshing = false;
    }
});

// È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÂà∑Êñ∞ÔºåÈ°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§ç
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÂà∑Êñ∞
        if (deviceListRefreshTimerId) {
            clearInterval(deviceListRefreshTimerId);
            deviceListRefreshTimerId = null;
        }
        // ÂÅúÊ≠¢Âà∑Êñ∞ÂÄíËÆ°Êó∂
        stopRefreshCountdown();
    } else {
        // È°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§çÂà∑Êñ∞
        const deviceMonitorPage = document.getElementById('deviceMonitorPage');
        if (deviceMonitorPage && deviceMonitorPage.classList.contains('active')) {
            if (!deviceListRefreshTimerId && typeof window.startDeviceListAutoRefresh === 'function') {
                window.startDeviceListAutoRefresh();
            }
        }
    }
});

// Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ
function forceRefreshData() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const originalText = refreshBtn.textContent;
    refreshBtn.textContent = 'üîÑ Âà∑Êñ∞‰∏≠...';
    refreshBtn.disabled = true;

    fetch('/iot/data/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(async response => {
        // Ê£ÄÊü•ÂìçÂ∫îÁ±ªÂûã
        const contentType = response.headers.get('content-type');

        // Â¶ÇÊûúËøîÂõûÁöÑ‰∏çÊòØJSONÔºåÂèØËÉΩÊòØHTMLÈîôËØØÈ°µÈù¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('ÈùûJSONÂìçÂ∫î:', text.substring(0, 200));

            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            // ÈáçÊñ∞Ê∏≤ÊüìËÆæÂ§áÊï∞ÊçÆ
            if (data.data && Array.isArray(data.data)) {
                const transformed = data.data.map(item => transformDeviceRecord(item, 0));
                // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊó©ÂàõÂª∫ÁöÑÂú®ÊúÄÂâçÈù¢ÔºåÊñ∞ËÆæÂ§áÂú®ÊúÄÂêéÔºâ
                transformed.sort((a, b) => {
                    const timeA = a.raw.created_at || a.raw.createdAt || '9999-12-31 23:59:59';
                    const timeB = b.raw.created_at || b.raw.createdAt || '9999-12-31 23:59:59';
                    // ÂçáÂ∫èÊéíÂ∫èÔºöÊó©ÁöÑÊó∂Èó¥Âú®ÂâçÔºåÊôöÁöÑÊó∂Èó¥Âú®Âêé
                    if (timeA < timeB) return -1;
                    if (timeA > timeB) return 1;
                    return 0;
                });
                console.log('[Âº∫Âà∂Âà∑Êñ∞] ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÂÆåÊàêÔºåËÆæÂ§áÈ°∫Â∫è:', transformed.map(d => `${d.id}(${d.raw.created_at || d.raw.createdAt})`));
                deviceList = transformed;
                if (deviceList.length > 0) {
                    activeDeviceId = deviceList[0].id;
                } else {
                    activeDeviceId = null;
                }
                renderDevices();
                showResult(`Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäüÔºÅÂÖ±Âä†ËΩΩ‰∫Ü ${data.count} Âè∞ËÆæÂ§á`, 'success');
            } else {
                deviceList = [];
                activeDeviceId = null;
                renderDevices();
                showResult('Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäüÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞ËÆæÂ§áÊï∞ÊçÆ', 'success');
            }
        } else {
            showResult('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    })
    .catch(error => {
        console.error('Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•:', error);
        if (error.message && error.message.includes('<!DOCTYPE')) {
            showResult('Âà∑Êñ∞Â§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜHTMLÈ°µÈù¢ÔºåÂèØËÉΩÊòØÁôªÂΩïËÆ§ËØÅÈóÆÈ¢ò', 'error');
        } else {
            showResult('Âà∑Êñ∞Â§±Ë¥•Ôºö' + error.message, 'error');
        }
    })
    .finally(() => {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        refreshBtn.textContent = originalText;
        refreshBtn.disabled = false;
        // ÈáçÁΩÆÂÄíËÆ°Êó∂
        refreshCountdown = 20;
        updateRefreshButtonCountdown();
    });
}

// ÂèëÈÄÅÂëΩ‰ª§Áõ∏ÂÖ≥ÂáΩÊï∞
function openCommandModal() {
    document.getElementById('commandModal').style.display = 'block';
    document.getElementById('resultMessage').innerHTML = '';

    // ËÆæÁΩÆÈªòËÆ§JSONÊï∞ÊçÆ
    const defaultJson = `{
  "device_id": "DEVICE001",
  "valueorprogram": "1",
  "fixed_temp_set": "25.0",
  "fixed_hum_set": "60.0",
  "set_program_number": "1",
  "set_run_status": "1",
  "set_program_no": "0",
  "create_by": "Âç¢ÂÅ•"
}`;

    const jsonInput = document.getElementById('jsonInput');
    if (jsonInput && !jsonInput.value.trim()) {
        jsonInput.value = defaultJson;
    }
}

function closeCommandModal() {
    document.getElementById('commandModal').style.display = 'none';
}

function formatJson() {
    const jsonInput = document.getElementById('jsonInput');
    try {
        const jsonObj = JSON.parse(jsonInput.value);
        jsonInput.value = JSON.stringify(jsonObj, null, 2);
        showResult('JSONÊ†ºÂºèÂåñÊàêÂäüÔºÅ', 'success');
    } catch (e) {
        showResult('JSONÊ†ºÂºèÈîôËØØÔºö' + e.message, 'error');
    }
}

function clearJson() {
    document.getElementById('jsonInput').value = '';
    document.getElementById('resultMessage').innerHTML = '';
}

function sendCommand() {
    const jsonInput = document.getElementById('jsonInput');
    const jsonText = jsonInput.value.trim();
    
    if (!jsonText) {
        showResult('ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆ', 'error');
        return;
    }

    let jsonData;
    try {
        jsonData = JSON.parse(jsonText);
    } catch (e) {
        showResult('JSONÊ†ºÂºèÈîôËØØÔºö' + e.message, 'error');
        return;
    }

    // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
    const requiredFields = ['device_id', 'valueorprogram', 'set_run_status', 'create_by'];
    const missingFields = requiredFields.filter(field => !jsonData[field]);

    if (missingFields.length > 0) {
        showResult('Áº∫Â∞ëÂøÖÂ°´Â≠óÊÆµÔºö' + missingFields.join(', '), 'error');
        return;
    }

    // È™åËØÅvalueorprogramÂ≠óÊÆµ
    if (!['0', '1'].includes(String(jsonData.valueorprogram))) {
        showResult('valueorprogramÂ≠óÊÆµÂøÖÈ°ªÊòØ0Êàñ1Ôºà0=Á®ãÂºèËØïÈ™åÔºå1=ÂÆöÂÄºËØïÈ™åÔºâ', 'error');
        return;
    }

    // È™åËØÅset_run_statusÂ≠óÊÆµ
    if (!['0', '1', '2'].includes(String(jsonData.set_run_status))) {
        showResult('set_run_statusÂ≠óÊÆµÂøÖÈ°ªÊòØ0„ÄÅ1Êàñ2Ôºà0=ÂÅúÊ≠¢Ôºå1=ËøêË°åÔºå2=ÊöÇÂÅúÔºâ', 'error');
        return;
    }

    showResult('Ê≠£Âú®ÂèëÈÄÅÂëΩ‰ª§...', 'loading');

    fetch('/iot/createCommand', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(async response => {
        // Ê£ÄÊü•ÂìçÂ∫îÁ±ªÂûã
        const contentType = response.headers.get('content-type');
        
        // Â¶ÇÊûúËøîÂõûÁöÑ‰∏çÊòØJSONÔºåÂèØËÉΩÊòØHTMLÈîôËØØÈ°µÈù¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('ÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
            
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                showResult('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü', 'error');
            } else {
                showResult('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ', 'error');
            }
            return null;
        }
        
        // Ëß£ÊûêJSONÂìçÂ∫î
        return response.json();
    })
    .then(data => {
        if (data === null) return; // Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÈîôËØØ
        
        if (data.success) {
            showResult('ÂëΩ‰ª§ÂèëÈÄÅÊàêÂäüÔºÅÂëΩ‰ª§ID: ' + (data.id || 'N/A'), 'success');
            setTimeout(() => {
                clearJson();
            }, 3000);
        } else {
            showResult('ÂëΩ‰ª§ÂèëÈÄÅÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message && error.message.includes('<!DOCTYPE')) {
            showResult('ÂèëÈÄÅËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜHTMLÈ°µÈù¢ÔºåÂèØËÉΩÊòØÁôªÂΩïËÆ§ËØÅÈóÆÈ¢ò', 'error');
        } else {
            showResult('ÂèëÈÄÅËØ∑Ê±ÇÂ§±Ë¥•Ôºö' + error.message, 'error');
        }
    });
}

function showResult(message, type) {
    const resultDiv = document.getElementById('resultMessage');
    resultDiv.textContent = message;
    resultDiv.className = 'result-message ' + type;
    resultDiv.style.display = 'block';
}

// ÈÄöÁî®ÊèêÁ§∫Ê®°ÊÄÅÊ°ÜÂáΩÊï∞ÔºàÊö¥Èú≤Âà∞windowÂØπË±°‰æõapp.js‰ΩøÁî®Ôºâ
window.showAlert = function(message, title = 'ÊèêÁ§∫', type = 'info') {
    const modal = document.getElementById('alertModal');
    const titleElement = document.getElementById('alertModalTitle');
    const messageElement = document.getElementById('alertModalMessage');
    const iconElement = document.getElementById('alertModalIcon');
    
    if (!modal || !titleElement || !messageElement || !iconElement) return;
    
    // ËÆæÁΩÆÊ†áÈ¢òÂíåÊ∂àÊÅØ
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // ËÆæÁΩÆÂõæÊ†á
    const icons = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå'
    };
    iconElement.textContent = icons[type] || icons['info'];
    iconElement.className = 'alert-modal-icon ' + type;
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
};

window.closeAlertModal = function() {
    const modal = document.getElementById('alertModal');
    if (modal) {
        modal.style.display = 'none';
    }
};

// ÊòæÁ§∫Ê†∑ÂìÅ‰ø°ÊÅØËØ¶ÊÉÖ
function showSampleInfo(sample) {
    const modal = document.getElementById('sampleInfoModal');
    const testerElement = document.getElementById('sampleInfoTester');
    const modelElement = document.getElementById('sampleInfoModel');
    const categoryElement = document.getElementById('sampleInfoCategory');
    const startTestingBtn = document.getElementById('startTestingBtn');
    const cancelWaitingBtn = document.getElementById('cancelWaitingBtn');
    const completeTestingBtn = document.getElementById('completeTestingBtn');
    const cancelTestingBtn = document.getElementById('cancelTestingBtn');
    
    if (!modal || !testerElement || !modelElement || !categoryElement) return;
    
    // Â°´ÂÖÖÊ†∑ÂìÅ‰ø°ÊÅØ
    testerElement.textContent = sample.tester || 'Êú™Â°´ÂÜô';
    modelElement.textContent = sample.model || 'Êú™Â°´ÂÜô';
    categoryElement.textContent = sample.category || 'Êú™Â°´ÂÜô';
    
    // ‰øùÂ≠òÊ†∑ÂìÅ‰ø°ÊÅØÂà∞Ê®°ÊÄÅÊ°ÜÁöÑdataset‰∏≠Ôºå‰æõÂêéÁª≠‰ΩøÁî®
    modal.dataset.sampleId = sample.id || '';
    modal.dataset.deviceId = sample.deviceId || '';
    modal.dataset.sampleStatus = sample.status || '';
    
    // Ê†πÊçÆÊ†∑ÂìÅÁä∂ÊÄÅÊòæÁ§∫/ÈöêËóèÊåâÈíÆ
    // WAITINGÁä∂ÊÄÅÔºöÊòæÁ§∫"ËΩ¨ÂÖ•ÊµãËØï"Âíå"ÂèñÊ∂àÈ¢ÑÁ∫¶"
    // TESTINGÁä∂ÊÄÅÔºöÊòæÁ§∫"Â∑≤ÂÆåÊàêÊµãËØï"Âíå"ÂèñÊ∂àÊµãËØï"
    // ÂÖ∂‰ªñÁä∂ÊÄÅÔºö‰∏çÊòæÁ§∫Êìç‰ΩúÊåâÈíÆ
    
    // ÈáçÁΩÆÊâÄÊúâÊåâÈíÆÁöÑÊòæÁ§∫Áä∂ÊÄÅ
    if (startTestingBtn) startTestingBtn.style.display = 'none';
    if (cancelWaitingBtn) cancelWaitingBtn.style.display = 'none';
    if (completeTestingBtn) completeTestingBtn.style.display = 'none';
    if (cancelTestingBtn) cancelTestingBtn.style.display = 'none';
    
    if (sample.status === 'WAITING') {
        if (startTestingBtn) startTestingBtn.style.display = 'inline-block';
        if (cancelWaitingBtn) cancelWaitingBtn.style.display = 'inline-block';
    } else if (sample.status === 'TESTING') {
        if (completeTestingBtn) completeTestingBtn.style.display = 'inline-block';
        if (cancelTestingBtn) cancelTestingBtn.style.display = 'inline-block';
    }
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
}

// ÂÖ≥Èó≠Ê†∑ÂìÅ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
function closeSampleInfoModal() {
    const modal = document.getElementById('sampleInfoModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Â∞ÜÈ¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅËΩ¨ÂÖ•ÊµãËØï
function startTestingSample() {
    const modal = document.getElementById('sampleInfoModal');
    if (!modal) return;
    
    const sampleId = modal.dataset.sampleId;
    const deviceId = modal.dataset.deviceId;
    
    if (!sampleId || !deviceId) {
        if (typeof showAlert === 'function') {
            showAlert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïËΩ¨ÂÖ•ÊµãËØï', 'ÈîôËØØ', 'error');
        } else {
            alert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïËΩ¨ÂÖ•ÊµãËØï');
        }
        return;
    }
    
    // Á°ÆËÆ§Êìç‰Ωú
    if (!confirm('Á°ÆÂÆöË¶ÅÂ∞ÜÊ≠§Ê†∑ÂìÅ‰ªéÈ¢ÑÁ∫¶Á≠âÂÄôËΩ¨ÂÖ•ÊµãËØïÈò∂ÊÆµÂêóÔºü')) {
        return;
    }
    
    // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
    fetch('/iot/sample/startTesting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            sample_id: sampleId,
            device_id: deviceId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeSampleInfoModal();
            // Âà∑Êñ∞ËÆæÂ§áÊï∞ÊçÆÔºåÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
            if (typeof refreshDevicesFromServer === 'function') {
                refreshDevicesFromServer().then(() => {
                    if (typeof showAlert === 'function') {
                        showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüËΩ¨ÂÖ•ÊµãËØïÈò∂ÊÆµ', 'ÊàêÂäü', 'success');
                    } else {
                        alert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüËΩ¨ÂÖ•ÊµãËØïÈò∂ÊÆµ');
                    }
                });
            } else {
                // Â¶ÇÊûúrefreshDevicesFromServer‰∏çÂ≠òÂú®ÔºåÂàôÂà∑Êñ∞È°µÈù¢
                if (typeof showAlert === 'function') {
                    showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüËΩ¨ÂÖ•ÊµãËØïÈò∂ÊÆµÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞', 'ÊàêÂäü', 'success');
                }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            if (typeof showAlert === 'function') {
                showAlert(data.message || 'ËΩ¨ÂÖ•ÊµãËØïÂ§±Ë¥•', 'ÈîôËØØ', 'error');
            } else {
                alert(data.message || 'ËΩ¨ÂÖ•ÊµãËØïÂ§±Ë¥•');
            }
        }
    })
    .catch(error => {
        console.error('ËΩ¨ÂÖ•ÊµãËØïÂ§±Ë¥•:', error);
        if (typeof showAlert === 'function') {
            showAlert('ËΩ¨ÂÖ•ÊµãËØïÂ§±Ë¥•: ' + error.message, 'ÈîôËØØ', 'error');
        } else {
            alert('ËΩ¨ÂÖ•ÊµãËØïÂ§±Ë¥•: ' + error.message);
        }
    });
}

// ÂèñÊ∂àÈ¢ÑÁ∫¶Á≠âÂÄôÁöÑÊ†∑ÂìÅÊµãËØï
function cancelTestingSample() {
    const modal = document.getElementById('sampleInfoModal');
    if (!modal) return;
    
    const sampleId = modal.dataset.sampleId;
    const deviceId = modal.dataset.deviceId;
    
    if (!sampleId || !deviceId) {
        if (typeof showAlert === 'function') {
            showAlert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂèñÊ∂àÈ¢ÑÁ∫¶', 'ÈîôËØØ', 'error');
        } else {
            alert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂèñÊ∂àÈ¢ÑÁ∫¶');
        }
        return;
    }
    
    // Á°ÆËÆ§Êìç‰Ωú
    if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÊ≠§Ê†∑ÂìÅÁöÑÊµãËØïÈ¢ÑÁ∫¶ÂêóÔºüÂèñÊ∂àÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ')) {
        return;
    }
    
    // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
    fetch('/iot/sample/cancelTesting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            sample_id: sampleId,
            device_id: deviceId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeSampleInfoModal();
            // Âà∑Êñ∞ËÆæÂ§áÊï∞ÊçÆÔºåÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
            if (typeof refreshDevicesFromServer === 'function') {
                refreshDevicesFromServer().then(() => {
                    if (typeof showAlert === 'function') {
                        showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÂèñÊ∂àÊµãËØïÈ¢ÑÁ∫¶', 'ÊàêÂäü', 'success');
                    } else {
                        alert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÂèñÊ∂àÊµãËØïÈ¢ÑÁ∫¶');
                    }
                });
            } else {
                // Â¶ÇÊûúrefreshDevicesFromServer‰∏çÂ≠òÂú®ÔºåÂàôÂà∑Êñ∞È°µÈù¢
                if (typeof showAlert === 'function') {
                    showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÂèñÊ∂àÊµãËØïÈ¢ÑÁ∫¶ÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞', 'ÊàêÂäü', 'success');
                }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            if (typeof showAlert === 'function') {
                showAlert(data.message || 'ÂèñÊ∂àÈ¢ÑÁ∫¶Â§±Ë¥•', 'ÈîôËØØ', 'error');
            } else {
                alert(data.message || 'ÂèñÊ∂àÈ¢ÑÁ∫¶Â§±Ë¥•');
            }
        }
    })
    .catch(error => {
        console.error('ÂèñÊ∂àÈ¢ÑÁ∫¶Â§±Ë¥•:', error);
        if (typeof showAlert === 'function') {
            showAlert('ÂèñÊ∂àÈ¢ÑÁ∫¶Â§±Ë¥•: ' + error.message, 'ÈîôËØØ', 'error');
        } else {
            alert('ÂèñÊ∂àÈ¢ÑÁ∫¶Â§±Ë¥•: ' + error.message);
        }
    });
}

// ÂÆåÊàêÊµãËØï‰∏≠ÁöÑÊ†∑ÂìÅ
function completeTestingSample() {
    const modal = document.getElementById('sampleInfoModal');
    if (!modal) return;
    
    const sampleId = modal.dataset.sampleId;
    const deviceId = modal.dataset.deviceId;
    
    if (!sampleId || !deviceId) {
        if (typeof showAlert === 'function') {
            showAlert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂÆåÊàêÊµãËØï', 'ÈîôËØØ', 'error');
        } else {
            alert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂÆåÊàêÊµãËØï');
        }
        return;
    }
    
    // ÊòæÁ§∫ÊµãËØïÁªìÊûúÈÄâÊã©ÂØπËØùÊ°Ü
    showTestResultDialog(sampleId, deviceId);
}

// ÊòæÁ§∫ÊµãËØïÁªìÊûúÈÄâÊã©ÂØπËØùÊ°Ü
function showTestResultDialog(sampleId, deviceId) {
    // ÂàõÂª∫ÂØπËØùÊ°ÜHTML
    const dialogHTML = `
        <div id="testResultDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; display: flex; align-items: center; justify-content: center;" onclick="if(event.target.id === 'testResultDialog') closeTestResultDialog();">
            <div style="background: white; border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; box-shadow: 0 8px 24px rgba(0,0,0,0.2);" onclick="event.stopPropagation();">
                <h3 style="margin: 0 0 20px 0; color: #111827; font-size: 18px; font-weight: 700;">ÈÄâÊã©ÊµãËØïÁªìÊûú</h3>
                <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 14px;">ËØ∑ÈÄâÊã©Ê≠§Ê†∑ÂìÅÁöÑÊµãËØïÁªìÊûúÔºö</p>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 24px;">
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                           onmouseover="this.style.borderColor='#6366f1'; this.style.background='#f0f4ff';" 
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                        <input type="radio" name="testResult" value="PASS" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;" checked>
                        <span style="font-size: 15px; font-weight: 600; color: #10b981;">‚úÖ PASSÔºàÈÄöËøáÔºâ</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                           onmouseover="this.style.borderColor='#6366f1'; this.style.background='#f0f4ff';" 
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                        <input type="radio" name="testResult" value="FAIL" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 15px; font-weight: 600; color: #ef4444;">‚ùå FAILÔºàÂ§±Ë¥•Ôºâ</span>
                    </label>
                    <label style="display: flex; align-items: center; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; transition: all 0.2s;" 
                           onmouseover="this.style.borderColor='#6366f1'; this.style.background='#f0f4ff';" 
                           onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                        <input type="radio" name="testResult" value="PARTIAL_OK" style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 15px; font-weight: 600; color: #f59e0b;">‚ö†Ô∏è ÈÉ®ÂàÜOK</span>
                    </label>
                </div>
                <div style="display: flex; gap: 12px; justify-content: flex-end;">
                    <button onclick="closeTestResultDialog()" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 8px; background: white; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.2s;" 
                            onmouseover="this.style.borderColor='#d1d5db'; this.style.background='#f9fafb';" 
                            onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white';">
                        ÂèñÊ∂à
                    </button>
                    <button onclick="confirmCompleteTesting('${sampleId}', '${deviceId}')" style="padding: 10px 20px; border: none; border-radius: 8px; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; font-weight: 600; cursor: pointer; transition: all 0.2s;" 
                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(99,102,241,0.3)';" 
                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                        Á°ÆÂÆö
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // ÁßªÈô§Â∑≤Â≠òÂú®ÁöÑÂØπËØùÊ°Ü
    const existingDialog = document.getElementById('testResultDialog');
    if (existingDialog) {
        existingDialog.remove();
    }
    
    // Ê∑ªÂä†ÂØπËØùÊ°ÜÂà∞È°µÈù¢
    document.body.insertAdjacentHTML('beforeend', dialogHTML);
}

// ÂÖ≥Èó≠ÊµãËØïÁªìÊûúÂØπËØùÊ°Ü
function closeTestResultDialog() {
    const dialog = document.getElementById('testResultDialog');
    if (dialog) {
        dialog.remove();
    }
}

// Á°ÆËÆ§ÂÆåÊàêÊµãËØï
function confirmCompleteTesting(sampleId, deviceId) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏ÂÆåÊàêÊµãËØï
    if (isReadOnlyMode) {
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÂÆåÊàêÊµãËØï', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    // Ëé∑ÂèñÈÄâ‰∏≠ÁöÑÊµãËØïÁªìÊûú
    const selectedResult = document.querySelector('input[name="testResult"]:checked');
    if (!selectedResult) {
        if (typeof showAlert === 'function') {
            showAlert('ËØ∑ÈÄâÊã©ÊµãËØïÁªìÊûú', 'ÊèêÁ§∫', 'warning');
        } else {
            alert('ËØ∑ÈÄâÊã©ÊµãËØïÁªìÊûú');
        }
        return;
    }
    
    const testResult = selectedResult.value;
    
    // ÂÖ≥Èó≠ÂØπËØùÊ°Ü
    closeTestResultDialog();
    
    // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
    fetch('/iot/sample/completeTesting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            sample_id: sampleId,
            device_id: deviceId,
            test_result: testResult
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeSampleInfoModal();
            // Âà∑Êñ∞ËÆæÂ§áÊï∞ÊçÆÔºåÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
            if (typeof refreshDevicesFromServer === 'function') {
                refreshDevicesFromServer().then(() => {
                    if (typeof showAlert === 'function') {
                        showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÊ†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÊµãËØï', 'ÊàêÂäü', 'success');
                    } else {
                        alert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÊ†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÊµãËØï');
                    }
                });
            } else {
                // Â¶ÇÊûúrefreshDevicesFromServer‰∏çÂ≠òÂú®ÔºåÂàôÂà∑Êñ∞È°µÈù¢
                if (typeof showAlert === 'function') {
                    showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÊ†áËÆ∞‰∏∫Â∑≤ÂÆåÊàêÊµãËØïÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞', 'ÊàêÂäü', 'success');
                }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            if (typeof showAlert === 'function') {
                showAlert(data.message || 'ÂÆåÊàêÊµãËØïÂ§±Ë¥•', 'ÈîôËØØ', 'error');
            } else {
                alert(data.message || 'ÂÆåÊàêÊµãËØïÂ§±Ë¥•');
            }
        }
    })
    .catch(error => {
        console.error('ÂÆåÊàêÊµãËØïÂ§±Ë¥•:', error);
        if (typeof showAlert === 'function') {
            showAlert('ÂÆåÊàêÊµãËØïÂ§±Ë¥•: ' + error.message, 'ÈîôËØØ', 'error');
        } else {
            alert('ÂÆåÊàêÊµãËØïÂ§±Ë¥•: ' + error.message);
        }
    });
}

// ÂèñÊ∂àÊµãËØï‰∏≠ÁöÑÊ†∑ÂìÅ
function cancelTestingSampleForTesting() {
    const modal = document.getElementById('sampleInfoModal');
    if (!modal) return;
    
    const sampleId = modal.dataset.sampleId;
    const deviceId = modal.dataset.deviceId;
    
    if (!sampleId || !deviceId) {
        if (typeof showAlert === 'function') {
            showAlert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂèñÊ∂àÊµãËØï', 'ÈîôËØØ', 'error');
        } else {
            alert('Ê†∑ÂìÅ‰ø°ÊÅØ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÂèñÊ∂àÊµãËØï');
        }
        return;
    }
    
    // Á°ÆËÆ§Êìç‰Ωú
    if (!confirm('Á°ÆÂÆöË¶ÅÂèñÊ∂àÊ≠§Ê†∑ÂìÅÁöÑÊµãËØïÂêóÔºüÂèñÊ∂àÂêéÂ∞ÜÊó†Ê≥ïÊÅ¢Â§ç„ÄÇ')) {
        return;
    }
    
    // ÂèëÈÄÅËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
    fetch('/iot/sample/cancelTestingForTesting', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            sample_id: sampleId,
            device_id: deviceId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeSampleInfoModal();
            // Âà∑Êñ∞ËÆæÂ§áÊï∞ÊçÆÔºåÈáçÊñ∞Ê∏≤ÊüìÈ°µÈù¢
            if (typeof refreshDevicesFromServer === 'function') {
                refreshDevicesFromServer().then(() => {
                    if (typeof showAlert === 'function') {
                        showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÂèñÊ∂àÊµãËØï', 'ÊàêÂäü', 'success');
                    } else {
                        alert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÂèñÊ∂àÊµãËØï');
                    }
                });
            } else {
                // Â¶ÇÊûúrefreshDevicesFromServer‰∏çÂ≠òÂú®ÔºåÂàôÂà∑Êñ∞È°µÈù¢
                if (typeof showAlert === 'function') {
                    showAlert('Ê†∑ÂìÅÂ∑≤ÊàêÂäüÂèñÊ∂àÊµãËØïÔºåÈ°µÈù¢Â∞ÜÂà∑Êñ∞', 'ÊàêÂäü', 'success');
                }
                setTimeout(() => {
                    location.reload();
                }, 1000);
            }
        } else {
            if (typeof showAlert === 'function') {
                showAlert(data.message || 'ÂèñÊ∂àÊµãËØïÂ§±Ë¥•', 'ÈîôËØØ', 'error');
            } else {
                alert(data.message || 'ÂèñÊ∂àÊµãËØïÂ§±Ë¥•');
            }
        }
    })
    .catch(error => {
        console.error('ÂèñÊ∂àÊµãËØïÂ§±Ë¥•:', error);
        if (typeof showAlert === 'function') {
            showAlert('ÂèñÊ∂àÊµãËØïÂ§±Ë¥•: ' + error.message, 'ÈîôËØØ', 'error');
        } else {
            alert('ÂèñÊ∂àÊµãËØïÂ§±Ë¥•: ' + error.message);
        }
    });
}

// ÊâìÂºÄÈ¢ÑÁ∫¶Á≠âÂÄôÊ†∑ÂìÅË°®ÂçïÊ®°ÊÄÅÊ°Ü
function openWaitingSampleFormModal(deviceId) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏ÊâìÂºÄ
    if (isReadOnlyMode) {
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÊ∑ªÂä†È¢ÑÁ∫¶Ê†∑ÂìÅ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    const modal = document.getElementById('waitingSampleFormModal');
    const form = document.getElementById('waitingSampleForm');
    
    if (!modal || !form) return;
    
    // ‰øùÂ≠òËÆæÂ§áIDÂà∞Ë°®Âçï
    form.dataset.deviceId = deviceId;
    
    // ‰ªélocalStorageËé∑ÂèñÂΩìÂâçÁî®Êà∑Âêç
    const username = localStorage.getItem('username') || '';
    
    // Ê∏ÖÁ©∫Ë°®ÂçïÂπ∂Â°´ÂÖÖÈªòËÆ§ÂÄº
    const testerInput = document.getElementById('waitingSampleTester');
    const modelInput = document.getElementById('waitingSampleModel');
    const categoryInput = document.getElementById('waitingSampleCategory');
    
    if (testerInput) {
        testerInput.value = username; // ÈªòËÆ§Â°´ÂÖÖÂΩìÂâçÁî®Êà∑Âêç
    }
    if (modelInput) {
        modelInput.value = '';
    }
    if (categoryInput) {
        categoryInput.value = '';
    }
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    
    // ËÅöÁÑ¶Âà∞ÂûãÂè∑ËæìÂÖ•Ê°ÜÔºàÁ¨¨‰∏Ä‰∏™Â≠óÊÆµÔºâ
    if (modelInput) {
        setTimeout(() => {
            modelInput.focus();
        }, 100);
    }
}

// ÂÖ≥Èó≠È¢ÑÁ∫¶Á≠âÂÄôÊ†∑ÂìÅË°®ÂçïÊ®°ÊÄÅÊ°Ü
function closeWaitingSampleFormModal() {
    const modal = document.getElementById('waitingSampleFormModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// Êèê‰∫§È¢ÑÁ∫¶Á≠âÂÄôÊ†∑ÂìÅË°®Âçï
function submitWaitingSample(event) {
    // ÊùÉÈôêÊ£ÄÊü•ÔºöÂè™ËØªÊ®°Âºè‰∏ã‰∏çÂÖÅËÆ∏Êèê‰∫§
    if (isReadOnlyMode) {
        if (event) {
            event.preventDefault();
        }
        showAlert('ÊÇ®Ê≤°ÊúâÁºñËæëÊùÉÈôêÔºåÊó†Ê≥ïÊèê‰∫§È¢ÑÁ∫¶Ê†∑ÂìÅ', 'ÊùÉÈôê‰∏çË∂≥', 'warning');
        return;
    }
    
    if (event) {
        event.preventDefault();
    }
    
    const form = document.getElementById('waitingSampleForm');
    const deviceId = form.dataset.deviceId;
    
    if (!deviceId) {
        showAlert('ÈîôËØØÔºöÊú™ÊâæÂà∞ËÆæÂ§áID', 'Êèê‰∫§Â§±Ë¥•', 'error');
        return;
    }
    
    // Ëé∑ÂèñË°®ÂçïÊï∞ÊçÆ
    const tester = document.getElementById('waitingSampleTester').value.trim();
    const model = document.getElementById('waitingSampleModel').value.trim();
    const category = document.getElementById('waitingSampleCategory').value.trim();
    
    // È™åËØÅËá≥Â∞ëÂ°´ÂÜô‰∏Ä‰∏™Â≠óÊÆµ
    if (!tester && !model && !category) {
        showAlert('ËØ∑Ëá≥Â∞ëÂ°´ÂÜô‰∏Ä‰∏™Â≠óÊÆµÔºàÊµãËØï‰∫∫Âëò„ÄÅÂûãÂè∑ÊàñÂìÅÁ±ªÔºâ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        return;
    }
    
    // ÊòæÁ§∫Êèê‰∫§‰∏≠ÊèêÁ§∫
    showAlert('Ê≠£Âú®‰øùÂ≠òÈ¢ÑÁ∫¶ÊéíÈòüÊ†∑ÂìÅ‰ø°ÊÅØ...', 'Êèê‰∫§‰∏≠', 'info');
    
    // ÊûÑÂª∫ËØ∑Ê±ÇÊï∞ÊçÆ
    const requestData = {
        device_id: deviceId,
        tester: tester || '',
        model: model || '',
        category: category || '',
        is_waiting: true  // Ê†áËÆ∞‰∏∫È¢ÑÁ∫¶Á≠âÂÄôÊ†∑ÂìÅ
    };
    
    // Ë∞ÉÁî®ÂêéÁ´ØAPI‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ì
    fetch('/iot/device/sample/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestData)
    })
    .then(async response => {
        // Ê£ÄÊü•ÂìçÂ∫îÁ±ªÂûã
        const contentType = response.headers.get('content-type');
        
        // Â¶ÇÊûúËøîÂõûÁöÑ‰∏çÊòØJSONÔºåÂèØËÉΩÊòØHTMLÈîôËØØÈ°µÈù¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('ÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
            
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                showAlert('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü', 'Êèê‰∫§Â§±Ë¥•', 'error');
            } else {
                showAlert('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ', 'Êèê‰∫§Â§±Ë¥•', 'error');
            }
            return null;
        }
        
        // Ëß£ÊûêJSONÂìçÂ∫î
        return response.json();
    })
    .then(data => {
        if (data === null) return; // Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÈîôËØØ
        
        if (data.success) {
            // ÂàõÂª∫Ê†∑ÂìÅÂØπË±°ÔºàÂåÖÂê´ÂêéÁ´ØËøîÂõûÁöÑIDÔºâ
            const sample = {
                id: data.sample_id || data.id,
                tester: tester || '',
                model: model || '',
                category: category || ''
            };
            
            // ÊâæÂà∞ÂØπÂ∫îÁöÑËÆæÂ§áÂπ∂Ê∑ªÂä†Ê†∑ÂìÅÂà∞È¢ÑÁ∫¶Á≠âÂÄôÂàóË°®
            const device = deviceList.find(d => d.id === deviceId);
            
            if (device) {
                // ÂàùÂßãÂåñwaitingSamplesÊï∞ÁªÑÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
                if (!device.waitingSamples) {
                    device.waitingSamples = [];
                }
                if (device.raw && !device.raw.waitingSamples) {
                    device.raw.waitingSamples = [];
                }
                
                // Ê∑ªÂä†Ê†∑ÂìÅÂà∞È¢ÑÁ∫¶Á≠âÂÄôÂàóË°®
                device.waitingSamples.push(sample);
                if (device.raw) {
                    device.raw.waitingSamples.push(sample);
                }
                
                // Êõ¥Êñ∞ËÆæÂ§áÂç°ÁâáÊòæÁ§∫
                const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
                if (card) {
                    updateDeviceCard(card, device);
                }
            }
            
            // ÊòæÁ§∫ÊàêÂäüÊèêÁ§∫
            showAlert('È¢ÑÁ∫¶ÊéíÈòüÊ†∑ÂìÅ‰ø°ÊÅØÂ∑≤‰øùÂ≠òÂà∞Êï∞ÊçÆÂ∫ìÔºÅ', 'Êèê‰∫§ÊàêÂäü', 'success');
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeWaitingSampleFormModal();
        } else {
            showAlert('‰øùÂ≠òÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Êèê‰∫§Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('‰øùÂ≠òËØ∑Ê±ÇÂ§±Ë¥•Ôºö' + error.message, 'Êèê‰∫§Â§±Ë¥•', 'error');
    });
}

// ÊîØÊåÅESCÈîÆÂÖ≥Èó≠ÊèêÁ§∫Ê®°ÊÄÅÊ°Ü
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const alertModal = document.getElementById('alertModal');
        if (alertModal && alertModal.style.display === 'block') {
            closeAlertModal();
        }
        const editDeviceInfoModal = document.getElementById('editDeviceInfoModal');
        if (editDeviceInfoModal && editDeviceInfoModal.style.display === 'block') {
            closeEditDeviceInfoModal();
        }
        const waitingSampleFormModal = document.getElementById('waitingSampleFormModal');
        if (waitingSampleFormModal && waitingSampleFormModal.style.display === 'block') {
            closeWaitingSampleFormModal();
        }
    }
});

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
window.onclick = function(event) {
    const commandModal = document.getElementById('commandModal');
    if (event.target === commandModal) {
        closeCommandModal();
    }
    const deviceFormModal = document.getElementById('deviceFormModal');
    if (event.target === deviceFormModal) {
        closeAddDeviceModal();
    }
    const alertModal = document.getElementById('alertModal');
    if (event.target === alertModal) {
        closeAlertModal();
    }
    const editDeviceInfoModal = document.getElementById('editDeviceInfoModal');
    if (event.target === editDeviceInfoModal) {
        closeEditDeviceInfoModal();
    }
    const sampleInfoModal = document.getElementById('sampleInfoModal');
    if (event.target === sampleInfoModal) {
        closeSampleInfoModal();
    }
    const waitingSampleFormModal = document.getElementById('waitingSampleFormModal');
    if (event.target === waitingSampleFormModal) {
        closeWaitingSampleFormModal();
    }
}

</script>
</body>
</html>
