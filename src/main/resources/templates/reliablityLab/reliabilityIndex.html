<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UApp_boxed</title>
    <link rel="stylesheet" href="/css/reliablityLab/styles.css">
    <style>
        .monitor-header { position: relative; }
        .back-home {
            position: absolute;
            left: 20px;
            top: 20px;
            padding: 8px 14px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: #fff;
            text-decoration: none;
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
            font-weight: 700;
        }
        .back-home:hover {
            background: rgba(99,102,241,0.35);
        }
        .user-info {
            position: absolute;
            right: 20px;
            top: 20px;
            padding: 8px 16px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
        }
        .user-info-username {
            font-weight: 700;
            font-size: 15px;
        }
        .user-info-job {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }
        .title-with-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
        }
        .send-command-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            white-space: nowrap;
        }
        .send-command-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .send-command-btn:active {
            transform: translateY(0) scale(1);
        }
        .refresh-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            white-space: nowrap;
            margin-left: 10px;
        }
        .refresh-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .refresh-btn:active {
            transform: translateY(0) scale(1);
        }
        .monitor-layout {
            display: flex;
            gap: 26px;
            align-items: flex-start;
            margin-top: 24px;
        }
        .device-sidebar {
            width: 260px;
            background: linear-gradient(180deg, rgba(30,41,59,0.85) 0%, rgba(15,23,42,0.85) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 22px;
            box-shadow: 0 12px 32px -16px rgba(15,23,42,0.8);
            backdrop-filter: blur(10px);
            color: #e2e8f0;
            position: sticky;
            top: 32px;
            max-height: calc(100vh - 120px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .device-sidebar-inner {
            display: flex;
            flex-direction: column;
            gap: 22px;
            padding: 24px 20px 28px;
            overflow-y: auto;
        }
        .sidebar-add-card {
            width: 100%;
            border-radius: 16px;
            border: 1px dashed rgba(129, 140, 248, 0.65);
            padding: 20px;
            background: rgba(79, 70, 229, 0.1);
            color: #c7d2fe;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .sidebar-add-card:hover {
            background: rgba(79, 70, 229, 0.18);
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -18px rgba(129, 140, 248, 0.9);
        }
        .sidebar-add-icon {
            width: 46px;
            height: 46px;
            border-radius: 14px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(139, 92, 246, 1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            color: #fff;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.45);
        }
        .sidebar-add-hint {
            font-size: 13px;
            color: rgba(226, 232, 240, 0.85);
        }
        .device-sidebar h3 {
            margin: 0;
            font-size: 16px;
            color: #e2e8f0;
            letter-spacing: 0.6px;
        }
        .sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-item {
            padding: 12px 14px;
            border-radius: 12px;
            background: rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(100, 116, 139, 0.2);
            color: #cbd5f5;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(79, 70, 229, 0.2);
            border-color: rgba(129, 140, 248, 0.35);
        }
        .sidebar-item.active {
            background: rgba(79, 70, 229, 0.28);
            border-color: rgba(129, 140, 248, 0.55);
            box-shadow: inset 0 0 0 1px rgba(129, 140, 248, 0.25);
        }
        .sidebar-item-mode {
            font-size: 12px;
            color: rgba(226, 232, 240, 0.7);
        }
        .sidebar-empty {
            padding: 14px 12px;
            font-size: 13px;
            color: rgba(226, 232, 240, 0.65);
            background: rgba(15, 23, 42, 0.35);
            border-radius: 12px;
            border: 1px dashed rgba(148, 163, 184, 0.2);
        }
        .device-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .device-grid {
            min-height: 180px;
            display: flex;
            flex-direction: column;
            gap: 18px;
            padding-right: 4px;
        }
        .device-grid-inner {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 24px;
        }
        .device-card {
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 22px;
            box-shadow: 0 16px 30px -20px rgba(15, 23, 42, 0.7);
            background: rgba(255, 255, 255, 0.96);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }
        @media (max-width: 960px) {
            .device-grid-inner {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 780px) {
            .monitor-layout {
                flex-direction: column;
            }
            .device-sidebar {
                position: static;
                width: 100%;
            }
        }
        .device-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 22px 40px -22px rgba(79, 70, 229, 0.5);
        }
        .device-card.active {
            border-color: rgba(99, 102, 241, 0.45);
            box-shadow: 0 24px 45px -26px rgba(99, 102, 241, 0.55);
        }
        .device-card-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .device-card:hover .device-card-actions {
            opacity: 1;
        }
        .delete-device-btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(248, 113, 113, 0.5);
            background: rgba(248, 113, 113, 0.12);
            color: #b91c1c;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.25s ease;
        }
        .delete-device-btn:hover {
            background: rgba(248, 113, 113, 0.22);
            border-color: rgba(248, 113, 113, 0.7);
            color: #7f1d1d;
        }
        .device-empty-state {
            padding: 60px 20px;
            border: 2px dashed rgba(148, 163, 184, 0.35);
            border-radius: 24px;
            text-align: center;
            color: #64748b;
            font-size: 16px;
            background: rgba(248, 250, 252, 0.6);
            backdrop-filter: blur(6px);
        }
        .device-form-content {
            max-width: 520px;
        }
        .device-form-body {
            padding: 32px 36px 36px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .device-form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .device-form-group label {
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
        }
        .device-form-group input,
        .device-form-group select {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #cbd5f5;
            font-size: 14px;
            background: #fff;
            transition: all 0.2s ease;
        }
        .device-form-group input:focus,
        .device-form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }
        .device-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 0 36px 32px;
        }
        .device-form-btn {
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .device-form-btn.cancel {
            background: #e2e8f0;
            color: #475569;
        }
        .device-form-btn.cancel:hover {
            background: #cbd5e1;
        }
        .device-form-btn.submit {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
        }
        .device-form-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.25);
        }
        /* æ¨¡æ€æ¡†æ ·å¼ - å…¨æ–°ç°ä»£åŒ–è®¾è®¡ */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            animation: fadeIn 0.25s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            margin: 2% auto;
            border-radius: 28px;
            width: 92%;
            max-width: 950px;
            max-height: none;
            height: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(0, 0, 0, 0.05),
                0 0 100px rgba(102, 126, 234, 0.15);
            animation: modalSlideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: visible;
            position: relative;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #4facfe 75%, 
                #667eea 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px) scale(0.96);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
        }
        .modal-header h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.8px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .modal-header h2::before {
            content: 'ğŸ“¡';
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        .close {
            color: rgba(255, 255, 255, 0.95);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .modal-body {
            padding: 40px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            overflow: visible;
            flex: 1;
            min-height: 0;
        }
        .form-group {
            margin-bottom: 28px;
        }
        .form-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            font-weight: 700;
            color: #1e293b;
            font-size: 16px;
            letter-spacing: -0.3px;
        }
        .form-group label::before {
            content: 'ğŸ“';
            font-size: 20px;
        }
        .json-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            resize: vertical;
            min-height: 520px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: #ffffff;
            color: #0f172a;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .json-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 
                0 0 0 5px rgba(102, 126, 234, 0.1),
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.15);
            background: #ffffff;
            transform: translateY(-1px);
        }
        .json-input::placeholder {
            color: #94a3b8;
            font-style: italic;
        }
        .form-actions {
            display: flex;
            gap: 14px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            min-width: 140px;
            letter-spacing: 0.2px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.4);
            position: relative;
        }
        .btn-primary::after {
            content: 'ğŸš€';
            font-size: 18px;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                0 0 30px rgba(102, 126, 234, 0.5);
        }
        .btn-primary:active {
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #ffffff;
            color: #475569;
            border: 2px solid #e2e8f0;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .btn-secondary:nth-of-type(2)::after {
            content: 'âœ¨';
            font-size: 16px;
        }
        .btn-secondary:nth-of-type(3)::after {
            content: 'ğŸ—‘ï¸';
            font-size: 16px;
        }
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: #334155;
        }
        .result-message {
            padding: 18px 24px;
            border-radius: 12px;
            margin-top: 24px;
            display: none;
            font-weight: 500;
            font-size: 15px;
            animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            line-height: 1.6;
            position: relative;
            overflow: hidden;
        }
        .result-message::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 12px 0 0 12px;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .result-message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #6ee7b7;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }
        .result-message.success::before {
            background: #10b981;
        }
        .result-message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2);
        }
        .result-message.error::before {
            background: #ef4444;
        }
        .result-message.loading {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
        }
        .result-message.loading::before {
            background: #3b82f6;
        }
        /* ç¨‹å¼è¯•éªŒé¡µé¢ç›¸å¯¹å®šä½ï¼Œç¡®ä¿ç»å¯¹å®šä½çš„å­å…ƒç´ æ­£ç¡®å®šä½ */
        #programPage {
            position: relative;
        }

        /* ç¨‹å¼è¯•éªŒçŠ¶æ€ä¿¡æ¯æ¡†æ ·å¼ */
        .program-status-box {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 180px; /* å®šä½åœ¨åŠŸç‡å€¼ä¸‹æ–¹10px */
            z-index: 10;
            width: calc(100% - 48px); /* ä¸è¯•éªŒå®¹å™¨(main-content)ä¸€æ ·å®½ï¼Œå‡å»å·¦å³è¾¹è· */
            margin: 0 24px; /* å·¦å³è¾¹è·24pxï¼Œä¸main-contentä¸€è‡´ */
            padding: 16px 24px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            pointer-events: none; /* ä¸å½±å“ä¸‹é¢çš„ç‚¹å‡»äº‹ä»¶ */
        }

        .program-status-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 15px;
            font-weight: 600;
            pointer-events: auto; /* çŠ¶æ€æ¡†æœ¬èº«å¯ä»¥ç‚¹å‡» */
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .status-item span:last-child {
            font-weight: 700;
            color: #1e3a8a;
        }

        @media (max-width: 768px) {
            .title-with-btn {
                flex-direction: column;
                gap: 10px;
            }
            .send-command-btn {
                font-size: 13px;
                padding: 8px 16px;
            }
            .program-status-content {
                gap: 12px;
                font-size: 13px;
            }
            .program-status-box {
                bottom: 100px; /* ç§»åŠ¨ç«¯åŠŸç‡å€¼ä¸‹æ–¹10px */
                width: calc(100% - 32px); /* ç§»åŠ¨ç«¯è°ƒæ•´å®½åº¦ */
                margin: 0 16px; /* ç§»åŠ¨ç«¯è°ƒæ•´è¾¹è· */
                padding: 12px 18px;
            }
            .modal-content {
                width: 96%;
                margin: 1% auto;
                max-height: none;
                height: auto;
                border-radius: 24px;
                overflow: visible;
            }
            .modal-header {
                padding: 24px 28px;
            }
            .modal-header h2 {
                font-size: 22px;
            }
            .modal-header h2::before {
                font-size: 26px;
            }
            .modal-body {
                padding: 28px 24px;
            }
            .json-input {
                min-height: 450px;
                padding: 16px;
                font-size: 13px;
            }
            .form-actions {
                flex-direction: column;
                gap: 12px;
            }
            .btn {
                width: 100%;
                min-width: unset;
                padding: 14px 24px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- è®¾å¤‡ç›‘æ§é¦–é¡µ -->
    <div id="deviceMonitorPage" class="page active">
        <div class="monitor-header">
            <a class="back-home" href="/">â† è¿”å›ä¸»é¡µ</a>
            <div class="title-with-btn">
                <button class="send-command-btn" onclick="openCommandModal()">ğŸ“¤ å‘é€å‘½ä»¤</button>
                <button class="refresh-btn" onclick="forceRefreshData()" title="å¼ºåˆ¶ä»æ•°æ®åº“åˆ·æ–°æ•°æ®">ğŸ”„ åˆ·æ–°æ•°æ®</button>
                <h1 class="monitor-title">å¯é æ€§ç‰©è”ç½‘æ¸©ç®±ç›‘æ§ç³»ç»Ÿ</h1>
            </div>
            <div class="monitor-datetime" id="monitorDatetime">2025-10-28 13:41:04</div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-info-username" id="userInfoUsername"></div>
                <div class="user-info-job" id="userInfoJob"></div>
            </div>
        </div>

        <div class="monitor-layout">
            <aside class="device-sidebar">
                <div class="device-sidebar-inner">
                    <div class="sidebar-add-card" onclick="openDeviceForm()">
                        <div class="sidebar-add-icon">+</div>
                        <div>æ·»åŠ è®¾å¤‡</div>
                        <div class="sidebar-add-hint">å½•å…¥æ–°çš„æ¸©ç®±å¹¶åŒæ­¥ç›‘æ§ä¿¡æ¯</div>
                    </div>
                    <div>
                        <h3>è®¾å¤‡åˆ—è¡¨</h3>
                        <div id="deviceSidebarList" class="sidebar-list"></div>
                    </div>
                </div>
            </aside>
            <div class="device-content">
                <div class="device-grid">
                    <div id="deviceGrid" class="device-grid-inner"></div>
                    <div id="deviceEmptyState" class="device-empty-state" style="display: none;">
                        å½“å‰æ²¡æœ‰ç›‘æ§ä¸­çš„è®¾å¤‡ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹â€œæ·»åŠ è®¾å¤‡â€å¡ç‰‡åˆ›å»ºã€‚
                    </div>
                </div>
            </div>
        </div>
    </div>
    <template id="deviceCardTemplate">
        <div class="device-card">
            <div class="device-card-actions">
                <button class="delete-device-btn" type="button">ç§»é™¤</button>
            </div>
            <div class="device-card-header">
                <div class="device-name">
                    <span class="device-icon">ğŸŒ¡ï¸</span>
                    <span class="device-id" data-field="deviceId">--</span>
                </div>
                <div class="device-status" data-field="statusWrapper">
                    <span class="status-dot"></span>
                    <span class="status-text" data-field="statusText">--</span>
                </div>
            </div>
            <div class="device-card-body">
                <div class="device-data-section">
                    <div class="data-item">
                        <div class="data-label">æ¸©åº¦</div>
                        <div class="data-value temp-value" data-field="temperature">0<span class="unit">â„ƒ</span></div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">æ¹¿åº¦</div>
                        <div class="data-value humidity-value" data-field="humidity">0<span class="unit">%</span></div>
                    </div>
                </div>
                <div class="device-stats-section">
                    <div class="device-info-grid">
                        <div class="info-item">
                            <span class="info-label">è¿è¡Œæ—¶é—´</span>
                            <span class="info-value" data-field="runtime">0H 00M 00S</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å‰©ä½™æ—¶é—´</span>
                            <span class="info-value" data-field="remaining">--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">å½“å‰æ¨¡å¼</span>
                            <span class="info-value mode" data-field="mode">--</span>
                        </div>
                        <div class="info-item info-item-power">
                            <div class="power-grid">
                                <div class="power-item">
                                    <span class="power-label">æ¸©åº¦åŠŸç‡å€¼</span>
                                    <span class="power-value" data-field="tempPower">0%</span>
                                </div>
                                <div class="power-item">
                                    <span class="power-label">æ¹¿åº¦åŠŸç‡å€¼</span>
                                    <span class="power-value" data-field="humidityPower">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="device-card-footer">
                <div class="connection-status" data-field="connectionWrapper">
                    <span class="connection-dot"></span>
                    <span data-field="connectionText">--</span>
                </div>
                <div class="last-update" data-field="lastUpdate">æ›´æ–°: --</div>
            </div>
        </div>
    </template>

    <!-- ä¸»èœå•é¡µé¢ (WK1) -->
    <div id="menuPage" class="page">
        <div class="menu-header">
            <div class="device-id">U680</div>
            <div class="menu-datetime" id="menuDatetime">2025-10-27 17:46:01</div>
        </div>

        <div class="menu-controls">
            <button class="menu-back-btn" onclick="backToMonitor()">â† è¿”å›ç›‘æ§é¦–é¡µ</button>
        </div>

        <div class="menu-grid">
            <button class="menu-item menu-item-yellow" onclick="navigateTo('constant')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M8 10h8"/>
                </svg>
                <span>å®šå€¼è¯•éªŒ</span>
            </button>

            <button class="menu-item menu-item-red" onclick="navigateTo('program')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M8 8h8M8 12h8M8 16h8"/>
                </svg>
                <span>ç¨‹å¼è¯•éªŒ</span>
            </button>

            <button class="menu-item menu-item-orange" onclick="navigateTo('settings')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M6 8h12M6 12h12M6 16h12"/>
                </svg>
                <span>æ“ä½œè®¾ç½®</span>
            </button>

            <button class="menu-item menu-item-green" onclick="navigateTo('communication')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>é€šè®¯è®¾ç½®</span>
            </button>

            <button class="menu-item menu-item-purple" onclick="navigateTo('appointment')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>é¢„çº¦è®¾ç½®</span>
            </button>
        </div>

        <div class="menu-footer">
            <div class="error-message">æ¸©æ¹¿åº¦æ¨¡å—è¿æ¥å¼‚å¸¸</div>
            <div class="version">V1.9</div>
        </div>
    </div>

    <!-- å®šå€¼è¯•éªŒé¡µé¢ (WK6/WK7) -->
    <div id="constantPage" class="page">
        <div class="header has-device-id">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ç›®å½•</button>
            <div class="device-id" id="constantDeviceId">--</div>
            <h1 class="header-title">å®šå€¼è¯•éªŒ</h1>
            <div class="header-status">
                <div class="status-datetime" id="constantDatetime">2025-10-27 17:46:01</div>
                <div class="status-text" id="constantStatus">è¯•éªŒåœæ­¢</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-temp">
                <div class="panel-header">
                    <span class="panel-title">æ¸©åº¦</span>
                    <span class="panel-unit">â„ƒ</span>
                </div>
                <div class="panel-value" id="currentTemp">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label">è®¾å®šå€¼</span>
                        <div class="control-input-clickable" id="targetTempDisplay">0.0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">åŠŸç‡å€¼</span>
                        <div class="control-display" id="tempPower">0.0%</div>
                    </div>
                </div>
            </div>

            <div class="panel panel-humidity">
                <div class="panel-header">
                    <span class="panel-title">æ¹¿åº¦</span>
                    <span class="panel-unit">%</span>
                </div>
                <div class="panel-value" id="currentHumidity">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label">è®¾å®šå€¼</span>
                        <div class="control-input-clickable" id="targetHumidityDisplay">0.0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">åŠŸç‡å€¼</span>
                        <div class="control-display" id="humidityPower">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="time-display">
                <div class="time-box">
                    <span class="time-label">è¿è¡Œæ—¶é—´:</span>
                    <span class="time-value" id="runtime">0H 00M 00S</span>
                </div>
                <div class="time-box">
                    <span class="time-label">å‰©ä½™æ—¶é—´:</span>
                    <span class="time-value" id="remainingTime">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="settingsBtn">è®¾ç½®</button>
                <button class="action-btn pause-btn" id="chartBtn">æš‚åœ</button>
                <button class="action-btn action-btn-primary" id="runBtn">è¿è¡Œ</button>
            </div>
        </div>
    </div>

    <!-- ç¨‹å¼è¯•éªŒé¡µé¢ -->
    <div id="programPage" class="page">
        <div class="header has-device-id">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ç›®å½•</button>
            <div class="device-id" id="programDeviceId">--</div>
            <h1 class="header-title">ç¨‹å¼è¯•éªŒ</h1>
            <div class="header-status">
                <div class="status-datetime" id="programDatetime">2025-10-27 17:46:01</div>
                <div class="status-text" id="programStatus">è¯•éªŒåœæ­¢</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-temp">
                <div class="panel-header">
                    <span class="panel-title">æ¸©åº¦</span>
                    <span class="panel-unit">â„ƒ</span>
                </div>
                <div class="panel-value" id="programCurrentTemp">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label" id="programTempLabel">ç¨‹å¼å·</span>
                        <div class="control-input-clickable" id="programNumberDisplay">000</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">åŠŸç‡å€¼</span>
                        <div class="control-display" id="programTempPower">0.0%</div>
                    </div>
                </div>
            </div>

            <div class="panel panel-humidity">
                <div class="panel-header">
                    <span class="panel-title">æ¹¿åº¦</span>
                    <span class="panel-unit">%</span>
                </div>
                <div class="panel-value" id="programCurrentHumidity">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label" id="programHumLabel">æ€»æ®µæ•°</span>
                        <div class="control-display" id="totalSegmentsDisplay">00</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">åŠŸç‡å€¼</span>
                        <div class="control-display" id="programHumidityPower">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç¨‹å¼è¯•éªŒçŠ¶æ€ä¿¡æ¯æ¡† -->
        <div id="programStatusBox" class="program-status-box" style="display: none;">
            <div class="program-status-content">
                <span class="status-item">ç¨‹å¼å·ï¼š<span id="programStatusNumber">003</span></span>
                <span class="status-item">æ®µå·ï¼š<span id="programStatusSegment">01</span></span>
                <span class="status-item">ç¨‹å¼å¾ªç¯ï¼š<span id="programStatusCycle">00/05</span></span>
                <span class="status-item">æ®µå¾ªç¯ï¼š<span id="programStatusSegmentCycle">00/00</span></span>
                <span class="status-item">æ€»æ®µæ•°ï¼š<span id="programStatusTotalSegments">004</span></span>
            </div>
        </div>

        <div class="bottom-section">
            <div class="time-display">
                <div class="time-box">
                    <span class="time-label">è¿è¡Œæ—¶é—´:</span>
                    <span class="time-value" id="programRuntime">0H 00M 00S</span>
                </div>
                <div class="time-box">
                    <span class="time-label">å‰©ä½™æ—¶é—´:</span>
                    <span class="time-value" id="programRemainingTime">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="editBtn">ç¼–è¾‘</button>
                <button class="action-btn pause-btn" id="programChartBtn">æš‚åœ</button>
                <button class="action-btn action-btn-primary" id="programRunBtn">è¿è¡Œ</button>
            </div>
        </div>
    </div>

    <!-- æ“ä½œè®¾ç½®é¡µé¢ (WK8) -->
    <div id="settingsPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ç›®å½•</button>
            <h1 class="header-title">æ“ä½œè®¾ç½®1</h1>
        </div>

        <div class="settings-content">
            <div class="setting-row">
                <label class="setting-label">è¯­è¨€é€‰æ‹©</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="langZh">ä¸­æ–‡</button>
                    <button class="toggle-btn" id="langEn">ENGLISH</button>
                </div>
            </div>

            <div class="setting-row">
                <label class="setting-label">å¯åŠ¨æ–¹å¼</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="startStop">åœæ­¢</button>
                    <button class="toggle-btn" id="startCold">å†·å¯</button>
                    <button class="toggle-btn" id="startHot">çƒ­å¯</button>
                </div>
            </div>

            <div class="setting-row">
                <label class="setting-label">å¤šå°è¿æ¥ä½¿èƒ½</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="multiNo">å¦</button>
                    <button class="toggle-btn" id="multiYes">æ˜¯</button>
                </div>
            </div>

            <button class="input-settings-btn" onclick="navigateTo('menu')">è¾“å…¥è®¾ç½®</button>
        </div>
    </div>

    <!-- é€šè®¯è®¾ç½®é¡µé¢ (WK3) -->
    <div id="communicationPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ç›®å½•</button>
            <h1 class="header-title">é€šè®¯è®¾ç½®</h1>
        </div>

        <div class="communication-content">
            <div class="comm-row">
                <label class="comm-label">é€šä¿¡åè®®</label>
                <div class="protocol-toggle">
                    <button class="protocol-btn active" id="rtuBtn">RTU</button>
                    <button class="protocol-btn" id="tcpBtn">TCP</button>
                </div>
            </div>

            <!-- RTU è®¾ç½®ç•Œé¢ -->
            <div id="rtuSettings" class="protocol-settings">
                <div class="comm-row">
                    <label class="comm-label">ç«¯å£å·</label>
                    <select class="comm-input" id="portNumber">
                        <option>COM12</option>
                        <option>COM1</option>
                        <option>COM2</option>
                    </select>
                    <label class="comm-label">æ³¢ç‰¹ç‡</label>
                    <select class="comm-input" id="baudRate">
                        <option>9600</option>
                        <option>19200</option>
                        <option>38400</option>
                    </select>
                </div>

                <div class="comm-row">
                    <label class="comm-label">åœæ­¢ä½</label>
                    <select class="comm-input" id="stopBit">
                        <option>1</option>
                        <option>2</option>
                    </select>
                    <label class="comm-label">æ•°æ®ä½</label>
                    <select class="comm-input" id="dataBit">
                        <option>8</option>
                        <option>7</option>
                    </select>
                </div>

                <div class="comm-row">
                    <label class="comm-label">å¥‡å¶æ ¡éªŒ</label>
                    <select class="comm-input" id="parity">
                        <option>N</option>
                        <option>E</option>
                        <option>O</option>
                    </select>
                    <label class="comm-label">é€šä¿¡åœ°å€</label>
                    <input type="number" class="comm-input" id="commAddress" value="1">
                    <button class="connect-btn" id="connectBtn">è¿æ¥</button>
                </div>

                <div class="server-upload">
                    <label class="comm-label">ä¸Šä¼ æœåŠ¡å™¨</label>
                    <input type="text" class="server-input" id="serverUrl" placeholder="è¾“å…¥æœåŠ¡å™¨åœ°å€">
                    <button class="upload-btn" id="uploadBtn">ä¸Šä¼ </button>
                </div>
            </div>

            <!-- TCP è®¾ç½®ç•Œé¢ -->
            <div id="tcpSettings" class="protocol-settings" style="display: none;">
                <div class="comm-row">
                    <label class="comm-label">å±IPåœ°å€</label>
                    <input type="text" class="comm-input" id="screenIp" value="192.168.0.146">
                    <label class="comm-label">ç«¯å£å·</label>
                    <input type="number" class="comm-input" id="tcpPort" value="8000">
                </div>

                <div class="comm-row">
                    <button class="connect-btn" id="tcpConnectBtn">è¿æ¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢„çº¦è®¾ç½®é¡µé¢ (WK5) -->
    <div id="appointmentPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ç›®å½•</button>
            <h1 class="header-title">é¢„çº¦è®¾ç½®</h1>
        </div>

        <div class="appointment-content">
            <div class="time-section">
                <label class="time-label">ç³»ç»Ÿæ—¶é—´</label>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="sysYear" value="0000">
                    <span class="time-unit">å¹´</span>
                    <input type="number" class="time-input" id="sysMonth" value="00">
                    <span class="time-unit">æœˆ</span>
                    <input type="number" class="time-input" id="sysDay" value="00">
                    <span class="time-unit">æ—¥</span>
                </div>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="sysHour" value="00">
                    <span class="time-unit">æ—¶</span>
                    <input type="number" class="time-input" id="sysMinute" value="00">
                    <span class="time-unit">åˆ†</span>
                    <input type="number" class="time-input" id="sysSecond" value="00">
                    <span class="time-unit">ç§’</span>
                </div>
            </div>

            <div class="time-section">
                <label class="time-label">é¢„çº¦æ—¶é—´</label>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="resYear" value="0000">
                    <span class="time-unit">å¹´</span>
                    <input type="number" class="time-input" id="resMonth" value="00">
                    <span class="time-unit">æœˆ</span>
                    <input type="number" class="time-input" id="resDay" value="00">
                    <span class="time-unit">æ—¥</span>
                </div>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="resHour" value="00">
                    <span class="time-unit">æ—¶</span>
                    <input type="number" class="time-input" id="resMinute" value="00">
                    <span class="time-unit">åˆ†</span>
                    <input type="number" class="time-input" id="resSecond" value="00">
                    <span class="time-unit">ç§’</span>
                </div>
            </div>

            <div class="time-section">
                <label class="time-label">é¢„çº¦è®¾ç½®</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="appointmentOff">å…³</button>
                    <button class="toggle-btn" id="appointmentOn">å¼€</button>
                </div>
            </div>
        </div>
    </div>

    <!-- å®šå€¼è®¾ç½®é¡µé¢ (WK2) -->
    <div id="valueSettingsPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">è¿”å›</button>
            <h1 class="header-title">å®šå€¼è®¾ç½®</h1>
            <button class="menu-btn orange" onclick="navigateTo('standby')">å¾…æœº</button>
        </div>

        <div class="value-settings-content">
            <div class="value-setting-row">
                <label class="value-setting-label">å®šæ—¶è¿è¡Œ</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="timerOff">å…³</button>
                    <button class="toggle-btn" id="timerOn">å¼€</button>
                </div>
                <input type="number" class="value-input" id="runTimeInput" value="0.00" step="0.01">
                <span class="value-unit">H.M</span>
            </div>

            <div class="value-setting-row">
                <label class="value-setting-label">æ¸©åº¦</label>
                <input type="number" class="value-input" id="setTempInput" value="0.0" step="0.1">
                <span class="value-unit">Â°C/M</span>
            </div>

            <div class="value-setting-row">
                <label class="value-setting-label">æ¹¿åº¦</label>
                <input type="number" class="value-input" id="setHumInput" value="0.0" step="0.1">
                <span class="value-unit">%/M</span>
            </div>
        </div>
    </div>

    <!-- ç¨‹å¼ç¼–è¾‘é¡µé¢ (WK4) -->
    <div id="programEditPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">è¿”å›</button>
            <h1 class="header-title">ç¨‹å¼ç¼–è¾‘</h1>
            <button class="menu-btn orange" onclick="navigateTo('standby')">å¾…æœº</button>
        </div>

        <div class="program-edit-content">
            <div class="program-info-row">
                <label class="program-info-label">ç¨‹å¼ç¼–å·</label>
                <input type="number" class="program-info-input" id="progNumber" value="000">
                <label class="program-info-label">å¾ªç¯</label>
                <input type="number" class="program-info-input" id="progCycle" value="000">
                <label class="program-info-label">è¿æ¥</label>
                <input type="number" class="program-info-input" id="progConnect" value="000">
            </div>

            <div class="program-table-container">
                <table class="program-table">
                    <thead>
                    <tr>
                        <th>No.</th>
                        <th>æ¸©åº¦(â„ƒ)</th>
                        <th>æ¹¿åº¦(%)</th>
                        <th>æ—¶é—´(H.M)</th>
                        <th>TS1</th>
                        <th>TS2</th>
                        <th>TS3</th>
                        <th>TS4</th>
                    </tr>
                    </thead>
                    <tbody id="programTableBody">
                    <tr>
                        <td>01</td>
                        <td><input type="number" class="table-input" value="0.0"></td>
                        <td><input type="number" class="table-input" value="0.0"></td>
                        <td><input type="number" class="table-input" value="0.00"></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- è¿è¡Œç¡®è®¤çª—å£ -->
<div id="runConfirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">ç¡®è®¤æ“ä½œ</h3>
        </div>
        <div class="modal-body">
            <div class="confirm-message" id="modalMessage">
                ç¡®å®šè¦æ‰§è¡Œæ­¤æ“ä½œå—ï¼Ÿ<br>
                <small>å‘½ä»¤å°†å‘é€è‡³è®¾å¤‡ï¼Œæ‰§è¡Œåå°†åœ¨30ç§’åè‡ªåŠ¨åˆ·æ–°çŠ¶æ€ã€‚</small>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-no" id="modalNo">å–æ¶ˆ</button>
            <button class="modal-btn modal-btn-yes" id="modalYes">ç¡®è®¤</button>
        </div>
    </div>
</div>

<!-- æ•°å€¼è¾“å…¥å¯¹è¯æ¡† -->
<div id="valueInputModal" class="modal">
    <div class="value-input-content">
        <div class="value-input-header">
            <div class="value-input-label" id="valueInputLabel">è®¾å®šå€¼</div>
            <div class="value-input-range" id="valueInputRange">[-200.00 - 400.00]</div>
            <div class="value-input-field">
                <input type="text" id="valueInput" placeholder="è¯·è¾“å…¥æ•°å€¼">
            </div>
        </div>
        <div class="value-keypad">
            <div class="keypad-row">
                <button class="keypad-btn" data-value="0">0</button>
                <button class="keypad-btn" data-value="1">1</button>
                <button class="keypad-btn" data-value="2">2</button>
                <button class="keypad-btn" data-value="3">3</button>
                <button class="keypad-btn" data-value="4">4</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn" data-value="5">5</button>
                <button class="keypad-btn" data-value="6">6</button>
                <button class="keypad-btn" data-value="7">7</button>
                <button class="keypad-btn" data-value="8">8</button>
                <button class="keypad-btn" data-value="9">9</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn" id="keypadSign">+/-</button>
                <button class="keypad-btn" id="keypadBackspace">â†</button>
                <button class="keypad-btn" id="keypadExit">é€€å‡º</button>
                <button class="keypad-btn" data-value=".">.</button>
                <button class="keypad-btn" id="keypadClear">æ¸…é™¤</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn keypad-confirm" id="keypadConfirm">ç¡®è®¤</button>
            </div>
        </div>
    </div>
</div>

<!-- è®¾å¤‡ç®¡ç†è¡¨å• -->
<div id="deviceFormModal" class="modal">
    <div class="modal-content device-form-content">
        <div class="modal-header">
            <h2 id="deviceFormTitle">æ·»åŠ è®¾å¤‡</h2>
            <span class="close" onclick="closeDeviceForm()">&times;</span>
        </div>
        <div class="device-form-body">
            <div class="device-form-group">
                <label for="deviceIdInput">è®¾å¤‡ç¼–å·</label>
                <input type="text" id="deviceIdInput" placeholder="ä¾‹å¦‚ï¼šU680-05">
            </div>
            <div class="device-form-group">
                <label for="deviceNameInput">æ˜¾ç¤ºåç§°</label>
                <input type="text" id="deviceNameInput" placeholder="ä¾‹å¦‚ï¼šå¯é æ€§è¯•éªŒç®±">
            </div>
            <div class="device-form-group">
                <label for="deviceStatusInput">è¿è¡ŒçŠ¶æ€</label>
                <select id="deviceStatusInput">
                    <option value="running">è¿è¡Œä¸­</option>
                    <option value="stopped">å·²åœæ­¢</option>
                    <option value="warning">è­¦å‘Š</option>
                </select>
            </div>
            <div class="device-form-group">
                <label for="deviceModeInput">å½“å‰æ¨¡å¼</label>
                <select id="deviceModeInput">
                    <option value="å®šå€¼è¯•éªŒ">å®šå€¼è¯•éªŒ</option>
                    <option value="ç¨‹å¼è¯•éªŒ">ç¨‹å¼è¯•éªŒ</option>
                    <option value="ç»´æŠ¤æ¨¡å¼">ç»´æŠ¤æ¨¡å¼</option>
                </select>
            </div>
        </div>
        <div class="device-form-actions">
            <button class="device-form-btn cancel" type="button" onclick="closeDeviceForm()">å–æ¶ˆ</button>
            <button class="device-form-btn submit" type="button" onclick="submitDeviceForm()">ä¿å­˜</button>
        </div>
    </div>
</div>

<!-- å‘é€å‘½ä»¤æ¨¡æ€æ¡† -->
<div id="commandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>å‘é€è®¾å¤‡å‘½ä»¤</h2>
            <span class="close" onclick="closeCommandModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="jsonInput">JSON æ•°æ®</label>
                <textarea id="jsonInput" class="json-input" rows="28" placeholder='è¯·è¾“å…¥JSONæ•°æ®ï¼Œä¾‹å¦‚ï¼š&#10;{&#10;  "device_id": "DEVICE001",&#10;  "valueorprogram": "1",&#10;  "fixed_temp_set": "25.0",&#10;  "fixed_hum_set": "60.0",&#10;  "set_program_number": "001",&#10;  "set_run_status": "1",&#10;  "set_program_no": "001",&#10;  "create_by": "admin"&#10;}&#10;&#10;å­—æ®µè¯´æ˜ï¼š&#10;- valueorprogram: å®šå€¼æˆ–ç¨‹å¼è¯•éªŒåˆ¤æ–­ï¼ˆ0=ç¨‹å¼è¯•éªŒï¼Œ1=å®šå€¼è¯•éªŒï¼‰&#10;- fixed_temp_set: å®šå€¼æ¸©åº¦&#10;- fixed_hum_set: å®šå€¼æ¹¿åº¦&#10;- set_program_number: è®¾å®šè¿è¡Œç¨‹å¼å·&#10;- set_run_status: è¿è¡ŒçŠ¶æ€ï¼ˆ0=åœæ­¢ï¼Œ1=è¿è¡Œï¼Œ2=æš‚åœï¼‰&#10;- set_program_no: è®¾ç½®ç¨‹å¼å·&#10;- create_by: åˆ›å»ºè€…'></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="sendCommand()">å‘é€å‘½ä»¤</button>
                <button class="btn btn-secondary" onclick="formatJson()">æ ¼å¼åŒ–</button>
                <button class="btn btn-secondary" onclick="clearJson()">æ¸…ç©º</button>
            </div>
            <div id="resultMessage" class="result-message"></div>
        </div>
    </div>
</div>

<script src="/css/reliablityLab/app.js"></script>
<script>
// é¡µé¢åŠ è½½æ—¶ï¼Œä»localStorageæˆ–URLå‚æ•°è·å–usernameå’Œjob
(function() {
    // ä»URLå‚æ•°è·å–
    const urlParams = new URLSearchParams(window.location.search);
    let username = urlParams.get('username');
    let job = urlParams.get('job');
    
    // å¦‚æœURLå‚æ•°ä¸­æ²¡æœ‰ï¼Œå°è¯•ä»localStorageè·å–
    if (!username) {
        username = localStorage.getItem('username') || '';
    }
    if (!job) {
        job = localStorage.getItem('job') || '';
    }
    
    // å¦‚æœè·å–åˆ°äº†ï¼Œä¿å­˜åˆ°localStorageï¼ˆæ–¹ä¾¿åç»­ä½¿ç”¨ï¼‰
    if (username) {
        localStorage.setItem('username', username);
    }
    if (job) {
        localStorage.setItem('job', job);
    }
    
    // æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯åˆ°å³ä¸Šè§’
    const userInfoDiv = document.getElementById('userInfo');
    const usernameDiv = document.getElementById('userInfoUsername');
    const jobDiv = document.getElementById('userInfoJob');
    
    if (username || job) {
        if (userInfoDiv && usernameDiv && jobDiv) {
            usernameDiv.textContent = username || 'æœªçŸ¥ç”¨æˆ·';
            jobDiv.textContent = job ? 'è§’è‰²ï¼š' + job : '';
            userInfoDiv.style.display = 'flex';
        }
        console.log('ç”¨æˆ·ä¿¡æ¯å·²åŠ è½½:', { username: username, job: job });
    } else {
        console.warn('æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼ˆusernameå’Œjobï¼‰ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½å—é™');
        // å¦‚æœéœ€è¦ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ æç¤ºæˆ–è·³è½¬é€»è¾‘
        // alert('è¯·å…ˆç™»å½•');
        // window.location.href = '/';
    }
})();

// è®¾å¤‡æ¨¡å—æ•°æ®ä¸æ¸²æŸ“é€»è¾‘
const DEVICE_STATUS_TEXT = {
    running: 'è¿è¡Œä¸­',
    stopped: 'å·²åœæ­¢',
    warning: 'è­¦å‘Š'
};

let deviceList = [];
let activeDeviceId = null;
let autoFetchTimerId = null;

function safeNumber(value, fractionDigits = 2) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const num = Number(value);
    if (Number.isNaN(num)) {
        return 0;
    }
    return typeof fractionDigits === 'number'
        ? Number(num.toFixed(fractionDigits))
        : num;
}

function toInt(value) {
    const num = parseInt(value, 10);
    return Number.isNaN(num) ? 0 : num;
}

function formatDuration(hours, minutes, seconds, fallback) {
    const hasValue = [hours, minutes, seconds].some(v => v !== null && v !== undefined && v !== '');
    if (!hasValue) {
        return fallback;
    }
    const h = Math.max(0, toInt(hours));
    const m = Math.max(0, toInt(minutes));
    const s = Math.max(0, toInt(seconds));
    return `${h}H ${String(m).padStart(2, '0')}M ${String(s).padStart(2, '0')}S`;
}

function formatRuntime(hours, minutes, seconds) {
    return formatDuration(hours, minutes, seconds, '0H 00M 00S');
}

function formatRemaining(hours, minutes, seconds) {
    return formatDuration(hours, minutes, seconds, '--');
}

function normalizeStatus(runStatus) {
    const text = (runStatus || '').toString().toLowerCase();
    if (!text) return 'stopped';
    if (text.includes('è­¦') || text.includes('warn') || text.includes('å¼‚å¸¸') || text.includes('alarm')) {
        return 'warning';
    }
    if (text.includes('åœ') || text.includes('stop') || text.includes('å¾…æœº') || text.includes('standby')) {
        return 'stopped';
    }
    return 'running';
}

function formatRunMode(runMode) {
    if (runMode === null || runMode === undefined) return '--';
    const modeValue = String(runMode).trim();
    if (modeValue === '0') return 'ç¨‹å¼æ¨¡å¼';
    if (modeValue === '1') return 'å®šå€¼æ¨¡å¼';
    return modeValue; // å¦‚æœä¸æ˜¯0æˆ–1ï¼Œæ˜¾ç¤ºåŸå§‹å€¼
}

// æ ¹æ®å­—æ®µå€¼è®¾ç½®é¢œè‰²å’Œæ–‡æœ¬
function formatConnectionStatus(serialStatus) {
    if (serialStatus === null || serialStatus === undefined || serialStatus === '') {
        return { connection: 'unknown', connectionText: 'æœªçŸ¥', colorClass: 'status-unknown' };
    }

    const statusValue = String(serialStatus).trim();
    if (statusValue === 'åœ¨çº¿') {
        return { connection: 'online', connectionText: 'åœ¨çº¿', colorClass: 'status-online' };
    } else if (statusValue === 'ç¦»çº¿') {
        return { connection: 'offline', connectionText: 'ç¦»çº¿', colorClass: 'status-offline' };
    } else {
        return { connection: 'unknown', connectionText: statusValue, colorClass: 'status-unknown' };
    }
}

function formatModuleConnection(moduleConnection) {
    if (moduleConnection === null || moduleConnection === undefined || moduleConnection === '') {
        return { status: 'unknown', message: 'æ¸©æ¹¿åº¦æ¨¡å—çŠ¶æ€æœªçŸ¥', colorClass: 'module-unknown' };
    }

    const statusValue = String(moduleConnection).trim();
    if (statusValue === 'è¿æ¥æ­£å¸¸') {
        return { status: 'normal', message: 'è¿æ¥æ­£å¸¸', colorClass: 'module-normal' };
    } else if (statusValue === 'è¿æ¥å¼‚å¸¸') {
        return { status: 'error', message: 'è¿æ¥å¼‚å¸¸', colorClass: 'module-error' };
    } else {
        return { status: 'unknown', message: statusValue, colorClass: 'module-unknown' };
    }
}

function formatPowerValue(value) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const numeric = Number(value);
    if (Number.isFinite(numeric)) {
        return Number(numeric.toFixed(0));
    }
    return String(value);
}

function formatLastUpdate(timestamp) {
    if (!timestamp) {
        return 'åˆšåˆš';
    }
    if (timestamp instanceof Date) {
        return `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}:${String(timestamp.getSeconds()).padStart(2, '0')}`;
    }
    if (typeof timestamp === 'string') {
        const sanitized = timestamp.replace('T', ' ').split('.')[0];
        return sanitized;
    }
    try {
        const date = new Date(timestamp);
        if (!Number.isNaN(date.getTime())) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        }
    } catch (err) {
        // ignore
    }
    return 'åˆšåˆš';
}

function transformDeviceRecord(record, index) {
    const deviceId = record.device_id || record.deviceId || `device-${Date.now()}-${index}`;
    const connectionStatus = formatConnectionStatus(record.serial_status || record.serialStatus);
    const moduleConnectionStatus = formatModuleConnection(record.module_connection || record.moduleConnection);

    return {
        id: deviceId,
        name: record.device_id || record.deviceId || 'æœªå‘½åè®¾å¤‡',
        status: normalizeStatus(record.run_status || record.runStatus),
        mode: formatRunMode(record.run_mode || record.runMode),
        temperature: safeNumber(record.temperature),
        humidity: safeNumber(record.humidity),
        runtime: formatRuntime(record.run_hours || record.runHours, record.run_minutes || record.runMinutes, record.run_seconds || record.runSeconds),
        remaining: formatRemaining(record.step_remaining_hours || record.stepRemainingHours, record.step_remaining_minutes || record.stepRemainingMinutes, record.step_remaining_seconds || record.stepRemainingSeconds),
        tempPower: formatPowerValue(record.power_temperature || record.powerTemperature),
        humidityPower: formatPowerValue(record.power_humidity || record.powerHumidity),
        connection: connectionStatus.connection,
        connectionText: connectionStatus.connectionText,
        connectionColorClass: connectionStatus.colorClass,
        moduleConnection: moduleConnectionStatus.status,
        moduleConnectionText: moduleConnectionStatus.message,
        moduleConnectionColorClass: moduleConnectionStatus.colorClass,
        lastUpdate: formatLastUpdate(record.updated_at || record.updatedAt || record.created_at || record.createdAt),
        programNumber: safeNumber(record.set_program_number || record.programNumber),
        totalSteps: safeNumber(record.total_steps || record.totalSteps),
        autoFetch: false,
        raw: record
    };
}

async function refreshDevicesFromServer() {
    const previousActiveId = activeDeviceId;
    const emptyState = document.getElementById('deviceEmptyState');
    if (emptyState) {
        emptyState.textContent = 'æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...';
        emptyState.style.display = 'block';
    }
    try {
        const response = await fetch('/iot/data/devices', { cache: 'no-store' });
        if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç  ${response.status}`);
        }
        const payload = await response.json();
        if (!Array.isArray(payload)) {
            throw new Error('æ¥å£è¿”å›æ ¼å¼å¼‚å¸¸ï¼Œé¢„æœŸä¸ºæ•°ç»„');
        }
        const transformed = payload.map((item, index) => {
            return transformDeviceRecord(item, index);
        });
        if (!transformed.length) {
            deviceList = [];
            activeDeviceId = null;
            renderDevices();
            const emptyState = document.getElementById('deviceEmptyState');
            if (emptyState) {
                emptyState.textContent = 'å½“å‰æ²¡æœ‰ç›‘æ§ä¸­çš„è®¾å¤‡ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“æ•°æ®ã€‚';
            }
            return;
        }
        deviceList = transformed;
        if (previousActiveId && deviceList.some(device => device.id === previousActiveId)) {
            activeDeviceId = previousActiveId;
        } else {
            activeDeviceId = deviceList[0].id;
        }
        renderDevices();
    } catch (error) {
        console.error('åŠ è½½è®¾å¤‡åˆ—è¡¨å¤±è´¥ï¼š', error);
        if (emptyState) {
            emptyState.textContent = 'è®¾å¤‡æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æœåŠ¡å™¨ã€‚';
            emptyState.style.display = 'block';
        }
    } finally {
        scheduleAutoFetch();
    }
}

function renderDevices() {
    const grid = document.getElementById('deviceGrid');
    const emptyState = document.getElementById('deviceEmptyState');
    const template = document.getElementById('deviceCardTemplate');
    if (!grid || !emptyState || !template) {
        return;
    }

    grid.innerHTML = '';

    if (!deviceList.length) {
        emptyState.style.display = 'block';
        renderSidebar();
        activeDeviceId = null;
        updateActiveIndicators();
        return;
    }

    emptyState.style.display = 'none';

    deviceList.forEach(device => {
        const fragment = template.content.cloneNode(true);
        const card = fragment.querySelector('.device-card');
        card.dataset.deviceId = device.id;

        const idSpan = fragment.querySelector('[data-field="deviceId"]');
        if (idSpan) {
            idSpan.textContent = device.name || device.id;
        }

        const statusWrapper = fragment.querySelector('[data-field="statusWrapper"]');
        if (statusWrapper) {
            statusWrapper.className = `device-status ${device.status || 'running'}`;
        }
        const statusText = fragment.querySelector('[data-field="statusText"]');
        if (statusText) {
            statusText.textContent = DEVICE_STATUS_TEXT[device.status] || 'è¿è¡Œä¸­';
        }

        const tempField = fragment.querySelector('[data-field="temperature"]');
        if (tempField) {
            const tempValue = Number(device.temperature || 0).toFixed(2);
            tempField.innerHTML = `${tempValue}<span class="unit">â„ƒ</span>`;
        }
        const humidityField = fragment.querySelector('[data-field="humidity"]');
        if (humidityField) {
            const humidityValue = Number(device.humidity || 0).toFixed(2);
            humidityField.innerHTML = `${humidityValue}<span class="unit">%</span>`;
        }

        const runtimeField = fragment.querySelector('[data-field="runtime"]');
        if (runtimeField) {
            runtimeField.textContent = device.runtime || '0H 00M 00S';
        }
        const remainingField = fragment.querySelector('[data-field="remaining"]');
        if (remainingField) {
            remainingField.textContent = device.remaining || '--';
        }
        const modeField = fragment.querySelector('[data-field="mode"]');
        if (modeField) {
            modeField.textContent = device.mode || 'å®šå€¼è¯•éªŒ';
        }

        const tempPowerField = fragment.querySelector('[data-field="tempPower"]');
        if (tempPowerField) {
            tempPowerField.textContent = `${device.tempPower ?? 0}%`;
        }
        const humidityPowerField = fragment.querySelector('[data-field="humidityPower"]');
        if (humidityPowerField) {
            humidityPowerField.textContent = `${device.humidityPower ?? 0}%`;
        }

        const connectionWrapper = fragment.querySelector('[data-field="connectionWrapper"]');
        if (connectionWrapper) {
            connectionWrapper.className = `connection-status ${device.connection || 'online'} ${device.connectionColorClass || ''}`;
        }
        const connectionText = fragment.querySelector('[data-field="connectionText"]');
        if (connectionText) {
            connectionText.textContent = device.connectionText || (device.connection === 'online' ? 'åœ¨çº¿' : 'ç¦»çº¿');
        }
        const lastUpdate = fragment.querySelector('[data-field="lastUpdate"]');
        if (lastUpdate) {
            lastUpdate.textContent = `æ›´æ–°: ${device.lastUpdate || 'åˆšåˆš'}`;
        }

        const deleteBtn = fragment.querySelector('.delete-device-btn');
        if (deleteBtn) {
            deleteBtn.addEventListener('click', event => {
                event.stopPropagation();
                removeDevice(device.id);
            });
        }

        card.addEventListener('click', () => {
            setActiveDevice(device.id);
            if (typeof window.enterDevice === 'function') {
                window.enterDevice(device.id);
            }
        });

        grid.appendChild(fragment);
    });

    if (!deviceList.some(device => device.id === activeDeviceId)) {
        activeDeviceId = deviceList[0].id;
    }

    renderSidebar();
    updateActiveIndicators();
}

function removeDevice(deviceId) {
    alert('è®¾å¤‡æ•°æ®æ¥æºäºæ•°æ®åº“ï¼Œè¯·åœ¨åå°æˆ–æ•°æ®åº“ä¸­åˆ é™¤ååˆ·æ–°é¡µé¢ã€‚');
    refreshDevicesFromServer();
}

function openDeviceForm() {
    const modal = document.getElementById('deviceFormModal');
    if (!modal) return;
    modal.dataset.mode = 'add';

    const idInput = document.getElementById('deviceIdInput');
    const nameInput = document.getElementById('deviceNameInput');
    const statusSelect = document.getElementById('deviceStatusInput');
    const modeSelect = document.getElementById('deviceModeInput');

    if (idInput) idInput.value = '';
    if (nameInput) nameInput.value = '';
    if (statusSelect) statusSelect.value = 'running';
    if (modeSelect) modeSelect.value = 'å®šå€¼è¯•éªŒ';

    modal.style.display = 'block';
}

function closeDeviceForm() {
    const modal = document.getElementById('deviceFormModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function submitDeviceForm() {
    const idInput = document.getElementById('deviceIdInput');
    const nameInput = document.getElementById('deviceNameInput');
    const statusSelect = document.getElementById('deviceStatusInput');
    const modeSelect = document.getElementById('deviceModeInput');

    const idValue = idInput ? idInput.value.trim() : '';
    if (!idValue) {
        alert('è¯·è¾“å…¥è®¾å¤‡ç¼–å·');
        return;
    }
    if (deviceList.some(device => device.id === idValue)) {
        alert('è¯¥è®¾å¤‡ç¼–å·å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ç¼–å·');
        return;
    }

    alert('è¯·é€šè¿‡åå°æ¥å£æˆ–æ•°æ®åº“æ’å…¥æ•°æ®ååˆ·æ–°æœ¬é¡µé¢ã€‚');
    closeDeviceForm();
    refreshDevicesFromServer();
}

function scheduleAutoFetch() {
    if (autoFetchTimerId) {
        clearInterval(autoFetchTimerId);
        autoFetchTimerId = null;
    }

    const autoDevices = deviceList.filter(device => device.autoFetch);
    if (!autoDevices.length) {
        return;
    }

    const runFetch = () => {
        autoDevices.forEach(device => fetchTemperature(device.id));
    };

    runFetch();
    autoFetchTimerId = setInterval(runFetch, 5000);
}

function initializeDeviceModule() {
    deviceList = [];
    activeDeviceId = null;
    const emptyState = document.getElementById('deviceEmptyState');
    if (emptyState) {
        emptyState.textContent = 'æ­£åœ¨åŠ è½½è®¾å¤‡æ•°æ®...';
    }
    renderDevices();
    refreshDevicesFromServer();
}

function renderSidebar() {
    const list = document.getElementById('deviceSidebarList');
    if (!list) return;

    list.innerHTML = '';

    if (!deviceList.length) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'sidebar-empty';
        emptyDiv.textContent = 'æš‚æ— ç›‘æ§è®¾å¤‡';
        list.appendChild(emptyDiv);
        return;
    }

    deviceList.forEach(device => {
        const item = document.createElement('div');
        item.className = 'sidebar-item';
        item.dataset.deviceId = device.id;
        item.innerHTML = `
            <span>${device.name || device.id}</span>
            <span class="sidebar-item-mode">${device.mode || 'å®šå€¼è¯•éªŒ'}</span>
        `;
        item.addEventListener('click', () => {
            setActiveDevice(device.id);
            scrollToDeviceCard(device.id);
        });
        list.appendChild(item);
    });
}

function setActiveDevice(deviceId) {
    activeDeviceId = deviceId;
    updateActiveIndicators();
}

function updateActiveIndicators() {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
        if (item.dataset.deviceId === activeDeviceId) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    const cards = document.querySelectorAll('.device-card');
    cards.forEach(card => {
        if (card.dataset.deviceId === activeDeviceId) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
}

function scrollToDeviceCard(deviceId) {
    const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// åŠ¨æ€è·å–æŒ‡å®šè®¾å¤‡çš„æœ€æ–°æ•°æ®
function fetchTemperature(deviceId) {
    fetch(`/iot/data/latest?device_id=${encodeURIComponent(deviceId)}`, { cache: 'no-store' })
        .then(res => {
            if (!res.ok) {
                throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç  ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data || Object.keys(data).length === 0) {
                return;
            }
            const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
            if (!card) {
                return;
            }

            const deviceRef = deviceList.find(device => device.id === deviceId);

            if (data && data.temperature != null) {
                const value = Number(data.temperature).toFixed(2);
                const tempField = card.querySelector('[data-field="temperature"]');
                if (tempField) {
                    tempField.innerHTML = `${value}<span class="unit">â„ƒ</span>`;
                }
                if (deviceRef) {
                    deviceRef.temperature = Number(value);
                }
            }

            if (data && data.humidity != null) {
                const humidityValue = Number(data.humidity).toFixed(2);
                const humidityField = card.querySelector('[data-field="humidity"]');
                if (humidityField) {
                    humidityField.innerHTML = `${humidityValue}<span class="unit">%</span>`;
                }
                if (deviceRef) {
                    deviceRef.humidity = Number(humidityValue);
                }
            }

            if (data && data.run_mode != null) {
                const modeSpan = card.querySelector('[data-field="mode"]');
                if (modeSpan) {
                    modeSpan.textContent = formatRunMode(data.run_mode);
                }
                if (deviceRef) {
                    deviceRef.mode = formatRunMode(data.run_mode);
                }

                // æ›´æ–°èœå•æŒ‰é’®çŠ¶æ€å’ŒçŠ¶æ€æ–‡æœ¬
                updateMenuButtons();
                updateTestStatusText();

                // æ›´æ–°è¿è¡ŒæŒ‰é’®çŠ¶æ€
                const statusDisplay = getStatusDisplay(data.run_status);
                updateRunButtons(statusDisplay);

                // æ›´æ–°æ¸©æ¹¿åº¦æ¨¡å—è¿æ¥çŠ¶æ€
                updateModuleConnectionStatus();
            }

            // è¿è¡Œæ—¶é—´
            const hStr = data && data.run_hours != null ? String(data.run_hours) : '0';
            const mStr = data && data.run_minutes != null ? String(data.run_minutes) : '0';
            const sStr = data && data.run_seconds != null ? String(data.run_seconds) : '0';
            const runtimeFormatted = (() => {
                const hh = parseInt(hStr, 10) || 0;
                const mm = parseInt(mStr, 10) || 0;
                const ss = parseInt(sStr, 10) || 0;
                return `${hh}H ${String(mm).padStart(2,'0')}M ${String(ss).padStart(2,'0')}S`;
            })();
            const runtimeSpan = card.querySelector('[data-field="runtime"]');
            if (runtimeSpan) {
                runtimeSpan.textContent = runtimeFormatted;
            }
            if (deviceRef) {
                deviceRef.runtime = runtimeFormatted;
            }

            // å‰©ä½™æ—¶é—´ï¼ˆæœ¬æ®µï¼‰
            const rhStr = data && data.step_remaining_hours != null ? String(data.step_remaining_hours) : '0';
            const rmStr = data && data.step_remaining_minutes != null ? String(data.step_remaining_minutes) : '0';
            const rsStr = data && data.step_remaining_seconds != null ? String(data.step_remaining_seconds) : '0';
            const remainingFormatted = (() => {
                const rh = parseInt(rhStr, 10) || 0;
                const rm = parseInt(rmStr, 10) || 0;
                const rs = parseInt(rsStr, 10) || 0;
                return `${rh}H ${String(rm).padStart(2,'0')}M ${String(rs).padStart(2,'0')}S`;
            })();
            const remainingSpan = card.querySelector('[data-field="remaining"]');
            if (remainingSpan) {
                remainingSpan.textContent = remainingFormatted;
            }
            if (deviceRef) {
                deviceRef.remaining = remainingFormatted;
            }

            // åŠŸç‡å€¼
            if (data && data.power_temperature != null) {
                const tpSpan = card.querySelector('[data-field="tempPower"]');
                if (tpSpan) {
                    tpSpan.textContent = `${data.power_temperature}%`;
                }
                if (deviceRef) {
                    deviceRef.tempPower = data.power_temperature;
                }
            }
            if (data && data.power_humidity != null) {
                const hpSpan = card.querySelector('[data-field="humidityPower"]');
                if (hpSpan) {
                    hpSpan.textContent = `${data.power_humidity}%`;
                }
                if (deviceRef) {
                    deviceRef.humidityPower = data.power_humidity;
                }
            }

            // è¿æ¥çŠ¶æ€
            if (data && data.serial_status != null) {
                const connectionStatus = formatConnectionStatus(data.serial_status);
                const connectionWrapper = card.querySelector('[data-field="connectionWrapper"]');
                if (connectionWrapper) {
                    connectionWrapper.className = `connection-status ${connectionStatus.connection} ${connectionStatus.colorClass || ''}`;
                }
                const connectionText = card.querySelector('[data-field="connectionText"]');
                if (connectionText) {
                    connectionText.textContent = connectionStatus.connectionText;
                }
                if (deviceRef) {
                    deviceRef.connection = connectionStatus.connection;
                    deviceRef.connectionText = connectionStatus.connectionText;
                }
            }

            const lastUpdateSpan = card.querySelector('[data-field="lastUpdate"]');
            if (lastUpdateSpan) {
                lastUpdateSpan.textContent = 'æ›´æ–°: åˆšåˆš';
            }
            if (deviceRef) {
                deviceRef.lastUpdate = 'åˆšåˆš';
            }
            if (data && (data.updated_at || data.created_at)) {
                const formatted = formatLastUpdate(data.updated_at || data.created_at);
                const span = card.querySelector('[data-field="lastUpdate"]');
                if (span) {
                    span.textContent = `æ›´æ–°: ${formatted}`;
                }
                if (deviceRef) {
                    deviceRef.lastUpdate = formatted;
                }
            }

            // åˆ¤æ–­æ˜¯å¦è¿è¡Œä¸­ï¼ˆrun_statusä¸ºè¿è¡ŒçŠ¶æ€ï¼‰
            const isRunning = data && (data.run_status === 'è¿è¡Œ' || data.run_status === '1' || data.run_status === 1 || 
                                      (typeof data.run_status === 'string' && data.run_status.includes('è¿è¡Œ')));
            
            // æ›´æ–°ç¨‹å¼è¯•éªŒé¡µé¢çš„æ¸©åº¦é¢æ¿ç¬¬ä¸€è¡Œï¼šè¿è¡Œæ—¶æ˜¾ç¤ºè®¾å®šæ¸©åº¦ï¼Œåœæ­¢æ—¶æ˜¾ç¤ºç¨‹å¼å·
            const programTempLabel = document.getElementById('programTempLabel');
            const programNumberDisplay = document.getElementById('programNumberDisplay');
            
            if (isRunning) {
                // è¿è¡ŒçŠ¶æ€ï¼šæ˜¾ç¤ºè®¾å®šæ¸©åº¦
                if (programTempLabel) {
                    programTempLabel.textContent = 'è®¾å®šå€¼';
                }
                if (programNumberDisplay && data.set_temperature != null) {
                    programNumberDisplay.textContent = Number(data.set_temperature).toFixed(1);
                }
            } else {
                // åœæ­¢çŠ¶æ€ï¼šæ˜¾ç¤ºç¨‹å¼å·
                if (programTempLabel) {
                    programTempLabel.textContent = 'ç¨‹å¼å·';
                }
                if (programNumberDisplay && data.set_program_number != null) {
                    programNumberDisplay.textContent = String(data.set_program_number).padStart(3, '0');
                }
            }
            
            // ä¿å­˜ç¨‹å¼å·åˆ°è®¾å¤‡å¼•ç”¨
            if (data && data.set_program_number != null && deviceRef) {
                deviceRef.programNumber = data.set_program_number;
            }

            // æ›´æ–°ç¨‹å¼å¾ªç¯æ•°æ®
            if (data && data.program_cycles != null) {
                if (deviceRef && deviceRef.raw) {
                    deviceRef.raw.program_cycles = data.program_cycles;
                }
            }
            if (data && data.program_total_cycles != null) {
                if (deviceRef && deviceRef.raw) {
                    deviceRef.raw.program_total_cycles = data.program_total_cycles;
                }
            }

            // æ›´æ–°ç¨‹å¼è¯•éªŒé¡µé¢çš„æ¹¿åº¦é¢æ¿ç¬¬ä¸€è¡Œï¼šè¿è¡Œæ—¶æ˜¾ç¤ºè®¾å®šæ¹¿åº¦ï¼Œåœæ­¢æ—¶æ˜¾ç¤ºæ€»æ®µæ•°
            const programHumLabel = document.getElementById('programHumLabel');
            const totalSegmentsDisplay = document.getElementById('totalSegmentsDisplay');
            
            if (isRunning) {
                // è¿è¡ŒçŠ¶æ€ï¼šæ˜¾ç¤ºè®¾å®šæ¹¿åº¦
                if (programHumLabel) {
                    programHumLabel.textContent = 'è®¾å®šå€¼';
                }
                if (totalSegmentsDisplay && data.set_humidity != null) {
                    totalSegmentsDisplay.textContent = Number(data.set_humidity).toFixed(1);
                }
            } else {
                // åœæ­¢çŠ¶æ€ï¼šæ˜¾ç¤ºæ€»æ®µæ•°
                if (programHumLabel) {
                    programHumLabel.textContent = 'æ€»æ®µæ•°';
                }
                if (totalSegmentsDisplay && data.total_steps != null) {
                    totalSegmentsDisplay.textContent = String(data.total_steps).padStart(2, '0');
                }
            }
            
            // ä¿å­˜æ€»æ®µæ•°åˆ°è®¾å¤‡å¼•ç”¨
            if (data && data.total_steps != null && deviceRef) {
                deviceRef.totalSteps = data.total_steps;
            }
        })
        .catch(err => {
            console.warn(`è·å–è®¾å¤‡ ${deviceId} æœ€æ–°æ•°æ®å¤±è´¥:`, err);
        });
}
document.addEventListener('DOMContentLoaded', function() {
    initializeDeviceModule();
    // é¡µé¢åŠ è½½å®Œæˆåå¼ºåˆ¶åˆ·æ–°æ•°æ®ï¼Œç¡®ä¿è·å–æœ€æ–°å­—æ®µ
    setTimeout(() => {
        refreshDevicesFromServer();
    }, 1000);
});

// å¼ºåˆ¶åˆ·æ–°æ•°æ®
function forceRefreshData() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const originalText = refreshBtn.textContent;
    refreshBtn.textContent = 'ğŸ”„ åˆ·æ–°ä¸­...';
    refreshBtn.disabled = true;

    fetch('/iot/data/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(async response => {
        // æ£€æŸ¥å“åº”ç±»å‹
        const contentType = response.headers.get('content-type');

        // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯HTMLé”™è¯¯é¡µé¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('éJSONå“åº”:', text.substring(0, 200));

            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('è¯·æ±‚å¤±è´¥ï¼šéœ€è¦ç™»å½•è®¤è¯ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ');
            } else {
                throw new Error('è¯·æ±‚å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”ï¼ˆçŠ¶æ€ç : ' + response.status + 'ï¼‰');
            }
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            // é‡æ–°æ¸²æŸ“è®¾å¤‡æ•°æ®
            if (data.data && Array.isArray(data.data)) {
                const transformed = data.data.map(item => transformDeviceRecord(item, 0));
                deviceList = transformed;
                if (deviceList.length > 0) {
                    activeDeviceId = deviceList[0].id;
                } else {
                    activeDeviceId = null;
                }
                renderDevices();
                showResult(`æ•°æ®åˆ·æ–°æˆåŠŸï¼å…±åŠ è½½äº† ${data.count} å°è®¾å¤‡`, 'success');
            } else {
                deviceList = [];
                activeDeviceId = null;
                renderDevices();
                showResult('æ•°æ®åˆ·æ–°æˆåŠŸï¼Œä½†æ²¡æœ‰æ‰¾åˆ°è®¾å¤‡æ•°æ®', 'success');
            }
        } else {
            showResult('æ•°æ®åˆ·æ–°å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('åˆ·æ–°æ•°æ®å¤±è´¥:', error);
        if (error.message && error.message.includes('<!DOCTYPE')) {
            showResult('åˆ·æ–°å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†HTMLé¡µé¢ï¼Œå¯èƒ½æ˜¯ç™»å½•è®¤è¯é—®é¢˜', 'error');
        } else {
            showResult('åˆ·æ–°å¤±è´¥ï¼š' + error.message, 'error');
        }
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        refreshBtn.textContent = originalText;
        refreshBtn.disabled = false;
    });
}

// å‘é€å‘½ä»¤ç›¸å…³å‡½æ•°
function openCommandModal() {
    document.getElementById('commandModal').style.display = 'block';
    document.getElementById('resultMessage').innerHTML = '';

    // è®¾ç½®é»˜è®¤JSONæ•°æ®
    const defaultJson = `{
  "device_id": "DEVICE001",
  "valueorprogram": "1",
  "fixed_temp_set": "25.0",
  "fixed_hum_set": "60.0",
  "set_program_number": "1",
  "set_run_status": "1",
  "set_program_no": "0",
  "create_by": "å¢å¥"
}`;

    const jsonInput = document.getElementById('jsonInput');
    if (jsonInput && !jsonInput.value.trim()) {
        jsonInput.value = defaultJson;
    }
}

function closeCommandModal() {
    document.getElementById('commandModal').style.display = 'none';
}

function formatJson() {
    const jsonInput = document.getElementById('jsonInput');
    try {
        const jsonObj = JSON.parse(jsonInput.value);
        jsonInput.value = JSON.stringify(jsonObj, null, 2);
        showResult('JSONæ ¼å¼åŒ–æˆåŠŸï¼', 'success');
    } catch (e) {
        showResult('JSONæ ¼å¼é”™è¯¯ï¼š' + e.message, 'error');
    }
}

function clearJson() {
    document.getElementById('jsonInput').value = '';
    document.getElementById('resultMessage').innerHTML = '';
}

function sendCommand() {
    const jsonInput = document.getElementById('jsonInput');
    const jsonText = jsonInput.value.trim();
    
    if (!jsonText) {
        showResult('è¯·è¾“å…¥JSONæ•°æ®', 'error');
        return;
    }

    let jsonData;
    try {
        jsonData = JSON.parse(jsonText);
    } catch (e) {
        showResult('JSONæ ¼å¼é”™è¯¯ï¼š' + e.message, 'error');
        return;
    }

    // éªŒè¯å¿…å¡«å­—æ®µ
    const requiredFields = ['device_id', 'valueorprogram', 'set_run_status', 'create_by'];
    const missingFields = requiredFields.filter(field => !jsonData[field]);

    if (missingFields.length > 0) {
        showResult('ç¼ºå°‘å¿…å¡«å­—æ®µï¼š' + missingFields.join(', '), 'error');
        return;
    }

    // éªŒè¯valueorprogramå­—æ®µ
    if (!['0', '1'].includes(String(jsonData.valueorprogram))) {
        showResult('valueorprogramå­—æ®µå¿…é¡»æ˜¯0æˆ–1ï¼ˆ0=ç¨‹å¼è¯•éªŒï¼Œ1=å®šå€¼è¯•éªŒï¼‰', 'error');
        return;
    }

    // éªŒè¯set_run_statuså­—æ®µ
    if (!['0', '1', '2'].includes(String(jsonData.set_run_status))) {
        showResult('set_run_statuså­—æ®µå¿…é¡»æ˜¯0ã€1æˆ–2ï¼ˆ0=åœæ­¢ï¼Œ1=è¿è¡Œï¼Œ2=æš‚åœï¼‰', 'error');
        return;
    }

    showResult('æ­£åœ¨å‘é€å‘½ä»¤...', 'loading');

    fetch('/iot/createCommand', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(async response => {
        // æ£€æŸ¥å“åº”ç±»å‹
        const contentType = response.headers.get('content-type');
        
        // å¦‚æœè¿”å›çš„ä¸æ˜¯JSONï¼Œå¯èƒ½æ˜¯HTMLé”™è¯¯é¡µé¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('éJSONå“åº”:', text.substring(0, 200));
            
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                showResult('è¯·æ±‚å¤±è´¥ï¼šéœ€è¦ç™»å½•è®¤è¯ï¼Œè¯·å…ˆç™»å½•ç³»ç»Ÿ', 'error');
            } else {
                showResult('è¯·æ±‚å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”ï¼ˆçŠ¶æ€ç : ' + response.status + 'ï¼‰', 'error');
            }
            return null;
        }
        
        // è§£æJSONå“åº”
        return response.json();
    })
    .then(data => {
        if (data === null) return; // å·²ç»å¤„ç†äº†é”™è¯¯
        
        if (data.success) {
            showResult('å‘½ä»¤å‘é€æˆåŠŸï¼å‘½ä»¤ID: ' + (data.id || 'N/A'), 'success');
            setTimeout(() => {
                clearJson();
            }, 3000);
        } else {
            showResult('å‘½ä»¤å‘é€å¤±è´¥ï¼š' + (data.message || 'æœªçŸ¥é”™è¯¯'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message && error.message.includes('<!DOCTYPE')) {
            showResult('å‘é€è¯·æ±‚å¤±è´¥ï¼šæœåŠ¡å™¨è¿”å›äº†HTMLé¡µé¢ï¼Œå¯èƒ½æ˜¯ç™»å½•è®¤è¯é—®é¢˜', 'error');
        } else {
            showResult('å‘é€è¯·æ±‚å¤±è´¥ï¼š' + error.message, 'error');
        }
    });
}

function showResult(message, type) {
    const resultDiv = document.getElementById('resultMessage');
    resultDiv.textContent = message;
    resultDiv.className = 'result-message ' + type;
    resultDiv.style.display = 'block';
}

// ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
window.onclick = function(event) {
    const commandModal = document.getElementById('commandModal');
    if (event.target === commandModal) {
        closeCommandModal();
    }
    const deviceFormModal = document.getElementById('deviceFormModal');
    if (event.target === deviceFormModal) {
        closeDeviceForm();
    }
}
</script>
</body>
</html>
