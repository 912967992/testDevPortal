<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂèØÈù†ÊÄßÁâ©ËÅîÁΩëÊ∏©ÁÆ±ÁõëÊéßÁ≥ªÁªü</title>
    <link rel="stylesheet" href="/css/reliablityLab/styles.css">
    <style>
        #deviceMonitorPage {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .monitor-header { 
            position: relative; 
            z-index: 100;
            padding: 12px 20px;
            flex-shrink: 0;
        }
        .monitor-datetime {
            position: fixed;
            right: 20px;
            top: 20px;
            z-index: 1001;
            pointer-events: none;
            color: rgba(255, 255, 255, 0.95);
            font-size: 18px;
            font-weight: 500;
        }
        .back-home {
            position: absolute;
            left: 12px;
            top: 12px;
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.9) 0%, rgba(37, 99, 235, 0.9) 100%);
            color: #fff;
            text-decoration: none;
            border: 2px solid rgba(255,255,255,0.3);
            backdrop-filter: blur(10px);
            font-weight: 700;
            font-size: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            z-index: 1000;
            pointer-events: auto;
        }
        .back-home:hover {
            background: linear-gradient(135deg, rgba(37, 99, 235, 1) 0%, rgba(29, 78, 216, 1) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.5);
            border-color: rgba(255,255,255,0.5);
        }
        .back-home:active {
            transform: translateY(0);
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.4);
        }
        .user-info {
            position: fixed;
            right: 20px;
            top: 55px;
            padding: 8px 16px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.35);
            backdrop-filter: blur(6px);
            font-size: 14px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 4px;
            z-index: 10;
            pointer-events: auto;
        }
        .user-info-username {
            font-weight: 700;
            font-size: 15px;
        }
        .user-info-job {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }
        .title-with-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
        }
        .monitor-title {
            font-size: 24px;
            font-weight: bold;
            color: white;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .send-command-btn {
            padding: 10px 20px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
            white-space: nowrap;
        }
        .send-command-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .send-command-btn:active {
            transform: translateY(0) scale(1);
        }
        .refresh-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            white-space: nowrap;
        }
        .refresh-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .refresh-btn:active {
            transform: translateY(0) scale(1);
        }
        .oee-analysis-btn {
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: #fff;
            border: 2px solid rgba(255,255,255,0.4);
            backdrop-filter: blur(10px);
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.3);
            white-space: nowrap;
            text-decoration: none;
            display: inline-block;
        }
        .oee-analysis-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.5);
            border-color: rgba(255,255,255,0.6);
        }
        .oee-analysis-btn:active {
            transform: translateY(0) scale(1);
        }
        .monitor-layout {
            display: flex;
            gap: 16px;
            align-items: flex-start;
            margin-top: 8px;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }
        .device-sidebar {
            width: 200px;
            background: linear-gradient(180deg, rgba(30,41,59,0.85) 0%, rgba(15,23,42,0.85) 100%);
            border: 1px solid rgba(148, 163, 184, 0.2);
            border-radius: 16px;
            box-shadow: 0 12px 32px -16px rgba(15,23,42,0.8);
            backdrop-filter: blur(10px);
            color: #e2e8f0;
            position: sticky;
            top: 8px;
            max-height: calc(100vh - 100px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }
        .device-sidebar.hidden {
            width: 0;
            opacity: 0;
            margin: 0;
            padding: 0;
            border: none;
            overflow: hidden;
            pointer-events: none;
        }
        .sidebar-toggle-btn {
            position: fixed;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1000;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.9) 0%, rgba(139, 92, 246, 0.9) 100%);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: #fff;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        .sidebar-toggle-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.9) 0%, rgba(99, 102, 241, 0.9) 100%);
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6);
        }
        .monitor-layout.sidebar-hidden .sidebar-toggle-btn {
            left: 12px;
        }
        .monitor-layout.sidebar-hidden .device-content {
            margin-left: 0;
        }
        @media (max-width: 780px) {
            .sidebar-toggle-btn {
                width: 36px;
                height: 36px;
                font-size: 16px;
                left: 8px;
            }
        }
        .device-sidebar-inner {
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding: 16px 14px;
            overflow-y: auto;
        }
        .sidebar-add-card {
            width: 100%;
            border-radius: 12px;
            border: 1px dashed rgba(129, 140, 248, 0.65);
            padding: 12px;
            background: rgba(79, 70, 229, 0.1);
            color: #c7d2fe;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .sidebar-add-card:hover {
            background: rgba(79, 70, 229, 0.18);
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -18px rgba(129, 140, 248, 0.9);
        }
        .sidebar-add-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 1), rgba(139, 92, 246, 1));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            color: #fff;
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        }
        .sidebar-add-hint {
            font-size: 11px;
            color: rgba(226, 232, 240, 0.85);
        }
        .device-sidebar h3 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: #e2e8f0;
            letter-spacing: 0.4px;
        }
        .sidebar-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .sidebar-item {
            padding: 8px 10px;
            border-radius: 10px;
            background: rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(100, 116, 139, 0.2);
            color: #cbd5f5;
            font-size: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sidebar-item:hover {
            background: rgba(79, 70, 229, 0.2);
            border-color: rgba(129, 140, 248, 0.35);
        }
        .sidebar-item.active {
            background: rgba(79, 70, 229, 0.28);
            border-color: rgba(129, 140, 248, 0.55);
            box-shadow: inset 0 0 0 1px rgba(129, 140, 248, 0.25);
        }
        .sidebar-item-mode {
            font-size: 12px;
            color: rgba(226, 232, 240, 0.7);
        }
        .sidebar-empty {
            padding: 14px 12px;
            font-size: 13px;
            color: rgba(226, 232, 240, 0.65);
            background: rgba(15, 23, 42, 0.35);
            border-radius: 12px;
            border: 1px dashed rgba(148, 163, 184, 0.2);
        }
        .device-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding-right: 4px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: calc(100vh - 120px);
        }
        .device-grid {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            overflow: visible;
        }
        .device-grid-inner {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            align-content: start;
            padding-bottom: 12px;
        }
        .device-card {
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(148, 163, 184, 0.18);
            border-radius: 16px;
            box-shadow: 0 8px 20px -12px rgba(15, 23, 42, 0.6);
            background: rgba(255, 255, 255, 0.96);
            overflow: hidden;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
            min-height: 280px;
            max-height: 350px;
        }
        @media (max-width: 960px) {
            .device-grid-inner {
                grid-template-columns: 1fr;
            }
        }
        @media (max-width: 780px) {
            .monitor-layout {
                flex-direction: column;
            }
            .device-sidebar {
                position: static;
                width: 100%;
            }
            .device-name {
                flex-direction: column;
                gap: 8px;
                width: 100%;
            }
            .device-name-left {
                width: 100%;
            }
            .device-info-inline {
                width: 100%;
                gap: 6px;
                font-size: 12px;
            }
            .device-info-row {
                gap: 10px;
            }
            .device-info-item {
                font-size: 12px;
            }
            .device-info-label {
                font-size: 12px;
            }
            .device-info-value {
                font-size: 12px;
            }
            .edit-device-info-btn {
                font-size: 11px;
                padding: 4px 8px;
            }
            .data-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .time-row {
                grid-template-columns: 1fr;
                gap: 6px;
            }
            .time-item {
                padding: 5px 6px;
            }
            .time-label {
                font-size: 9px;
            }
            .info-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            .data-value {
                font-size: 22px;
            }
            .time-value {
                font-size: 10px;
            }
            .info-value {
                font-size: 12px;
            }
            .sample-tag {
                flex: 1 1 calc((100% - 10px) / 2);
                max-width: calc((100% - 10px) / 2);
                min-width: 120px;
                padding: 6px 10px;
                font-size: 12px;
            }
            .device-samples-tags {
                gap: 8px;
            }
        }
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 24px -16px rgba(79, 70, 229, 0.4);
        }
        .device-card.active {
            border-color: rgba(99, 102, 241, 0.45);
            box-shadow: 0 16px 28px -18px rgba(99, 102, 241, 0.5);
        }
        /* ‰ºòÂåñËÆæÂ§áÂç°ÁâáÂÜÖÈÉ®Ê†∑Âºè - Á¥ßÂáëÂ∏ÉÂ±Ä */
        .device-card-header {
            padding: 12px 14px;
            background: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-shrink: 0;
            border-bottom: 2px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            min-height: 70px;
            max-height: 100px;
            overflow: hidden;
            gap: 12px;
        }
        .device-name {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
            max-width: calc(100% - 140px); /* ‰∏∫Âè≥‰æßÁä∂ÊÄÅÊåâÈíÆÈ¢ÑÁïôÁ©∫Èó¥ */
        }
        .device-name-left {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 6px;
            flex-shrink: 0;
        }
        .device-name-left-top {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .device-info-inline {
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 13px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        .device-samples-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            overflow: visible;
            max-width: 100%;
        }
        .sample-tag {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 8px;
            font-size: 13px;
            color: #1e40af;
            white-space: nowrap;
            flex: 0 0 calc((100% - 20px) / 3);
            width: calc((100% - 20px) / 3);
            max-width: calc((100% - 20px) / 3);
            min-width: 0;
            font-weight: 500;
            box-sizing: border-box;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .sample-tag:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border-color: rgba(59, 130, 246, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.2);
        }
        .sample-tag:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(59, 130, 246, 0.15);
        }
        .sample-tag-text {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 0;
        }
        .device-info-row {
            display: flex;
            align-items: center;
            gap: 14px;
            flex-wrap: nowrap;
            overflow: hidden;
            margin-top: 4px;
        }
        .device-info-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: #1e293b;
            white-space: nowrap;
            font-weight: 500;
            flex-shrink: 0;
            min-width: 0;
        }
        .device-info-label {
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95);
            font-size: 13px;
            flex-shrink: 0;
        }
        .device-info-value {
            color: #ffffff;
            font-weight: 600;
            font-size: 13px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 120px;
        }
        .edit-device-info-btn {
            padding: 6px 12px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: 1.5px solid rgba(99, 102, 241, 0.3);
            color: #ffffff;
            font-size: 11px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
            flex-shrink: 0;
            margin-left: 0;
            letter-spacing: 0.3px;
        }
        .edit-device-info-btn:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        .edit-device-info-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 6px rgba(99, 102, 241, 0.2);
        }
        .device-icon {
            font-size: 20px;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }
        .device-id {
            font-size: 19px;
            font-weight: 700;
            color: #1e293b;
            text-shadow: none;
            letter-spacing: 0.5px;
        }
        .device-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: #ffffff;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            align-self: flex-start;
            margin-top: 0;
        }
        .device-status.running {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.7) 0%, rgba(16, 185, 129, 0.7) 100%);
            border-color: rgba(34, 197, 94, 1);
            color: #ffffff;
            box-shadow: 0 0 12px rgba(34, 197, 94, 0.6), inset 0 0 8px rgba(34, 197, 94, 0.3);
        }
        .device-status.stopped {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.8) 0%, rgba(220, 38, 38, 0.8) 100%);
            border-color: rgba(239, 68, 68, 1);
            color: #ffffff;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.7), inset 0 0 8px rgba(239, 68, 68, 0.4);
        }
        .device-status.paused {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.7) 0%, rgba(234, 88, 12, 0.7) 100%);
            border-color: rgba(249, 115, 22, 1);
            color: #ffffff;
            box-shadow: 0 0 12px rgba(249, 115, 22, 0.6), inset 0 0 8px rgba(249, 115, 22, 0.3);
        }
        .device-status.warning {
            background: rgba(239, 68, 68, 0.3);
            border-color: rgba(239, 68, 68, 0.5);
        }
        .device-card-body {
            padding: 12px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-height: 0;
            overflow: visible;
        }
        /* Á¨¨‰∏ÄË°åÔºöÊ∏©Â∫¶ÂíåÊπøÂ∫¶ */
        .data-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .data-item {
            text-align: center;
            padding: 12px 8px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 12px;
            border: 1px solid rgba(59, 130, 246, 0.2);
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.1);
            transition: all 0.3s ease;
        }
        .data-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.4);
        }
        .data-label {
            font-size: 12px;
            color: #475569;
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .data-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e40af;
            line-height: 1.2;
        }
        .data-value.temp-value {
            color: #dc2626;
        }
        .data-value.humidity-value {
            color: #0284c7;
        }
        .unit {
            font-size: 16px;
            margin-left: 2px;
            opacity: 0.85;
            font-weight: 500;
        }
        /* Á¨¨‰∫åË°åÔºöËøêË°åÊó∂Èó¥ÂíåÂâ©‰ΩôÊó∂Èó¥ */
        .time-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .time-item {
            display: flex;
            flex-direction: column;
            gap: 2px;
            padding: 6px 6px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 8px;
            border: 1px solid rgba(245, 158, 11, 0.3);
            text-align: center;
            box-shadow: 0 1px 4px rgba(245, 158, 11, 0.1);
            transition: all 0.3s ease;
        }
        .time-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.5);
        }
        .time-label {
            font-size: 10px;
            color: #92400e;
            font-weight: 600;
            letter-spacing: 0.2px;
        }
        .time-value {
            font-size: 11px;
            font-weight: 700;
            color: #78350f;
            line-height: 1.2;
        }
        /* Á¨¨‰∏âË°åÔºöÂΩìÂâçÊ®°Âºè„ÄÅÊ∏©Â∫¶ÂäüÁéáÂÄº„ÄÅÊπøÂ∫¶ÂäüÁéáÂÄº */
        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }
        .info-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 10px 6px;
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-radius: 10px;
            border: 1px solid rgba(139, 92, 246, 0.3);
            text-align: center;
            box-shadow: 0 2px 6px rgba(139, 92, 246, 0.1);
            transition: all 0.3s ease;
        }
        .info-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.5);
        }
        .info-label {
            font-size: 10px;
            color: #6b21a8;
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .info-value {
            font-size: 13px;
            font-weight: 700;
            color: #581c87;
            line-height: 1.3;
        }
        .info-value.mode {
            color: #667eea;
            font-weight: 700;
        }
        .device-card-footer {
            padding: 6px 12px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid #e0e0e0;
            flex-shrink: 0;
        }
        .connection-status {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            font-weight: 600;
        }
        .connection-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }
        .last-update {
            font-size: 10px;
            color: #9e9e9e;
        }
        .device-card-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .device-card:hover .device-card-actions {
            opacity: 1;
        }
        .delete-device-btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid rgba(248, 113, 113, 0.5);
            background: rgba(248, 113, 113, 0.12);
            color: #b91c1c;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            backdrop-filter: blur(4px);
            transition: all 0.25s ease;
        }
        .delete-device-btn:hover {
            background: rgba(248, 113, 113, 0.22);
            border-color: rgba(248, 113, 113, 0.7);
            color: #7f1d1d;
        }
        .device-empty-state {
            padding: 60px 20px;
            border: 2px dashed rgba(148, 163, 184, 0.35);
            border-radius: 24px;
            text-align: center;
            color: #64748b;
            font-size: 16px;
            background: rgba(248, 250, 252, 0.6);
            backdrop-filter: blur(6px);
        }
        .device-form-content {
            max-width: 520px;
        }
        .device-form-body {
            padding: 32px 36px 36px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .device-form-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .device-form-group label {
            font-weight: 600;
            color: #1e293b;
            font-size: 15px;
        }
        .device-form-group input,
        .device-form-group select {
            padding: 12px 14px;
            border-radius: 10px;
            border: 1px solid #cbd5f5;
            font-size: 14px;
            background: #fff;
            transition: all 0.2s ease;
        }
        .device-form-group input:focus,
        .device-form-group select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
        }
        .device-form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            padding: 0 36px 32px;
        }
        .device-form-btn {
            padding: 12px 28px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .device-form-btn.cancel {
            background: #e2e8f0;
            color: #475569;
        }
        .device-form-btn.cancel:hover {
            background: #cbd5e1;
        }
        .device-form-btn.submit {
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            box-shadow: 0 10px 20px rgba(99, 102, 241, 0.2);
        }
        .device-form-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 24px rgba(99, 102, 241, 0.25);
        }
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè - ÂÖ®Êñ∞Áé∞‰ª£ÂåñËÆæËÆ° */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background: rgba(15, 23, 42, 0.75);
            backdrop-filter: blur(12px);
            animation: fadeIn 0.25s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content {
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            margin: 2% auto;
            border-radius: 28px;
            width: 92%;
            max-width: 950px;
            max-height: none;
            height: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04),
                0 0 0 1px rgba(0, 0, 0, 0.05),
                0 0 100px rgba(102, 126, 234, 0.15);
            animation: modalSlideIn 0.35s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: visible;
            position: relative;
        }
        .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, 
                #667eea 0%, 
                #764ba2 25%, 
                #f093fb 50%, 
                #4facfe 75%, 
                #667eea 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease infinite;
        }
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        @keyframes modalSlideIn {
            from {
                transform: translateY(-20px) scale(0.96);
                opacity: 0;
            }
            to {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 30px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
            position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .modal-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent 0%, 
                rgba(255, 255, 255, 0.3) 50%, 
                transparent 100%);
        }
        .modal-header h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            letter-spacing: -0.8px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        .modal-header h2::before {
            content: 'üì°';
            font-size: 32px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        .close {
            color: rgba(255, 255, 255, 0.95);
            font-size: 24px;
            font-weight: 300;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .close:hover {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            transform: rotate(90deg) scale(1.1);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .modal-body {
            padding: 40px;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            overflow: visible;
            flex: 1;
            min-height: 0;
        }
        .form-group {
            margin-bottom: 28px;
        }
        .form-group label {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            font-weight: 700;
            color: #1e293b;
            font-size: 16px;
            letter-spacing: -0.3px;
        }
        .form-group label::before {
            content: 'üìù';
            font-size: 20px;
        }
        .json-input {
            width: 100%;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-family: 'SF Mono', 'Monaco', 'Consolas', 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.8;
            resize: vertical;
            min-height: 520px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            background: #ffffff;
            color: #0f172a;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .json-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 
                0 0 0 5px rgba(102, 126, 234, 0.1),
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.15);
            background: #ffffff;
            transform: translateY(-1px);
        }
        .json-input::placeholder {
            color: #94a3b8;
            font-style: italic;
        }
        .form-actions {
            display: flex;
            gap: 14px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            flex: 1;
            min-width: 140px;
            letter-spacing: 0.2px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                0 0 20px rgba(102, 126, 234, 0.4);
            position: relative;
        }
        .btn-primary::after {
            content: 'üöÄ';
            font-size: 18px;
        }
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                0 0 30px rgba(102, 126, 234, 0.5);
        }
        .btn-primary:active {
            transform: translateY(-1px);
        }
        .btn-secondary {
            background: #ffffff;
            color: #475569;
            border: 2px solid #e2e8f0;
            box-shadow: 
                0 1px 3px 0 rgba(0, 0, 0, 0.1),
                0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .btn-secondary:nth-of-type(2)::after {
            content: '‚ú®';
            font-size: 16px;
        }
        .btn-secondary:nth-of-type(3)::after {
            content: 'üóëÔ∏è';
            font-size: 16px;
        }
        .btn-secondary:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-2px);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: #334155;
        }
        .result-message {
            padding: 18px 24px;
            border-radius: 12px;
            margin-top: 24px;
            display: none;
            font-weight: 500;
            font-size: 15px;
            animation: slideInUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            line-height: 1.6;
            position: relative;
            overflow: hidden;
        }
        .result-message::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            border-radius: 12px 0 0 12px;
        }
        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(10px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        .result-message.success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 1px solid #6ee7b7;
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }
        .result-message.success::before {
            background: #10b981;
        }
        .result-message.error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 1px solid #fca5a5;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2);
        }
        .result-message.error::before {
            background: #ef4444;
        }
        .result-message.loading {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border: 1px solid #93c5fd;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.2);
        }
        .result-message.loading::before {
            background: #3b82f6;
        }
        /* Á®ãÂºèËØïÈ™åÈ°µÈù¢Áõ∏ÂØπÂÆö‰ΩçÔºåÁ°Æ‰øùÁªùÂØπÂÆö‰ΩçÁöÑÂ≠êÂÖÉÁ¥†Ê≠£Á°ÆÂÆö‰Ωç */
        #programPage {
            position: relative;
        }

        /* Á®ãÂºèËØïÈ™åÁä∂ÊÄÅ‰ø°ÊÅØÊ°ÜÊ†∑Âºè */
        .program-status-box {
            position: absolute;
            left: 0;
            right: 0;
            bottom: 180px; /* ÂÆö‰ΩçÂú®ÂäüÁéáÂÄº‰∏ãÊñπ10px */
            z-index: 10;
            width: calc(100% - 48px); /* ‰∏éËØïÈ™åÂÆπÂô®(main-content)‰∏ÄÊ†∑ÂÆΩÔºåÂáèÂéªÂ∑¶Âè≥ËæπË∑ù */
            margin: 0 24px; /* Â∑¶Âè≥ËæπË∑ù24pxÔºå‰∏émain-content‰∏ÄËá¥ */
            padding: 16px 24px;
            background: linear-gradient(135deg, #60a5fa 0%, #3b82f6 100%);
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(96, 165, 250, 0.25);
            border: 2px solid rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px);
            pointer-events: none; /* ‰∏çÂΩ±Âìç‰∏ãÈù¢ÁöÑÁÇπÂáª‰∫ã‰ª∂ */
        }

        .program-status-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 15px;
            font-weight: 600;
            pointer-events: auto; /* Áä∂ÊÄÅÊ°ÜÊú¨Ë∫´ÂèØ‰ª•ÁÇπÂáª */
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .status-item span:last-child {
            font-weight: 700;
            color: #1e3a8a;
        }

        /* Á®ãÂºèÂè∑ÂèØÁÇπÂáªÊ†∑Âºè */
        #programNumberDisplay.clickable {
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 6px;
            padding: 2px 8px;
        }
        
        #programNumberDisplay.clickable:hover {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            transform: scale(1.05);
        }
        
        #programNumberDisplay.modified {
            color: #667eea !important;
            font-weight: 700 !important;
            position: relative;
        }
        
        #programNumberDisplay.modified::after {
            content: '‚úé';
            position: absolute;
            right: -18px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
            color: #667eea;
        }
        
        /* ÂÆöÂÄºËØïÈ™åËÆæÂÆöÂÄº‰øÆÊîπÊ†áËØÜÊ†∑Âºè */
        #targetTempDisplay.modified,
        #targetHumidityDisplay.modified {
            color: #667eea !important;
            font-weight: 700 !important;
        }
        
        /* ÂÆöÊó∂ËøêË°åÂèÇÊï∞‰øÆÊîπÊ†áËØÜÊ†∑Âºè */
        #runTimeInput.modified {
            color: #667eea !important;
            font-weight: 700 !important;
            border-color: #667eea !important;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2) !important;
        }
        
        #timerOff.modified,
        #timerOn.modified {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
            color: white !important;
            font-weight: 700 !important;
        }
        
        /* ÈÄöÁî®ÊèêÁ§∫Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .alert-modal-content {
            max-width: 480px;
            margin: 15% auto;
            background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 20px 25px -5px rgba(0, 0, 0, 0.1),
                0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: modalSlideIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .alert-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: white;
        }
        
        .alert-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }
        
        .alert-modal-body {
            padding: 35px 30px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }
        
        .alert-modal-icon {
            font-size: 48px;
            line-height: 1;
        }
        
        .alert-modal-message {
            font-size: 16px;
            color: #1e293b;
            line-height: 1.6;
            white-space: pre-line;
        }
        
        .alert-modal-footer {
            padding: 0 30px 30px;
            display: flex;
            justify-content: center;
        }
        
        .alert-modal-btn {
            padding: 12px 40px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            min-width: 120px;
        }
        
        .alert-modal-btn:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }
        
        .alert-modal-btn:active {
            transform: translateY(0);
        }
        
        /* ‰∏çÂêåÁ±ªÂûãÁöÑÂõæÊ†áÈ¢úËâ≤ */
        .alert-modal-icon.info { color: #3b82f6; }
        .alert-modal-icon.success { color: #10b981; }
        .alert-modal-icon.warning { color: #f59e0b; }
        .alert-modal-icon.error { color: #ef4444; }
        
        /* ÊâßË°å‰∏≠ÊåâÈíÆÊ†∑Âºè */
        .action-btn.executing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white !important;
            cursor: pointer !important;
            animation: pulse 1.5s ease-in-out infinite;
            position: relative;
        }
        
        .action-btn.executing::after {
            content: '‚è≥';
            margin-left: 6px;
            font-size: 16px;
        }
        
        .action-btn.executing:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        /* ÊöÇÂÅú‰∏≠ÊåâÈíÆÊ†∑ÂºèÔºàÊ©ôËâ≤Á≥ªÔºâ */
        .pause-btn.executing {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%) !important;
            color: white !important;
            cursor: pointer !important;
            animation: pulse 1.5s ease-in-out infinite;
        }
        
        .pause-btn.executing::after {
            content: '‚è≥';
            margin-left: 6px;
            font-size: 16px;
        }
        
        .pause-btn.executing:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(245, 158, 11, 0.4);
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }
        
        @media (max-width: 768px) {
            .title-with-btn {
                flex-direction: column;
                gap: 10px;
            }
            .send-command-btn {
                font-size: 13px;
                padding: 8px 16px;
            }
            .program-status-content {
                gap: 12px;
                font-size: 13px;
            }
            .program-status-box {
                bottom: 100px; /* ÁßªÂä®Á´ØÂäüÁéáÂÄº‰∏ãÊñπ10px */
                width: calc(100% - 32px); /* ÁßªÂä®Á´ØË∞ÉÊï¥ÂÆΩÂ∫¶ */
                margin: 0 16px; /* ÁßªÂä®Á´ØË∞ÉÊï¥ËæπË∑ù */
                padding: 12px 18px;
            }
            .modal-content {
                width: 96%;
                margin: 1% auto;
                max-height: none;
                height: auto;
                border-radius: 24px;
                overflow: visible;
            }
            .modal-header {
                padding: 24px 28px;
            }
            .modal-header h2 {
                font-size: 22px;
            }
            .modal-header h2::before {
                font-size: 26px;
            }
            .modal-body {
                padding: 28px 24px;
            }
            .json-input {
                min-height: 450px;
                padding: 16px;
                font-size: 13px;
            }
            .form-actions {
                flex-direction: column;
                gap: 12px;
            }
            .btn {
                width: 100%;
                min-width: unset;
                padding: 14px 24px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <!-- ÂÖ®Â±ÄÊó∂Èó¥ÊòæÁ§∫ÔºàÂõ∫ÂÆöÂú®Âè≥‰∏äËßíÔºåÊâÄÊúâÈ°µÈù¢ÂÖ±Áî®Ôºâ -->
    <div class="monitor-datetime" id="monitorDatetime">2025-10-28 13:41:04</div>
    
    <!-- ËÆæÂ§áÁõëÊéßÈ¶ñÈ°µ -->
    <div id="deviceMonitorPage" class="page active">
        <div class="monitor-header">
            <a class="back-home" href="/" id="backHomeBtn" onclick="handleBackHome(event)">‚Üê ËøîÂõû‰∏ªÈ°µ</a>
            <div class="title-with-btn">
                <!-- <button class="send-command-btn" onclick="openCommandModal()">üì§ ÂèëÈÄÅÊâßË°åÂëΩ‰ª§</button> -->
                <button class="refresh-btn" id="refreshDataBtn" onclick="forceRefreshData()" title="Âº∫Âà∂‰ªéÊï∞ÊçÆÂ∫ìÂà∑Êñ∞Êï∞ÊçÆ">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
                <a class="oee-analysis-btn" id="oeeAnalysisBtn" href="/reliabilityLab/oeeAnalysis" title="Êü•ÁúãOEEÂàÜÊûê">üìä OEEÂàÜÊûê</a>
                <h1 class="monitor-title" id="monitorTitle">ÂèØÈù†ÊÄßÁâ©ËÅîÁΩëÊ∏©ÁÆ±ÁõëÊéßÁ≥ªÁªü</h1>
            </div>
            <div class="user-info" id="userInfo" style="display: none;">
                <div class="user-info-username" id="userInfoUsername"></div>
                <div class="user-info-job" id="userInfoJob"></div>
            </div>
        </div>

        <div class="monitor-layout" id="monitorLayout">
            <button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" title="ÊòæÁ§∫/ÈöêËóè‰æßËæπÊ†è">‚óÄ</button>
            <aside class="device-sidebar" id="deviceSidebar">
                <div class="device-sidebar-inner">
                    <div class="sidebar-add-card" onclick="openAddDeviceModal()">
                        <div class="sidebar-add-icon">+</div>
                        <div>Ê∑ªÂä†Êñ∞ËÆæÂ§á</div>
                        <div class="sidebar-add-hint">Ê≥®ÂÜåËÆæÂ§áIDÂà∞ÁõëÊéßÁ≥ªÁªü</div>
                    </div>
                    <div>
                        <h3>ËÆæÂ§áÂàóË°®</h3>
                        <div id="deviceSidebarList" class="sidebar-list"></div>
                    </div>
                </div>
            </aside>
            <div class="device-content">
                <div class="device-grid">
                    <div id="deviceGrid" class="device-grid-inner"></div>
                    <div id="deviceEmptyState" class="device-empty-state" style="display: none;">
                        ÂΩìÂâçÊ≤°ÊúâÁõëÊéß‰∏≠ÁöÑËÆæÂ§á
                        <br><br>
                        üí° ËØ∑ÁÇπÂáªÂ∑¶‰æß <strong>"Ê∑ªÂä†Êñ∞ËÆæÂ§á"</strong> ÊåâÈíÆÊ≥®ÂÜåËÆæÂ§áÂà∞ÁõëÊéßÁ≥ªÁªü
                    </div>
                </div>
            </div>
        </div>
    </div>
    <template id="deviceCardTemplate">
        <div class="device-card">
            <div class="device-card-actions">
                <button class="delete-device-btn" type="button">ÁßªÈô§</button>
            </div>
            <div class="device-card-header">
                <div class="device-name">
                    <div class="device-name-left">
                        <div class="device-name-left-top">
                            <span class="device-icon">üå°Ô∏è</span>
                            <span class="device-id" data-field="deviceId">--</span>
                        </div>
                        <button class="edit-device-info-btn" data-device-id="" title="ÁÆ°ÁêÜÊ†∑ÂìÅ‰ø°ÊÅØ">
                            <span>‚úèÔ∏è</span>
                            <span>ÁÆ°ÁêÜÊ†∑ÂìÅ</span>
                        </button>
                    </div>
                    <div class="device-info-inline">
                        <div class="device-samples-tags" data-field="samplesContainer">
                            <!-- Ê†∑ÂìÅÊ†áÁ≠æÂ∞ÜÂä®ÊÄÅÊèíÂÖ•ËøôÈáå -->
                        </div>
                    </div>
                </div>
                <div class="device-status" data-field="statusWrapper">
                    <span class="status-dot"></span>
                    <span class="status-text" data-field="statusText">--</span>
                </div>
            </div>
            <div class="device-card-body">
                <!-- Á¨¨‰∏ÄË°åÔºöÊ∏©Â∫¶ÂíåÊπøÂ∫¶ -->
                <div class="data-row">
                    <div class="data-item">
                        <div class="data-label">üå°Ô∏è Ê∏©Â∫¶</div>
                        <div class="data-value temp-value" data-field="temperature">0<span class="unit">‚ÑÉ</span></div>
                    </div>
                    <div class="data-item">
                        <div class="data-label">üíß ÊπøÂ∫¶</div>
                        <div class="data-value humidity-value" data-field="humidity">0<span class="unit">%</span></div>
                    </div>
                </div>
                <!-- Á¨¨‰∫åË°åÔºöËøêË°åÊó∂Èó¥ÂíåÂâ©‰ΩôÊó∂Èó¥ -->
                <div class="time-row">
                    <div class="time-item">
                        <span class="time-label">‚è±Ô∏è ËøêË°åÊó∂Èó¥</span>
                        <span class="time-value" data-field="runtime">0H 00M 00S</span>
                    </div>
                    <div class="time-item">
                        <span class="time-label">‚è≥ Ââ©‰ΩôÊó∂Èó¥</span>
                        <span class="time-value" data-field="remaining">--</span>
                    </div>
                </div>
                <!-- Á¨¨‰∏âË°åÔºöÂΩìÂâçÊ®°Âºè„ÄÅÊ∏©Â∫¶ÂäüÁéáÂÄº„ÄÅÊπøÂ∫¶ÂäüÁéáÂÄº -->
                <div class="info-row">
                    <div class="info-item">
                        <span class="info-label">üìã ÂΩìÂâçÊ®°Âºè</span>
                        <span class="info-value mode" data-field="mode">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üî• Ê∏©Â∫¶ÂäüÁéá</span>
                        <span class="info-value" data-field="tempPower">0%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">üí® ÊπøÂ∫¶ÂäüÁéá</span>
                        <span class="info-value" data-field="humidityPower">0%</span>
                    </div>
                </div>
            </div>
            <div class="device-card-footer">
                <div class="connection-status" data-field="connectionWrapper">
                    <span class="connection-dot"></span>
                    <span data-field="connectionText">--</span>
                </div>
                <div class="last-update" data-field="lastUpdate">Êõ¥Êñ∞: --</div>
            </div>
        </div>
    </template>

    <!-- ‰∏ªËèúÂçïÈ°µÈù¢ (WK1) -->
    <div id="menuPage" class="page">
        <div class="menu-header">
            <div class="device-id">U680</div>
            <div class="menu-datetime" id="menuDatetime">2025-10-27 17:46:01</div>
        </div>

        <div class="menu-controls">
            <button class="menu-btn orange" onclick="backToMonitor()">ÁõÆÂΩï</button>
        </div>

        <div class="menu-grid">
            <button class="menu-item menu-item-yellow" onclick="navigateTo('constant')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M8 10h8"/>
                </svg>
                <span>ÂÆöÂÄºËØïÈ™å</span>
            </button>

            <button class="menu-item menu-item-red" onclick="navigateTo('program')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M8 8h8M8 12h8M8 16h8"/>
                </svg>
                <span>Á®ãÂºèËØïÈ™å</span>
            </button>

            <button class="menu-item menu-item-orange" onclick="navigateTo('settings')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <path d="M6 8h12M6 12h12M6 16h12"/>
                </svg>
                <span>Êìç‰ΩúËÆæÁΩÆ</span>
            </button>

            <button class="menu-item menu-item-green" onclick="navigateTo('communication')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5">
                    <circle cx="12" cy="12" r="10"/>
                    <line x1="12" y1="8" x2="12" y2="12"/>
                    <line x1="12" y1="16" x2="12.01" y2="16"/>
                </svg>
                <span>ÈÄöËÆØËÆæÁΩÆ</span>
            </button>

            <button class="menu-item menu-item-purple" onclick="navigateTo('appointment')">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>È¢ÑÁ∫¶ËÆæÁΩÆ</span>
            </button>
        </div>

        <div class="menu-footer">
            <div class="error-message">Ê∏©ÊπøÂ∫¶Ê®°ÂùóËøûÊé•ÂºÇÂ∏∏</div>
            <div class="version">V1.9</div>
        </div>
    </div>

    <!-- ÂÆöÂÄºËØïÈ™åÈ°µÈù¢ (WK6/WK7) -->
    <div id="constantPage" class="page">
        <div class="header has-device-id">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <div class="device-id" id="constantDeviceId">--</div>
            <h1 class="header-title">ÂÆöÂÄºËØïÈ™å</h1>
            <div class="header-status">
                <div class="status-datetime" id="constantDatetime">2025-10-27 17:46:01</div>
                <div class="status-text" id="constantStatus">ËØïÈ™åÂÅúÊ≠¢</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-temp">
                <div class="panel-header">
                    <span class="panel-title">Ê∏©Â∫¶</span>
                    <span class="panel-unit">‚ÑÉ</span>
                </div>
                <div class="panel-value" id="currentTemp">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label">ËÆæÂÆöÂÄº</span>
                        <div class="control-input-clickable" id="targetTempDisplay">0.0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="tempPower">0.0%</div>
                    </div>
                </div>
            </div>

            <div class="panel panel-humidity">
                <div class="panel-header">
                    <span class="panel-title">ÊπøÂ∫¶</span>
                    <span class="panel-unit">%</span>
                </div>
                <div class="panel-value" id="currentHumidity">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label">ËÆæÂÆöÂÄº</span>
                        <div class="control-input-clickable" id="targetHumidityDisplay">0.0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="humidityPower">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="bottom-section">
            <div class="time-display">
                <div class="time-box">
                    <span class="time-label">ËøêË°åÊó∂Èó¥:</span>
                    <span class="time-value" id="runtime">0H 00M 00S</span>
                </div>
                <div class="time-box">
                    <span class="time-label">Ââ©‰ΩôÊó∂Èó¥:</span>
                    <span class="time-value" id="remainingTime">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="settingsBtn">ËÆæÁΩÆ</button>
                <button class="action-btn pause-btn" id="chartBtn">ÊöÇÂÅú</button>
                <button class="action-btn action-btn-primary" id="runBtn">ËøêË°å</button>
            </div>
        </div>
    </div>

    <!-- Á®ãÂºèËØïÈ™åÈ°µÈù¢ -->
    <div id="programPage" class="page">
        <div class="header has-device-id">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <div class="device-id" id="programDeviceId">--</div>
            <h1 class="header-title">Á®ãÂºèËØïÈ™å</h1>
            <div class="header-status">
                <div class="status-datetime" id="programDatetime">2025-10-27 17:46:01</div>
                <div class="status-text" id="programStatus">ËØïÈ™åÂÅúÊ≠¢</div>
            </div>
        </div>

        <div class="main-content">
            <div class="panel panel-temp">
                <div class="panel-header">
                    <span class="panel-title">Ê∏©Â∫¶</span>
                    <span class="panel-unit">‚ÑÉ</span>
                </div>
                <div class="panel-value" id="programCurrentTemp">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label" id="programTempLabel">Á®ãÂºèÂè∑</span>
                        <div class="control-input-clickable" id="programNumberDisplay">0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="programTempPower">0.0%</div>
                    </div>
                </div>
            </div>

            <div class="panel panel-humidity">
                <div class="panel-header">
                    <span class="panel-title">ÊπøÂ∫¶</span>
                    <span class="panel-unit">%</span>
                </div>
                <div class="panel-value" id="programCurrentHumidity">0.0</div>
                <div class="panel-control">
                    <div class="control-row">
                        <span class="control-label" id="programHumLabel">ÊÄªÊÆµÊï∞</span>
                        <div class="control-display" id="totalSegmentsDisplay">0</div>
                    </div>
                    <div class="control-row">
                        <span class="control-label">ÂäüÁéáÂÄº</span>
                        <div class="control-display" id="programHumidityPower">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Á®ãÂºèËØïÈ™åÁä∂ÊÄÅ‰ø°ÊÅØÊ°Ü -->
        <div id="programStatusBox" class="program-status-box" style="display: none;">
            <div class="program-status-content">
                <span class="status-item">Á®ãÂºèÂè∑Ôºö<span id="programStatusNumber">0</span></span>
                <span class="status-item">ÊÆµÂè∑Ôºö<span id="programStatusSegment">01</span></span>
                <span class="status-item">Á®ãÂºèÂæ™ÁéØÔºö<span id="programStatusCycle">00/05</span></span>
                <span class="status-item">ÊÆµÂæ™ÁéØÔºö<span id="programStatusSegmentCycle">00/00</span></span>
                <span class="status-item">ÊÄªÊÆµÊï∞Ôºö<span id="programStatusTotalSegments">0</span></span>
            </div>
        </div>

        <div class="bottom-section">
            <div class="time-display">
                <div class="time-box">
                    <span class="time-label">ËøêË°åÊó∂Èó¥:</span>
                    <span class="time-value" id="programRuntime">0H 00M 00S</span>
                </div>
                <div class="time-box">
                    <span class="time-label">Ââ©‰ΩôÊó∂Èó¥:</span>
                    <span class="time-value" id="programRemainingTime">--</span>
                </div>
            </div>
            <div class="action-buttons">
                <button class="action-btn" id="editBtn">ÁºñËæë</button>
                <button class="action-btn pause-btn" id="programChartBtn">ÊöÇÂÅú</button>
                <button class="action-btn action-btn-primary" id="programRunBtn">ËøêË°å</button>
            </div>
        </div>
    </div>

    <!-- Êìç‰ΩúËÆæÁΩÆÈ°µÈù¢ (WK8) -->
    <div id="settingsPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <h1 class="header-title">Êìç‰ΩúËÆæÁΩÆ1</h1>
        </div>

        <div class="settings-content">
            <div class="setting-row">
                <label class="setting-label">ËØ≠Ë®ÄÈÄâÊã©</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="langZh">‰∏≠Êñá</button>
                    <button class="toggle-btn" id="langEn">ENGLISH</button>
                </div>
            </div>

            <div class="setting-row">
                <label class="setting-label">ÂêØÂä®ÊñπÂºè</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="startStop">ÂÅúÊ≠¢</button>
                    <button class="toggle-btn" id="startCold">ÂÜ∑ÂêØ</button>
                    <button class="toggle-btn" id="startHot">ÁÉ≠ÂêØ</button>
                </div>
            </div>

            <div class="setting-row">
                <label class="setting-label">Â§öÂè∞ËøûÊé•‰ΩøËÉΩ</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="multiNo">Âê¶</button>
                    <button class="toggle-btn" id="multiYes">ÊòØ</button>
                </div>
            </div>

            <button class="input-settings-btn" onclick="navigateTo('menu')">ËæìÂÖ•ËÆæÁΩÆ</button>
        </div>
    </div>

    <!-- ÈÄöËÆØËÆæÁΩÆÈ°µÈù¢ (WK3) -->
    <div id="communicationPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <h1 class="header-title">ÈÄöËÆØËÆæÁΩÆ</h1>
        </div>

        <div class="communication-content">
            <div class="comm-row">
                <label class="comm-label">ÈÄö‰ø°ÂçèËÆÆ</label>
                <div class="protocol-toggle">
                    <button class="protocol-btn active" id="rtuBtn">RTU</button>
                    <button class="protocol-btn" id="tcpBtn">TCP</button>
                </div>
            </div>

            <!-- RTU ËÆæÁΩÆÁïåÈù¢ -->
            <div id="rtuSettings" class="protocol-settings">
                <div class="comm-row">
                    <label class="comm-label">Á´ØÂè£Âè∑</label>
                    <select class="comm-input" id="portNumber">
                        <option>COM12</option>
                        <option>COM1</option>
                        <option>COM2</option>
                    </select>
                    <label class="comm-label">Ê≥¢ÁâπÁéá</label>
                    <select class="comm-input" id="baudRate">
                        <option>9600</option>
                        <option>19200</option>
                        <option>38400</option>
                    </select>
                </div>

                <div class="comm-row">
                    <label class="comm-label">ÂÅúÊ≠¢‰Ωç</label>
                    <select class="comm-input" id="stopBit">
                        <option>1</option>
                        <option>2</option>
                    </select>
                    <label class="comm-label">Êï∞ÊçÆ‰Ωç</label>
                    <select class="comm-input" id="dataBit">
                        <option>8</option>
                        <option>7</option>
                    </select>
                </div>

                <div class="comm-row">
                    <label class="comm-label">Â•áÂÅ∂Ê†°È™å</label>
                    <select class="comm-input" id="parity">
                        <option>N</option>
                        <option>E</option>
                        <option>O</option>
                    </select>
                    <label class="comm-label">ÈÄö‰ø°Âú∞ÂùÄ</label>
                    <input type="number" class="comm-input" id="commAddress" value="1">
                    <button class="connect-btn" id="connectBtn">ËøûÊé•</button>
                </div>

                <div class="server-upload">
                    <label class="comm-label">‰∏ä‰º†ÊúçÂä°Âô®</label>
                    <input type="text" class="server-input" id="serverUrl" placeholder="ËæìÂÖ•ÊúçÂä°Âô®Âú∞ÂùÄ">
                    <button class="upload-btn" id="uploadBtn">‰∏ä‰º†</button>
                </div>
            </div>

            <!-- TCP ËÆæÁΩÆÁïåÈù¢ -->
            <div id="tcpSettings" class="protocol-settings" style="display: none;">
                <div class="comm-row">
                    <label class="comm-label">Â±èIPÂú∞ÂùÄ</label>
                    <input type="text" class="comm-input" id="screenIp" value="192.168.0.146">
                    <label class="comm-label">Á´ØÂè£Âè∑</label>
                    <input type="number" class="comm-input" id="tcpPort" value="8000">
                </div>

                <div class="comm-row">
                    <button class="connect-btn" id="tcpConnectBtn">ËøûÊé•</button>
                </div>
            </div>
        </div>
    </div>

    <!-- È¢ÑÁ∫¶ËÆæÁΩÆÈ°µÈù¢ (WK5) -->
    <div id="appointmentPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('menu')">ÁõÆÂΩï</button>
            <h1 class="header-title">È¢ÑÁ∫¶ËÆæÁΩÆ</h1>
        </div>

        <div class="appointment-content">
            <div class="time-section">
                <label class="time-label">Á≥ªÁªüÊó∂Èó¥</label>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="sysYear" value="0000">
                    <span class="time-unit">Âπ¥</span>
                    <input type="number" class="time-input" id="sysMonth" value="00">
                    <span class="time-unit">Êúà</span>
                    <input type="number" class="time-input" id="sysDay" value="00">
                    <span class="time-unit">Êó•</span>
                </div>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="sysHour" value="00">
                    <span class="time-unit">Êó∂</span>
                    <input type="number" class="time-input" id="sysMinute" value="00">
                    <span class="time-unit">ÂàÜ</span>
                    <input type="number" class="time-input" id="sysSecond" value="00">
                    <span class="time-unit">Áßí</span>
                </div>
            </div>

            <div class="time-section">
                <label class="time-label">È¢ÑÁ∫¶Êó∂Èó¥</label>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="resYear" value="0000">
                    <span class="time-unit">Âπ¥</span>
                    <input type="number" class="time-input" id="resMonth" value="00">
                    <span class="time-unit">Êúà</span>
                    <input type="number" class="time-input" id="resDay" value="00">
                    <span class="time-unit">Êó•</span>
                </div>
                <div class="time-inputs">
                    <input type="number" class="time-input" id="resHour" value="00">
                    <span class="time-unit">Êó∂</span>
                    <input type="number" class="time-input" id="resMinute" value="00">
                    <span class="time-unit">ÂàÜ</span>
                    <input type="number" class="time-input" id="resSecond" value="00">
                    <span class="time-unit">Áßí</span>
                </div>
            </div>

            <div class="time-section">
                <label class="time-label">È¢ÑÁ∫¶ËÆæÁΩÆ</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="appointmentOff">ÂÖ≥</button>
                    <button class="toggle-btn" id="appointmentOn">ÂºÄ</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂÆöÂÄºËÆæÁΩÆÈ°µÈù¢ (WK2) -->
    <div id="valueSettingsPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('constant')">ËøîÂõû</button>
            <h1 class="header-title">ÂÆöÂÄºËÆæÁΩÆ</h1>
            <button class="menu-btn orange" onclick="resetTimerSettingsToDefault()">ËøòÂéü</button>
        </div>

        <div class="value-settings-content">
            <div class="value-setting-row">
                <label class="value-setting-label">ÂÆöÊó∂ËøêË°å</label>
                <div class="toggle-group">
                    <button class="toggle-btn active" id="timerOff">ÂÖ≥</button>
                    <button class="toggle-btn" id="timerOn">ÂºÄ</button>
                </div>
                <input type="text" class="value-input" id="runTimeInput" value="0.00" placeholder="H.M" maxlength="6">
                <span class="value-unit">H.M</span>
            </div>
        </div>
    </div>

    <!-- Á®ãÂºèÁºñËæëÈ°µÈù¢ (WK4) -->
    <div id="programEditPage" class="page">
        <div class="header">
            <button class="menu-btn orange" onclick="navigateTo('program')">ËøîÂõû</button>
            <h1 class="header-title">Á®ãÂºèÁºñËæë</h1>
            <button class="menu-btn orange" onclick="navigateTo('standby')">ÂæÖÊú∫</button>
        </div>

        <div class="program-edit-content">
            <div class="program-info-row">
                <label class="program-info-label">Á®ãÂºèÁºñÂè∑</label>
                <input type="number" class="program-info-input" id="progNumber" value="0">
                <label class="program-info-label">Âæ™ÁéØ</label>
                <input type="number" class="program-info-input" id="progCycle" value="0">
                <label class="program-info-label">ËøûÊé•</label>
                <input type="number" class="program-info-input" id="progConnect" value="0">
            </div>

            <div class="program-table-container">
                <table class="program-table">
                    <thead>
                    <tr>
                        <th>No.</th>
                        <th>Ê∏©Â∫¶(‚ÑÉ)</th>
                        <th>ÊπøÂ∫¶(%)</th>
                        <th>Êó∂Èó¥(H.M)</th>
                        <th>TS1</th>
                        <th>TS2</th>
                        <th>TS3</th>
                        <th>TS4</th>
                    </tr>
                    </thead>
                    <tbody id="programTableBody">
                    <tr>
                        <td>01</td>
                        <td><input type="number" class="table-input" value="0.0"></td>
                        <td><input type="number" class="table-input" value="0.0"></td>
                        <td><input type="number" class="table-input" value="0.00"></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                        <td><button class="table-off-btn">OFF</button></td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- ËøêË°åÁ°ÆËÆ§Á™óÂè£ -->
<div id="runConfirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Á°ÆËÆ§Êìç‰Ωú</h3>
        </div>
        <div class="modal-body">
            <div class="confirm-message" id="modalMessage">
                Á°ÆÂÆöË¶ÅÊâßË°åÊ≠§Êìç‰ΩúÂêóÔºü<br>
                <small>ÂëΩ‰ª§Â∞ÜÂèëÈÄÅËá≥ËÆæÂ§áÔºåÊâßË°åÂêéÂ∞ÜÂú®30ÁßíÂêéËá™Âä®Âà∑Êñ∞Áä∂ÊÄÅ„ÄÇ</small>
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-no" id="modalNo">ÂèñÊ∂à</button>
            <button class="modal-btn modal-btn-yes" id="modalYes">Á°ÆËÆ§</button>
        </div>
    </div>
</div>

<!-- Êï∞ÂÄºËæìÂÖ•ÂØπËØùÊ°Ü -->
<div id="valueInputModal" class="modal">
    <div class="value-input-content">
        <div class="value-input-header">
            <div class="value-input-label" id="valueInputLabel">ËÆæÂÆöÂÄº</div>
            <div class="value-input-range" id="valueInputRange">[-200.00 - 400.00]</div>
            <div class="value-input-field">
                <input type="text" id="valueInput" placeholder="ËØ∑ËæìÂÖ•Êï∞ÂÄº">
            </div>
        </div>
        <div class="value-keypad">
            <div class="keypad-row">
                <button class="keypad-btn" data-value="0">0</button>
                <button class="keypad-btn" data-value="1">1</button>
                <button class="keypad-btn" data-value="2">2</button>
                <button class="keypad-btn" data-value="3">3</button>
                <button class="keypad-btn" data-value="4">4</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn" data-value="5">5</button>
                <button class="keypad-btn" data-value="6">6</button>
                <button class="keypad-btn" data-value="7">7</button>
                <button class="keypad-btn" data-value="8">8</button>
                <button class="keypad-btn" data-value="9">9</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn" id="keypadSign">+/-</button>
                <button class="keypad-btn" id="keypadBackspace">‚Üê</button>
                <button class="keypad-btn" id="keypadExit">ÈÄÄÂá∫</button>
                <button class="keypad-btn" data-value=".">.</button>
                <button class="keypad-btn" id="keypadClear">Ê∏ÖÈô§</button>
            </div>
            <div class="keypad-row">
                <button class="keypad-btn keypad-confirm" id="keypadConfirm">Á°ÆËÆ§</button>
            </div>
        </div>
    </div>
</div>

<!-- Ê∑ªÂä†ËÆæÂ§áË°®Âçï -->
<div id="deviceFormModal" class="modal">
    <div class="modal-content device-form-content">
        <div class="modal-header">
            <h2 id="deviceFormTitle">üì° Ê∑ªÂä†Êñ∞ËÆæÂ§á</h2>
            <span class="close" onclick="closeAddDeviceModal()">&times;</span>
        </div>
        <div class="device-form-body">
            <div class="device-form-group">
                <label for="deviceIdInput">ËÆæÂ§áid *</label>
                <input type="text" id="deviceIdInput" placeholder="ËØ∑ËæìÂÖ•ËÆæÂ§áIDÔºå‰æãÂ¶ÇÔºöDEVICE001„ÄÅU680-05">
            </div>
            <div class="device-form-group">
                <label for="categoryInput">ÂìÅÁ±ª</label>
                <input type="text" id="categoryInput" placeholder="ËØ∑ËæìÂÖ•ÊµãËØïÊ†∑ÂìÅÂìÅÁ±ªÔºå‰æãÂ¶ÇÔºöÊâãÊú∫„ÄÅÁîµËÑë">
            </div>
            <div class="device-form-group">
                <label for="modelInput">ÂûãÂè∑</label>
                <input type="text" id="modelInput" placeholder="ËØ∑ËæìÂÖ•ÊµãËØïÊ†∑ÂìÅÂûãÂè∑Ôºå‰æãÂ¶ÇÔºöiPhone 15„ÄÅThinkPad X1">
            </div>
            <div class="device-form-group">
                <label for="testerInput">ÊµãËØï‰∫∫Âëò</label>
                <input type="text" id="testerInput" placeholder="ËØ∑ËæìÂÖ•ÊµãËØï‰∫∫ÂëòÂßìÂêç">
            </div>
            <div style="padding: 12px 14px; background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 10px; border: 1px solid #93c5fd; font-size: 13px; color: #1e40af; line-height: 1.6;">
                <div style="font-weight: 600; margin-bottom: 6px;">üí° Êìç‰ΩúËØ¥ÊòéÔºö</div>
                <div>1. ËæìÂÖ•ËÆæÂ§áIDÂêéÁÇπÂáª"Ê∑ªÂä†ËÆæÂ§á"ÔºåÁ≥ªÁªüÂ∞ÜÂú®Êï∞ÊçÆÂ∫ì‰∏≠ÂàõÂª∫ÂàùÂßãËÆ∞ÂΩï</div>
                <div>2. ËÆæÂ§áÂêØÂä®Âêé‰ºöËá™Âä®ÈÄöËøáÊé•Âè£‰∏äÊä•Êï∞ÊçÆÂπ∂Êõ¥Êñ∞Áä∂ÊÄÅ</div>
                <div>3. Ê∑ªÂä†ÊàêÂäüÂêéËÆæÂ§áÂ∞ÜÂá∫Áé∞Âú®ÁõëÊéßÂàóË°®‰∏≠</div>
                <div>4. ÂìÅÁ±ª„ÄÅÂûãÂè∑„ÄÅÊµãËØï‰∫∫Âëò‰ø°ÊÅØÁî®‰∫éÊ†áËØÜÊµãËØïÊ†∑ÂìÅÔºåÊñπ‰æøÈÉ®Èó®‰∫∫ÂëòÁÆ°ÁêÜ</div>
            </div>
        </div>
        <div class="device-form-actions">
            <button class="device-form-btn cancel" type="button" onclick="closeAddDeviceModal()">ÂèñÊ∂à</button>
            <button class="device-form-btn submit" type="button" onclick="submitAddDevice()">Ê∑ªÂä†ËÆæÂ§á</button>
        </div>
    </div>
</div>

<!-- Ê†∑ÂìÅÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü -->
<div id="editDeviceInfoModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 id="editDeviceInfoTitle">üìù ÁÆ°ÁêÜÊ†∑ÂìÅ‰ø°ÊÅØ</h2>
            <span class="close" onclick="closeEditDeviceInfoModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="device-form-group">
                <label>ËÆæÂ§áID</label>
                <input type="text" id="editDeviceInfoId" readonly style="background: #f1f5f9; cursor: not-allowed;">
            </div>
            
            <!-- Ê†∑ÂìÅÂàóË°® -->
            <div class="device-form-group">
                <label>Ê†∑ÂìÅÂàóË°®</label>
                <div id="samplesListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px; background: #f8fafc;">
                    <!-- Ê†∑ÂìÅÂàóË°®Â∞ÜÂä®ÊÄÅÊèíÂÖ•ËøôÈáå -->
                </div>
            </div>
            
            <!-- Ê∑ªÂä†Êñ∞Ê†∑ÂìÅË°®Âçï -->
            <div style="border-top: 2px dashed #e2e8f0; padding-top: 20px; margin-top: 20px;">
                <div style="font-weight: 600; margin-bottom: 12px; color: #1e293b;">‚ûï Ê∑ªÂä†Êñ∞Ê†∑ÂìÅ</div>
                <div class="device-form-group">
                    <label for="editCategoryInput">ÂìÅÁ±ª</label>
                    <input type="text" id="editCategoryInput" placeholder="ËØ∑ËæìÂÖ•ÊµãËØïÊ†∑ÂìÅÂìÅÁ±ªÔºå‰æãÂ¶ÇÔºöÊâãÊú∫„ÄÅÁîµËÑë">
                </div>
                <div class="device-form-group">
                    <label for="editModelInput">ÂûãÂè∑</label>
                    <input type="text" id="editModelInput" placeholder="ËØ∑ËæìÂÖ•ÊµãËØïÊ†∑ÂìÅÂûãÂè∑Ôºå‰æãÂ¶ÇÔºöiPhone 15„ÄÅThinkPad X1">
                </div>
                <div class="device-form-group">
                    <label for="editTesterInput">ÊµãËØï‰∫∫Âëò</label>
                    <input type="text" id="editTesterInput" placeholder="ËØ∑ËæìÂÖ•ÊµãËØï‰∫∫ÂëòÂßìÂêç">
                </div>
            </div>
            
            <div style="padding: 12px 14px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 10px; border: 1px solid #fbbf24; font-size: 13px; color: #92400e; line-height: 1.6; margin-top: 16px;">
                <div style="font-weight: 600; margin-bottom: 6px;">üí° ÊèêÁ§∫Ôºö</div>
                <div>‰∏ÄÂè∞ËÆæÂ§áÂèØ‰ª•Ê∑ªÂä†Â§ö‰∏™ÊµãËØïÊ†∑ÂìÅÔºåÊØè‰∏™Ê†∑ÂìÅÂèØ‰ª•Êúâ‰∏çÂêåÁöÑÂìÅÁ±ª„ÄÅÂûãÂè∑ÂíåÊµãËØï‰∫∫Âëò</div>
            </div>
        </div>
        <div class="device-form-actions">
            <button class="device-form-btn cancel" type="button" onclick="closeEditDeviceInfoModal()">ÂÖ≥Èó≠</button>
            <button class="device-form-btn submit" type="button" onclick="submitAddSample()">Ê∑ªÂä†Ê†∑ÂìÅ</button>
        </div>
    </div>
</div>

<!-- ÈÄöÁî®ÊèêÁ§∫Ê®°ÊÄÅÊ°Ü -->
<div id="alertModal" class="modal">
    <div class="modal-content alert-modal-content">
        <div class="alert-modal-header">
            <h3 id="alertModalTitle">ÊèêÁ§∫</h3>
            <span class="close" onclick="closeAlertModal()">&times;</span>
        </div>
        <div class="alert-modal-body">
            <div class="alert-modal-icon" id="alertModalIcon">‚ÑπÔ∏è</div>
            <div class="alert-modal-message" id="alertModalMessage">ËøôÊòØ‰∏ÄÊù°ÊèêÁ§∫‰ø°ÊÅØ</div>
        </div>
        <div class="alert-modal-footer">
            <button class="alert-modal-btn" onclick="closeAlertModal()">Á°ÆÂÆö</button>
        </div>
    </div>
</div>

<!-- Ê†∑ÂìÅ‰ø°ÊÅØËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü -->
<div id="sampleInfoModal" class="modal">
    <div class="modal-content alert-modal-content" style="max-width: 500px;">
        <div class="alert-modal-header">
            <h3>üì¶ Ê†∑ÂìÅ‰ø°ÊÅØËØ¶ÊÉÖ</h3>
            <span class="close" onclick="closeSampleInfoModal()">&times;</span>
        </div>
        <div class="alert-modal-body" style="text-align: left; align-items: flex-start;">
            <div style="width: 100%;">
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-radius: 8px; border: 1px solid #bae6fd;">
                    <div style="font-weight: 600; color: #0369a1; margin-bottom: 8px; font-size: 14px;">ÊµãËØï‰∫∫Âëò</div>
                    <div style="font-size: 16px; color: #0c4a6e; font-weight: 600;" id="sampleInfoTester">--</div>
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border-radius: 8px; border: 1px solid #fcd34d;">
                    <div style="font-weight: 600; color: #92400e; margin-bottom: 8px; font-size: 14px;">ÂûãÂè∑</div>
                    <div style="font-size: 16px; color: #78350f; font-weight: 600;" id="sampleInfoModel">--</div>
                </div>
                <div style="margin-bottom: 16px; padding: 12px; background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%); border-radius: 8px; border: 1px solid #c4b5fd;">
                    <div style="font-weight: 600; color: #6b21a8; margin-bottom: 8px; font-size: 14px;">ÂìÅÁ±ª</div>
                    <div style="font-size: 16px; color: #581c87; font-weight: 600;" id="sampleInfoCategory">--</div>
                </div>
            </div>
        </div>
        <div class="alert-modal-footer">
            <button class="alert-modal-btn" onclick="closeSampleInfoModal()">ÂÖ≥Èó≠</button>
        </div>
    </div>
</div>

<!-- ÂèëÈÄÅÂëΩ‰ª§Ê®°ÊÄÅÊ°Ü -->
<div id="commandModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>ÂèëÈÄÅËÆæÂ§áÊâßË°åÂëΩ‰ª§</h2>
            <span class="close" onclick="closeCommandModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="jsonInput">JSON Êï∞ÊçÆ</label>
                <textarea id="jsonInput" class="json-input" rows="28" placeholder='ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆÔºå‰æãÂ¶ÇÔºö&#10;{&#10;  "device_id": "DEVICE001",&#10;  "valueorprogram": "1",&#10;  "fixed_temp_set": "25.0",&#10;  "fixed_hum_set": "60.0",&#10;  "set_program_number": "001",&#10;  "set_run_status": "1",&#10;  "set_program_no": "001",&#10;  "create_by": "admin"&#10;}&#10;&#10;Â≠óÊÆµËØ¥ÊòéÔºö&#10;- valueorprogram: ÂÆöÂÄºÊàñÁ®ãÂºèËØïÈ™åÂà§Êñ≠Ôºà0=Á®ãÂºèËØïÈ™åÔºå1=ÂÆöÂÄºËØïÈ™åÔºâ&#10;- fixed_temp_set: ÂÆöÂÄºÊ∏©Â∫¶&#10;- fixed_hum_set: ÂÆöÂÄºÊπøÂ∫¶&#10;- set_program_number: ËÆæÂÆöËøêË°åÁ®ãÂºèÂè∑&#10;- set_run_status: ËøêË°åÁä∂ÊÄÅÔºà0=ÂÅúÊ≠¢Ôºå1=ËøêË°åÔºå2=ÊöÇÂÅúÔºâ&#10;- set_program_no: ËÆæÁΩÆÁ®ãÂºèÂè∑&#10;- create_by: ÂàõÂª∫ËÄÖ'></textarea>
            </div>
            <div class="form-actions">
                <button class="btn btn-primary" onclick="sendCommand()">ÂèëÈÄÅÊâßË°åÂëΩ‰ª§</button>
                <button class="btn btn-secondary" onclick="formatJson()">Ê†ºÂºèÂåñ</button>
                <button class="btn btn-secondary" onclick="clearJson()">Ê∏ÖÁ©∫</button>
            </div>
            <div id="resultMessage" class="result-message"></div>
        </div>
    </div>
</div>

<script src="/css/reliablityLab/app.js"></script>
<script>
// Êâ©Â±ïÊï∞ÂÄºËæìÂÖ•ÂØπËØùÊ°ÜÁöÑÁ°ÆËÆ§ÊåâÈíÆÔºåÊîØÊåÅÁ®ãÂºèÂè∑ËæìÂÖ•
document.addEventListener('DOMContentLoaded', function() {
    const keypadConfirm = document.getElementById('keypadConfirm');
    const valueInputModal = document.getElementById('valueInputModal');
    const valueInput = document.getElementById('valueInput');
    const keypadExit = document.getElementById('keypadExit');
    
    if (keypadConfirm && valueInputModal && valueInput) {
        // ‰∏∫Á°ÆËÆ§ÊåâÈíÆÊ∑ªÂä†È¢ùÂ§ñÁöÑÂ§ÑÁêÜÈÄªËæëÔºà‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµÔºå‰ºòÂÖàÊâßË°åÔºâ
        keypadConfirm.addEventListener('click', function(e) {
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÁ®ãÂºèÂè∑ËæìÂÖ•
            if (valueInputModal.dataset.inputType === 'programNumber') {
                // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶Âèë app.js ÁöÑ onclick ‰∫ã‰ª∂
                e.stopPropagation();
                e.preventDefault();
                
                const inputValue = valueInput.value.trim();
                if (inputValue !== '') {
                    const success = confirmProgramNumberInput(inputValue);
                    if (success) {
                        valueInputModal.style.display = 'none';
                        valueInputModal.dataset.inputType = '';
                    }
                } else {
                    showAlert('ËØ∑ËæìÂÖ•Á®ãÂºèÂè∑', 'ËæìÂÖ•ÈîôËØØ', 'warning');
                }
                return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
            }
            // Â¶ÇÊûú‰∏çÊòØÁ®ãÂºèÂè∑ËæìÂÖ•ÔºåËÆ© app.js ÁöÑ onclick Â§ÑÁêÜ
        }, true); // ‰ΩøÁî®ÊçïËé∑Èò∂ÊÆµ
    }
    
    if (keypadExit && valueInputModal) {
        // ÈÄÄÂá∫ÊåâÈíÆÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        keypadExit.addEventListener('click', function() {
            if (valueInputModal.dataset.inputType === 'programNumber') {
                valueInputModal.style.display = 'none';
                valueInputModal.dataset.inputType = '';
            }
        });
    }
    
    // Êã¶Êà™navigateToÂáΩÊï∞ÔºåÂú®ËøîÂõûÁõÆÂΩïÊó∂ÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπ
    if (typeof window.navigateTo === 'function') {
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = function(pageName) {
            // Â¶ÇÊûúÊòØËøîÂõûÁõÆÂΩïÔºåÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπÔºàÈúÄË¶ÅËé∑ÂèñÂΩìÂâçËÆæÂ§áIDÔºâ
            if (pageName === 'menu') {
                const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                       (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
                resetAllTemporaryModifications(currentDeviceId);
            }
            // Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞
            return originalNavigateTo.apply(this, arguments);
        };
    }
    
    // Êã¶Êà™backToMonitorÂáΩÊï∞ÔºåÂú®ËøîÂõûÁõëÊéßÈ¶ñÈ°µÊó∂ÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπ
    if (typeof window.backToMonitor === 'function') {
        const originalBackToMonitor = window.backToMonitor;
        window.backToMonitor = function() {
            const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                   (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
            resetAllTemporaryModifications(currentDeviceId);
            // Ë∞ÉÁî®ÂéüÂßãÂáΩÊï∞
            return originalBackToMonitor.apply(this, arguments);
        };
    }
});

// ËøîÂõû‰∏ªÈ°µÊåâÈíÆÂ§ÑÁêÜÂáΩÊï∞ÔºàÂÖ®Â±ÄÂáΩÊï∞ÔºåÂèØÁõ¥Êé•Ë¢´ onclick Ë∞ÉÁî®Ôºâ
function handleBackHome(event) {
    if (event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    console.log('üîÑ ËøîÂõû‰∏ªÈ°µÊåâÈíÆË¢´ÁÇπÂáª');
    
    try {
        // Ê∏ÖÁêÜÂÆöÊó∂Âô®
        if (typeof stopDeviceListAutoRefresh === 'function') {
            stopDeviceListAutoRefresh();
            console.log('‚úÖ Â∑≤ÂÅúÊ≠¢ËÆæÂ§áËá™Âä®Âà∑Êñ∞');
        }
        
        // Ê£ÄÊü•Êú¨Âú∞ÁºìÂ≠òÁöÑ username
        const username = localStorage.getItem('username');
        const job = localStorage.getItem('job');
        
        if (username) {
            console.log('‚úÖ Ê£ÄÊµãÂà∞Êú¨Âú∞Áî®Êà∑‰ø°ÊÅØ: ' + username + 'ÔºåÂÖàÊÅ¢Â§ç Session ÂÜçËøîÂõû‰∏ªÈ°µ');
            
            // ÂÖàË∞ÉÁî®ÂêéÁ´ØÊé•Âè£ÊÅ¢Â§ç SessionÔºåÂÜçË∑≥ËΩ¨
            fetch('/api/restoreSession', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    username: username,
                    job: job
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Session ÊÅ¢Â§çÁªìÊûú:', data);
                // ‰∏çÁÆ°ÊàêÂäüÂ§±Ë¥•ÔºåÈÉΩÁõ¥Êé•Ë∑≥ËΩ¨‰∏ªÈ°µ
                // ÊàêÂäüÔºöSession Â∑≤ÊÅ¢Â§çÔºåÂèØ‰ª•ËÆøÈóÆ‰∏ªÈ°µ
                // Â§±Ë¥•ÔºöËÆ©ÂêéÁ´ØËá™Â∑±Â§ÑÁêÜÔºàÂèØËÉΩ‰ºöÈáçÂÆöÂêëÂà∞ÁôªÂΩïÈ°µÔºå‰ΩÜ‰∏ç‰ºöÊó†ÈôêÂæ™ÁéØÔºâ
                window.location.href = '/';
            })
            .catch(error => {
                console.error('‚ùå Session ÊÅ¢Â§çËØ∑Ê±ÇÂ§±Ë¥•:', error);
                // Âç≥‰ΩøÂ§±Ë¥•‰πüË∑≥ËΩ¨ÔºåËÆ©ÂêéÁ´ØÂ§ÑÁêÜ
                window.location.href = '/';
            });
        } else {
            // Ê≤°Êúâ usernameÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ
            console.log('‚ö†Ô∏è Êú™ÊâæÂà∞Êú¨Âú∞Áî®Êà∑‰ø°ÊÅØÔºåË∑≥ËΩ¨Âà∞ÁôªÂΩïÈ°µ');
            window.location.href = '/index.html';
        }
        
    } catch (err) {
        console.error('ËøîÂõû‰∏ªÈ°µËøáÁ®ã‰∏≠Âá∫Èîô:', err);
        // Âá∫Èîô‰πüËøîÂõû‰∏ªÈ°µ
        window.location.href = '/';
    }
    
    return false; // ÈòªÊ≠¢ÈªòËÆ§Ë°å‰∏∫
}

// È°µÈù¢Âä†ËΩΩÊó∂ÔºåÂÖà‰ªélocalStorageËé∑ÂèñusernameÂíåjobÔºåÂ¶ÇÊûúÊ≤°ÊúâÂÜç‰ªéURLÂèÇÊï∞Ëé∑Âèñ
(function() {
    // ÂÖà‰ªélocalStorageËé∑Âèñ
    let username = localStorage.getItem('username') || '';
    let job = localStorage.getItem('job') || '';
    
    // Â¶ÇÊûúlocalStorage‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªéURLÂèÇÊï∞Ëé∑Âèñ
    if (!username || !job) {
        const urlParams = new URLSearchParams(window.location.search);
        const urlUsername = urlParams.get('username');
        const urlJob = urlParams.get('job');
        
        // Â¶ÇÊûúURL‰∏≠ÊúâÂÄºÔºå‰ΩøÁî®URLÁöÑÂÄºÂπ∂‰øùÂ≠òÂà∞localStorage
        if (urlUsername) {
            username = urlUsername;
            localStorage.setItem('username', username);
            console.log('‰ªéURLËé∑ÂèñÂπ∂‰øùÂ≠òusernameÂà∞Êú¨Âú∞ÁºìÂ≠ò:', username);
        }
        if (urlJob) {
            job = urlJob;
            localStorage.setItem('job', job);
            console.log('‰ªéURLËé∑ÂèñÂπ∂‰øùÂ≠òjobÂà∞Êú¨Âú∞ÁºìÂ≠ò:', job);
        }
    } else {
        console.log('‰ªéÊú¨Âú∞ÁºìÂ≠òËØªÂèñÁî®Êà∑‰ø°ÊÅØ:', { username: username, job: job });
    }
    
    // ÊòæÁ§∫Áî®Êà∑‰ø°ÊÅØÂà∞Âè≥‰∏äËßí
    const userInfoDiv = document.getElementById('userInfo');
    const usernameDiv = document.getElementById('userInfoUsername');
    const jobDiv = document.getElementById('userInfoJob');
    
    if (username || job) {
        if (userInfoDiv && usernameDiv && jobDiv) {
            usernameDiv.textContent = username || 'Êú™Áü•Áî®Êà∑';
            jobDiv.textContent = job ? 'ËßíËâ≤Ôºö' + job : '';
            userInfoDiv.style.display = 'flex';
        }
        console.log('Áî®Êà∑‰ø°ÊÅØÂ∑≤Âä†ËΩΩÂπ∂ÊòæÁ§∫:', { username: username, job: job });
    } else {
        console.warn('Êú™Ëé∑ÂèñÂà∞Áî®Êà∑‰ø°ÊÅØÔºàusernameÂíåjobÔºâÔºåÊüê‰∫õÂäüËÉΩÂèØËÉΩÂèóÈôê');
        // Â¶ÇÊûúÈúÄË¶ÅÔºåÂèØ‰ª•Âú®ËøôÈáåÊ∑ªÂä†ÊèêÁ§∫ÊàñË∑≥ËΩ¨ÈÄªËæë
        // alert('ËØ∑ÂÖàÁôªÂΩï');
        // window.location.href = '/';
    }
})();

// ËÆæÂ§áÊ®°ÂùóÊï∞ÊçÆ‰∏éÊ∏≤ÊüìÈÄªËæë
const DEVICE_STATUS_TEXT = {
    running: 'ËøêË°å‰∏≠',
    stopped: 'Â∑≤ÂÅúÊ≠¢',
    paused: 'Â∑≤ÊöÇÂÅú',
    warning: 'Ë≠¶Âëä'
};

let deviceList = [];
let activeDeviceId = null;
let autoFetchTimerId = null;
let deviceListRefreshTimerId = null; // ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®

// ÂÖÅËÆ∏Âà†Èô§ËÆæÂ§áÁöÑÁî®Êà∑ÂêçÂçï
const ALLOWED_DELETE_USERS = ['Âç¢ÂÅ•', 'Êà¥ÊùèÂçé', 'ÊùéËâØÂÅ•'];

// Ê£ÄÊü•ÂΩìÂâçÁî®Êà∑ÊòØÂê¶ÊúâÂà†Èô§ËÆæÂ§áÁöÑÊùÉÈôê
function hasDeletePermission() {
    const username = localStorage.getItem('username');
    return username && ALLOWED_DELETE_USERS.includes(username);
}

// Á®ãÂºèÂè∑‰∏¥Êó∂Â≠òÂÇ®ÔºàÁî®‰∫éÁ®ãÂºèËØïÈ™åÈ°µÈù¢ÁöÑ‰∏¥Êó∂‰øÆÊîπÔºâ
// ‰ΩøÁî®windowÂØπË±°Á°Æ‰øùÂÖ®Â±ÄÂèØËÆøÈóÆ
window.tempProgramNumber = null;
window.isProgramNumberModified = false;

// ÂÆöÂÄºËØïÈ™åËÆæÂÆöÂÄº‰∏¥Êó∂Â≠òÂÇ®ÔºàÁî®‰∫éÂÆöÂÄºËØïÈ™åÈ°µÈù¢ÁöÑ‰∏¥Êó∂‰øÆÊîπÔºâ
window.tempTargetTemp = null;
window.tempTargetHumidity = null;
window.isTargetTempModified = false;
window.isTargetHumidityModified = false;

// ÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏¥Êó∂Â≠òÂÇ®ÔºàÊåâËÆæÂ§áIDÂ≠òÂÇ®ÔºåÁî®‰∫éÂÆöÂÄºËÆæÁΩÆÈ°µÈù¢ÁöÑ‰∏¥Êó∂‰øÆÊîπÔºâ
// ÁªìÊûÑÔºö{ deviceId: { timerEnabled: 0/1, timerTime: 'H.M', isTimerEnabledModified: bool, isTimerTimeModified: bool } }
window.deviceTimerSettings = window.deviceTimerSettings || {};

// Ëé∑ÂèñÊåáÂÆöËÆæÂ§áÁöÑÂÆöÊó∂ËøêË°åÂèÇÊï∞
function getDeviceTimerSettings(deviceId) {
    if (!deviceId) return null;
    if (!window.deviceTimerSettings[deviceId]) {
        window.deviceTimerSettings[deviceId] = {
            timerEnabled: null,
            timerTime: null,
            isTimerEnabledModified: false,
            isTimerTimeModified: false
        };
    }
    return window.deviceTimerSettings[deviceId];
}

// ËÆæÁΩÆÊåáÂÆöËÆæÂ§áÁöÑÂÆöÊó∂ËøêË°åÂèÇÊï∞
function setDeviceTimerSettings(deviceId, settings) {
    if (!deviceId) return;
    if (!window.deviceTimerSettings[deviceId]) {
        window.deviceTimerSettings[deviceId] = {};
    }
    Object.assign(window.deviceTimerSettings[deviceId], settings);
}

function safeNumber(value, fractionDigits = 2) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const num = Number(value);
    if (Number.isNaN(num)) {
        return 0;
    }
    return typeof fractionDigits === 'number'
        ? Number(num.toFixed(fractionDigits))
        : num;
}

function toInt(value) {
    const num = parseInt(value, 10);
    return Number.isNaN(num) ? 0 : num;
}

function formatDuration(hours, minutes, seconds, fallback) {
    const hasValue = [hours, minutes, seconds].some(v => v !== null && v !== undefined && v !== '');
    if (!hasValue) {
        return fallback;
    }
    const h = Math.max(0, toInt(hours));
    const m = Math.max(0, toInt(minutes));
    const s = Math.max(0, toInt(seconds));
    return `${h}H ${String(m).padStart(2, '0')}M ${String(s).padStart(2, '0')}S`;
}

function formatRuntime(hours, minutes, seconds) {
    return formatDuration(hours, minutes, seconds, '0H 00M 00S');
}

function formatRemaining(hours, minutes, seconds) {
    return formatDuration(hours, minutes, seconds, '--');
}

function normalizeStatus(runStatus) {
    // Â§ÑÁêÜÁ©∫ÂÄº
    if (runStatus === null || runStatus === undefined || runStatus === '') {
        return 'stopped';
    }
    
    // ‰ºòÂÖàÂ§ÑÁêÜÊï∞Â≠óÊ†ºÂºèÔºö0=ÂÅúÊ≠¢, 1=ËøêË°å, 2=ÊöÇÂÅú
    const numValue = Number(runStatus);
    if (!isNaN(numValue)) {
        if (numValue === 0) return 'stopped';
        if (numValue === 1) return 'running';
        if (numValue === 2) return 'paused';
    }
    
    // ÂÖºÂÆπÊñáÊú¨Ê†ºÂºè
    const text = String(runStatus).toLowerCase();
    if (text.includes('Ë≠¶') || text.includes('warn') || text.includes('ÂºÇÂ∏∏') || text.includes('alarm')) {
        return 'warning';
    }
    if (text.includes('ÂÅú') || text.includes('stop') || text.includes('ÂæÖÊú∫') || text.includes('standby')) {
        return 'stopped';
    }
    if (text.includes('ÊöÇÂÅú') || text.includes('pause')) {
        return 'paused';
    }
    if (text.includes('ËøêË°å') || text.includes('run')) {
        return 'running';
    }
    
    // ÈªòËÆ§ËøîÂõûÂÅúÊ≠¢
    return 'stopped';
}

function formatRunMode(runMode) {
    if (runMode === null || runMode === undefined) return '--';
    const modeValue = String(runMode).trim();
    
    // ÊîØÊåÅÊï∞Â≠óÂíåÊñáÊú¨‰∏§ÁßçÊ†ºÂºè
    if (modeValue === '0' || modeValue === 'Á®ãÂºè' || modeValue === 'Á®ãÂºèÊ®°Âºè') return 'Á®ãÂºèÊ®°Âºè';
    if (modeValue === '1' || modeValue === 'ÂÆöÂÄº' || modeValue === 'ÂÆöÂÄºÊ®°Âºè') return 'ÂÆöÂÄºÊ®°Âºè';
    
    console.warn(`[formatRunMode] Êú™ËØÜÂà´ÁöÑËøêË°åÊ®°Âºè: ${modeValue}`);
    return modeValue; // Â¶ÇÊûú‰∏çÊòØÂ∑≤Áü•Ê†ºÂºèÔºåÊòæÁ§∫ÂéüÂßãÂÄº
}

// Ê†πÊçÆÂ≠óÊÆµÂÄºËÆæÁΩÆÈ¢úËâ≤ÂíåÊñáÊú¨
function formatConnectionStatus(serialStatus) {
    if (serialStatus === null || serialStatus === undefined || serialStatus === '') {
        return { connection: 'unknown', connectionText: 'Êú™Áü•', colorClass: 'status-unknown' };
    }

    const statusValue = String(serialStatus).trim();
    if (statusValue === 'Âú®Á∫ø') {
        return { connection: 'online', connectionText: 'Âú®Á∫ø', colorClass: 'status-online' };
    } else if (statusValue === 'Á¶ªÁ∫ø') {
        return { connection: 'offline', connectionText: 'Á¶ªÁ∫ø', colorClass: 'status-offline' };
    } else {
        return { connection: 'unknown', connectionText: statusValue, colorClass: 'status-unknown' };
    }
}

function formatModuleConnection(moduleConnection) {
    if (moduleConnection === null || moduleConnection === undefined || moduleConnection === '') {
        return { status: 'unknown', message: 'Ê∏©ÊπøÂ∫¶Ê®°ÂùóÁä∂ÊÄÅÊú™Áü•', colorClass: 'module-unknown' };
    }

    const statusValue = String(moduleConnection).trim();
    if (statusValue === 'ËøûÊé•Ê≠£Â∏∏') {
        return { status: 'normal', message: 'ËøûÊé•Ê≠£Â∏∏', colorClass: 'module-normal' };
    } else if (statusValue === 'ËøûÊé•ÂºÇÂ∏∏') {
        return { status: 'error', message: 'ËøûÊé•ÂºÇÂ∏∏', colorClass: 'module-error' };
    } else {
        return { status: 'unknown', message: statusValue, colorClass: 'module-unknown' };
    }
}

function formatPowerValue(value) {
    if (value === null || value === undefined || value === '') {
        return 0;
    }
    const numeric = Number(value);
    if (Number.isFinite(numeric)) {
        return Number(numeric.toFixed(0));
    }
    return String(value);
}

function formatLastUpdate(timestamp) {
    if (!timestamp) {
        return 'ÂàöÂàö';
    }
    if (timestamp instanceof Date) {
        return `${timestamp.getFullYear()}-${String(timestamp.getMonth() + 1).padStart(2, '0')}-${String(timestamp.getDate()).padStart(2, '0')} ${String(timestamp.getHours()).padStart(2, '0')}:${String(timestamp.getMinutes()).padStart(2, '0')}:${String(timestamp.getSeconds()).padStart(2, '0')}`;
    }
    if (typeof timestamp === 'string') {
        const sanitized = timestamp.replace('T', ' ').split('.')[0];
        return sanitized;
    }
    try {
        const date = new Date(timestamp);
        if (!Number.isNaN(date.getTime())) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}:${String(date.getSeconds()).padStart(2, '0')}`;
        }
    } catch (err) {
        // ignore
    }
    return 'ÂàöÂàö';
}

function transformDeviceRecord(record, index) {
    const deviceId = record.device_id || record.deviceId || `device-${Date.now()}-${index}`;
    const connectionStatus = formatConnectionStatus(record.serial_status || record.serialStatus);
    const moduleConnectionStatus = formatModuleConnection(record.module_connection || record.moduleConnection);

    return {
        id: deviceId,
        name: record.device_id || record.deviceId || 'Êú™ÂëΩÂêçËÆæÂ§á',
        status: normalizeStatus(record.run_status || record.runStatus),
        mode: formatRunMode(record.run_mode || record.runMode),
        temperature: safeNumber(record.temperature),
        humidity: safeNumber(record.humidity),
        runtime: formatRuntime(record.run_hours || record.runHours, record.run_minutes || record.runMinutes, record.run_seconds || record.runSeconds),
        remaining: formatRemaining(record.step_remaining_hours || record.stepRemainingHours, record.step_remaining_minutes || record.stepRemainingMinutes, record.step_remaining_seconds || record.stepRemainingSeconds),
        tempPower: formatPowerValue(record.power_temperature || record.powerTemperature),
        humidityPower: formatPowerValue(record.power_humidity || record.powerHumidity),
        connection: connectionStatus.connection,
        connectionText: connectionStatus.connectionText,
        connectionColorClass: connectionStatus.colorClass,
        moduleConnection: moduleConnectionStatus.status,
        moduleConnectionText: moduleConnectionStatus.message,
        moduleConnectionColorClass: moduleConnectionStatus.colorClass,
        lastUpdate: formatLastUpdate(record.updated_at || record.updatedAt || record.created_at || record.createdAt),
        programNumber: safeNumber(record.set_program_number || record.programNumber),
        totalSteps: safeNumber(record.total_steps || record.totalSteps),
        category: record.category || null,
        model: record.model || null,
        tester: record.tester || null,
        samples: record.samples || [],
        autoFetch: false,
        raw: record
    };
}

async function refreshDevicesFromServer() {
    const previousActiveId = activeDeviceId;
    const emptyState = document.getElementById('deviceEmptyState');
    if (emptyState) {
        emptyState.textContent = 'Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆ...';
        emptyState.style.display = 'block';
    }
    try {
        const response = await fetch('/iot/data/devices', { cache: 'no-store' });
        if (!response.ok) {
            throw new Error(`ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å ${response.status}`);
        }
        const payload = await response.json();
        if (!Array.isArray(payload)) {
            throw new Error('Êé•Âè£ËøîÂõûÊ†ºÂºèÂºÇÂ∏∏ÔºåÈ¢ÑÊúü‰∏∫Êï∞ÁªÑ');
        }
        const transformed = payload.map((item, index) => {
            return transformDeviceRecord(item, index);
        });
        if (!transformed.length) {
            deviceList = [];
            activeDeviceId = null;
            renderDevices();
            const emptyState = document.getElementById('deviceEmptyState');
            if (emptyState) {
                emptyState.innerHTML = 'ÂΩìÂâçÊ≤°ÊúâÁõëÊéß‰∏≠ÁöÑËÆæÂ§á<br><br>üí° ËØ∑ÁÇπÂáªÂ∑¶‰æß <strong>"Ê∑ªÂä†Êñ∞ËÆæÂ§á"</strong> ÊåâÈíÆÊ≥®ÂÜåËÆæÂ§áÂà∞ÁõëÊéßÁ≥ªÁªü';
            }
            return;
        }
        // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊó©ÂàõÂª∫ÁöÑÂú®ÊúÄÂâçÈù¢ÔºåÊñ∞ËÆæÂ§áÂú®ÊúÄÂêéÔºâ
        transformed.sort((a, b) => {
            const timeA = a.raw.created_at || a.raw.createdAt || '9999-12-31 23:59:59';
            const timeB = b.raw.created_at || b.raw.createdAt || '9999-12-31 23:59:59';
            // ÂçáÂ∫èÊéíÂ∫èÔºöÊó©ÁöÑÊó∂Èó¥Âú®ÂâçÔºåÊôöÁöÑÊó∂Èó¥Âú®Âêé
            if (timeA < timeB) return -1;
            if (timeA > timeB) return 1;
            return 0;
        });
        console.log('[ËÆæÂ§áÊéíÂ∫è] ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÂÆåÊàêÔºåËÆæÂ§áÈ°∫Â∫è:', transformed.map(d => {
            const createdAt = d.raw.created_at || d.raw.createdAt || 'Êó†ÂàõÂª∫Êó∂Èó¥';
            return `${d.id}(${createdAt})`;
        }));
        // Ê£ÄÊü•ÊòØÂê¶ÊúâËÆæÂ§áÁº∫Â∞ëcreated_at
        const missingCreatedAt = transformed.filter(d => !d.raw.created_at && !d.raw.createdAt);
        if (missingCreatedAt.length > 0) {
            console.warn('[ËÆæÂ§áÊéíÂ∫è] ‚ö†Ô∏è ‰ª•‰∏ãËÆæÂ§áÁº∫Â∞ëcreated_atÂ≠óÊÆµÔºåÂ∞ÜË¢´ÊéíÂú®ÊúÄÂêé:', missingCreatedAt.map(d => d.id));
        }
        deviceList = transformed;
        if (previousActiveId && deviceList.some(device => device.id === previousActiveId)) {
            activeDeviceId = previousActiveId;
        } else {
            activeDeviceId = deviceList[0].id;
        }
        renderDevices();
    } catch (error) {
        console.error('Âä†ËΩΩËÆæÂ§áÂàóË°®Â§±Ë¥•Ôºö', error);
        if (emptyState) {
            emptyState.innerHTML = '‚ùå ËÆæÂ§áÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•<br><br>üí° ËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØïÊàñÊ£ÄÊü•ÁΩëÁªúËøûÊé•';
            emptyState.style.display = 'block';
        }
    } finally {
        scheduleAutoFetch();
    }
}

// ËÆæÂ§áÂç°ÁâáÁºìÂ≠òÔºåÁî®‰∫éÂ¢ûÈáèÊõ¥Êñ∞
const deviceCardCache = new Map();

function renderDevices() {
    const grid = document.getElementById('deviceGrid');
    const emptyState = document.getElementById('deviceEmptyState');
    const template = document.getElementById('deviceCardTemplate');
    if (!grid || !emptyState || !template) {
        return;
    }

    if (!deviceList.length) {
        // Ê∏ÖÁ©∫ÁºìÂ≠ò
        deviceCardCache.clear();
        grid.innerHTML = '';
        emptyState.style.display = 'block';
        renderSidebar();
        activeDeviceId = null;
        updateActiveIndicators();
        return;
    }

    emptyState.style.display = 'none';

    // Ëé∑ÂèñÁé∞ÊúâÁöÑËÆæÂ§áÂç°ÁâáIDÈõÜÂêà
    const existingCardIds = new Set();
    const existingCards = grid.querySelectorAll('.device-card');
    existingCards.forEach(card => {
        const deviceId = card.dataset.deviceId;
        if (deviceId) {
            existingCardIds.add(deviceId);
        }
    });

    // Ëé∑ÂèñÈúÄË¶ÅÊ∏≤ÊüìÁöÑËÆæÂ§áIDÈõÜÂêà
    const neededDeviceIds = new Set(deviceList.map(d => d.id));

    // Âà†Èô§‰∏çÂÜçÂ≠òÂú®ÁöÑËÆæÂ§áÂç°Áâá
    existingCards.forEach(card => {
        const deviceId = card.dataset.deviceId;
        if (deviceId && !neededDeviceIds.has(deviceId)) {
            card.remove();
            deviceCardCache.delete(deviceId);
        }
    });

    // ÂàõÂª∫ÊàñÊõ¥Êñ∞ËÆæÂ§áÂç°Áâá
    deviceList.forEach((device, index) => {
        let card = grid.querySelector(`.device-card[data-device-id="${device.id}"]`);
        
        if (!card) {
            // ÂàõÂª∫Êñ∞Âç°Áâá
            const fragment = template.content.cloneNode(true);
            card = fragment.querySelector('.device-card');
            card.dataset.deviceId = device.id;
            
            // ÊèíÂÖ•Âà∞Ê≠£Á°Æ‰ΩçÁΩÆ
            const nextCard = Array.from(grid.children).find(child => {
                const nextDevice = deviceList.find(d => d.id === child.dataset.deviceId);
                return nextDevice && deviceList.indexOf(nextDevice) > index;
            });
            if (nextCard) {
                grid.insertBefore(card, nextCard);
            } else {
                grid.appendChild(card);
            }
            
            deviceCardCache.set(device.id, card);
        }
        
        // Êõ¥Êñ∞Âç°ÁâáÂÜÖÂÆπÔºàÂ¢ûÈáèÊõ¥Êñ∞Ôºâ
        updateDeviceCard(card, device);
    });

    if (!deviceList.some(device => device.id === activeDeviceId)) {
        activeDeviceId = deviceList[0]?.id || null;
    }

    renderSidebar();
    updateActiveIndicators();
}

// Êõ¥Êñ∞Âçï‰∏™ËÆæÂ§áÂç°ÁâáÔºàÂ¢ûÈáèÊõ¥Êñ∞ÔºåÈÅøÂÖçÈáçÊñ∞ÂàõÂª∫DOMÔºâ
function updateDeviceCard(card, device) {
    if (!card || !device) return;

    // Âè™Âú®È¶ñÊ¨°ÂàõÂª∫Êó∂ÁªëÂÆö‰∫ã‰ª∂ÔºåÈÅøÂÖçÈáçÂ§çÁªëÂÆö
    if (!card.dataset.eventsBound) {
        // ÁªëÂÆöÂà†Èô§ÊåâÈíÆ‰∫ã‰ª∂
        const deleteBtn = card.querySelector('.delete-device-btn');
        if (deleteBtn) {
            if (!hasDeletePermission()) {
                deleteBtn.style.display = 'none';
            } else {
                deleteBtn.addEventListener('click', event => {
                    event.stopPropagation();
                    removeDevice(device.id);
                });
            }
        }

        // ÁªëÂÆöÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂
        card.addEventListener('click', function(e) {
            if (e.target.closest('.delete-device-btn')) return; // ÁÇπÂáªÂà†Èô§ÊåâÈíÆÊó∂‰∏çËß¶Âèë
            if (e.target.closest('.edit-device-info-btn')) return; // ÁÇπÂáªÁºñËæëÊåâÈíÆÊó∂‰∏çËß¶Âèë
            e.stopPropagation();
            setActiveDevice(device.id);
            if (typeof window.enterDevice === 'function') {
                window.enterDevice(device.id);
            }
        });
        
        // ÁªëÂÆöÁºñËæëÊåâÈíÆ‰∫ã‰ª∂
        const editBtn = card.querySelector('.edit-device-info-btn');
        if (editBtn) {
            editBtn.dataset.deviceId = device.id;
            // ÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºàÂ¶ÇÊûúÂ≠òÂú®Ôºâ
            const newEditBtn = editBtn.cloneNode(true);
            editBtn.parentNode.replaceChild(newEditBtn, editBtn);
            // ÈáçÊñ∞ÁªëÂÆö‰∫ã‰ª∂
            const currentEditBtn = card.querySelector('.edit-device-info-btn');
            if (currentEditBtn) {
                currentEditBtn.dataset.deviceId = device.id;
                currentEditBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    openEditDeviceInfoModal(e);
                });
            }
        }
        
        card.dataset.eventsBound = 'true';
    }

    // Êõ¥Êñ∞ËÆæÂ§áID
    const idSpan = card.querySelector('[data-field="deviceId"]');
    if (idSpan && idSpan.textContent !== (device.name || device.id)) {
        idSpan.textContent = device.name || device.id;
    }

    // Êõ¥Êñ∞Áä∂ÊÄÅ
    const statusWrapper = card.querySelector('[data-field="statusWrapper"]');
    if (statusWrapper) {
        const newClassName = `device-status ${device.status || 'running'}`;
        if (statusWrapper.className !== newClassName) {
            statusWrapper.className = newClassName;
        }
    }
    const statusText = card.querySelector('[data-field="statusText"]');
    if (statusText) {
        const newStatusText = DEVICE_STATUS_TEXT[device.status] || 'ËøêË°å‰∏≠';
        if (statusText.textContent !== newStatusText) {
            statusText.textContent = newStatusText;
        }
    }

    // Êõ¥Êñ∞Ê∏©Â∫¶ÔºàÂè™Âú®ÂÄºÂèòÂåñÊó∂Êõ¥Êñ∞Ôºâ
    const tempField = card.querySelector('[data-field="temperature"]');
    if (tempField) {
        const tempValue = Number(device.temperature || 0).toFixed(2);
        const newTempHtml = `${tempValue}<span class="unit">‚ÑÉ</span>`;
        if (tempField.innerHTML !== newTempHtml) {
            tempField.innerHTML = newTempHtml;
        }
    }
    
    // Êõ¥Êñ∞ÊπøÂ∫¶ÔºàÂè™Âú®ÂÄºÂèòÂåñÊó∂Êõ¥Êñ∞Ôºâ
    const humidityField = card.querySelector('[data-field="humidity"]');
    if (humidityField) {
        const humidityValue = Number(device.humidity || 0).toFixed(2);
        const newHumidityHtml = `${humidityValue}<span class="unit">%</span>`;
        if (humidityField.innerHTML !== newHumidityHtml) {
            humidityField.innerHTML = newHumidityHtml;
        }
    }

    // Êõ¥Êñ∞ËøêË°åÊó∂Èó¥
    const runtimeField = card.querySelector('[data-field="runtime"]');
    if (runtimeField && runtimeField.textContent !== device.runtime) {
        runtimeField.textContent = device.runtime || '0H 00M 00S';
    }
    
    // Êõ¥Êñ∞Ââ©‰ΩôÊó∂Èó¥
    const remainingField = card.querySelector('[data-field="remaining"]');
    if (remainingField && remainingField.textContent !== device.remaining) {
        remainingField.textContent = device.remaining || '--';
    }
    
    // Êõ¥Êñ∞Ê®°Âºè
    const modeField = card.querySelector('[data-field="mode"]');
    if (modeField && modeField.textContent !== device.mode) {
        modeField.textContent = device.mode || 'ÂÆöÂÄºËØïÈ™å';
    }

    // Êõ¥Êñ∞Ê∏©Â∫¶ÂäüÁéá
    const tempPowerField = card.querySelector('[data-field="tempPower"]');
    if (tempPowerField) {
        const newTempPower = `${device.tempPower ?? 0}%`;
        if (tempPowerField.textContent !== newTempPower) {
            tempPowerField.textContent = newTempPower;
        }
    }
    
    // Êõ¥Êñ∞ÊπøÂ∫¶ÂäüÁéá
    const humidityPowerField = card.querySelector('[data-field="humidityPower"]');
    if (humidityPowerField) {
        const newHumidityPower = `${device.humidityPower ?? 0}%`;
        if (humidityPowerField.textContent !== newHumidityPower) {
            humidityPowerField.textContent = newHumidityPower;
        }
    }

    // Êõ¥Êñ∞ËøûÊé•Áä∂ÊÄÅ
    const connectionWrapper = card.querySelector('[data-field="connectionWrapper"]');
    if (connectionWrapper) {
        const newConnectionClass = `connection-status ${device.moduleConnection || 'unknown'} ${device.moduleConnectionColorClass || ''}`;
        if (connectionWrapper.className !== newConnectionClass) {
            connectionWrapper.className = newConnectionClass;
        }
    }
    const connectionText = card.querySelector('[data-field="connectionText"]');
    if (connectionText && connectionText.textContent !== device.moduleConnectionText) {
        connectionText.textContent = device.moduleConnectionText || 'Áä∂ÊÄÅÊú™Áü•';
    }
    
    // Êõ¥Êñ∞ÊúÄÂêéÊõ¥Êñ∞Êó∂Èó¥
    const lastUpdate = card.querySelector('[data-field="lastUpdate"]');
    if (lastUpdate) {
        const newLastUpdate = `Êõ¥Êñ∞: ${device.lastUpdate || 'ÂàöÂàö'}`;
        if (lastUpdate.textContent !== newLastUpdate) {
            lastUpdate.textContent = newLastUpdate;
        }
    }
    
    // Êõ¥Êñ∞Ê†∑ÂìÅÊ†áÁ≠æÊòæÁ§∫
    const samplesContainer = card.querySelector('[data-field="samplesContainer"]');
    if (samplesContainer) {
        const samples = device.samples || [];
        samplesContainer.innerHTML = '';
        
        if (samples.length === 0) {
            // Â¶ÇÊûúÊ≤°ÊúâÊ†∑ÂìÅÔºåÊòæÁ§∫ÊèêÁ§∫
            const emptyTag = document.createElement('span');
            emptyTag.className = 'sample-tag';
            emptyTag.style.opacity = '0.6';
            emptyTag.style.cursor = 'default';
            emptyTag.textContent = 'ÊöÇÊó†Ê†∑ÂìÅ';
            samplesContainer.appendChild(emptyTag);
        } else {
            // ÊòæÁ§∫ÊâÄÊúâÊ†∑ÂìÅÊ†áÁ≠æÔºåÊ®™ÂêëÊéíÂàó
            samples.forEach((sample, index) => {
                const tag = document.createElement('span');
                tag.className = 'sample-tag';
                
                // ÊòæÁ§∫È°∫Â∫èÔºöÊµãËØï‰∫∫Âëò -> ÂûãÂè∑ -> ÂìÅÁ±ª
                const tester = sample.tester || '';
                const model = sample.model || '';
                const category = sample.category || '';
                
                let displayText = '';
                if (tester) {
                    displayText = tester;
                    if (model) {
                        displayText += `-${model}`;
                    }
                    if (category) {
                        displayText += `-${category}`;
                    }
                } else if (model) {
                    displayText = model;
                    if (category) {
                        displayText += `-${category}`;
                    }
                } else if (category) {
                    displayText = category;
                } else {
                    displayText = 'Êú™ÂëΩÂêçÊ†∑ÂìÅ';
                }
                
                tag.innerHTML = `<span class="sample-tag-text">${displayText}</span>`;
                
                // Ê∑ªÂä†ÁÇπÂáª‰∫ã‰ª∂ÔºåÊòæÁ§∫Ê†∑ÂìÅËØ¶ÊÉÖ
                tag.addEventListener('click', function(e) {
                    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°ÔºåÈÅøÂÖçËß¶ÂèëÂç°ÁâáÁÇπÂáª
                    showSampleInfo(sample);
                });
                
                // Â≠òÂÇ®ÂÆåÊï¥ÁöÑÊ†∑ÂìÅÊï∞ÊçÆÂà∞Ê†áÁ≠æ‰∏äÔºåÊñπ‰æøÁÇπÂáªÊó∂‰ΩøÁî®
                tag.dataset.sampleData = JSON.stringify(sample);
                
                samplesContainer.appendChild(tag);
            });
        }
    }
    
    // Êõ¥Êñ∞ÁºñËæëÊåâÈíÆÁöÑËÆæÂ§áID
    const editBtn = card.querySelector('.edit-device-info-btn');
    if (editBtn) {
        editBtn.dataset.deviceId = device.id;
    }
}

function removeDevice(deviceId) {
    // Ê£ÄÊü•Áî®Êà∑ÊùÉÈôê
    if (!hasDeletePermission()) {
        const username = localStorage.getItem('username') || 'ÂΩìÂâçÁî®Êà∑';
        showAlert(
            `Êä±Ê≠âÔºåÊÇ®Ôºà${username}ÔºâÊ≤°ÊúâÂà†Èô§ËÆæÂ§áÁöÑÊùÉÈôêÔºÅ\n\nÂ¶ÇÈúÄÂà†Èô§ËÆæÂ§áÔºåËØ∑ËÅîÁ≥ªÁ≥ªÁªüÁÆ°ÁêÜÂëò„ÄÇ`, 
            'ÊùÉÈôê‰∏çË∂≥', 
            'warning'
        );
        return;
    }
    
    const device = deviceList.find(d => d.id === deviceId);
    const deviceName = device ? (device.name || device.id) : deviceId;
    
    // ÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü
    if (!confirm(`Á°ÆÂÆöË¶ÅÂà†Èô§ËÆæÂ§á "${deviceName}" ÂêóÔºü\n\nÂà†Èô§ÂêéÂ∞Ü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§Ê≠§ËÆæÂ§áÔºå‰ΩÜÂéÜÂè≤Êï∞ÊçÆ‰ºö‰øùÁïô„ÄÇ\n\nÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄÔºÅ`)) {
        return;
    }
    
    // ÂèëÈÄÅÂà†Èô§ËØ∑Ê±Ç
    fetch('/iot/device/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(
                `ËÆæÂ§á "${deviceName}" Â∑≤ÊàêÂäü‰ªéÁõëÊéßÁ≥ªÁªü‰∏≠ÁßªÈô§ÔºÅ\n\n- Â∑≤‰ªéÊï∞ÊçÆÂ∫ìÂà†Èô§\n- Â∑≤Ê∏ÖÈô§RedisÁºìÂ≠ò\n\nÈ°µÈù¢Â∞ÜÂú®2ÁßíÂêéËá™Âä®Âà∑Êñ∞`, 
                'Âà†Èô§ÊàêÂäü', 
                'success'
            );
            
            // Âª∂Ëøü2ÁßíÂêéÂà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 2000);
        } else {
            showAlert(
                'Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ') + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
                'Âà†Èô§Â§±Ë¥•', 
                'error'
            );
        }
    })
    .catch(error => {
        console.error('Âà†Èô§ËÆæÂ§áÂ§±Ë¥•:', error);
        showAlert(
            'Âà†Èô§ËÆæÂ§áÂ§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
            'Âà†Èô§Â§±Ë¥•', 
            'error'
        );
    });
}

// ÊâìÂºÄÊ∑ªÂä†ËÆæÂ§áÊ®°ÊÄÅÊ°Ü
function openAddDeviceModal() {
    const modal = document.getElementById('deviceFormModal');
    const deviceIdInput = document.getElementById('deviceIdInput');
    const categoryInput = document.getElementById('categoryInput');
    const modelInput = document.getElementById('modelInput');
    const testerInput = document.getElementById('testerInput');
    
    if (!modal || !deviceIdInput) return;
    
    // Ê∏ÖÁ©∫ÊâÄÊúâËæìÂÖ•Ê°Ü
    deviceIdInput.value = '';
    if (categoryInput) categoryInput.value = '';
    if (modelInput) modelInput.value = '';
    if (testerInput) testerInput.value = '';
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    
    // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
    setTimeout(() => deviceIdInput.focus(), 100);
}

// ÂÖ≥Èó≠Ê∑ªÂä†ËÆæÂ§áÊ®°ÊÄÅÊ°Ü
function closeAddDeviceModal() {
    const modal = document.getElementById('deviceFormModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ÂΩìÂâçÊ≠£Âú®ÁÆ°ÁêÜÁöÑËÆæÂ§áID
let currentManagingDeviceId = null;

// ÊâìÂºÄÁºñËæëËÆæÂ§á‰ø°ÊÅØÊ®°ÊÄÅÊ°ÜÔºàÊ†∑ÂìÅÁÆ°ÁêÜÔºâ
function openEditDeviceInfoModal(event) {
    event.stopPropagation();
    
    const modal = document.getElementById('editDeviceInfoModal');
    const deviceIdInput = document.getElementById('editDeviceInfoId');
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    const samplesListContainer = document.getElementById('samplesListContainer');
    
    if (!modal || !deviceIdInput) return;
    
    // Ëé∑ÂèñËÆæÂ§áIDÔºà‰ªéÊåâÈíÆÁöÑdataÂ±ûÊÄßÊàñ‰∫ã‰ª∂ÁõÆÊ†áËé∑ÂèñÔºâ
    let deviceId = null;
    if (event && event.currentTarget) {
        deviceId = event.currentTarget.dataset.deviceId;
    } else if (event && event.target) {
        const btn = event.target.closest('.edit-device-info-btn');
        if (btn) {
            deviceId = btn.dataset.deviceId;
        }
    }
    
    if (!deviceId) {
        showAlert('Êó†Ê≥ïËé∑ÂèñËÆæÂ§áID', 'ÈîôËØØ', 'error');
        return;
    }
    
    currentManagingDeviceId = deviceId;
    
    // Â°´ÂÖÖËÆæÂ§áID
    deviceIdInput.value = deviceId;
    
    // Ê∏ÖÁ©∫Ê∑ªÂä†Ë°®Âçï
    if (categoryInput) categoryInput.value = '';
    if (modelInput) modelInput.value = '';
    if (testerInput) testerInput.value = '';
    
    // Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
    loadSamplesList(deviceId, samplesListContainer);
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    
    // ËÅöÁÑ¶Á¨¨‰∏Ä‰∏™ËæìÂÖ•Ê°Ü
    setTimeout(() => {
        if (categoryInput) categoryInput.focus();
    }, 100);
}

// Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
function loadSamplesList(deviceId, container) {
    if (!container) return;
    
    container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">Âä†ËΩΩ‰∏≠...</div>';
    
    fetch(`/iot/device/samples?device_id=${encodeURIComponent(deviceId)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.samples) {
                renderSamplesList(data.samples, container);
            } else {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">ÊöÇÊó†Ê†∑ÂìÅ</div>';
            }
        })
        .catch(error => {
            console.error('Âä†ËΩΩÊ†∑ÂìÅÂàóË°®Â§±Ë¥•:', error);
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Âä†ËΩΩÂ§±Ë¥•</div>';
        });
}

// Ê∏≤ÊüìÊ†∑ÂìÅÂàóË°®
function renderSamplesList(samples, container) {
    if (!samples || samples.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #64748b;">ÊöÇÊó†Ê†∑ÂìÅÔºåËØ∑Âú®‰∏ãÊñπÊ∑ªÂä†</div>';
        return;
    }
    
    container.innerHTML = '';
    
    samples.forEach((sample, index) => {
        const sampleItem = document.createElement('div');
        sampleItem.className = 'sample-list-item';
        sampleItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px;';
        
        const sampleInfo = document.createElement('div');
        sampleInfo.style.cssText = 'flex: 1;';
        sampleInfo.innerHTML = `
            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">
                ${sample.category || '--'} - ${sample.model || '--'}
            </div>
            <div style="font-size: 12px; color: #64748b;">
                ÊµãËØï‰∫∫Âëò: ${sample.tester || '--'}
            </div>
        `;
        
        const sampleActions = document.createElement('div');
        sampleActions.style.cssText = 'display: flex; gap: 8px;';
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'ÁºñËæë';
        editBtn.className = 'sample-action-btn';
        editBtn.style.cssText = 'padding: 6px 12px; border-radius: 6px; border: 1px solid #6366f1; background: rgba(99, 102, 241, 0.1); color: #6366f1; cursor: pointer; font-size: 12px;';
        editBtn.onclick = () => editSample(sample);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'Âà†Èô§';
        deleteBtn.className = 'sample-action-btn';
        deleteBtn.style.cssText = 'padding: 6px 12px; border-radius: 6px; border: 1px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #ef4444; cursor: pointer; font-size: 12px;';
        deleteBtn.onclick = () => deleteSample(sample.id, currentManagingDeviceId);
        
        sampleActions.appendChild(editBtn);
        sampleActions.appendChild(deleteBtn);
        
        sampleItem.appendChild(sampleInfo);
        sampleItem.appendChild(sampleActions);
        container.appendChild(sampleItem);
    });
}

// ÁºñËæëÊ†∑ÂìÅ
function editSample(sample) {
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    
    if (categoryInput) categoryInput.value = sample.category || '';
    if (modelInput) modelInput.value = sample.model || '';
    if (testerInput) testerInput.value = sample.tester || '';
    
    // ‰øùÂ≠òÂΩìÂâçÁºñËæëÁöÑÊ†∑ÂìÅID
    window.currentEditingSampleId = sample.id;
    
    // ÊªöÂä®Âà∞Ê∑ªÂä†Ë°®Âçï
    const addForm = document.querySelector('#editDeviceInfoModal .device-form-body > div[style*="border-top"]');
    if (addForm) {
        addForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    if (submitBtn) {
        submitBtn.textContent = 'Êõ¥Êñ∞Ê†∑ÂìÅ';
        submitBtn.onclick = submitUpdateSample;
    }
}

// Âà†Èô§Ê†∑ÂìÅ
function deleteSample(sampleId, deviceId) {
    if (!confirm('Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™Ê†∑ÂìÅÂêóÔºü')) {
        return;
    }
    
    fetch('/iot/device/sample/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id: sampleId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Ê†∑ÂìÅÂà†Èô§ÊàêÂäüÔºÅ', 'Âà†Èô§ÊàêÂäü', 'success');
            // ÈáçÊñ∞Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
            const samplesListContainer = document.getElementById('samplesListContainer');
            if (samplesListContainer && deviceId) {
                loadSamplesList(deviceId, samplesListContainer);
            }
            // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert('Âà†Èô§Â§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Âà†Èô§Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Âà†Èô§Ê†∑ÂìÅÂ§±Ë¥•:', error);
        showAlert('Âà†Èô§Â§±Ë¥•Ôºö' + error.message, 'Âà†Èô§Â§±Ë¥•', 'error');
    });
}

// ÂÖ≥Èó≠ÁºñËæëËÆæÂ§á‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
function closeEditDeviceInfoModal() {
    const modal = document.getElementById('editDeviceInfoModal');
    if (modal) {
        modal.style.display = 'none';
    }
    
    // Ê∏ÖÁ©∫ÁºñËæëÁä∂ÊÄÅ
    window.currentEditingSampleId = null;
    currentManagingDeviceId = null;
    
    // ÊÅ¢Â§çÊåâÈíÆÊñáÊú¨
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    if (submitBtn) {
        submitBtn.textContent = 'Ê∑ªÂä†Ê†∑ÂìÅ';
        submitBtn.onclick = submitAddSample;
    }
    
    // Ê∏ÖÁ©∫Ë°®Âçï
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    if (categoryInput) categoryInput.value = '';
    if (modelInput) modelInput.value = '';
    if (testerInput) testerInput.value = '';
}

// Ê∑ªÂä†Ê†∑ÂìÅ
function submitAddSample() {
    const deviceIdInput = document.getElementById('editDeviceInfoId');
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    
    if (!deviceIdInput || !submitBtn) return;
    
    const deviceId = deviceIdInput.value.trim();
    if (!deviceId) {
        showAlert('ËÆæÂ§áID‰∏çËÉΩ‰∏∫Á©∫ÔºÅ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        return;
    }
    
    const category = categoryInput ? categoryInput.value.trim() : '';
    const model = modelInput ? modelInput.value.trim() : '';
    const tester = testerInput ? testerInput.value.trim() : '';
    
    // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ê∑ªÂä†‰∏≠...';
    
    // ÂèëÈÄÅÊ∑ªÂä†Ê†∑ÂìÅËØ∑Ê±Ç
    fetch('/iot/device/sample/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            category: category || null,
            model: model || null,
            tester: tester || null
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('Ê†∑ÂìÅÊ∑ªÂä†ÊàêÂäüÔºÅ', 'Ê∑ªÂä†ÊàêÂäü', 'success');
            
            // Ê∏ÖÁ©∫Ë°®Âçï
            if (categoryInput) categoryInput.value = '';
            if (modelInput) modelInput.value = '';
            if (testerInput) testerInput.value = '';
            
            // ÈáçÊñ∞Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
            const samplesListContainer = document.getElementById('samplesListContainer');
            if (samplesListContainer && deviceId) {
                loadSamplesList(deviceId, samplesListContainer);
            }
            
            // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert('Ê∑ªÂä†Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Ê∑ªÂä†Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Ê∑ªÂä†Ê†∑ÂìÅÂ§±Ë¥•:', error);
        showAlert('Ê∑ªÂä†Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + error.message, 'Ê∑ªÂä†Â§±Ë¥•', 'error');
    })
    .finally(() => {
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ê∑ªÂä†Ê†∑ÂìÅ';
    });
}

// Êõ¥Êñ∞Ê†∑ÂìÅ
function submitUpdateSample() {
    const deviceIdInput = document.getElementById('editDeviceInfoId');
    const categoryInput = document.getElementById('editCategoryInput');
    const modelInput = document.getElementById('editModelInput');
    const testerInput = document.getElementById('editTesterInput');
    const submitBtn = document.querySelector('#editDeviceInfoModal .device-form-btn.submit');
    
    if (!deviceIdInput || !submitBtn) return;
    
    const sampleId = window.currentEditingSampleId;
    if (!sampleId) {
        showAlert('ËØ∑ÂÖàÈÄâÊã©Ë¶ÅÁºñËæëÁöÑÊ†∑ÂìÅ', 'ÈîôËØØ', 'warning');
        return;
    }
    
    const category = categoryInput ? categoryInput.value.trim() : '';
    const model = modelInput ? modelInput.value.trim() : '';
    const tester = testerInput ? testerInput.value.trim() : '';
    
    // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    submitBtn.disabled = true;
    submitBtn.textContent = 'Êõ¥Êñ∞‰∏≠...';
    
    // ÂèëÈÄÅÊõ¥Êñ∞Ê†∑ÂìÅËØ∑Ê±Ç
    fetch('/iot/device/sample/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            id: sampleId,
            category: category || null,
            model: model || null,
            tester: tester || null
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert('Ê†∑ÂìÅÊõ¥Êñ∞ÊàêÂäüÔºÅ', 'Êõ¥Êñ∞ÊàêÂäü', 'success');
            
            // Ê∏ÖÁ©∫Ë°®ÂçïÂíåÁºñËæëÁä∂ÊÄÅ
            if (categoryInput) categoryInput.value = '';
            if (modelInput) modelInput.value = '';
            if (testerInput) testerInput.value = '';
            window.currentEditingSampleId = null;
            
            // ÊÅ¢Â§çÊåâÈíÆÊñáÊú¨
            submitBtn.textContent = 'Ê∑ªÂä†Ê†∑ÂìÅ';
            submitBtn.onclick = submitAddSample;
            
            // ÈáçÊñ∞Âä†ËΩΩÊ†∑ÂìÅÂàóË°®
            const samplesListContainer = document.getElementById('samplesListContainer');
            const deviceId = deviceIdInput.value.trim();
            if (samplesListContainer && deviceId) {
                loadSamplesList(deviceId, samplesListContainer);
            }
            
            // Âà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 1000);
        } else {
            showAlert('Êõ¥Êñ∞Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
        }
    })
    .catch(error => {
        console.error('Êõ¥Êñ∞Ê†∑ÂìÅÂ§±Ë¥•:', error);
        showAlert('Êõ¥Êñ∞Ê†∑ÂìÅÂ§±Ë¥•Ôºö' + error.message, 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
    })
    .finally(() => {
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
        submitBtn.disabled = false;
    });
}

// Êèê‰∫§Ê∑ªÂä†ËÆæÂ§á
function submitAddDevice() {
    const deviceIdInput = document.getElementById('deviceIdInput');
    const submitBtn = document.querySelector('.device-form-btn.submit');
    
    if (!deviceIdInput || !submitBtn) return;
    
    const deviceId = deviceIdInput.value.trim();
    
    // È™åËØÅËÆæÂ§áID
    if (!deviceId) {
        showAlert('ËØ∑ËæìÂÖ•ËÆæÂ§áÁºñÂè∑ÔºÅ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        deviceIdInput.focus();
        return;
    }
    
    // È™åËØÅËÆæÂ§áIDÊ†ºÂºèÔºàÂèØÈÄâÔºöÂè™ÂÖÅËÆ∏Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏≠ÂàíÁ∫ø„ÄÅ‰∏ãÂàíÁ∫øÔºâ
    const deviceIdPattern = /^[a-zA-Z0-9\-_\u4e00-\u9fa5]+$/;
    if (!deviceIdPattern.test(deviceId)) {
        showAlert('ËÆæÂ§áÁºñÂè∑Ê†ºÂºè‰∏çÊ≠£Á°ÆÔºÅ\nÂè™ËÉΩÂåÖÂê´Â≠óÊØç„ÄÅÊï∞Â≠ó„ÄÅ‰∏≠ÂàíÁ∫ø„ÄÅ‰∏ãÂàíÁ∫øÂíå‰∏≠Êñá', 'Ê†ºÂºèÈîôËØØ', 'warning');
        deviceIdInput.focus();
        return;
    }
    
    // Ê£ÄÊü•ÊòØÂê¶Â∑≤Â≠òÂú®
    if (deviceList.some(device => device.id === deviceId)) {
        showAlert(`ËÆæÂ§á "${deviceId}" Â∑≤Â≠òÂú®‰∫éÁõëÊéßÂàóË°®‰∏≠ÔºÅ\nËØ∑Ê£ÄÊü•ËÆæÂ§áÂàóË°®Êàñ‰ΩøÁî®ÂÖ∂‰ªñËÆæÂ§áID`, 'ËÆæÂ§áÂ∑≤Â≠òÂú®', 'warning');
        return;
    }
    
    // Á¶ÅÁî®Êèê‰∫§ÊåâÈíÆÔºåÈò≤Ê≠¢ÈáçÂ§çÊèê‰∫§
    submitBtn.disabled = true;
    submitBtn.textContent = 'Ê∑ªÂä†‰∏≠...';
    
    // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑ÂêçÔºàÁî®‰∫éËÆ∞ÂΩïÂàõÂª∫ËÄÖÔºâ
    const username = localStorage.getItem('username') || 'Á≥ªÁªüÁÆ°ÁêÜÂëò';
    
    // Ëé∑ÂèñËÆæÂ§á‰ø°ÊÅØ
    const categoryInput = document.getElementById('categoryInput');
    const modelInput = document.getElementById('modelInput');
    const testerInput = document.getElementById('testerInput');
    
    const category = categoryInput ? categoryInput.value.trim() : '';
    const model = modelInput ? modelInput.value.trim() : '';
    const tester = testerInput ? testerInput.value.trim() : '';
    
    // ÂèëÈÄÅÊ∑ªÂä†ËÆæÂ§áËØ∑Ê±Ç
    fetch('/iot/device/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            device_id: deviceId,
            category: category || null,
            model: model || null,
            tester: tester || null,
            create_by: username
        })
    })
    .then(async response => {
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showAlert(
                `ËÆæÂ§á "${deviceId}" Ê∑ªÂä†ÊàêÂäüÔºÅ\n\nËÆæÂ§áÂ∞ÜÂá∫Áé∞Âú®ÁõëÊéßÂàóË°®‰∏≠\nËØ∑ÂêØÂä®ËÆæÂ§áÔºåÁ≥ªÁªüÂ∞ÜËá™Âä®Êé•Êî∂Âπ∂ÊòæÁ§∫ËÆæÂ§áÊï∞ÊçÆ`, 
                'Ê∑ªÂä†ÊàêÂäü', 
                'success'
            );
            
            // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
            closeAddDeviceModal();
            
            // Âª∂Ëøü2ÁßíÂêéÂà∑Êñ∞ËÆæÂ§áÂàóË°®
            setTimeout(() => {
                refreshDevicesFromServer();
            }, 2000);
        } else {
            showAlert(
                'Ê∑ªÂä†ËÆæÂ§áÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ') + '\n\nËØ∑Ê£ÄÊü•ËÆæÂ§áIDÊòØÂê¶Ê≠£Á°ÆÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
                'Ê∑ªÂä†Â§±Ë¥•', 
                'error'
            );
        }
    })
    .catch(error => {
        console.error('Ê∑ªÂä†ËÆæÂ§áÂ§±Ë¥•:', error);
        showAlert(
            'Ê∑ªÂä†ËÆæÂ§áÂ§±Ë¥•Ôºö' + error.message + '\n\nËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÊàñËÅîÁ≥ªÁÆ°ÁêÜÂëò', 
            'Ê∑ªÂä†Â§±Ë¥•', 
            'error'
        );
    })
    .finally(() => {
        // ÊÅ¢Â§çÊèê‰∫§ÊåâÈíÆÁä∂ÊÄÅ
        submitBtn.disabled = false;
        submitBtn.textContent = 'Ê∑ªÂä†ËÆæÂ§á';
    });
}

function scheduleAutoFetch() {
    if (autoFetchTimerId) {
        clearInterval(autoFetchTimerId);
        autoFetchTimerId = null;
    }

    const autoDevices = deviceList.filter(device => device.autoFetch);
    if (!autoDevices.length) {
        return;
    }

    const runFetch = () => {
        autoDevices.forEach(device => fetchTemperature(device.id));
    };

    runFetch();
    autoFetchTimerId = setInterval(runFetch, 5000);
}

function initializeDeviceModule() {
    deviceList = [];
    activeDeviceId = null;
    const emptyState = document.getElementById('deviceEmptyState');
    if (emptyState) {
        emptyState.innerHTML = 'üîÑ Ê≠£Âú®Âä†ËΩΩËÆæÂ§áÊï∞ÊçÆ...';
    }
    renderDevices();
    refreshDevicesFromServer();
    
    // ÂêØÂä®ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÔºàÊØè5ÁßíÔºâ
    window.startDeviceListAutoRefresh();
}

// ÂêØÂä®ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÔºàÊö¥Èú≤Âà∞windowÂØπË±°Ôºâ
window.startDeviceListAutoRefresh = function() {
    // Ê∏ÖÈô§Â∑≤ÊúâÁöÑÂÆöÊó∂Âô®
    if (deviceListRefreshTimerId) {
        clearInterval(deviceListRefreshTimerId);
        deviceListRefreshTimerId = null;
    }
    
    // Âà∑Êñ∞Âæ™ÁéØÂáΩÊï∞
    const refreshLoop = () => {
        // Âè™Âú®ËÆæÂ§áÁõëÊéßÈ¶ñÈ°µ‰∏îÈ°µÈù¢ÂèØËßÅÊó∂Âà∑Êñ∞
        const deviceMonitorPage = document.getElementById('deviceMonitorPage');
        if (deviceMonitorPage && deviceMonitorPage.classList.contains('active') && !document.hidden) {
            refreshDevicesFromServerQuietly();
        }
    };
    
    // ÊØè5ÁßíÂà∑Êñ∞‰∏ÄÊ¨°ËÆæÂ§áÂàóË°®Ôºà‰ªéRedisÁºìÂ≠òËé∑ÂèñÔºâ
    deviceListRefreshTimerId = setInterval(refreshLoop, 5000);
};

// Èò≤ÊäñÊ†áÂøóÔºåÈÅøÂÖçÂπ∂ÂèëËØ∑Ê±Ç
let isRefreshing = false;

// ÈùôÈªòÂà∑Êñ∞ËÆæÂ§áÂàóË°®Ôºà‰∏çÊòæÁ§∫Âä†ËΩΩÊèêÁ§∫Ôºâ
async function refreshDevicesFromServerQuietly() {
    // Â¶ÇÊûúÊ≠£Âú®Âà∑Êñ∞ÔºåË∑≥ËøáÊú¨Ê¨°Âà∑Êñ∞
    if (isRefreshing) {
        return;
    }
    
    isRefreshing = true;
    const previousActiveId = activeDeviceId;
    
    try {
        const response = await fetch('/iot/data/devices', { cache: 'no-store' });
        if (!response.ok) {
            return;
        }
        const payload = await response.json();
        if (!Array.isArray(payload)) {
            return;
        }
        
        const transformed = payload.map((item, index) => {
            return transformDeviceRecord(item, index);
        });
        
        // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊó©ÂàõÂª∫ÁöÑÂú®ÊúÄÂâçÈù¢ÔºåÊñ∞ËÆæÂ§áÂú®ÊúÄÂêéÔºâ
        transformed.sort((a, b) => {
            const timeA = a.raw.created_at || a.raw.createdAt || '9999-12-31 23:59:59';
            const timeB = b.raw.created_at || b.raw.createdAt || '9999-12-31 23:59:59';
            if (timeA < timeB) return -1;
            if (timeA > timeB) return 1;
            return 0;
        });
        
        // Ê£ÄÊü•Êï∞ÊçÆÊòØÂê¶ÊúâÂèòÂåñÔºàÂè™Âú®ÊúâÂèòÂåñÊó∂ÊâçÊõ¥Êñ∞Ôºâ
        if (hasDeviceListChanged(deviceList, transformed)) {
            deviceList = transformed;
            
            // ‰øùÊåÅÂΩìÂâçÈÄâ‰∏≠ÁöÑËÆæÂ§á
            if (previousActiveId && deviceList.some(device => device.id === previousActiveId)) {
                activeDeviceId = previousActiveId;
            } else if (deviceList.length > 0) {
                activeDeviceId = deviceList[0].id;
            } else {
                activeDeviceId = null;
            }
            
            // ‰ΩøÁî® requestAnimationFrame ‰ºòÂåñÊ∏≤ÊüìÊÄßËÉΩ
            if (window.requestAnimationFrame) {
                requestAnimationFrame(() => {
                    renderDevices();
                });
            } else {
                renderDevices();
            }
        }
    } catch (error) {
        // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çËæìÂá∫Êó•Âøó
    } finally {
        isRefreshing = false;
    }
}

// Ê£ÄÊü•ËÆæÂ§áÂàóË°®ÊòØÂê¶ÊúâÂèòÂåñÔºà‰ºòÂåñÁâàÊú¨Ôºå‰ΩøÁî®MapÊèêÈ´òÊü•ÊâæÊïàÁéáÔºâ
function hasDeviceListChanged(oldList, newList) {
    if (!oldList || !newList) return true;
    if (oldList.length !== newList.length) {
        return true;
    }
    
    // ‰ΩøÁî®MapÊèêÈ´òÊü•ÊâæÊïàÁéá
    const newDeviceMap = new Map();
    newList.forEach(device => {
        newDeviceMap.set(device.id, device);
    });
    
    // ÊØîËæÉÊØè‰∏™ËÆæÂ§áÁöÑÂÖ≥ÈîÆÂ≠óÊÆµ
    for (let i = 0; i < oldList.length; i++) {
        const oldDevice = oldList[i];
        const newDevice = newDeviceMap.get(oldDevice.id);
        
        if (!newDevice) {
            return true; // ËÆæÂ§á‰∏çÂ≠òÂú®
        }
        
        // Âè™Ê£ÄÊü•ÂÖ≥ÈîÆÂ≠óÊÆµÔºå‰ΩøÁî®‰∏•Ê†ºÁõ∏Á≠âÊØîËæÉ
        if (oldDevice.temperature !== newDevice.temperature ||
            oldDevice.humidity !== newDevice.humidity ||
            oldDevice.status !== newDevice.status ||
            oldDevice.mode !== newDevice.mode ||
            oldDevice.runtime !== newDevice.runtime ||
            oldDevice.remaining !== newDevice.remaining ||
            oldDevice.tempPower !== newDevice.tempPower ||
            oldDevice.humidityPower !== newDevice.humidityPower ||
            oldDevice.moduleConnection !== newDevice.moduleConnection) {
            return true;
        }
    }
    
    return false;
}

// ÂÅúÊ≠¢ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞
function stopDeviceListAutoRefresh() {
    if (deviceListRefreshTimerId) {
        clearInterval(deviceListRefreshTimerId);
        deviceListRefreshTimerId = null;
        console.log('[Ëá™Âä®Âà∑Êñ∞] ËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞Â∑≤ÂÅúÊ≠¢');
    }
}

function renderSidebar() {
    const list = document.getElementById('deviceSidebarList');
    if (!list) return;

    list.innerHTML = '';

    if (!deviceList.length) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'sidebar-empty';
        emptyDiv.textContent = 'ÊöÇÊó†ËÆæÂ§áÔºåËØ∑ÁÇπÂáª‰∏äÊñπÊ∑ªÂä†';
        list.appendChild(emptyDiv);
        return;
    }

    deviceList.forEach(device => {
        const item = document.createElement('div');
        item.className = 'sidebar-item';
        item.dataset.deviceId = device.id;
        item.innerHTML = `
            <span>${device.name || device.id}</span>
            <span class="sidebar-item-mode">${device.mode || 'ÂÆöÂÄºËØïÈ™å'}</span>
        `;
        item.addEventListener('click', () => {
            setActiveDevice(device.id);
            scrollToDeviceCard(device.id);
            // Ë∞ÉÁî®ËøõÂÖ•ËÆæÂ§áÁöÑÂáΩÊï∞ÔºåÂíåÂè≥‰æßËÆæÂ§áÂç°ÁâáÁÇπÂáªË°å‰∏∫‰∏ÄËá¥
            if (typeof window.enterDevice === 'function') {
                window.enterDevice(device.id);
            }
        });
        list.appendChild(item);
    });
}

function setActiveDevice(deviceId) {
    activeDeviceId = deviceId;
    updateActiveIndicators();
}

function updateActiveIndicators() {
    const sidebarItems = document.querySelectorAll('.sidebar-item');
    sidebarItems.forEach(item => {
        if (item.dataset.deviceId === activeDeviceId) {
            item.classList.add('active');
        } else {
            item.classList.remove('active');
        }
    });

    const cards = document.querySelectorAll('.device-card');
    cards.forEach(card => {
        if (card.dataset.deviceId === activeDeviceId) {
            card.classList.add('active');
        } else {
            card.classList.remove('active');
        }
    });
}

function scrollToDeviceCard(deviceId) {
    const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
    if (card) {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
}

// Âä®ÊÄÅËé∑ÂèñÊåáÂÆöËÆæÂ§áÁöÑÊúÄÊñ∞Êï∞ÊçÆ
function fetchTemperature(deviceId) {
    fetch(`/iot/data/latest?device_id=${encodeURIComponent(deviceId)}`, { cache: 'no-store' })
        .then(res => {
            if (!res.ok) {
                throw new Error(`ËØ∑Ê±ÇÂ§±Ë¥•ÔºåÁä∂ÊÄÅÁ†Å ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            if (!data || Object.keys(data).length === 0) {
                return;
            }
            const card = document.querySelector(`.device-card[data-device-id="${deviceId}"]`);
            if (!card) {
                return;
            }

            const deviceRef = deviceList.find(device => device.id === deviceId);

            if (data && data.temperature != null) {
                const value = Number(data.temperature).toFixed(2);
                const tempField = card.querySelector('[data-field="temperature"]');
                if (tempField) {
                    tempField.innerHTML = `${value}<span class="unit">‚ÑÉ</span>`;
                }
                if (deviceRef) {
                    deviceRef.temperature = Number(value);
                }
            }

            if (data && data.humidity != null) {
                const humidityValue = Number(data.humidity).toFixed(2);
                const humidityField = card.querySelector('[data-field="humidity"]');
                if (humidityField) {
                    humidityField.innerHTML = `${humidityValue}<span class="unit">%</span>`;
                }
                if (deviceRef) {
                    deviceRef.humidity = Number(humidityValue);
                }
            }

            if (data && data.run_mode != null) {
                const modeSpan = card.querySelector('[data-field="mode"]');
                if (modeSpan) {
                    modeSpan.textContent = formatRunMode(data.run_mode);
                }
                if (deviceRef) {
                    deviceRef.mode = formatRunMode(data.run_mode);
                }

                // Êõ¥Êñ∞ËèúÂçïÊåâÈíÆÁä∂ÊÄÅÂíåÁä∂ÊÄÅÊñáÊú¨
                updateMenuButtons();
                updateTestStatusText();

                // Êõ¥Êñ∞ËøêË°åÊåâÈíÆÁä∂ÊÄÅ
                const statusDisplay = getStatusDisplay(data.run_status);
                updateRunButtons(statusDisplay);

                // Êõ¥Êñ∞Ê∏©ÊπøÂ∫¶Ê®°ÂùóËøûÊé•Áä∂ÊÄÅ
                updateModuleConnectionStatus();
            }

            // Êõ¥Êñ∞ËÆæÂ§áÂç°Áâá‰∏äÁöÑ run_status Áä∂ÊÄÅÊòæÁ§∫
            if (data && data.run_status != null) {
                const normalizedStatus = normalizeStatus(data.run_status);
                const statusWrapper = card.querySelector('[data-field="statusWrapper"]');
                if (statusWrapper) {
                    statusWrapper.className = `device-status ${normalizedStatus}`;
                }
                const statusText = card.querySelector('[data-field="statusText"]');
                if (statusText) {
                    statusText.textContent = DEVICE_STATUS_TEXT[normalizedStatus] || 'ËøêË°å‰∏≠';
                }
                if (deviceRef) {
                    deviceRef.status = normalizedStatus;
                }
            }

            // ËøêË°åÊó∂Èó¥
            const hStr = data && data.run_hours != null ? String(data.run_hours) : '0';
            const mStr = data && data.run_minutes != null ? String(data.run_minutes) : '0';
            const sStr = data && data.run_seconds != null ? String(data.run_seconds) : '0';
            const runtimeFormatted = (() => {
                const hh = parseInt(hStr, 10) || 0;
                const mm = parseInt(mStr, 10) || 0;
                const ss = parseInt(sStr, 10) || 0;
                return `${hh}H ${String(mm).padStart(2,'0')}M ${String(ss).padStart(2,'0')}S`;
            })();
            const runtimeSpan = card.querySelector('[data-field="runtime"]');
            if (runtimeSpan) {
                runtimeSpan.textContent = runtimeFormatted;
            }
            if (deviceRef) {
                deviceRef.runtime = runtimeFormatted;
            }

            // Ââ©‰ΩôÊó∂Èó¥ÔºàÊú¨ÊÆµÔºâ
            const rhStr = data && data.step_remaining_hours != null ? String(data.step_remaining_hours) : '0';
            const rmStr = data && data.step_remaining_minutes != null ? String(data.step_remaining_minutes) : '0';
            const rsStr = data && data.step_remaining_seconds != null ? String(data.step_remaining_seconds) : '0';
            const remainingFormatted = (() => {
                const rh = parseInt(rhStr, 10) || 0;
                const rm = parseInt(rmStr, 10) || 0;
                const rs = parseInt(rsStr, 10) || 0;
                return `${rh}H ${String(rm).padStart(2,'0')}M ${String(rs).padStart(2,'0')}S`;
            })();
            const remainingSpan = card.querySelector('[data-field="remaining"]');
            if (remainingSpan) {
                remainingSpan.textContent = remainingFormatted;
            }
            if (deviceRef) {
                deviceRef.remaining = remainingFormatted;
            }

            // ÂäüÁéáÂÄº
            if (data && data.power_temperature != null) {
                const tpSpan = card.querySelector('[data-field="tempPower"]');
                if (tpSpan) {
                    tpSpan.textContent = `${data.power_temperature}%`;
                }
                if (deviceRef) {
                    deviceRef.tempPower = data.power_temperature;
                }
            }
            if (data && data.power_humidity != null) {
                const hpSpan = card.querySelector('[data-field="humidityPower"]');
                if (hpSpan) {
                    hpSpan.textContent = `${data.power_humidity}%`;
                }
                if (deviceRef) {
                    deviceRef.humidityPower = data.power_humidity;
                }
            }

            // ËøûÊé•Áä∂ÊÄÅÔºàÊ∏©ÊπøÂ∫¶Ê®°ÂùóËøûÊé•Áä∂ÊÄÅÔºâ
            if (data && data.module_connection != null) {
                const moduleConnectionStatus = formatModuleConnection(data.module_connection);
                const connectionWrapper = card.querySelector('[data-field="connectionWrapper"]');
                if (connectionWrapper) {
                    connectionWrapper.className = `connection-status ${moduleConnectionStatus.status} ${moduleConnectionStatus.colorClass || ''}`;
                }
                const connectionText = card.querySelector('[data-field="connectionText"]');
                if (connectionText) {
                    connectionText.textContent = moduleConnectionStatus.message;
                }
                if (deviceRef) {
                    deviceRef.moduleConnection = moduleConnectionStatus.status;
                    deviceRef.moduleConnectionText = moduleConnectionStatus.message;
                    deviceRef.moduleConnectionColorClass = moduleConnectionStatus.colorClass;
                }
            }

            const lastUpdateSpan = card.querySelector('[data-field="lastUpdate"]');
            if (lastUpdateSpan) {
                lastUpdateSpan.textContent = 'Êõ¥Êñ∞: ÂàöÂàö';
            }
            if (deviceRef) {
                deviceRef.lastUpdate = 'ÂàöÂàö';
            }
            if (data && (data.updated_at || data.created_at)) {
                const formatted = formatLastUpdate(data.updated_at || data.created_at);
                const span = card.querySelector('[data-field="lastUpdate"]');
                if (span) {
                    span.textContent = `Êõ¥Êñ∞: ${formatted}`;
                }
                if (deviceRef) {
                    deviceRef.lastUpdate = formatted;
                }
            }

            // Âà§Êñ≠ÊòØÂê¶ËøêË°å‰∏≠Ôºàrun_status‰∏∫ËøêË°åÁä∂ÊÄÅÔºâ
            const isRunning = data && (data.run_status === 'ËøêË°å' || data.run_status === '1' || data.run_status === 1 || 
                                      (typeof data.run_status === 'string' && data.run_status.includes('ËøêË°å')));
            
            // Êõ¥Êñ∞Á®ãÂºèËØïÈ™åÈ°µÈù¢ÁöÑÊ∏©Â∫¶Èù¢ÊùøÁ¨¨‰∏ÄË°åÔºöËøêË°åÊó∂ÊòæÁ§∫ËÆæÂÆöÊ∏©Â∫¶ÔºåÂÅúÊ≠¢Êó∂ÊòæÁ§∫Á®ãÂºèÂè∑
            const programTempLabel = document.getElementById('programTempLabel');
            const programNumberDisplay = document.getElementById('programNumberDisplay');
            
            if (isRunning) {
                // ËøêË°åÁä∂ÊÄÅÔºöÊòæÁ§∫ËÆæÂÆöÊ∏©Â∫¶
                if (programTempLabel) {
                    programTempLabel.textContent = 'ËÆæÂÆöÂÄº';
                }
                if (programNumberDisplay && data.set_temperature != null) {
                    programNumberDisplay.textContent = Number(data.set_temperature).toFixed(1);
                }
                // Ê∏ÖÈô§‰∏¥Êó∂‰øÆÊîπÊ†áËØÜÔºàÂõ†‰∏∫Â∑≤ËøõÂÖ•ËøêË°åÁä∂ÊÄÅÔºâ
                if (programNumberDisplay && window.isProgramNumberModified) {
                    programNumberDisplay.classList.remove('modified');
                    programNumberDisplay.style.color = '';
                    programNumberDisplay.style.fontWeight = '';
                }
            } else {
                // ÂÅúÊ≠¢Áä∂ÊÄÅÔºöÊòæÁ§∫Á®ãÂºèÂè∑
                if (programTempLabel) {
                    programTempLabel.textContent = 'Á®ãÂºèÂè∑';
                }
                if (programNumberDisplay) {
                    // ‰ºòÂÖàÊòæÁ§∫‰∏¥Êó∂‰øÆÊîπÁöÑÁ®ãÂºèÂè∑ÔºàÁõ¥Êé•ÊòæÁ§∫Êï¥Êï∞Ôºå‰∏çË°•Èõ∂Ôºâ
                    if (window.isProgramNumberModified && window.tempProgramNumber !== null) {
                        programNumberDisplay.textContent = String(window.tempProgramNumber);
                        programNumberDisplay.classList.add('modified');
                    } else if (data.set_program_number != null) {
                        programNumberDisplay.textContent = String(data.set_program_number);
                        programNumberDisplay.classList.remove('modified');
                        programNumberDisplay.style.color = '';
                        programNumberDisplay.style.fontWeight = '';
                    }
                }
            }
            
            // Êõ¥Êñ∞Á®ãÂºèÂè∑ÂèØÁÇπÂáªÁä∂ÊÄÅ
            updateProgramNumberClickableState(isRunning);
            
            // ‰øùÂ≠òÁ®ãÂºèÂè∑Âà∞ËÆæÂ§áÂºïÁî®
            if (data && data.set_program_number != null && deviceRef) {
                deviceRef.programNumber = data.set_program_number;
            }

            // Êõ¥Êñ∞Á®ãÂºèÂæ™ÁéØÊï∞ÊçÆ
            if (data && data.program_cycles != null) {
                if (deviceRef && deviceRef.raw) {
                    deviceRef.raw.program_cycles = data.program_cycles;
                }
            }
            if (data && data.program_total_cycles != null) {
                if (deviceRef && deviceRef.raw) {
                    deviceRef.raw.program_total_cycles = data.program_total_cycles;
                }
            }

            // Êõ¥Êñ∞Á®ãÂºèËØïÈ™åÈ°µÈù¢ÁöÑÊπøÂ∫¶Èù¢ÊùøÁ¨¨‰∏ÄË°åÔºöËøêË°åÊó∂ÊòæÁ§∫ËÆæÂÆöÊπøÂ∫¶ÔºåÂÅúÊ≠¢Êó∂ÊòæÁ§∫ÊÄªÊÆµÊï∞
            const programHumLabel = document.getElementById('programHumLabel');
            const totalSegmentsDisplay = document.getElementById('totalSegmentsDisplay');
            
            if (isRunning) {
                // ËøêË°åÁä∂ÊÄÅÔºöÊòæÁ§∫ËÆæÂÆöÊπøÂ∫¶
                if (programHumLabel) {
                    programHumLabel.textContent = 'ËÆæÂÆöÂÄº';
                }
                if (totalSegmentsDisplay && data.set_humidity != null) {
                    totalSegmentsDisplay.textContent = Number(data.set_humidity).toFixed(1);
                }
            } else {
                // ÂÅúÊ≠¢Áä∂ÊÄÅÔºöÊòæÁ§∫ÊÄªÊÆµÊï∞
                if (programHumLabel) {
                    programHumLabel.textContent = 'ÊÄªÊÆµÊï∞';
                }
                if (totalSegmentsDisplay && data.total_steps != null) {
                    totalSegmentsDisplay.textContent = String(data.total_steps).padStart(2, '0');
                }
            }
            
            // ‰øùÂ≠òÊÄªÊÆµÊï∞Âà∞ËÆæÂ§áÂºïÁî®
            if (data && data.total_steps != null && deviceRef) {
                deviceRef.totalSteps = data.total_steps;
            }
            
            // ========================================
            // ÈáçË¶ÅÔºöÂ¶ÇÊûúÊòØÂΩìÂâçÊ¥ªÂä®ËÆæÂ§áÔºåÂêåÊ≠•Êõ¥Êñ∞ app.js ‰∏≠ÁöÑ currentDeviceLatestData
            // ========================================
            if (deviceId === activeDeviceId && typeof window.currentDeviceId !== 'undefined' && window.currentDeviceId === deviceId) {
                if (typeof window.currentDeviceLatestData !== 'undefined') {
                    window.currentDeviceLatestData = data;
                    console.log(`[ÁºìÂ≠òÂêåÊ≠•] ÂêåÊ≠•Êõ¥Êñ∞ app.js ÁöÑ currentDeviceLatestData, run_status: ${data.run_status}`);
                }
            }
        })
        .catch(err => {
            console.warn(`Ëé∑ÂèñËÆæÂ§á ${deviceId} ÊúÄÊñ∞Êï∞ÊçÆÂ§±Ë¥•:`, err);
        });
}
// Á®ãÂºèÂè∑ÁÇπÂáªËÆæÁΩÆÂäüËÉΩÔºàÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆöÔºâ
let programNumberHandlerInitialized = false;
function initProgramNumberClickHandler() {
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    if (!programNumberDisplay) return;
    
    // Â¶ÇÊûúÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåÂÖàÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
    if (programNumberHandlerInitialized) {
        const newDisplay = programNumberDisplay.cloneNode(true);
        programNumberDisplay.parentNode.replaceChild(newDisplay, programNumberDisplay);
    }
    
    // ÈáçÊñ∞Ëé∑ÂèñÂÖÉÁ¥†ÔºàÂèØËÉΩÊòØÊñ∞ÂÖãÈöÜÁöÑÔºâ
    const currentProgramNumberDisplay = document.getElementById('programNumberDisplay');
    if (!currentProgramNumberDisplay) return;
    
    // Ê∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®
    currentProgramNumberDisplay.addEventListener('click', function() {
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÁ®ãÂºèËØïÈ™åÈ°µÈù¢
        const programPage = document.getElementById('programPage');
        if (!programPage || !programPage.classList.contains('active')) {
            return;
        }
        
        // Ëé∑ÂèñÂΩìÂâçÊ¥ªÂä®ËÆæÂ§áÁöÑÊï∞ÊçÆ
        const activeDevice = deviceList.find(d => d.id === activeDeviceId);
        if (!activeDevice || !activeDevice.raw) {
            console.warn('Êú™ÊâæÂà∞Ê¥ªÂä®ËÆæÂ§áÊï∞ÊçÆ');
            return;
        }
        
        // Ê£ÄÊü•ÊòØÂê¶Â§Ñ‰∫éÂÅúÊ≠¢Áä∂ÊÄÅ
        const runStatus = activeDevice.raw.run_status;
        const isRunning = runStatus === 'ËøêË°å' || runStatus === '1' || runStatus === 1 || 
                         (typeof runStatus === 'string' && runStatus.includes('ËøêË°å'));
        
        if (isRunning) {
            showAlert('ËÆæÂ§áÊ≠£Âú®ËøêË°å‰∏≠ÔºåÊó†Ê≥ï‰øÆÊîπÁ®ãÂºèÂè∑ÔºÅËØ∑ÂÖàÂÅúÊ≠¢ËØïÈ™å„ÄÇ', 'Êó†Ê≥ï‰øÆÊîπ', 'warning');
            return;
        }
        
        // ÊâìÂºÄÊï∞ÂÄºËæìÂÖ•ÂØπËØùÊ°Ü
        openProgramNumberInput();
    });
    
    programNumberHandlerInitialized = true;
}

// Êõ¥Êñ∞Á®ãÂºèÂè∑ÊòæÁ§∫ÁöÑÂèØÁÇπÂáªÁä∂ÊÄÅ
function updateProgramNumberClickableState(isRunning) {
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    const programTempLabel = document.getElementById('programTempLabel');
    
    if (!programNumberDisplay || !programTempLabel) return;
    
    // Âè™ÊúâÂú®ÂÅúÊ≠¢Áä∂ÊÄÅ‰∏îÊòæÁ§∫Á®ãÂºèÂè∑Êó∂ÊâçÂèØÁÇπÂáª
    const isShowingProgramNumber = programTempLabel.textContent === 'Á®ãÂºèÂè∑';
    
    if (!isRunning && isShowingProgramNumber) {
        programNumberDisplay.classList.add('clickable');
    } else {
        programNumberDisplay.classList.remove('clickable');
    }
}

// ÊâìÂºÄÁ®ãÂºèÂè∑ËæìÂÖ•ÂØπËØùÊ°Ü
function openProgramNumberInput() {
    const modal = document.getElementById('valueInputModal');
    const label = document.getElementById('valueInputLabel');
    const range = document.getElementById('valueInputRange');
    const input = document.getElementById('valueInput');
    
    if (!modal || !label || !range || !input) return;
    
    // ËÆæÁΩÆÂØπËØùÊ°ÜÊ†áÈ¢òÂíåËåÉÂõ¥
    label.textContent = 'ËÆæÂÆöÁ®ãÂºèÂè∑';
    range.textContent = '[0 - 999]';
    
    // Ëé∑ÂèñÂΩìÂâçÁ®ãÂºèÂè∑
    const currentValue = window.tempProgramNumber !== null ? window.tempProgramNumber : 
                        (document.getElementById('programNumberDisplay').textContent || '0');
    input.value = parseInt(currentValue) || 0;
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
    modal.dataset.inputType = 'programNumber'; // Ê†áËÆ∞ËæìÂÖ•Á±ªÂûã
    
    // ËÅöÁÑ¶ËæìÂÖ•Ê°Ü
    setTimeout(() => input.focus(), 100);
}

// Á°ÆËÆ§Á®ãÂºèÂè∑ËæìÂÖ•
function confirmProgramNumberInput(value) {
    const numValue = parseInt(value);
    
    // È™åËØÅËåÉÂõ¥
    if (isNaN(numValue) || numValue < 0 || numValue > 999) {
        showAlert('Á®ãÂºèÂè∑ÂøÖÈ°ªÂú® 0 Âà∞ 999 ‰πãÈó¥ÔºÅ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
        return false;
    }
    
    // ‰øùÂ≠ò‰∏¥Êó∂Á®ãÂºèÂè∑
    window.tempProgramNumber = numValue;
    window.isProgramNumberModified = true;
    
    // Êõ¥Êñ∞ÊòæÁ§∫ÔºàÁõ¥Êé•ÊòæÁ§∫Êï¥Êï∞Ôºå‰∏çË°•Èõ∂Ôºâ
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    if (programNumberDisplay) {
        programNumberDisplay.textContent = String(numValue);
        programNumberDisplay.classList.add('modified');
    }
    
    console.log('Á®ãÂºèÂè∑Â∑≤‰∏¥Êó∂ËÆæÁΩÆ‰∏∫:', numValue);
    return true;
}

// ÈáçÁΩÆÁ®ãÂºèÂè∑‰∏¥Êó∂‰øÆÊîπ
function resetProgramNumberModification() {
    window.tempProgramNumber = null;
    window.isProgramNumberModified = false;
    
    // ÊÅ¢Â§çÊòæÁ§∫Ê†∑Âºè
    const programNumberDisplay = document.getElementById('programNumberDisplay');
    if (programNumberDisplay) {
        programNumberDisplay.classList.remove('modified');
        programNumberDisplay.style.color = '';
        programNumberDisplay.style.fontWeight = '';
    }
    
    console.log('Á®ãÂºèÂè∑‰∏¥Êó∂‰øÆÊîπÂ∑≤ÈáçÁΩÆ');
}

// ÈáçÁΩÆÂÆöÂÄºËØïÈ™åËÆæÂÆöÂÄº‰∏¥Êó∂‰øÆÊîπ
function resetConstantValueModification() {
    window.tempTargetTemp = null;
    window.tempTargetHumidity = null;
    window.isTargetTempModified = false;
    window.isTargetHumidityModified = false;
    
    // ÊÅ¢Â§çÊòæÁ§∫Ê†∑Âºè
    const targetTempDisplay = document.getElementById('targetTempDisplay');
    const targetHumidityDisplay = document.getElementById('targetHumidityDisplay');
    
    if (targetTempDisplay) {
        targetTempDisplay.classList.remove('modified');
        targetTempDisplay.style.color = '';
        targetTempDisplay.style.fontWeight = '';
    }
    
    if (targetHumidityDisplay) {
        targetHumidityDisplay.classList.remove('modified');
        targetHumidityDisplay.style.color = '';
        targetHumidityDisplay.style.fontWeight = '';
    }
    
    console.log('ÂÆöÂÄºËÆæÂÆöÂÄº‰∏¥Êó∂‰øÆÊîπÂ∑≤ÈáçÁΩÆ');
}

// ÈáçÁΩÆÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏¥Êó∂‰øÆÊîπÔºàÈíàÂØπÂΩìÂâçËÆæÂ§áÔºâ
function resetTimerModification(deviceId) {
    if (!deviceId) return;
    
    const settings = getDeviceTimerSettings(deviceId);
    if (settings) {
        settings.timerEnabled = null;
        settings.timerTime = null;
        settings.isTimerEnabledModified = false;
        settings.isTimerTimeModified = false;
    }
    
    // ÊÅ¢Â§çÊòæÁ§∫Ê†∑Âºè
    const runTimeInput = document.getElementById('runTimeInput');
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    
    if (runTimeInput) {
        runTimeInput.classList.remove('modified');
        runTimeInput.style.color = '';
        runTimeInput.style.fontWeight = '';
    }
    
    if (timerOff && timerOn) {
        timerOff.classList.remove('modified');
        timerOn.classList.remove('modified');
        // ÊÅ¢Â§çÈªòËÆ§Áä∂ÊÄÅÔºàÂÖ≥Èó≠Ôºâ
        timerOff.classList.add('active');
        timerOn.classList.remove('active');
    }
    
    console.log(`ÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏¥Êó∂‰øÆÊîπÂ∑≤ÈáçÁΩÆ: ${deviceId}`);
}

// ËøòÂéüÂÆöÊó∂ËøêË°åÂèÇÊï∞‰∏∫ÂàùÂßãÂÄºÔºà0Âíå0.00Ôºâ
function resetTimerSettingsToDefault() {
    // Ëé∑ÂèñÂΩìÂâçËÆæÂ§áIDÔºà‰ºòÂÖà‰ªéwindowÂØπË±°Ëé∑ÂèñÔºåÂ¶ÇÊûúÊ≤°ÊúâÂàô‰ªéÈ°µÈù¢ÂÖÉÁ¥†Ëé∑ÂèñÔºâ
    let currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : null;
    
    // Â¶ÇÊûúwindowÂØπË±°‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªéÈ°µÈù¢ÊòæÁ§∫ÁöÑËÆæÂ§áIDÂÖÉÁ¥†Ëé∑Âèñ
    if (!currentDeviceId) {
        const constantDeviceIdElement = document.getElementById('constantDeviceId');
        const programDeviceIdElement = document.getElementById('programDeviceId');
        
        if (constantDeviceIdElement && constantDeviceIdElement.textContent && constantDeviceIdElement.textContent !== '--') {
            currentDeviceId = constantDeviceIdElement.textContent.trim();
        } else if (programDeviceIdElement && programDeviceIdElement.textContent && programDeviceIdElement.textContent !== '--') {
            currentDeviceId = programDeviceIdElement.textContent.trim();
        }
    }
    
    // Â¶ÇÊûúËøòÊòØÊ≤°ÊúâÔºåÂ∞ùËØï‰ªéactiveDeviceIdËé∑Âèñ
    if (!currentDeviceId && typeof activeDeviceId !== 'undefined' && activeDeviceId) {
        currentDeviceId = activeDeviceId;
    }
    
    if (!currentDeviceId) {
        // ÈùôÈªòÂ§±Ë¥•Ôºå‰∏çÊòæÁ§∫ÊèêÁ§∫
        return;
    }
    
    // ÈáçÁΩÆËÆæÂ§áËÆæÁΩÆ
    const settings = getDeviceTimerSettings(currentDeviceId);
    if (settings) {
        settings.timerEnabled = 0; // ËÆæÁΩÆ‰∏∫ÂÖ≥Èó≠
        settings.timerTime = '0.00'; // ËÆæÁΩÆ‰∏∫0.00
        settings.isTimerEnabledModified = true; // Ê†áËÆ∞‰∏∫Â∑≤‰øÆÊîπÔºàËøôÊ†∑‰ºö‰øùÂ≠òÂà∞ÂëΩ‰ª§‰∏≠Ôºâ
        settings.isTimerTimeModified = true;
    }
    
    // Êõ¥Êñ∞È°µÈù¢ÊòæÁ§∫
    const runTimeInput = document.getElementById('runTimeInput');
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    
    if (runTimeInput) {
        runTimeInput.value = '0.00';
        runTimeInput.classList.remove('modified');
    }
    
    if (timerOff && timerOn) {
        timerOff.classList.add('active');
        timerOff.classList.remove('modified');
        timerOn.classList.remove('active', 'modified');
    }
    
    console.log(`ÂÆöÊó∂ËøêË°åÂèÇÊï∞Â∑≤ËøòÂéü‰∏∫ÂàùÂßãÂÄº: ${currentDeviceId}`);
}

// Âä†ËΩΩÊåáÂÆöËÆæÂ§áÁöÑÂÆöÊó∂ËøêË°åÂèÇÊï∞Âà∞È°µÈù¢ÔºàÊö¥Èú≤Âà∞windowÂØπË±°‰æõapp.jsË∞ÉÁî®Ôºâ
window.loadDeviceTimerSettings = function(deviceId) {
    if (!deviceId) return;
    
    const settings = getDeviceTimerSettings(deviceId);
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    const runTimeInput = document.getElementById('runTimeInput');
    
    // Âä†ËΩΩÂÆöÊó∂ËøêË°åÂºÄÂÖ≥
    if (timerOff && timerOn) {
        if (settings.isTimerEnabledModified && settings.timerEnabled !== null) {
            // ‰ΩøÁî®‰øùÂ≠òÁöÑÂÄº
            if (settings.timerEnabled === 0) {
                timerOff.classList.add('active', 'modified');
                timerOn.classList.remove('active', 'modified');
            } else {
                timerOn.classList.add('active', 'modified');
                timerOff.classList.remove('active', 'modified');
            }
        } else {
            // ‰ΩøÁî®ÈªòËÆ§ÂÄºÔºàÂÖ≥Èó≠Ôºâ
            timerOff.classList.add('active');
            timerOn.classList.remove('active');
            timerOff.classList.remove('modified');
            timerOn.classList.remove('modified');
        }
    }
    
    // Âä†ËΩΩÂÆöÊó∂ËøêË°åÊó∂Èó¥
    if (runTimeInput) {
        if (settings.isTimerTimeModified && settings.timerTime !== null) {
            runTimeInput.value = settings.timerTime;
            runTimeInput.classList.add('modified');
        } else {
            runTimeInput.value = '0.00';
            runTimeInput.classList.remove('modified');
        }
    }
    
    console.log(`Â∑≤Âä†ËΩΩËÆæÂ§áÂÆöÊó∂ËøêË°åÂèÇÊï∞: ${deviceId}`, settings);
};

// ÈáçÁΩÆÊâÄÊúâ‰∏¥Êó∂‰øÆÊîπÔºàÈúÄË¶Å‰º†ÂÖ•ÂΩìÂâçËÆæÂ§áIDÔºâ
function resetAllTemporaryModifications(deviceId) {
    resetProgramNumberModification();
    resetConstantValueModification();
    if (deviceId) {
        resetTimerModification(deviceId);
    }
}

// ÂàùÂßãÂåñÂÆöÊó∂ËøêË°åËÆæÁΩÆÔºàÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆöÔºâ
let timerSettingsInitialized = false;
function initTimerSettings() {
    // Â¶ÇÊûúÂ∑≤ÁªèÂàùÂßãÂåñËøáÔºåÂÖàÁßªÈô§ÊóßÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
    if (timerSettingsInitialized) {
        const timerOff = document.getElementById('timerOff');
        const timerOn = document.getElementById('timerOn');
        const runTimeInput = document.getElementById('runTimeInput');
        
        if (timerOff) {
            const newTimerOff = timerOff.cloneNode(true);
            timerOff.parentNode.replaceChild(newTimerOff, timerOff);
        }
        if (timerOn) {
            const newTimerOn = timerOn.cloneNode(true);
            timerOn.parentNode.replaceChild(newTimerOn, timerOn);
        }
        if (runTimeInput) {
            const newRunTimeInput = runTimeInput.cloneNode(true);
            runTimeInput.parentNode.replaceChild(newRunTimeInput, runTimeInput);
        }
    }
    
    const timerOff = document.getElementById('timerOff');
    const timerOn = document.getElementById('timerOn');
    const runTimeInput = document.getElementById('runTimeInput');
    
    // ÂÆöÊó∂ËøêË°åÂºÄÂÖ≥ÁÇπÂáªÂ§ÑÁêÜ
    if (timerOff && timerOn) {
        timerOff.addEventListener('click', function() {
            timerOff.classList.add('active', 'modified');
            timerOn.classList.remove('active', 'modified');
            // ‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπÂà∞ÂΩìÂâçËÆæÂ§á
            const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                   (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
            if (currentDeviceId) {
                setDeviceTimerSettings(currentDeviceId, {
                    timerEnabled: 0,
                    isTimerEnabledModified: true
                });
                console.log(`ÂÆöÊó∂ËøêË°åÂ∑≤ËÆæÁΩÆ‰∏∫ÔºöÂÖ≥Èó≠ (ËÆæÂ§á: ${currentDeviceId})`);
            }
        });
        
        timerOn.addEventListener('click', function() {
            timerOn.classList.add('active', 'modified');
            timerOff.classList.remove('active', 'modified');
            // ‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπÂà∞ÂΩìÂâçËÆæÂ§á
            const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                                   (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
            if (currentDeviceId) {
                setDeviceTimerSettings(currentDeviceId, {
                    timerEnabled: 1,
                    isTimerEnabledModified: true
                });
                console.log(`ÂÆöÊó∂ËøêË°åÂ∑≤ËÆæÁΩÆ‰∏∫ÔºöÊâìÂºÄ (ËÆæÂ§á: ${currentDeviceId})`);
            }
        });
    }
    
    // ÂÆöÊó∂ËøêË°åÊó∂Èó¥ËæìÂÖ•È™åËØÅ
    if (runTimeInput) {
        runTimeInput.addEventListener('input', function(e) {
            validateTimerTimeInput(e.target);
        });
        
        runTimeInput.addEventListener('blur', function(e) {
            validateAndFormatTimerTime(e.target);
        });
    }
    
    timerSettingsInitialized = true;
}

// È™åËØÅÂÆöÊó∂ËøêË°åÊó∂Èó¥ËæìÂÖ•ÔºàÂÆûÊó∂È™åËØÅÔºâ
function validateTimerTimeInput(input) {
    let value = input.value.trim();
    
    // Âè™ÂÖÅËÆ∏Êï∞Â≠óÂíåÂ∞èÊï∞ÁÇπ
    value = value.replace(/[^\d.]/g, '');
    
    // Á°Æ‰øùÂè™Êúâ‰∏Ä‰∏™Â∞èÊï∞ÁÇπ
    const parts = value.split('.');
    if (parts.length > 2) {
        value = parts[0] + '.' + parts.slice(1).join('');
    }
    
    input.value = value;
}

// È™åËØÅÂπ∂Ê†ºÂºèÂåñÂÆöÊó∂ËøêË°åÊó∂Èó¥
function validateAndFormatTimerTime(input) {
    let value = input.value.trim();
    
    if (value === '') {
        input.value = '0.00';
        return;
    }
    
    // Ëß£ÊûêH.MÊ†ºÂºè
    const parts = value.split('.');
    let hours = 0;
    let minutes = 0;
    
    if (parts.length === 1) {
        // Âè™ÊúâÂ∞èÊó∂ÔºåÊ≤°ÊúâÂàÜÈíü
        hours = parseInt(parts[0]) || 0;
        minutes = 0;
    } else if (parts.length === 2) {
        // ÊúâÂ∞èÊó∂ÂíåÂàÜÈíü
        hours = parseInt(parts[0]) || 0;
        let minutesStr = parts[1];
        
        // Â¶ÇÊûúÂàÜÈíüÈÉ®ÂàÜË∂ÖËøá2‰ΩçÔºåÂè™ÂèñÂâç2‰Ωç
        if (minutesStr.length > 2) {
            minutesStr = minutesStr.substring(0, 2);
        }
        
        minutes = parseInt(minutesStr) || 0;
        
        // È™åËØÅÂàÜÈíü‰∏çËÉΩË∂ÖËøá60
        if (minutes > 60) {
            showAlert('ÂàÜÈíüÊï∞‰∏çËÉΩË∂ÖËøá60ÔºÅËØ∑ËæìÂÖ•0-60‰πãÈó¥ÁöÑÂàÜÈíüÊï∞„ÄÇ', 'ËæìÂÖ•ÈîôËØØ', 'warning');
            input.value = hours + '.00';
            return;
        }
    } else {
        // Ê†ºÂºèÈîôËØØÔºåÈáçÁΩÆ‰∏∫0.00
        showAlert('ËØ∑ËæìÂÖ•Ê≠£Á°ÆÁöÑÊ†ºÂºèÔºàH.MÔºâÔºå‰æãÂ¶ÇÔºö2.30 Ë°®Á§∫2Â∞èÊó∂30ÂàÜÈíü', 'Ê†ºÂºèÈîôËØØ', 'warning');
        input.value = '0.00';
        return;
    }
    
    // Ê†ºÂºèÂåñÊòæÁ§∫ÔºàÂàÜÈíüÈÉ®ÂàÜË°•Èõ∂Âà∞2‰ΩçÔºâ
    const formattedValue = hours + '.' + String(minutes).padStart(2, '0');
    input.value = formattedValue;
    
    // ‰øùÂ≠ò‰∏¥Êó∂‰øÆÊîπÂà∞ÂΩìÂâçËÆæÂ§á
    const currentDeviceId = typeof window.currentDeviceId !== 'undefined' ? window.currentDeviceId : 
                           (typeof window.activeDeviceId !== 'undefined' ? window.activeDeviceId : null);
    if (currentDeviceId) {
        setDeviceTimerSettings(currentDeviceId, {
            timerTime: formattedValue,
            isTimerTimeModified: true
        });
        console.log(`ÂÆöÊó∂ËøêË°åÊó∂Èó¥Â∑≤ËÆæÁΩÆ‰∏∫: ${formattedValue} (ËÆæÂ§á: ${currentDeviceId})`);
    }
    
    input.classList.add('modified');
}

// Â∞ÜH.MÊ†ºÂºèËΩ¨Êç¢‰∏∫H*100+MÊ†ºÂºèÔºàÁî®‰∫é‰º†ÂèÇÔºâ
function convertTimerTimeToParam(timeStr) {
    if (!timeStr || timeStr === '') {
        return 0;
    }
    
    const parts = timeStr.split('.');
    let hours = 0;
    let minutes = 0;
    
    if (parts.length === 1) {
        hours = parseInt(parts[0]) || 0;
        minutes = 0;
    } else if (parts.length === 2) {
        hours = parseInt(parts[0]) || 0;
        minutes = parseInt(parts[1]) || 0;
    } else {
        return 0;
    }
    
    // È™åËØÅÂàÜÈíü‰∏çËÉΩË∂ÖËøá60
    if (minutes > 60) {
        console.warn('ÂÆöÊó∂ËøêË°åÊó∂Èó¥ÂàÜÈíüÊï∞Ë∂ÖËøá60ÔºåÂ∑≤ÈáçÁΩÆ‰∏∫60');
        minutes = 60;
    }
    
    // ËΩ¨Êç¢‰∏∫H*100+MÊ†ºÂºè
    return hours * 100 + minutes;
}

// ‰æßËæπÊ†èÊòæÁ§∫/ÈöêËóèÊéßÂà∂
function toggleSidebar() {
    const sidebar = document.getElementById('deviceSidebar');
    const layout = document.getElementById('monitorLayout');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    
    if (!sidebar || !layout || !toggleBtn) return;
    
    const isHidden = sidebar.classList.contains('hidden');
    
    if (isHidden) {
        // ÊòæÁ§∫‰æßËæπÊ†è
        sidebar.classList.remove('hidden');
        layout.classList.remove('sidebar-hidden');
        toggleBtn.textContent = '‚óÄ';
        toggleBtn.title = 'ÈöêËóè‰æßËæπÊ†è';
        localStorage.setItem('sidebarHidden', 'false');
    } else {
        // ÈöêËóè‰æßËæπÊ†è
        sidebar.classList.add('hidden');
        layout.classList.add('sidebar-hidden');
        toggleBtn.textContent = '‚ñ∂';
        toggleBtn.title = 'ÊòæÁ§∫‰æßËæπÊ†è';
        localStorage.setItem('sidebarHidden', 'true');
    }
}

// ÂàùÂßãÂåñ‰æßËæπÊ†èÁä∂ÊÄÅÔºà‰ªélocalStorageËØªÂèñÁî®Êà∑ÂÅèÂ•ΩÔºâ
function initSidebarState() {
    const sidebar = document.getElementById('deviceSidebar');
    const layout = document.getElementById('monitorLayout');
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    
    if (!sidebar || !layout || !toggleBtn) return;
    
    const sidebarHidden = localStorage.getItem('sidebarHidden') === 'true';
    
    if (sidebarHidden) {
        sidebar.classList.add('hidden');
        layout.classList.add('sidebar-hidden');
        toggleBtn.textContent = '‚ñ∂';
        toggleBtn.title = 'ÊòæÁ§∫‰æßËæπÊ†è';
    } else {
        sidebar.classList.remove('hidden');
        layout.classList.remove('sidebar-hidden');
        toggleBtn.textContent = '‚óÄ';
        toggleBtn.title = 'ÈöêËóè‰æßËæπÊ†è';
    }
}

document.addEventListener('DOMContentLoaded', function() {
    initializeDeviceModule();
    // ÂàùÂßãÂåñ‰æßËæπÊ†èÁä∂ÊÄÅ
    initSidebarState();
    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆÔºåÁ°Æ‰øùËé∑ÂèñÊúÄÊñ∞Â≠óÊÆµ
    setTimeout(() => {
        refreshDevicesFromServer();
    }, 1000);
    
    // ÂàùÂßãÂåñÁ®ãÂºèÂè∑ÁÇπÂáªÂ§ÑÁêÜ
    setTimeout(() => {
        initProgramNumberClickHandler();
    }, 1500);
    
    // ÂàùÂßãÂåñÂÆöÊó∂ËøêË°åËÆæÁΩÆ
    setTimeout(() => {
        initTimerSettings();
    }, 1500);
});

// È°µÈù¢Âç∏ËΩΩÊó∂Ê∏ÖÁêÜÊâÄÊúâÂÆöÊó∂Âô®ÂíåËµÑÊ∫ê
window.addEventListener('beforeunload', function() {
    // Ê∏ÖÁêÜËÆæÂ§áÂàóË°®Ëá™Âä®Âà∑Êñ∞ÂÆöÊó∂Âô®
    if (deviceListRefreshTimerId) {
        clearInterval(deviceListRefreshTimerId);
        deviceListRefreshTimerId = null;
    }
    
    // Ê∏ÖÁêÜËá™Âä®Ëé∑ÂèñÂÆöÊó∂Âô®
    if (autoFetchTimerId) {
        clearInterval(autoFetchTimerId);
        autoFetchTimerId = null;
    }
    
    // Ê∏ÖÁêÜËÆæÂ§áÂç°ÁâáÁºìÂ≠ò
    deviceCardCache.clear();
    
    // ÂèñÊ∂àÊ≠£Âú®ËøõË°åÁöÑËØ∑Ê±Ç
    if (isRefreshing) {
        isRefreshing = false;
    }
});

// È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÂà∑Êñ∞ÔºåÈ°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§ç
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        // È°µÈù¢ÈöêËóèÊó∂ÊöÇÂÅúÂà∑Êñ∞
        if (deviceListRefreshTimerId) {
            clearInterval(deviceListRefreshTimerId);
            deviceListRefreshTimerId = null;
        }
    } else {
        // È°µÈù¢ÊòæÁ§∫Êó∂ÊÅ¢Â§çÂà∑Êñ∞
        const deviceMonitorPage = document.getElementById('deviceMonitorPage');
        if (deviceMonitorPage && deviceMonitorPage.classList.contains('active')) {
            if (!deviceListRefreshTimerId && typeof window.startDeviceListAutoRefresh === 'function') {
                window.startDeviceListAutoRefresh();
            }
        }
    }
});

// Âº∫Âà∂Âà∑Êñ∞Êï∞ÊçÆ
function forceRefreshData() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const originalText = refreshBtn.textContent;
    refreshBtn.textContent = 'üîÑ Âà∑Êñ∞‰∏≠...';
    refreshBtn.disabled = true;

    fetch('/iot/data/refresh', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(async response => {
        // Ê£ÄÊü•ÂìçÂ∫îÁ±ªÂûã
        const contentType = response.headers.get('content-type');

        // Â¶ÇÊûúËøîÂõûÁöÑ‰∏çÊòØJSONÔºåÂèØËÉΩÊòØHTMLÈîôËØØÈ°µÈù¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('ÈùûJSONÂìçÂ∫î:', text.substring(0, 200));

            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü');
            } else {
                throw new Error('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ');
            }
        }

        return response.json();
    })
    .then(data => {
        if (data.success) {
            // ÈáçÊñ∞Ê∏≤ÊüìËÆæÂ§áÊï∞ÊçÆ
            if (data.data && Array.isArray(data.data)) {
                const transformed = data.data.map(item => transformDeviceRecord(item, 0));
                // ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÔºàÊúÄÊó©ÂàõÂª∫ÁöÑÂú®ÊúÄÂâçÈù¢ÔºåÊñ∞ËÆæÂ§áÂú®ÊúÄÂêéÔºâ
                transformed.sort((a, b) => {
                    const timeA = a.raw.created_at || a.raw.createdAt || '9999-12-31 23:59:59';
                    const timeB = b.raw.created_at || b.raw.createdAt || '9999-12-31 23:59:59';
                    // ÂçáÂ∫èÊéíÂ∫èÔºöÊó©ÁöÑÊó∂Èó¥Âú®ÂâçÔºåÊôöÁöÑÊó∂Èó¥Âú®Âêé
                    if (timeA < timeB) return -1;
                    if (timeA > timeB) return 1;
                    return 0;
                });
                console.log('[Âº∫Âà∂Âà∑Êñ∞] ÊåâÂàõÂª∫Êó∂Èó¥ÊéíÂ∫èÂÆåÊàêÔºåËÆæÂ§áÈ°∫Â∫è:', transformed.map(d => `${d.id}(${d.raw.created_at || d.raw.createdAt})`));
                deviceList = transformed;
                if (deviceList.length > 0) {
                    activeDeviceId = deviceList[0].id;
                } else {
                    activeDeviceId = null;
                }
                renderDevices();
                showResult(`Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäüÔºÅÂÖ±Âä†ËΩΩ‰∫Ü ${data.count} Âè∞ËÆæÂ§á`, 'success');
            } else {
                deviceList = [];
                activeDeviceId = null;
                renderDevices();
                showResult('Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäüÔºå‰ΩÜÊ≤°ÊúâÊâæÂà∞ËÆæÂ§áÊï∞ÊçÆ', 'success');
            }
        } else {
            showResult('Êï∞ÊçÆÂà∑Êñ∞Â§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    })
    .catch(error => {
        console.error('Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•:', error);
        if (error.message && error.message.includes('<!DOCTYPE')) {
            showResult('Âà∑Êñ∞Â§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜHTMLÈ°µÈù¢ÔºåÂèØËÉΩÊòØÁôªÂΩïËÆ§ËØÅÈóÆÈ¢ò', 'error');
        } else {
            showResult('Âà∑Êñ∞Â§±Ë¥•Ôºö' + error.message, 'error');
        }
    })
    .finally(() => {
        // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
        refreshBtn.textContent = originalText;
        refreshBtn.disabled = false;
    });
}

// ÂèëÈÄÅÂëΩ‰ª§Áõ∏ÂÖ≥ÂáΩÊï∞
function openCommandModal() {
    document.getElementById('commandModal').style.display = 'block';
    document.getElementById('resultMessage').innerHTML = '';

    // ËÆæÁΩÆÈªòËÆ§JSONÊï∞ÊçÆ
    const defaultJson = `{
  "device_id": "DEVICE001",
  "valueorprogram": "1",
  "fixed_temp_set": "25.0",
  "fixed_hum_set": "60.0",
  "set_program_number": "1",
  "set_run_status": "1",
  "set_program_no": "0",
  "create_by": "Âç¢ÂÅ•"
}`;

    const jsonInput = document.getElementById('jsonInput');
    if (jsonInput && !jsonInput.value.trim()) {
        jsonInput.value = defaultJson;
    }
}

function closeCommandModal() {
    document.getElementById('commandModal').style.display = 'none';
}

function formatJson() {
    const jsonInput = document.getElementById('jsonInput');
    try {
        const jsonObj = JSON.parse(jsonInput.value);
        jsonInput.value = JSON.stringify(jsonObj, null, 2);
        showResult('JSONÊ†ºÂºèÂåñÊàêÂäüÔºÅ', 'success');
    } catch (e) {
        showResult('JSONÊ†ºÂºèÈîôËØØÔºö' + e.message, 'error');
    }
}

function clearJson() {
    document.getElementById('jsonInput').value = '';
    document.getElementById('resultMessage').innerHTML = '';
}

function sendCommand() {
    const jsonInput = document.getElementById('jsonInput');
    const jsonText = jsonInput.value.trim();
    
    if (!jsonText) {
        showResult('ËØ∑ËæìÂÖ•JSONÊï∞ÊçÆ', 'error');
        return;
    }

    let jsonData;
    try {
        jsonData = JSON.parse(jsonText);
    } catch (e) {
        showResult('JSONÊ†ºÂºèÈîôËØØÔºö' + e.message, 'error');
        return;
    }

    // È™åËØÅÂøÖÂ°´Â≠óÊÆµ
    const requiredFields = ['device_id', 'valueorprogram', 'set_run_status', 'create_by'];
    const missingFields = requiredFields.filter(field => !jsonData[field]);

    if (missingFields.length > 0) {
        showResult('Áº∫Â∞ëÂøÖÂ°´Â≠óÊÆµÔºö' + missingFields.join(', '), 'error');
        return;
    }

    // È™åËØÅvalueorprogramÂ≠óÊÆµ
    if (!['0', '1'].includes(String(jsonData.valueorprogram))) {
        showResult('valueorprogramÂ≠óÊÆµÂøÖÈ°ªÊòØ0Êàñ1Ôºà0=Á®ãÂºèËØïÈ™åÔºå1=ÂÆöÂÄºËØïÈ™åÔºâ', 'error');
        return;
    }

    // È™åËØÅset_run_statusÂ≠óÊÆµ
    if (!['0', '1', '2'].includes(String(jsonData.set_run_status))) {
        showResult('set_run_statusÂ≠óÊÆµÂøÖÈ°ªÊòØ0„ÄÅ1Êàñ2Ôºà0=ÂÅúÊ≠¢Ôºå1=ËøêË°åÔºå2=ÊöÇÂÅúÔºâ', 'error');
        return;
    }

    showResult('Ê≠£Âú®ÂèëÈÄÅÂëΩ‰ª§...', 'loading');

    fetch('/iot/createCommand', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(jsonData)
    })
    .then(async response => {
        // Ê£ÄÊü•ÂìçÂ∫îÁ±ªÂûã
        const contentType = response.headers.get('content-type');
        
        // Â¶ÇÊûúËøîÂõûÁöÑ‰∏çÊòØJSONÔºåÂèØËÉΩÊòØHTMLÈîôËØØÈ°µÈù¢
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('ÈùûJSONÂìçÂ∫î:', text.substring(0, 200));
            
            if (response.status === 302 || response.redirected || text.includes('<!DOCTYPE')) {
                showResult('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÈúÄË¶ÅÁôªÂΩïËÆ§ËØÅÔºåËØ∑ÂÖàÁôªÂΩïÁ≥ªÁªü', 'error');
            } else {
                showResult('ËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜÈùûJSONÊ†ºÂºèÁöÑÂìçÂ∫îÔºàÁä∂ÊÄÅÁ†Å: ' + response.status + 'Ôºâ', 'error');
            }
            return null;
        }
        
        // Ëß£ÊûêJSONÂìçÂ∫î
        return response.json();
    })
    .then(data => {
        if (data === null) return; // Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÈîôËØØ
        
        if (data.success) {
            showResult('ÂëΩ‰ª§ÂèëÈÄÅÊàêÂäüÔºÅÂëΩ‰ª§ID: ' + (data.id || 'N/A'), 'success');
            setTimeout(() => {
                clearJson();
            }, 3000);
        } else {
            showResult('ÂëΩ‰ª§ÂèëÈÄÅÂ§±Ë¥•Ôºö' + (data.message || 'Êú™Áü•ÈîôËØØ'), 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (error.message && error.message.includes('<!DOCTYPE')) {
            showResult('ÂèëÈÄÅËØ∑Ê±ÇÂ§±Ë¥•ÔºöÊúçÂä°Âô®ËøîÂõû‰∫ÜHTMLÈ°µÈù¢ÔºåÂèØËÉΩÊòØÁôªÂΩïËÆ§ËØÅÈóÆÈ¢ò', 'error');
        } else {
            showResult('ÂèëÈÄÅËØ∑Ê±ÇÂ§±Ë¥•Ôºö' + error.message, 'error');
        }
    });
}

function showResult(message, type) {
    const resultDiv = document.getElementById('resultMessage');
    resultDiv.textContent = message;
    resultDiv.className = 'result-message ' + type;
    resultDiv.style.display = 'block';
}

// ÈÄöÁî®ÊèêÁ§∫Ê®°ÊÄÅÊ°ÜÂáΩÊï∞ÔºàÊö¥Èú≤Âà∞windowÂØπË±°‰æõapp.js‰ΩøÁî®Ôºâ
window.showAlert = function(message, title = 'ÊèêÁ§∫', type = 'info') {
    const modal = document.getElementById('alertModal');
    const titleElement = document.getElementById('alertModalTitle');
    const messageElement = document.getElementById('alertModalMessage');
    const iconElement = document.getElementById('alertModalIcon');
    
    if (!modal || !titleElement || !messageElement || !iconElement) return;
    
    // ËÆæÁΩÆÊ†áÈ¢òÂíåÊ∂àÊÅØ
    titleElement.textContent = title;
    messageElement.textContent = message;
    
    // ËÆæÁΩÆÂõæÊ†á
    const icons = {
        'info': '‚ÑπÔ∏è',
        'success': '‚úÖ',
        'warning': '‚ö†Ô∏è',
        'error': '‚ùå'
    };
    iconElement.textContent = icons[type] || icons['info'];
    iconElement.className = 'alert-modal-icon ' + type;
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
};

window.closeAlertModal = function() {
    const modal = document.getElementById('alertModal');
    if (modal) {
        modal.style.display = 'none';
    }
};

// ÊòæÁ§∫Ê†∑ÂìÅ‰ø°ÊÅØËØ¶ÊÉÖ
function showSampleInfo(sample) {
    const modal = document.getElementById('sampleInfoModal');
    const testerElement = document.getElementById('sampleInfoTester');
    const modelElement = document.getElementById('sampleInfoModel');
    const categoryElement = document.getElementById('sampleInfoCategory');
    
    if (!modal || !testerElement || !modelElement || !categoryElement) return;
    
    // Â°´ÂÖÖÊ†∑ÂìÅ‰ø°ÊÅØ
    testerElement.textContent = sample.tester || 'Êú™Â°´ÂÜô';
    modelElement.textContent = sample.model || 'Êú™Â°´ÂÜô';
    categoryElement.textContent = sample.category || 'Êú™Â°´ÂÜô';
    
    // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
    modal.style.display = 'block';
}

// ÂÖ≥Èó≠Ê†∑ÂìÅ‰ø°ÊÅØÊ®°ÊÄÅÊ°Ü
function closeSampleInfoModal() {
    const modal = document.getElementById('sampleInfoModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

// ÊîØÊåÅESCÈîÆÂÖ≥Èó≠ÊèêÁ§∫Ê®°ÊÄÅÊ°Ü
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        const alertModal = document.getElementById('alertModal');
        if (alertModal && alertModal.style.display === 'block') {
            closeAlertModal();
        }
        const editDeviceInfoModal = document.getElementById('editDeviceInfoModal');
        if (editDeviceInfoModal && editDeviceInfoModal.style.display === 'block') {
            closeEditDeviceInfoModal();
        }
    }
});

// ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
window.onclick = function(event) {
    const commandModal = document.getElementById('commandModal');
    if (event.target === commandModal) {
        closeCommandModal();
    }
    const deviceFormModal = document.getElementById('deviceFormModal');
    if (event.target === deviceFormModal) {
        closeAddDeviceModal();
    }
    const alertModal = document.getElementById('alertModal');
    if (event.target === alertModal) {
        closeAlertModal();
    }
    const editDeviceInfoModal = document.getElementById('editDeviceInfoModal');
    if (event.target === editDeviceInfoModal) {
        closeEditDeviceInfoModal();
    }
    const sampleInfoModal = document.getElementById('sampleInfoModal');
    if (event.target === sampleInfoModal) {
        closeSampleInfoModal();
    }
}

</script>
</body>
</html>
