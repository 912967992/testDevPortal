<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQE问题点模块</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/commonDQEMoudle.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>


<div class="header-container">
    <div class="title">问题点模块</div>
    <button class="BackBtn" id="BackBtn" onclick="location.href='/DQEIndex'">返回<br>主页</button>
</div>

<div class="search-container">
    <form class="search-form">
        <!-- 产品大，小编码 -->
        <div class="input-group">
            <label for="full_model">大小<br>编码:</label>
            <input type="text" id="full_model" name="full_model" placeholder="输入大小编码">
        </div>

        <!-- 问题点编号test_issues_id-->
        <div class="input-group">
            <label for="test_issues_id">编号:</label>
            <input type="text" id="test_issues_id" name="test_issues_id" placeholder="编号">
        </div>

        <!-- 任务属性 ：无，新品，新设备，新软件版本，售后问题分析，量产升级，竞品-->
        <div class="input-group">
            <label for="questStats">产品<br>类别:</label>
            <select id="questStats" name="questStats">
                <option value=""></option>
                <option value="无">无</option>
                <option value="新品">新品</option>
                <option value="新设备">新设备</option>
                <option value="新软件版本">新软件版本</option>
                <option value="售后问题分析">售后问题分析</option>
                <option value="量产升级">量产升级</option>
                <option value="竞品">竞品</option>
            </select>
        </div>


        <!-- 产品类别 -->
        <div class="input-group">
            <label for="sample_category">产品<br>类别:</label>
            <select id="sample_category" name="sample_category">
                <option value="">选择类别</option>
                <option value="大货">大货</option>
                <option value="功能样">功能样</option>
                <option value="预研">预研</option>
                <option value="竞品">竞品</option>
            </select>
        </div>

        <!-- 版本号 -->
        <div class="input-group">
            <label for="version">版本<br>号:</label>
            <input type="text" id="version" name="version" placeholder="输入版本号">
        </div>

        <!-- 主控芯片 -->
        <div class="input-group">
            <label for="chip_control">主控<br>芯片:</label>
            <input type="text" id="chip_control" name="chip_control" placeholder="输入主控芯片">
        </div>


        <!-- 大类 -->
        <div class="input-group">
            <!-- 引入品类细分组件 -->
            <label for="big_species">大类:</label>
            <select id="big_species" name="big_species"  onchange="populateSubCategory()">
                <option value="" selected>请选择大类</option>
                <!-- 通过json文件动态加入选项 -->
            </select>
        </div>

        <!-- 小类 -->
        <div class="input-group">
            <label for="small_species">细分<br>品类:</label>
            <select id="small_species" name="small_species" >
                <option value="" selected>选择细分品类</option>
                <!-- 根据大类自动填充 -->
            </select>
        </div>


        <!-- 供应商 -->
        <div class="input-group">
            <label for="supplier">供应<br>商:</label>
            <input type="text" id="supplier" name="supplier" placeholder="输入供应商">
        </div>

        <!-- 国内外测试 -->
        <div class="input-group">
            <label for="test_Overseas">国内<br>外:</label>
            <select id="test_Overseas" name="test_Overseas">
                <option value=""></option>
                <option value="国内">国内测试</option>
                <option value="国外">国外测试</option>
                <option value="国内+国外+">国内+国外测试</option>
            </select>
        </div>


        <!-- 测试平台 -->
        <div class="input-group">
            <label for="test_platform">测试<br>平台:</label>
            <input type="text" id="test_platform" name="test_platform" placeholder="输入测试平台">
        </div>



        <!-- DQE -->
        <div class="input-group">
            <label for="sample_DQE">DQE:</label>
            <input type="text" id="sample_DQE" name="sample_DQE" placeholder="输入 DQE">
        </div>

        <!-- 电子工程师 -->
        <div class="input-group">
            <label for="sample_Developer">研发<br>电子:</label>
            <input type="text" id="sample_Developer" name="sample_Developer" placeholder="">
        </div>

        <!-- 测试人 -->
        <div class="input-group">
            <label for="tester">测试<br>人:</label>
            <input type="text" id="tester" name="tester" placeholder="输入测试人">
        </div>

        <!-- 优先级 -->
        <div class="input-group">
            <label for="priority">优先<br>级:</label>
            <select id="priority" name="priority">
                <option value=""></option>
                <option value="加急">加急</option>
                <option value="同步">同步</option>
                <option value="优先">优先</option>
                <option value="普通">普通</option>
            </select>
        </div>


        <!-- 最终状态 -->
        <div class="input-group">
            <label for="final_status">最终<br>状态:</label>
            <select id="final_status" name="final_status">
                <option value=""></option>
                <option value="OPEN">OPEN</option>
                <option value="CLOSED">CLOSED</option>
                <option value="待解决">待解决</option>

            </select>
        </div>


        <!-- 判定结果 -->
        <div class="input-group">
            <label for="result_judge">判定<br>结果:</label>
            <select id="result_judge" name="result_judge">
                <option value=""></option>
                <option value="0">不用签样</option>
                <option value="1">签样</option>
                <option value="2">退样</option>
                <option value="3">免签只发邮件</option>

            </select>
        </div>

        <!-- 日期范围选择器 -->
        <div class="input-group date-range">
            <label>提交<br>日期:</label>
            <input type="date" id="problemTimeStart" placeholder="开始日期">
            <span class="date-separator">至</span> <!-- 添加“至”标签 -->
            <input type="date" id="problemTimeEnd" placeholder="结束日期">
        </div>

        <!-- DQE审核状态 -->
        <div class="input-group">
            <label for="dqe_status">DQE<br>审核:</label>
            <select id="dqe_status" name="dqe_status">
                <option value=""></option>
                <option value="0">未审核</option>
                <option value="1">开始审核</option>
                <option value="2">审核完成</option>

            </select>
        </div>

        <!-- 研发审核状态 -->
        <div class="input-group">
            <label for="rd_status">研发<br>审核:</label>
            <select id="rd_status" name="rd_status">
                <option value=""></option>
                <option value="0">未审核</option>
                <option value="1">开始审核</option>
                <option value="2">审核完成</option>

            </select>
        </div>

        <!-- 搜索按钮 -->
        <button type="submit">搜索</button>
    </form>
</div>

<!-- 表格容器 -->
<div class="problemtable_container">
    <!-- 这里是表格的占位符 -->
    <!-- 实际表格内容可以通过 JavaScript 动态生成 -->
</div>

<!-- 模态框结构 -->
<div id="testIssuesModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="testIssuesContent"></div>
    </div>
</div>



<!-- 下方固定按钮 -->
<div class="btn-container">
    <hr class="divider"> <!-- 按钮上方的横线 -->
    <!-- 主页按钮 -->
    <button class="btn" id="homeBtn"><i class="fas fa-home"></i></button>
    <!-- 搜索资源库按钮 -->
    <button class="btn" id="cloudBtn"><i class="fas fa-cloud"></i></button>
    <!-- 个人界面按钮 -->
    <button class="btn" id="profileBtn"><i class="fas fa-user"></i></button>
</div>

<script>
    // 存储已选中的 item.id 的数组
    let selectedIds = [];

    const username = sessionStorage.getItem('username');
    const job = sessionStorage.getItem('job');

    $(document).ready(function() {
        console.log(username)
        console.log(job)
        // alert(username)
        // alert(job)
    });

    //选择大类之后选择小类
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/json/categories.json')
            .then(response => response.json())
            .then(data => {
                const bigSpeciesSelect = document.getElementById('big_species');

                // 填充大类选择器
                for (const bigSpecies in data) {
                    const option = document.createElement('option');
                    option.value = bigSpecies;
                    option.textContent = bigSpecies;
                    bigSpeciesSelect.appendChild(option);
                }

                // 存储数据供后续使用
                window.categoryData = data;
            });
    });
    function populateSubCategory() {
        const bigSpeciesSelect = document.getElementById('big_species');
        const smallSpeciesSelect = document.getElementById('small_species');
        const bigSpeciesCategory = bigSpeciesSelect.value;

        // 清空当前的细分品类选项
        smallSpeciesSelect.innerHTML = '<option value="" selected>请选择细分品类</option>';

        if (window.categoryData) {
            let smallSpeciesArray = [];
            if (bigSpeciesCategory === "竞品-预研类" || bigSpeciesCategory === "高频类") {
                for (const category in window.categoryData) {
                    if (category !== "竞品-预研类" && category !== "高频类") {
                        window.categoryData[category].forEach(subCategory => {
                            smallSpeciesArray.push(`${category}-${subCategory}`);
                        });
                    }
                }
            } else if (window.categoryData[bigSpeciesCategory]) {
                smallSpeciesArray = window.categoryData[bigSpeciesCategory];
            }

            smallSpeciesArray.forEach(smallSpecies => {
                const option = document.createElement('option');
                option.value = smallSpecies;
                option.textContent = smallSpecies;
                smallSpeciesSelect.appendChild(option);
            });
        }
    }


    $(document).ready(function() {
        let currentPage = 1;
        // 设置每页多少个问题点才分页
        const pageSize = 15;
        let pages = []; // 用于存储分页数据

        // 在页面加载时自动搜索
        // performSearch();

        // 表单提交时触发搜索
        $('.search-form').on('submit', function(event) {
            event.preventDefault(); // 防止表单的默认提交行为
            performSearch(); // 执行搜索
        });

        function performSearch() {
            // 获取表单数据
            var formData = $('.search-form').serialize();

            // 构建搜索请求的 URL
            var searchUrl = '/problemMoudle/searchSamplesDQE';

            // 发起 AJAX 请求
            $.ajax({
                url: searchUrl,
                type: 'GET',
                dataType: 'json',
                data: formData, // 使用表单数据进行搜索
                success: function(data) {
                    // 处理搜索结果
                    pages = paginateData(data, pageSize);
                    currentPage = 1; // 重置当前页
                    displayPage(currentPage);
                },
                error: function(xhr, status, error) {
                    console.error('搜索请求失败:', error);
                }
            });
        }

        function paginateData(data, pageSize) {
            const pages = [];
            for (let i = 0; i < data.length; i += pageSize) {
                pages.push(data.slice(i, i + pageSize));
            }
            return pages;
        }

        function displayPage(pageNum) {
            if (pageNum < 1 || pageNum > pages.length) return; // 检查页码范围

            currentPage = pageNum; // 更新当前页码

            const tableContainer = document.querySelector('.problemtable_container');
            tableContainer.innerHTML = ''; // 清空表格容器

            const pageData = pages[pageNum - 1] || [];
            const table = document.createElement('table');
            table.classList.add('result-table'); // 添加样式类

            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');


            const headers = [
                 "样品ID","样品进度","判定结果", "完整编码", "产品名称", "产品类别", "版本", "提交时间",
                 "供应商", "任务属性", "大类", "小类", "国内外测试",
                 "测试人员","DQE", "研发工程师","项目负责人", "备注", "合伙测试人",
                 "优先级", "送样数量", "送样次数","高频"
            ];

            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // 创建表体
            const tbody = document.createElement('tbody');
            pageData.forEach(item => {
                const row = document.createElement('tr');


                // 填充表格行的每个单元格
                const cells = [
                    item.sample_id,item.sample_schedule, item.result_judge,
                    item.full_model, item.sample_name,item.sample_category, item.version,
                    item.finish_time,
                    item.supplier, item.questStats,
                    item.big_species, item.small_species,
                    item.test_Overseas,
                    item.tester,item.sample_DQE, item.sample_Developer,item.sample_leader,
                    item.sample_remark, item.tester_teamwork,
                    item.priority,
                    item.sample_quantity, item.sample_frequency,item.high_frequency

                ];

                cells.forEach((cellData, index) => {
                    const td = document.createElement('td');

                    if (headers[index] === "提交时间") {
                        td.textContent = cellData ? cellData.replace('T', ' ') : '';
                    } else if(headers[index] === "样品进度"){
                        if (cellData === "0"){
                            td.textContent = "测试中";
                        }else if(cellData === "1"){
                            td.textContent = "待审核";
                            td.style.color = 'red'; // 设置字体颜色为绿色
                        }else if(cellData === "2"){
                            td.textContent = "已完成";
                        }
                    } else if(headers[index] === "判定结果"){
                        if (cellData==null){
                            td.textContent = "待DQE审核";
                        }else if(cellData === "1"){
                            td.textContent = "待研发审核";
                            // td.style.color = 'red'; // 设置字体颜色为绿色
                        }else{
                            td.textContent = cellData;
                        }
                    } else{
                        td.textContent = cellData || '';
                    }

                    // 为每个单元格添加点击事件，传递 item.sample_id
                    td.addEventListener('click', () => editClickBtn(item.sample_id));

                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // 创建分页按钮并添加到表格容器
            updatePagination(tableContainer);
        }

        function updatePagination(container) {
            const pagination = document.createElement('div');
            pagination.classList.add('pagination');

            // Function to change page without reloading data
            function changePage(newPage) {
                currentPage = newPage;
                updatePagination(container); // Refresh pagination buttons only
                displayPage(currentPage); // Update the display for the selected page
            }

            // Function to change page range and adjust current page
            function changePageRange(step) {
                let newPage = currentPage + step;
                if (newPage < 1) newPage = 1; // Ensure newPage does not go below 1
                if (newPage > pages.length) newPage = pages.length; // Ensure newPage does not exceed numPages
                changePage(newPage);
            }

            // Create the '<<' button (jump to first page)
            const firstPageButton = document.createElement('button');
            firstPageButton.textContent = '<<';
            firstPageButton.disabled = currentPage === 1; // Disable if on the first page
            firstPageButton.addEventListener('click', () => changePage(1));
            pagination.appendChild(firstPageButton);

            // Create the '<' button (move to previous page range)
            const prevRangeButton = document.createElement('button');
            prevRangeButton.textContent = '<';
            prevRangeButton.disabled = currentPage === 1; // Disable if on the first page
            prevRangeButton.addEventListener('click', () => changePageRange(-10)); // Adjust -10 based on range
            pagination.appendChild(prevRangeButton);

            // Calculate the number of pages and determine start and end for display
            const numPages = pages.length;
            let startPage, endPage;

            if (numPages <= 10) {
                // Show all pages if total pages are 10 or less
                startPage = 1;
                endPage = numPages;
            } else {
                // Show pages around the current page with a range of 10
                if (currentPage <= 5) {
                    startPage = 1;
                    endPage = 10;
                } else if (currentPage + 4 >= numPages) {
                    startPage = numPages - 9;
                    endPage = numPages;
                } else {
                    startPage = currentPage - 5;
                    endPage = currentPage + 4;
                }
            }

            // Add page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.disabled = i === currentPage; // Disable the current page button
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    displayPage(i); // Update the display for the selected page
                });
                pagination.appendChild(pageButton);
            }

            // Create the '>' button (move to next page range)
            const nextRangeButton = document.createElement('button');
            nextRangeButton.textContent = '>';
            nextRangeButton.disabled = currentPage === numPages; // Disable if on the last page
            nextRangeButton.addEventListener('click', () => changePageRange(10)); // Adjust +10 based on range
            pagination.appendChild(nextRangeButton);

            // Create the '>>' button (jump to last page)
            const lastPageButton = document.createElement('button');
            lastPageButton.textContent = '>>';
            lastPageButton.disabled = currentPage === numPages; // Disable if on the last page
            lastPageButton.addEventListener('click', () => changePage(numPages));
            pagination.appendChild(lastPageButton);

            // Remove the previous pagination and add the new one
            const existingPagination = container.querySelector('.pagination');
            if (existingPagination) {
                container.removeChild(existingPagination);
            }

            // Insert the new pagination at the beginning of the container
            container.insertBefore(pagination, container.firstChild);
        }

        function enableDragScroll(element) {
            let isDragging = false;
            let startX, scrollLeft;

            element.addEventListener('mousedown', (e) => {
                isDragging = true;
                element.style.cursor = 'grabbing';
                startX = e.pageX - element.offsetLeft;
                scrollLeft = element.scrollLeft;
            });

            element.addEventListener('mouseleave', () => {
                isDragging = false;
                element.style.cursor = 'grab';
            });

            element.addEventListener('mouseup', () => {
                isDragging = false;
                element.style.cursor = 'grab';
            });

            element.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const x = e.pageX - element.offsetLeft;
                const walk = (x - startX) * 2; // 滚动速度
                element.scrollLeft = scrollLeft - walk;
            });
        }

        //可点击修改的输入框，用于editClickBtn方法
        function createEditableSpan(value, item, attr, modifiedData, valueDiv) {
            const span = document.createElement('span');
            span.textContent = value || '无';  // 如果没有数据，展示为 '无'

            // 点击后变为输入框
            span.addEventListener('click', function () {
                const textarea = document.createElement('textarea');
                textarea.style.height = '50px';  // 设置高度，可以根据需求调整

                // 如果展示的是 '无'，则输入框内容为空，否则使用当前内容
                const originalValue = (span.textContent === '无') ? '' : span.textContent;
                textarea.value = originalValue;

                // 监听失焦事件
                textarea.addEventListener('blur', function () {
                    const newValue = textarea.value.trim() || '';  // 新值为空字符串则转换为空

                    // 如果新值和旧值都为空，或者它们相等，则不更新
                    if (newValue === originalValue) {
                        span.textContent = value || '无';  // 保持原值
                    } else {
                        // 更新 span 的内容为新值，若为空显示为 '无'
                        span.textContent = newValue || '无';

                        // 更新 item 的值，并标记修改过的数据
                        item[attr.field] = newValue;
                        if (!modifiedData.includes(item)) {
                            modifiedData.push(item);  // 标记修改过的数据
                        }
                    }

                    // 将 textarea 替换回 span
                    valueDiv.replaceChild(span, textarea);
                });

                // 将 span 替换为 textarea
                valueDiv.replaceChild(textarea, span);
                textarea.focus();
            });

            valueDiv.appendChild(span);
        }


        //editClickBtn点击新增问题按钮触发的方法
        function addNewRow(sampleId,attributes,modifiedData,table) {
            // 发送 AJAX 请求以获取数据，将 sampleId 作为查询参数
            fetch(`/problemMoudle/addNewRow?sampleId=${sampleId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    // 假设后端返回的数据是一个数组，获取第一个对象
                    const sample = data[0];  // 这里假设返回的数组只有一行数据，你可以根据实际情况调整

                    const newRow = document.createElement('tr');
                    newRow.className = 'value-row';

                    // 创建新的数据行
                    const newItem = {};

                    // 给每一行数据生成一个唯一 ID，用来标识并删除
                    const uniqueId = Date.now();  // 以当前时间戳作为唯一 ID（你也可以用其他方式生成唯一 ID）
                    newItem.uniqueId = uniqueId;  // 将唯一 ID 保存到 newItem 中
                    newRow.dataset.uniqueId = uniqueId; // 同时将唯一 ID 保存到行的自定义属性中

                    // 遍历 attributes 数组，将每个字段对应的数据插入到表格中
                    attributes.forEach((attr, index) => {
                        const newCell = document.createElement('td');
                        newCell.className = `value-cell value-cell-${index + 1}`;

                        const newDiv = document.createElement('div');

                        // 第一个字段是序号，不允许修改
                        if (index === 0) {
                            newDiv.textContent = '点击删除'; // 设置为自动生成的文本
                            newDiv.style.color = '#8a4e07'; // 设置字体颜色

                            // 添加删除功能
                            newDiv.addEventListener('click', function () {
                                // 从表格中删除行
                                newRow.remove();

                                // 使用 uniqueId 查找并从 modifiedData 中删除对应的项目
                                const itemIndex = modifiedData.findIndex(item => item.uniqueId === uniqueId);
                                if (itemIndex > -1) {
                                    modifiedData.splice(itemIndex, 1); // 从 modifiedData 中移除
                                }
                            });

                            newItem[attr.field] = null; // 序号不参与修改
                        } else {
                            // 处理字段映射：将 sample_category 映射到 sample_stage，将 max_histor_id 映射到 history_id
                            let value = ''; // 初始化值为一个空字符串

                            if (attr.field === 'sample_stage') {
                                value = sample.sample_category || ''; // 映射样品阶段
                            } else if (attr.field === 'history_id') {
                                value = sample.max_history_id || ''; // 映射历史ID

                                newDiv.textContent = value;
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                newItem[attr.field] = null; // 序号不参与修改

                            }else if (attr.field === 'full_model') {
                                value = sample.full_model || ''; // 映射历史ID
                            } else if (attr.field === 'version') {
                                value = sample.version || ''; // 映射历史ID
                            } else if (attr.field === 'created_at') {
                                const now = new Date();
                                value = now.toISOString().split('.')[0]; // 去掉毫秒部分; // 设置为自动生成的文本

                                newDiv.textContent = value;
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                newItem[attr.field] = null; // 序号不参与修改

                            } else if (attr.field === 'created_by') {
                                if (username && username === "卢健") {
                                    value = "dqe";
                                } else if (job && job.includes("DQE")) { // 判断 job 是否包含 "DQE"
                                    value = "dqe"; // 如果 job 包含 "DQE"，设置 value 为 "dqe"
                                } else {
                                    value = "rd"; // 否则设为空字符串或其他默认值
                                }
                                newDiv.textContent = value;
                                newDiv.style.color = '#8a4e07'; // 设置字体颜色
                                newItem[attr.field] = null; // 序号不参与修改

                            }  else if (attr.field === 'tester') {
                                if (username) {
                                    value = username;
                                } else {
                                    value = ''; // 其他字段保持为空字符串
                                }
                            } else {
                                value = ''; // 其他字段保持为空字符串
                            }

                            // 将新值添加到 newItem 中
                            newItem[attr.field] = value;

                            if(attr.field === 'history_id' || attr.field==='created_by'
                                || attr.field==='created_at') {

                            }else{
                                // 创建可编辑的内容
                                createEditableSpan(value, newItem, attr, modifiedData, newDiv); // 使用获取的值
                            }

                        }

                        newCell.appendChild(newDiv);
                        newRow.appendChild(newCell);
                    });

                    table.appendChild(newRow); // 将新行添加到表格
                    modifiedData.push(newItem); // 将新行数据推入修改数据数组
                })
                .catch(error => {
                    console.error('获取数据失败:', error.message);
                    alert(error.message); // 处理错误
                });
        }

        function editClickBtn(sampleId) {
            fetch('/problemMoudle/editClickBtn', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(sampleId)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.json();
                })
                .then(data => {
                    const modal = document.getElementById('testIssuesModal');
                    const contentDiv = document.getElementById('testIssuesContent');

                    // 清空之前的内容
                    contentDiv.innerHTML = '';

                    // 创建一个表格容器
                    const tableContainer = document.createElement('div');
                    tableContainer.className = 'table-container';

                    // 创建表格
                    const table = document.createElement('table');
                    table.className = 'data-table';

                    // 创建列名行
                    const headerRow = document.createElement('tr');
                    headerRow.className = 'header-row';
                    const attributes = [
                        { label: 'ID', field: 'id' },
                        // { label: 'DQE意见', field: 'dqe_comments' },
                        // { label: 'DQE意见时间', field: 'dqe_reviewed_at' },
                        // { label: '研发意见', field: 'rd_comments' },
                        // { label: '研发意见时间', field: 'rd_reviewed_at' },
                        { label: '完整型号', field: 'full_model' },
                        { label: '样品阶段', field: 'sample_stage' },
                        { label: '版本', field: 'version' },
                        { label: '芯片方案', field: 'chip_solution' },
                        { label: '测试平台', field: 'test_platform' },
                        { label: '显示设备', field: 'test_device' },
                        { label: '其他设备', field: 'other_device' },
                        { label: '问题描述', field: 'problem' },
                        { label: '问题图片', field: 'problem_image_or_video' },
                        { label: '问题时间', field: 'problem_time' },
                        { label: '复现方法', field: 'reproduction_method' },
                        { label: '恢复方法', field: 'recovery_method' },
                        { label: '复现概率', field: 'reproduction_probability' },
                        { label: '缺陷等级', field: 'defect_level' },
                        { label: '当前状态', field: 'current_status' },
                        { label: '对比上一版或竞品', field: 'comparison_with_previous' },
                        { label: '提出人', field: 'tester' },
                        { label: 'DQE&研发确认', field: 'dqe_and_development_confirm' },
                        { label: '改善对策（研发回复）', field: 'improvement_plan' },
                        { label: '分析责任人', field: 'responsible_person' },
                        { label: '改善后风险', field: 'post_improvement_risk' },
                        { label: '下一版回归测试', field: 'next_version_regression_test' },
                        { label: '备注', field: 'remark' },
                        { label: '创建时间', field: 'created_at' },
                        { label: '历史ID', field: 'history_id' },
                        { label: '问题点创建者', field: 'created_by' }
                    ];

                    attributes.forEach((attr, index) => {
                        const headerCell = document.createElement('th');
                        headerCell.className = `header-cell header-cell-${index + 1}`;

                        // 创建可滚动的 div
                        const headerDiv = document.createElement('div');
                        headerDiv.textContent = attr.label; // 显示 label
                        enableDragScroll(headerDiv);
                        headerCell.appendChild(headerDiv);
                        headerRow.appendChild(headerCell);
                    });

                    // 将列名行添加到表格
                    table.appendChild(headerRow);

                    // 存储被修改的数据行
                    let modifiedData = [];

                    data.forEach(item => {
                        // 创建值行
                        const valueRow = document.createElement('tr');
                        valueRow.className = 'value-row';

                        attributes.forEach((attr, index) => {
                            const valueCell = document.createElement('td');
                            valueCell.className = `value-cell value-cell-${index + 1}`;

                            // 创建可滚动的 div
                            const valueDiv = document.createElement('div');
                            const value = item[attr.field];

                            if (index === 0 || index === 9 || index === 15 || index === 24 || index === 25 || index ===26 ) { // 序号，问题图片,当前状态,创建时间,历史ID
                                if (value && String(value).includes('/imageDirectory/')) {  // 判断是否为有效图片路径
                                    const img = document.createElement('img');
                                    img.src = value.replace(/#/g, '%23') + '?t=' + new Date().getTime();  // 防止缓存，追加时间戳
                                    img.style.maxWidth = '100px';  // 设置图片最大宽度
                                    img.style.maxHeight = '80px';  // 设置图片最大高度
                                    img.style.cursor = 'pointer';  // 设置点击样式

                                    // 处理图片加载错误
                                    img.onerror = function () {
                                        console.error('图片加载失败:', img.src);
                                        img.style.display = 'none';  // 隐藏加载失败的图片
                                    };

                                    // 点击图片显示大图
                                    img.addEventListener('click', function () {
                                        showImageModal(img.src);
                                    });

                                    valueDiv.appendChild(img);  // 添加图片到 valueDiv 中
                                }else if(index === 15){
                                    // 定义需要转换为下拉框的选项
                                    const validOptions = ['OPEN', 'CLOSED'];

                                    // 将传递过来的值转换为统一格式，并检查是否需要转换CLOSE为CLOSED
                                    let normalizedValue = String(value).toUpperCase();

                                    if (normalizedValue === 'CLOSE') {
                                        normalizedValue = 'CLOSED';  // 自动将CLOSE转换为CLOSED
                                    }

                                    if (validOptions.includes(normalizedValue)) {
                                        // 创建下拉框
                                        const select = document.createElement('select');

                                        // 创建下拉选项
                                        validOptions.forEach(option => {
                                            const optionElement = document.createElement('option');
                                            optionElement.value = option;
                                            optionElement.textContent = option;

                                            // 设置默认选中的选项
                                            if (normalizedValue === option) {
                                                optionElement.selected = true;
                                            }

                                            select.appendChild(optionElement);
                                        });

                                        // 监听下拉框的变化事件
                                        select.addEventListener('change', function () {
                                            const selectedValue = select.value;
                                            console.log('状态已更新为:', selectedValue);  // 处理下拉框值的变化

                                            // 如果新值和旧值不同，标记为已修改
                                            if (selectedValue !== normalizedValue) {
                                                item[attr.field] = selectedValue;
                                                if (!modifiedData.includes(item)) {
                                                    modifiedData.push(item); // 标记修改过的数据
                                                }
                                            }
                                        });

                                        valueDiv.appendChild(select);  // 添加下拉框到 valueDiv 中
                                    } else {
                                        createEditableSpan(value, item, attr, modifiedData, valueDiv);
                                    }
                                }else {
                                    // 如果不是图片路径，显示默认文本
                                    const valueText = document.createElement('div');
                                    valueText.textContent = value || '无';
                                    valueText.style.color = '#8a4e07'; // 设置不允许修改的列的字体颜色
                                    valueDiv.appendChild(valueText);
                                }
                            } else {
                                createEditableSpan(value, item, attr, modifiedData, valueDiv);
                            }

                            enableDragScroll(valueDiv);

                            valueCell.appendChild(valueDiv);
                            valueRow.appendChild(valueCell);
                        });

                        table.appendChild(valueRow);
                    });

                    // 将表格添加到表格容器中
                    tableContainer.appendChild(table);
                    contentDiv.appendChild(tableContainer);

                    // 创建保存按钮
                    const saveButton = document.createElement('button');
                    saveButton.textContent = '保存\n修改'; // 使用换行符分两行显示文本
                    saveButton.className = 'save-button'; // 添加类名

                    contentDiv.appendChild(saveButton);

                    saveButton.addEventListener('click', function () {
                        saveChanges(modifiedData); // 只发送修改的数据
                    });

                    // 创建新增问题按钮
                    const addButton = document.createElement('button');
                    addButton.textContent = '新增\n问题';
                    addButton.className = 'add-button'; // 给新增问题按钮添加类名
                    contentDiv.appendChild(addButton);

                    // 新增问题按钮点击事件
                    addButton.addEventListener('click', function () {

                        addNewRow(sampleId,attributes,modifiedData,table);

                    });


                    //ESC快捷键退出点击的模态框
                    modal.style.display = 'block';

                    document.addEventListener('keydown', function (event) {
                        if (event.key === 'Escape') {
                            modal.style.display = 'none';
                        }
                    });

                    const span = document.getElementsByClassName('close')[0];
                    span.onclick = function () {
                        modal.style.display = 'none';
                    };
                })
                .catch(error => {
                    console.error('提交失败:', error.message);
                    alert(error.message);
                });
        }

        // 显示图片模态框的函数
        function showImageModal(imageSrc) {
            // 检查是否已存在模态框
            let modal = document.querySelector('.image-modal');

            // 如果模态框不存在，则创建一个
            if (!modal) {
                modal = document.createElement('div');
                modal.className = 'image-modal';

                // 将模态框添加到文档中
                document.body.appendChild(modal);

                // 点击模态框时关闭，但不包括图片区域
                modal.addEventListener('click', function (event) {
                    if (event.target === modal) {
                        modal.classList.remove('active'); // 隐藏模态框
                    }
                });
            }

            // 清空之前的内容，防止多次点击重复添加图片
            modal.innerHTML = '';

            // 创建图片元素并设置源
            const img = document.createElement('img');
            img.src = imageSrc;

            // 缩放比例初始化为 1
            let scale = 1;

            // 监听滚轮事件进行缩放
            img.addEventListener('wheel', function (event) {
                event.preventDefault();  // 防止页面滚动

                // 判断滚轮方向，放大或缩小
                if (event.deltaY < 0) {
                    scale += 0.1;  // 放大
                } else {
                    scale -= 0.1;  // 缩小
                }

                // 限制缩放范围
                if (scale < 0.5) scale = 0.5;
                if (scale > 3) scale = 3;

                // 设置图片缩放
                img.style.transform = `scale(${scale})`;
            });

            // 将图片添加到模态框中
            modal.appendChild(img);

            // 显示模态框
            modal.classList.add('active');
        }




// 保存修改的函数
        function saveChanges(modifiedData) {
            if (modifiedData.length === 0) {
                alert('没有修改的内容需要保存。');
                return;
            }

            console.log('要发送的数据:', JSON.stringify(modifiedData)); // 查看发送的数据
            fetch('/problemMoudle/saveAllData', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(modifiedData) // 只发送修改的 JSON 数组
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误');
                    }
                    return response.text(); // 返回文本响应
                })
                .then(responseText => {
                    console.log('保存成功:', responseText); // 打印成功消息
                    alert('保存成功');
                })
                .catch(error => {
                    console.error('提交失败:', error);
                    alert('提交失败，请检查网络连接或稍后重试。');
                });
        }




    });





</script>

</body>
</html>
