<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lu.ddwyydemo04.dao.ReliabilityLabDataDao">

    <resultMap id="ReliabilityLabDataMap" type="com.lu.ddwyydemo04.pojo.ReliabilityLabData">
        <id property="id" column="id" />
        <result property="deviceId" column="device_id" />
        <result property="sampleId" column="sample_id" />
        <result property="waitId" column="wait_id" />
        <result property="temperature" column="temperature" />
        <result property="humidity" column="humidity" />
        <result property="setTemperature" column="set_temperature" />
        <result property="setHumidity" column="set_humidity" />
        <result property="powerTemperature" column="power_temperature" />
        <result property="powerHumidity" column="power_humidity" />
        <result property="runMode" column="run_mode" />
        <result property="runStatus" column="run_status" />
        <result property="runHours" column="run_hours" />
        <result property="runMinutes" column="run_minutes" />
        <result property="runSeconds" column="run_seconds" />
        <result property="setProgramNumber" column="set_program_number" />
        <result property="programNumber" column="program_number" />
        <result property="setRunStatus" column="set_run_status" />
        <result property="totalSteps" column="total_steps" />
        <result property="runningStep" column="running_step" />
        <result property="programStep" column="program_step" />
        <result property="programCycles" column="program_cycles" />
        <result property="programTotalCycles" column="program_total_cycles" />
        <result property="stepRemainingHours" column="step_remaining_hours" />
        <result property="stepRemainingMinutes" column="step_remaining_minutes" />
        <result property="stepRemainingSeconds" column="step_remaining_seconds" />
        <result property="serialStatus" column="serial_status" />
        <result property="moduleConnection" column="module_connection" />
        <result property="createdAt" column="created_at" />
        <!-- updated_at 字段已从reliabilitylabdata表删除，但temperature_box_latest_data表仍保留 -->
        <!-- 对于reliabilitylabdata表的查询，此字段会为null；对于temperature_box_latest_data表的查询，此字段有值 -->
        <result property="updatedAt" column="updated_at" />
        <!-- raw_payload 字段已移除 -->
        <!-- <result property="rawPayload" column="raw_payload" /> -->
    </resultMap>

    <insert id="insert" parameterType="com.lu.ddwyydemo04.pojo.ReliabilityLabData" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO reliabilityLabData (
            device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
            power_temperature, power_humidity, run_mode, run_status,
            run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
            total_steps, running_step, program_step, program_cycles, program_total_cycles, step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
            serial_status, module_connection
        ) VALUES (
            #{deviceId}, #{sampleId}, #{waitId}, #{temperature}, #{humidity}, #{setTemperature}, #{setHumidity},
            #{powerTemperature}, #{powerHumidity}, #{runMode}, #{runStatus},
            #{runHours}, #{runMinutes}, #{runSeconds}, #{setProgramNumber}, #{programNumber}, #{setRunStatus},
            #{totalSteps}, #{runningStep}, #{programStep}, #{programCycles}, #{programTotalCycles}, #{stepRemainingHours}, #{stepRemainingMinutes}, #{stepRemainingSeconds},
            #{serialStatus}, #{moduleConnection}
        )
    </insert>

    <select id="selectLatest" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <select id="selectLatestByDeviceId" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE device_id = #{deviceId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <select id="selectLatestPerDevice" resultMap="ReliabilityLabDataMap">
        SELECT * FROM temperature_box_latest_data
        ORDER BY created_at ASC, id ASC
    </select>

    <!-- 更新temperature_box_latest_data表 -->
    <update id="updateLatestData" parameterType="com.lu.ddwyydemo04.pojo.ReliabilityLabData">
        UPDATE temperature_box_latest_data SET
            sample_id = #{sampleId},
            wait_id = #{waitId},
            temperature = #{temperature},
            humidity = #{humidity},
            set_temperature = #{setTemperature},
            set_humidity = #{setHumidity},
            power_temperature = #{powerTemperature},
            power_humidity = #{powerHumidity},
            run_mode = #{runMode},
            run_status = #{runStatus},
            run_hours = #{runHours},
            run_minutes = #{runMinutes},
            run_seconds = #{runSeconds},
            set_program_number = #{setProgramNumber},
            program_number = #{programNumber},
            set_run_status = #{setRunStatus},
            total_steps = #{totalSteps},
            running_step = #{runningStep},
            program_step = #{programStep},
            program_cycles = #{programCycles},
            program_total_cycles = #{programTotalCycles},
            step_remaining_hours = #{stepRemainingHours},
            step_remaining_minutes = #{stepRemainingMinutes},
            step_remaining_seconds = #{stepRemainingSeconds},
            serial_status = #{serialStatus},
            module_connection = #{moduleConnection},
            updated_at = NOW()
        WHERE device_id = #{deviceId}
    </update>

    <!-- 如果temperature_box_latest_data中没有该设备，则插入 -->
    <insert id="insertLatestData" parameterType="com.lu.ddwyydemo04.pojo.ReliabilityLabData" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO temperature_box_latest_data (
            device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
            power_temperature, power_humidity, run_mode, run_status,
            run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
            total_steps, running_step, program_step, program_cycles, program_total_cycles, step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
            serial_status, module_connection
        ) VALUES (
            #{deviceId}, #{sampleId}, #{waitId}, #{temperature}, #{humidity}, #{setTemperature}, #{setHumidity},
            #{powerTemperature}, #{powerHumidity}, #{runMode}, #{runStatus},
            #{runHours}, #{runMinutes}, #{runSeconds}, #{setProgramNumber}, #{programNumber}, #{setRunStatus},
            #{totalSteps}, #{runningStep}, #{programStep}, #{programCycles}, #{programTotalCycles}, #{stepRemainingHours}, #{stepRemainingMinutes}, #{stepRemainingSeconds},
            #{serialStatus}, #{moduleConnection}
        )
    </insert>

    <!-- 查询temperature_box_latest_data中是否有指定设备的记录 -->
    <select id="selectLatestDataByDeviceId" resultMap="ReliabilityLabDataMap">
        SELECT * FROM temperature_box_latest_data
        WHERE device_id = #{deviceId}
    </select>

    <!-- 获取所有设备的最新数据用于启动时缓存预热 -->
    <select id="selectAllLatestData" resultMap="ReliabilityLabDataMap">
        SELECT * FROM temperature_box_latest_data
        ORDER BY created_at ASC, id ASC
    </select>

    <!-- 查找超过指定秒数未更新的设备ID列表（根据module_connection字段判断，连接正常的设备才检测） -->
    <select id="selectTimeoutDeviceIds" resultType="string">
        SELECT device_id
        FROM temperature_box_latest_data
        WHERE module_connection = '连接正常'
          AND TIMESTAMPDIFF(SECOND, updated_at, NOW()) > #{seconds}
    </select>

    <!-- 批量更新设备的模块连接状态为异常（前端根据此字段显示），同时更新串口状态为离线（保持数据完整性） -->
    <update id="batchUpdateSerialStatusToOffline">
        UPDATE temperature_box_latest_data
        SET module_connection = '连接异常',
            serial_status = '离线',
            updated_at = NOW()
        WHERE device_id IN
        <foreach collection="deviceIds" item="deviceId" open="(" separator="," close=")">
            #{deviceId}
        </foreach>
    </update>

    <!-- 根据设备ID删除temperature_box_latest_data表中的记录 -->
    <delete id="deleteLatestDataByDeviceId">
        DELETE FROM temperature_box_latest_data
        WHERE device_id = #{deviceId}
    </delete>

    <!-- 查询历史数据（用于OEE分析） -->
    <select id="selectHistoryData" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE 1=1
        <if test="deviceId != null and deviceId != ''">
            AND device_id = #{deviceId}
        </if>
        <if test="startTime != null">
            AND created_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_at &lt;= #{endTime}
        </if>
        ORDER BY created_at DESC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 统计历史数据总数 -->
    <select id="countHistoryData" resultType="int">
        SELECT COUNT(*) FROM reliabilityLabData
        WHERE 1=1
        <if test="deviceId != null and deviceId != ''">
            AND device_id = #{deviceId}
        </if>
        <if test="startTime != null">
            AND created_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_at &lt;= #{endTime}
        </if>
    </select>

    <!-- 查询某个设备在指定时间点之前最近的一条数据 -->
    <select id="selectLatestBeforeTime" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE device_id = #{deviceId}
          AND created_at &lt;= #{beforeTime}
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- 查询某个设备最早的一条历史数据 -->
    <select id="selectEarliestByDeviceId" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE device_id = #{deviceId}
        ORDER BY created_at ASC
        LIMIT 1
    </select>

    <!-- 根据样品ID查询历史数据（支持多个ID，格式如 "1,22,33"） -->
    <select id="selectBySampleId" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE sample_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR sample_id LIKE CONCAT(#{sampleId}, ',%')
           OR sample_id LIKE CONCAT('%,', #{sampleId})
           OR sample_id = #{sampleId}
        ORDER BY created_at ASC
    </select>

    <!-- 根据样品ID和设备ID查询历史数据（优化查询，先按设备过滤）
         同时查询 sample_id 和 wait_id 字段，支持样品在测试中或等候预约的状态 -->
    <select id="selectBySampleIdAndDevice" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE device_id = #{deviceId}
          AND (
              <!-- 查询 sample_id 字段包含该样品ID的数据（正在测试中） -->
              sample_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR sample_id LIKE CONCAT(#{sampleId}, ',%')
           OR sample_id LIKE CONCAT('%,', #{sampleId})
           OR sample_id = #{sampleId}
           OR
              <!-- 查询 wait_id 字段包含该样品ID的数据（等候预约） -->
              wait_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR wait_id LIKE CONCAT(#{sampleId}, ',%')
           OR wait_id LIKE CONCAT('%,', #{sampleId})
           OR wait_id = #{sampleId}
          )
        <if test="startTime != null">
            AND created_at &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND created_at &lt;= #{endTime}
        </if>
        ORDER BY created_at ASC
        LIMIT #{offset}, #{limit}
    </select>

    <!-- 根据样品ID查询第一条包含该样品ID的数据
         同时查询 sample_id 和 wait_id 字段 -->
    <select id="selectFirstBySampleId" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE (
              <!-- 查询 sample_id 字段包含该样品ID的数据（正在测试中） -->
              sample_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR sample_id LIKE CONCAT(#{sampleId}, ',%')
           OR sample_id LIKE CONCAT('%,', #{sampleId})
           OR sample_id = #{sampleId}
           OR
              <!-- 查询 wait_id 字段包含该样品ID的数据（等候预约） -->
              wait_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR wait_id LIKE CONCAT(#{sampleId}, ',%')
           OR wait_id LIKE CONCAT('%,', #{sampleId})
           OR wait_id = #{sampleId}
          )
        <if test="deviceId != null and deviceId != ''">
            AND device_id = #{deviceId}
        </if>
        ORDER BY created_at ASC
        LIMIT 1
    </select>

    <!-- 根据样品ID查询最后一条包含该样品ID的数据
         同时查询 sample_id 和 wait_id 字段 -->
    <select id="selectLastBySampleId" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE (
              <!-- 查询 sample_id 字段包含该样品ID的数据（正在测试中） -->
              sample_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR sample_id LIKE CONCAT(#{sampleId}, ',%')
           OR sample_id LIKE CONCAT('%,', #{sampleId})
           OR sample_id = #{sampleId}
           OR
              <!-- 查询 wait_id 字段包含该样品ID的数据（等候预约） -->
              wait_id LIKE CONCAT('%,', #{sampleId}, ',%')
           OR wait_id LIKE CONCAT(#{sampleId}, ',%')
           OR wait_id LIKE CONCAT('%,', #{sampleId})
           OR wait_id = #{sampleId}
          )
        <if test="deviceId != null and deviceId != ''">
            AND device_id = #{deviceId}
        </if>
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- 查询指定设备在指定时间之后的第一条数据 -->
    <select id="selectFirstAfterTime" resultMap="ReliabilityLabDataMap">
        SELECT id, device_id, sample_id, wait_id, temperature, humidity, set_temperature, set_humidity,
               power_temperature, power_humidity, run_mode, run_status,
               run_hours, run_minutes, run_seconds, set_program_number, program_number, set_run_status,
               total_steps, running_step, program_step, program_cycles, program_total_cycles,
               step_remaining_hours, step_remaining_minutes, step_remaining_seconds,
               serial_status, module_connection, created_at, NULL AS updated_at
        FROM reliabilityLabData
        WHERE device_id = #{deviceId}
          AND created_at > #{afterTime}
        ORDER BY created_at ASC
        LIMIT 1
    </select>

    <!-- 根据设备ID追加 sample_id 到 reliabilitylabdata 表中最后一条记录 -->
    <!-- 注意：reliabilitylabdata表已删除updated_at字段，因此不再更新该字段 -->
    <update id="updateLatestSampleIdByDeviceId">
        UPDATE reliabilityLabData
        SET sample_id = CASE
            WHEN sample_id IS NULL OR sample_id = '' THEN CAST(#{sampleId} AS CHAR)
            WHEN FIND_IN_SET(CAST(#{sampleId} AS CHAR), sample_id) = 0 THEN CONCAT(sample_id, ',', CAST(#{sampleId} AS CHAR))
            ELSE sample_id
        END
        WHERE id = (
            SELECT id FROM (
                SELECT id FROM reliabilityLabData
                WHERE device_id = #{deviceId}
                ORDER BY created_at DESC, id DESC
                LIMIT 1
            ) AS temp
        )
        AND (sample_id IS NULL OR sample_id = '' OR FIND_IN_SET(CAST(#{sampleId} AS CHAR), sample_id) = 0)
    </update>

    <!-- 根据设备ID追加 sample_id 到 temperature_box_latest_data 表中 -->
    <update id="updateLatestDataSampleIdByDeviceId">
        UPDATE temperature_box_latest_data
        SET sample_id = CASE
            WHEN sample_id IS NULL OR sample_id = '' THEN CAST(#{sampleId} AS CHAR)
            WHEN FIND_IN_SET(CAST(#{sampleId} AS CHAR), sample_id) = 0 THEN CONCAT(sample_id, ',', CAST(#{sampleId} AS CHAR))
            ELSE sample_id
        END,
            updated_at = NOW()
        WHERE device_id = #{deviceId}
        AND (sample_id IS NULL OR sample_id = '' OR FIND_IN_SET(CAST(#{sampleId} AS CHAR), sample_id) = 0)
    </update>

    <!-- 只更新 temperature_box_latest_data 表的 updated_at 字段（用于数据无变化时刷新更新时间） -->
    <update id="updateLatestDataTimestamp">
        UPDATE temperature_box_latest_data
        SET updated_at = NOW()
        WHERE device_id = #{deviceId}
    </update>

</mapper>


