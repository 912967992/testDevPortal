<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.lu.ddwyydemo04.dao.DeviceInfoDao">

    <!-- 设备信息表结构（需要在数据库中创建） -->
    <!--
    注意：device_id 字段移除了 UNIQUE 约束，支持一个设备关联多个样品
    如果表已存在且有 UNIQUE 约束，需要执行：ALTER TABLE device_info DROP INDEX device_id;
    
    CREATE TABLE IF NOT EXISTS device_info (
        id BIGINT AUTO_INCREMENT PRIMARY KEY,
        device_id VARCHAR(100) NOT NULL COMMENT '设备ID（一个设备可以有多个样品）',
        category VARCHAR(200) COMMENT '品类',
        model VARCHAR(200) COMMENT '型号',
        tester VARCHAR(100) COMMENT '测试人员',
        status VARCHAR(20) DEFAULT 'WAITING' COMMENT '状态：WAITING(预约等候)、TESTING(测试中)、COMPLETED(测试完成)、CANCELLED(已取消)',
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
        INDEX idx_device_id (device_id),
        INDEX idx_status (status)
    ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='设备样品信息表';
    
    如果表已存在，需要添加 status 字段：
    ALTER TABLE device_info ADD COLUMN status VARCHAR(20) DEFAULT 'WAITING' COMMENT '状态：WAITING(预约等候)、TESTING(测试中)、COMPLETED(测试完成)、CANCELLED(已取消)' AFTER tester;
    ALTER TABLE device_info ADD INDEX idx_status (status);
    
    如果表已存在，需要添加 test_result 字段：
    ALTER TABLE device_info ADD COLUMN test_result VARCHAR(20) COMMENT '测试结果：PASS(通过)、FAIL(失败)、PARTIAL_OK(部分OK)' AFTER status;
    -->

    <resultMap id="DeviceInfoResultMap" type="com.lu.ddwyydemo04.pojo.DeviceInfo">
        <id property="id" column="id"/>
        <result property="deviceId" column="device_id"/>
        <result property="category" column="category"/>
        <result property="model" column="model"/>
        <result property="tester" column="tester"/>
        <result property="status" column="status"/>
        <result property="testResult" column="test_result"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
    </resultMap>

    <!-- 根据设备ID查询设备信息（查询第一条，兼容旧代码） -->
    <select id="selectByDeviceId" parameterType="String" resultMap="DeviceInfoResultMap">
        SELECT id, device_id, category, model, tester, status, test_result, created_at, updated_at
        FROM device_info
        WHERE device_id = #{deviceId}
        ORDER BY created_at DESC
        LIMIT 1
    </select>
    
    <!-- 根据设备ID查询所有样品信息 -->
    <select id="selectAllByDeviceId" parameterType="String" resultMap="DeviceInfoResultMap">
        SELECT id, device_id, category, model, tester, status, test_result, created_at, updated_at
        FROM device_info
        WHERE device_id = #{deviceId}
        ORDER BY created_at ASC
    </select>
    
    <!-- 根据ID查询样品信息 -->
    <select id="selectById" parameterType="Long" resultMap="DeviceInfoResultMap">
        SELECT id, device_id, category, model, tester, status, test_result, created_at, updated_at
        FROM device_info
        WHERE id = #{id}
    </select>

    <!-- 插入设备信息 -->
    <insert id="insert" parameterType="com.lu.ddwyydemo04.pojo.DeviceInfo" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO device_info (device_id, category, model, tester, status, test_result, created_at, updated_at)
        VALUES (#{deviceId}, #{category}, #{model}, #{tester}, 
                COALESCE(#{status}, 'WAITING'), #{testResult}, NOW(), NOW())
    </insert>

    <!-- 更新设备信息（样品） -->
    <update id="update" parameterType="com.lu.ddwyydemo04.pojo.DeviceInfo">
        UPDATE device_info
        SET category = #{category},
            model = #{model},
            tester = #{tester},
            <if test="status != null">
            status = #{status},
            </if>
            <if test="testResult != null">
            test_result = #{testResult},
            </if>
            updated_at = NOW()
        WHERE id = #{id}
    </update>
    
    <!-- 根据ID删除样品信息 -->
    <delete id="deleteById" parameterType="Long">
        DELETE FROM device_info
        WHERE id = #{id}
    </delete>

    <!-- 根据设备ID删除所有设备信息（删除设备时使用） -->
    <delete id="deleteByDeviceId" parameterType="String">
        DELETE FROM device_info
        WHERE device_id = #{deviceId}
    </delete>

    <!-- 查询设备当前正在测试的样品（status = 'TESTING'） -->
    <select id="selectCurrentTestingSample" parameterType="String" resultMap="DeviceInfoResultMap">
        SELECT id, device_id, category, model, tester, status, test_result, created_at, updated_at
        FROM device_info
        WHERE device_id = #{deviceId}
          AND status = 'TESTING'
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!-- 根据品类、型号、测试人员查询样品信息（支持模糊匹配） -->
    <select id="selectByCategoryModelTester" resultMap="DeviceInfoResultMap">
        SELECT id, device_id, category, model, tester, status, test_result, created_at, updated_at
        FROM device_info
        WHERE 1=1
        <if test="category != null and category != ''">
            AND category LIKE CONCAT('%', #{category}, '%')
        </if>
        <if test="model != null and model != ''">
            AND model LIKE CONCAT('%', #{model}, '%')
        </if>
        <if test="tester != null and tester != ''">
            AND tester LIKE CONCAT('%', #{tester}, '%')
        </if>
        ORDER BY created_at DESC
    </select>

    <!-- 根据样品ID列表批量查询样品信息 -->
    <select id="selectByIds" resultMap="DeviceInfoResultMap">
        SELECT id, device_id, category, model, tester, status, test_result, created_at, updated_at
        FROM device_info
        WHERE id IN
        <foreach collection="sampleIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY created_at DESC
    </select>

</mapper>

