<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•å¼€å‘é—¨æˆ·ç½‘ç«™ç™»é™†éªŒè¯ä¸­...</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }
        .login-container {
            text-align: center;
            color: white;
        }
        .login-container h1 {
            font-size: 24px;
            margin-bottom: 20px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #ffcccc;
            margin-top: 20px;
            display: none;
        }
    </style>
</head>
<body>
    <div class="login-container">
        <h1>æ­£åœ¨éªŒè¯èº«ä»½...</h1>
        <div class="loading-spinner"></div>
        <p>è¯·ç¨å€™ï¼Œæ­£åœ¨è¿æ¥é’‰é’‰è¿›è¡Œèº«ä»½éªŒè¯</p>
        <div class="error-message" id="errorMessage"></div>
    </div>
    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/2.7.0/dingtalk.open.js"></script>

<script>
    // æ£€æµ‹æ˜¯å¦åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…
    function isDingTalkEnvironment() {
        var userAgent = navigator.userAgent.toLowerCase();
        return userAgent.indexOf('dingtalk') !== -1;
    }

    // æ£€æµ‹æ˜¯å¦åœ¨é’‰é’‰å†…ï¼Œå¦‚æœä¸åœ¨åˆ™æ ¹æ®æœ¬åœ°ç¼“å­˜å†³å®šæ˜¯å¦è·³è½¬
    if (!isDingTalkEnvironment()) {
        console.log('âš ï¸ æ£€æµ‹åˆ°ä¸åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…');
        
        // æ£€æŸ¥æ˜¯å¦æ˜¯ä»ä¸»é¡µé‡å®šå‘å›æ¥çš„ï¼ˆé˜²æ­¢æ— é™å¾ªç¯ï¼‰
        var urlParams = new URLSearchParams(window.location.search);
        var fromRedirect = urlParams.get('from') === 'redirect';
        
        // æ£€æŸ¥ localStorage æ˜¯å¦æœ‰ username
        var username = localStorage.getItem('username');
        
        if (username && !fromRedirect) {
            // æœ‰ username ä¸”ä¸æ˜¯é‡å®šå‘å›æ¥çš„ï¼Œå°è¯•è·³è½¬ä¸»é¡µ
            console.log('âœ… æ‰¾åˆ°æœ¬åœ°ç”¨æˆ·ä¿¡æ¯: ' + username + ', å°è¯•è·³è½¬ä¸»é¡µ');
            document.querySelector('.login-container h1').textContent = 'æ¬¢è¿å›æ¥ï¼';
            document.querySelector('.login-container p').textContent = 'æ£€æµ‹åˆ°æ‚¨ä¹‹å‰å·²ç™»å½•ï¼Œæ­£åœ¨è·³è½¬...';
            
            setTimeout(function() {
                window.location.href = '/';
            }, 500);
        } else {
            // æ˜¯é‡å®šå‘å›æ¥çš„æˆ–æ²¡æœ‰ usernameï¼Œæ˜¾ç¤ºæç¤º
            if (fromRedirect && username) {
                console.warn('âš ï¸ Session å·²è¿‡æœŸï¼Œéœ€è¦é‡æ–°éªŒè¯èº«ä»½');
                document.querySelector('.login-container h1').textContent = 'Session å·²è¿‡æœŸ';
                document.querySelector('.login-container p').textContent = 'è¯·åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…é‡æ–°æ‰“å¼€åº”ç”¨è¿›è¡Œèº«ä»½éªŒè¯';
                document.querySelector('.loading-spinner').style.display = 'none';
                document.getElementById('errorMessage').innerHTML = 
                    'ğŸ’¡ æç¤ºï¼š<br>' +
                    '1. æ‚¨çš„ç™»å½•çŠ¶æ€å·²è¿‡æœŸ<br>' +
                    '2. è¯·åœ¨é’‰é’‰å®¢æˆ·ç«¯ä¸­é‡æ–°æ‰“å¼€æ­¤åº”ç”¨';
                document.getElementById('errorMessage').style.display = 'block';
            } else {
                console.warn('âš ï¸ æœ¬åœ°æ²¡æœ‰ç”¨æˆ·ä¿¡æ¯');
                showNotInDingTalkWarning();
            }
        }
    } else {
        // åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…ï¼Œæ­£å¸¸èµ°é’‰é’‰å…ç™»æµç¨‹
        var urlParams = new URLSearchParams(window.location.search);
        var fromRedirect = urlParams.get('from') === 'redirect';
        
        if (fromRedirect) {
            console.log('âœ… æ£€æµ‹åˆ°åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…ï¼ŒSession å·²è¿‡æœŸï¼Œé‡æ–°è·å–èº«ä»½');
            document.querySelector('.login-container h1').textContent = 'æ­£åœ¨é‡æ–°éªŒè¯èº«ä»½...';
            document.querySelector('.login-container p').textContent = 'æ£€æµ‹åˆ°ç™»å½•å·²è¿‡æœŸï¼Œæ­£åœ¨é‡æ–°è¿æ¥é’‰é’‰éªŒè¯';
        } else {
            console.log('âœ… æ£€æµ‹åˆ°åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…ï¼Œå¼€å§‹é’‰é’‰å…ç™»æµç¨‹');
        }
        
        dd.ready(function () {
            dd.runtime.permission.requestAuthCode({
                corpId: "ding39a9d20442a933ec35c2f4657eb6378f", // ä¼ä¸šCorpId
                onSuccess: function (result) {
                    // è·å–åˆ°authCodeåå‘é€åˆ°åç«¯
                    sendAuthCodeToServer(result.code);
                },
                onFail: function (err) {
                    document.getElementById('errorMessage').textContent = 'è·å–authCodeå¤±è´¥: ' + JSON.stringify(err);
                    document.getElementById('errorMessage').style.display = 'block';
                    document.querySelector('.loading-spinner').style.display = 'none';
                }
            });
        });
    }
    
    // æ˜¾ç¤ºä¸åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…çš„æç¤º
    function showNotInDingTalkWarning() {
        document.querySelector('.login-container h1').textContent = 'è¯·åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…æ‰“å¼€';
        document.querySelector('.login-container p').textContent = 'æœ¬ç³»ç»Ÿéœ€è¦åœ¨é’‰é’‰å®¢æˆ·ç«¯å†…ä½¿ç”¨èº«ä»½éªŒè¯åŠŸèƒ½';
        document.querySelector('.loading-spinner').style.display = 'none';
        document.getElementById('errorMessage').innerHTML = 
            'ğŸ’¡ æç¤ºï¼š<br>' +
            '1. è¯·åœ¨é’‰é’‰å®¢æˆ·ç«¯ä¸­æ‰“å¼€æ­¤é¡µé¢<br>' +
            '2. æˆ–è€…æ‰«æé’‰é’‰åº”ç”¨äºŒç»´ç è®¿é—®';
        document.getElementById('errorMessage').style.display = 'block';
    }

    function sendAuthCodeToServer(authCode) {
        var xhr = new XMLHttpRequest();
        xhr.open('POST', '/api/getUserInfo', true);
        xhr.setRequestHeader('Content-Type', 'application/json');
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var response = JSON.parse(xhr.responseText);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
                if (response.errorCode) {
                    document.getElementById('errorMessage').textContent = 'ç™»å½•å¤±è´¥: ' + (response.errorMessage || 'æœªçŸ¥é”™è¯¯');
                    document.getElementById('errorMessage').style.display = 'block';
                    document.querySelector('.loading-spinner').style.display = 'none';
                    return;
                }
                
                // å•ç‹¬å°†æ¯ä¸ªéœ€è¦çš„å­—æ®µä¿å­˜åˆ°localStorageï¼ˆæœ¬åœ°ç¼“å­˜ï¼‰
                localStorage.setItem('userId', response.userId);
                localStorage.setItem('username', response.username);
                localStorage.setItem('job', response.job);
                localStorage.setItem('departmentId', response.departmentId);
                if (response.departmentName) {
                    localStorage.setItem('departmentName', response.departmentName);
                }
                localStorage.setItem('corp_id', response.corp_id);
                localStorage.setItem('templatespath', response.templatespath);
                localStorage.setItem('savepath', response.savepath);
                localStorage.setItem('imagepath', response.imagepath);
                
                // æ˜¾ç¤ºæ¬¢è¿å¼¹çª—ï¼šç”¨æˆ·ï¼Œä½ å¥½ï¼Œéƒ¨é—¨ï¼šxxxxï¼ˆåªä½¿ç”¨ä» users è¡¨æŸ¥è¯¢çš„ departmentNameï¼‰
                var welcomeMessage = response.username + 'ï¼Œä½ å¥½';
                if (response.departmentName) {
                    welcomeMessage += 'ï¼Œéƒ¨é—¨ï¼š' + response.departmentName;
                }
                alert(welcomeMessage);
                
                // è·³è½¬åˆ°ä¸»é¡µ
                window.location.href = '/';
            } else if (xhr.readyState == 4) {
                document.getElementById('errorMessage').textContent = 'ç™»å½•è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ' + xhr.status;
                document.getElementById('errorMessage').style.display = 'block';
                document.querySelector('.loading-spinner').style.display = 'none';
            }
        };
        xhr.onerror = function() {
            document.getElementById('errorMessage').textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
            document.getElementById('errorMessage').style.display = 'block';
            document.querySelector('.loading-spinner').style.display = 'none';
        };
        xhr.send(JSON.stringify({authCode: authCode}));
    }

</script>
</body>
</html>
