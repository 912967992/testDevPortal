<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DQE问题点模块</title>
    <!-- 引入字体图标库 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <!-- 引入外部CSS文件 -->
    <link rel="stylesheet" href="/css/commonDQEMoudle.css">

    <script src="https://g.alicdn.com/dingding/dingtalk-jsapi/3.0.25/dingtalk.open.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

</head>
<body>


<div class="header-container">
    <div class="title">问题点模块</div>
    <button class="BackBtn" id="BackBtn" onclick="location.href='/DQEIndex'">返回<br>主页</button>
</div>

<div class="search-container">
    <form class="search-form">
        <!-- 产品大，小编码 -->
        <div class="input-group">
            <label for="full_model">大小<br>编码:</label>
            <input type="text" id="full_model" name="full_model" placeholder="输入大小编码">
        </div>

        <!-- 问题点编号test_issues_id-->
        <div class="input-group">
            <label for="test_issues_id">编号:</label>
            <input type="text" id="test_issues_id" name="test_issues_id" placeholder="编号">
        </div>

        <!-- 任务属性 ：无，新品，新设备，新软件版本，售后问题分析，量产升级，竞品-->
        <div class="input-group">
            <label for="questStats">产品<br>类别:</label>
            <select id="questStats" name="questStats">
                <option value=""></option>
                <option value="无">无</option>
                <option value="新品">新品</option>
                <option value="新设备">新设备</option>
                <option value="新软件版本">新软件版本</option>
                <option value="售后问题分析">售后问题分析</option>
                <option value="量产升级">量产升级</option>
                <option value="竞品">竞品</option>
            </select>
        </div>


        <!-- 产品类别 -->
        <div class="input-group">
            <label for="sample_category">产品<br>类别:</label>
            <select id="sample_category" name="sample_category">
                <option value="">选择类别</option>
                <option value="大货">大货</option>
                <option value="功能样">功能样</option>
                <option value="预研">预研</option>
                <option value="竞品">竞品</option>
            </select>
        </div>

        <!-- 版本号 -->
        <div class="input-group">
            <label for="version">版本<br>号:</label>
            <input type="text" id="version" name="version" placeholder="输入版本号">
        </div>

        <!-- 主控芯片 -->
        <div class="input-group">
            <label for="chip_control">主控<br>芯片:</label>
            <input type="text" id="chip_control" name="chip_control" placeholder="输入主控芯片">
        </div>


        <!-- 大类 -->
        <div class="input-group">
            <!-- 引入品类细分组件 -->
            <label for="big_species">大类:</label>
            <select id="big_species" name="big_species"  onchange="populateSubCategory()">
                <option value="" selected>请选择大类</option>
                <!-- 通过json文件动态加入选项 -->
            </select>
        </div>

        <!-- 小类 -->
        <div class="input-group">
            <label for="small_species">细分<br>品类:</label>
            <select id="small_species" name="small_species" >
                <option value="" selected>选择细分品类</option>
                <!-- 根据大类自动填充 -->
            </select>
        </div>


        <!-- 供应商 -->
        <div class="input-group">
            <label for="supplier">供应<br>商:</label>
            <input type="text" id="supplier" name="supplier" placeholder="输入供应商">
        </div>

        <!-- 国内外测试 -->
        <div class="input-group">
            <label for="test_Overseas">国内<br>外:</label>
            <select id="test_Overseas" name="test_Overseas">
                <option value=""></option>
                <option value="国内">国内测试</option>
                <option value="国外">国外测试</option>
                <option value="国内+国外+">国内+国外测试</option>
            </select>
        </div>


        <!-- 测试平台 -->
        <div class="input-group">
            <label for="test_platform">测试<br>平台:</label>
            <input type="text" id="test_platform" name="test_platform" placeholder="输入测试平台">
        </div>



        <!-- DQE -->
        <div class="input-group">
            <label for="sample_DQE">DQE:</label>
            <input type="text" id="sample_DQE" name="sample_DQE" placeholder="输入 DQE">
        </div>

        <!-- 电子工程师 -->
        <div class="input-group">
            <label for="sample_Developer">研发<br>电子:</label>
            <input type="text" id="sample_Developer" name="sample_Developer" placeholder="">
        </div>

        <!-- 测试人 -->
        <div class="input-group">
            <label for="tester">测试<br>人:</label>
            <input type="text" id="tester" name="tester" placeholder="输入测试人">
        </div>

        <!-- 优先级 -->
        <div class="input-group">
            <label for="priority">优先<br>级:</label>
            <select id="priority" name="priority">
                <option value=""></option>
                <option value="加急">加急</option>
                <option value="同步">同步</option>
                <option value="优先">优先</option>
                <option value="普通">普通</option>
            </select>
        </div>

        <!-- 测试设备 -->
        <div class="input-group">
            <label for="test_device">测试<br>设备:</label>
            <input type="text" id="test_device" name="test_device" placeholder="输入测试设备">
        </div>


        <!-- 缺陷等级 -->
        <div class="input-group">
            <label for="defect_level">缺陷<br>等级:</label>
            <select id="defect_level" name="defect_level">
                <option value=""></option>
                <option value="A">A</option>
                <option value="B">B</option>
                <option value="C">C</option>
            </select>
        </div>

        <!-- 当前状态,改成测试状态 -->
        <div class="input-group">
            <label for="current_status">测试<br>状态:</label>
            <select id="current_status" name="current_status">
                <option value=""></option>
                <option value="OPEN">OPEN</option>
                <option value="CLOSED">CLOSED</option>
                <option value="待解决">待解决</option>

            </select>
        </div>

        <!-- 最终状态 -->
        <div class="input-group">
            <label for="final_status">最终<br>状态:</label>
            <select id="final_status" name="final_status">
                <option value=""></option>
                <option value="OPEN">OPEN</option>
                <option value="CLOSED">CLOSED</option>
                <option value="待解决">待解决</option>

            </select>
        </div>


        <!-- 判定结果 -->
        <div class="input-group">
            <label for="result_judge">判定<br>结果:</label>
            <select id="result_judge" name="result_judge">
                <option value=""></option>
                <option value="0">不用签样</option>
                <option value="1">签样</option>
                <option value="2">退样</option>
                <option value="3">免签只发邮件</option>

            </select>
        </div>

        <!-- 日期范围选择器 -->
        <div class="input-group date-range">
            <label>提交<br>日期:</label>
            <input type="date" id="problemTimeStart" placeholder="开始日期">
            <span class="date-separator">至</span> <!-- 添加“至”标签 -->
            <input type="date" id="problemTimeEnd" placeholder="结束日期">
        </div>

        <!-- DQE审核状态 -->
        <div class="input-group">
            <label for="dqe_status">DQE<br>审核:</label>
            <select id="dqe_status" name="dqe_status">
                <option value=""></option>
                <option value="OPEN">OPEN</option>
                <option value="CLOSED">CLOSED</option>
                <option value="待解决">待解决</option>

            </select>
        </div>

        <!-- 研发审核状态 -->
        <div class="input-group">
            <label for="rd_status">研发<br>审核:</label>
            <select id="rd_status" name="rd_status">
                <option value=""></option>
                <option value="OPEN">OPEN</option>
                <option value="CLOSED">CLOSED</option>
                <option value="待解决">待解决</option>

            </select>
        </div>

        <!-- 搜索按钮 -->
        <button type="submit">搜索</button>
    </form>
</div>

<!-- 表格容器 -->
<div class="problemtable_container">
    <!-- 这里是表格的占位符 -->
    <!-- 实际表格内容可以通过 JavaScript 动态生成 -->
</div>

<!-- 模态框结构 -->
<div id="testIssuesModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <div id="testIssuesContent"></div>
    </div>
</div>



<!-- 下方固定按钮 -->
<div class="btn-container">
    <hr class="divider"> <!-- 按钮上方的横线 -->
    <!-- 主页按钮 -->
    <button class="btn" id="homeBtn"><i class="fas fa-home"></i></button>
    <!-- 搜索资源库按钮 -->
    <button class="btn" id="cloudBtn"><i class="fas fa-cloud"></i></button>
    <!-- 个人界面按钮 -->
    <button class="btn" id="profileBtn"><i class="fas fa-user"></i></button>
</div>

<script>
    // 存储已选中的 item.id 的数组
    let selectedIds = [];

    //选择大类之后选择小类
    document.addEventListener('DOMContentLoaded', function() {
        fetch('/json/categories.json')
            .then(response => response.json())
            .then(data => {
                const bigSpeciesSelect = document.getElementById('big_species');

                // 填充大类选择器
                for (const bigSpecies in data) {
                    const option = document.createElement('option');
                    option.value = bigSpecies;
                    option.textContent = bigSpecies;
                    bigSpeciesSelect.appendChild(option);
                }

                // 存储数据供后续使用
                window.categoryData = data;
            });
    });
    function populateSubCategory() {
        const bigSpeciesSelect = document.getElementById('big_species');
        const smallSpeciesSelect = document.getElementById('small_species');
        const bigSpeciesCategory = bigSpeciesSelect.value;

        // 清空当前的细分品类选项
        smallSpeciesSelect.innerHTML = '<option value="" selected>请选择细分品类</option>';

        if (window.categoryData) {
            let smallSpeciesArray = [];
            if (bigSpeciesCategory === "竞品-预研类" || bigSpeciesCategory === "高频类") {
                for (const category in window.categoryData) {
                    if (category !== "竞品-预研类" && category !== "高频类") {
                        window.categoryData[category].forEach(subCategory => {
                            smallSpeciesArray.push(`${category}-${subCategory}`);
                        });
                    }
                }
            } else if (window.categoryData[bigSpeciesCategory]) {
                smallSpeciesArray = window.categoryData[bigSpeciesCategory];
            }

            smallSpeciesArray.forEach(smallSpecies => {
                const option = document.createElement('option');
                option.value = smallSpecies;
                option.textContent = smallSpecies;
                smallSpeciesSelect.appendChild(option);
            });
        }
    }


    $(document).ready(function() {
        let currentPage = 1;
        // 设置每页多少个问题点才分页
        const pageSize = 15;
        let pages = []; // 用于存储分页数据

        // 在页面加载时自动搜索
        // performSearch();

        // 表单提交时触发搜索
        $('.search-form').on('submit', function(event) {
            event.preventDefault(); // 防止表单的默认提交行为
            performSearch(); // 执行搜索
        });

        function performSearch() {
            // 获取表单数据
            var formData = $('.search-form').serialize();

            // 构建搜索请求的 URL
            var searchUrl = '/problemMoudle/searchTestissues';

            // 发起 AJAX 请求
            $.ajax({
                url: searchUrl,
                type: 'GET',
                dataType: 'json',
                data: formData, // 使用表单数据进行搜索
                success: function(data) {
                    // 处理搜索结果
                    pages = paginateData(data, pageSize);
                    currentPage = 1; // 重置当前页
                    displayPage(currentPage);
                },
                error: function(xhr, status, error) {
                    console.error('搜索请求失败:', error);
                }
            });
        }

        function paginateData(data, pageSize) {
            const pages = [];
            for (let i = 0; i < data.length; i += pageSize) {
                pages.push(data.slice(i, i + pageSize));
            }
            return pages;
        }

        function displayPage(pageNum) {
            if (pageNum < 1 || pageNum > pages.length) return; // 检查页码范围

            currentPage = pageNum; // 更新当前页码

            const tableContainer = document.querySelector('.problemtable_container');
            tableContainer.innerHTML = ''; // 清空表格容器

            const pageData = pages[pageNum - 1] || [];
            const table = document.createElement('table');
            table.classList.add('result-table'); // 添加样式类

            // 创建表头
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            // 添加“全选”列
            const selectAllCell = document.createElement('th');
            const selectAllCheckbox = document.createElement('input');
            selectAllCheckbox.type = 'checkbox';
            selectAllCheckbox.id = 'select-all'; // 设置 ID 以便后续操作
            selectAllCell.appendChild(selectAllCheckbox);
            headerRow.appendChild(selectAllCell);

            const headers = [
                "ID", "完整编码", "样品阶段", "版本", "芯片方案", "日期",
                "测试人员", "测试平台", "测试设备", "其他设备", "问题描述", "问题视频/图片",
                "复现手法", "恢复方法", "复现概率", "缺陷等级", "当前状态",
                "对比上一版或竞品", "DQE&研发确认", "改善对策", "分析责任人",
                "改善后风险", "下一版回归测试", "备注", "提交时间", "历史版本ID",
                "样品ID", "最终状态", "修改人", "修改时间",
                "DQE状态", "DQE审核意见", "DQE审核时间", "研发状态",
                "研发审核意见", "研发审核时间"
            ];

            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            table.appendChild(thead);

            // 创建表体
            const tbody = document.createElement('tbody');
            pageData.forEach(item => {
                const row = document.createElement('tr');

                // 添加复选框单元格
                const selectCell = document.createElement('td');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';

                // 添加复选框点击事件
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        // 如果选中，添加到数组并排序
                        selectedIds.push(item.id);
                    } else {
                        // 如果取消选中，从数组中移除
                        selectedIds = selectedIds.filter(id => id !== item.id);
                    }
                    // 排序数组
                    selectedIds.sort((a, b) => a - b);
                    console.log(`当前选中的ID列表: ${selectedIds.join(', ')}`);
                });

                selectCell.appendChild(checkbox);
                row.appendChild(selectCell);

                // 填充表格行的每个单元格
                const cells = [
                    item.id, item.full_model, item.sample_stage, item.version,
                    item.chip_solution, item.problem_time, item.tester,
                    item.test_platform, item.test_device, item.other_device,
                    item.problem,
                    item.problem_image_or_video, item.reproduction_method,
                    item.recovery_method, item.reproduction_probability,
                    item.defect_level, item.current_status,
                    item.comparison_with_previous, item.dqe_and_development_confirm,
                    item.improvement_plan, item.responsible_person,
                    item.post_improvement_risk, item.next_version_regression_test,
                    item.remark, item.created_at, item.history_id, item.sample_id,
                    item.final_status, item.modifier,
                    item.modified_time, item.dqe_status, item.dqe_comments,
                    item.dqe_reviewed_at, item.rd_status, item.rd_comments,
                    item.rd_reviewed_at
                ];

                cells.forEach((cellData, index) => {
                    const td = document.createElement('td');

                    if (headers[index] === "问题视频/图片") {
                        if (cellData === "上传图片") {
                            cellData = "无";
                            td.textContent = cellData;
                        } else if (cellData) {
                            const imgSrc = cellData.replace(/#/g, '%23') + '?t=' + new Date().getTime(); // 替换#并添加时间戳
                            const img = document.createElement('img');
                            img.src = imgSrc;
                            img.style.width = '100px'; // 设置图片宽度

                            img.addEventListener('click', () => {
                                const fullView = document.createElement('div');
                                fullView.style.position = 'fixed';
                                fullView.style.top = '0';
                                fullView.style.left = '0';
                                fullView.style.width = '100%';
                                fullView.style.height = '100%';
                                fullView.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                                fullView.style.display = 'flex';
                                fullView.style.alignItems = 'center';
                                fullView.style.justifyContent = 'center';
                                fullView.style.zIndex = '1000';

                                const fullImg = document.createElement('img');
                                fullImg.src = imgSrc;
                                fullImg.style.maxWidth = '90%';
                                fullImg.style.maxHeight = '90%';
                                fullImg.alt = 'Full Image';

                                fullView.addEventListener('click', () => {
                                    document.body.removeChild(fullView);
                                });

                                fullView.appendChild(fullImg);
                                document.body.appendChild(fullView);
                            });

                            td.appendChild(img);
                        } else {
                            td.textContent = '无'; // 处理其他可能为空的数据
                        }
                    } else {
                        if (headers[index] === "提交时间") {
                            td.textContent = cellData ? cellData.replace('T', ' ') : '';
                        } else {
                            td.textContent = cellData || '';
                        }

                        td.addEventListener('click', () => {
                            const fullContentModal = document.createElement('div');
                            fullContentModal.style.position = 'fixed';
                            fullContentModal.style.top = '0';
                            fullContentModal.style.left = '0';
                            fullContentModal.style.width = '100%';
                            fullContentModal.style.height = '100%';
                            fullContentModal.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
                            fullContentModal.style.display = 'flex';
                            fullContentModal.style.alignItems = 'center';
                            fullContentModal.style.justifyContent = 'center';
                            fullContentModal.style.zIndex = '1000';

                            const contentBox = document.createElement('div');
                            contentBox.style.maxWidth = '80%';
                            contentBox.style.maxHeight = '80%';
                            contentBox.style.overflowY = 'auto';
                            contentBox.style.backgroundColor = '#fff';
                            contentBox.style.padding = '20px';
                            contentBox.style.borderRadius = '8px';
                            contentBox.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.5)';
                            contentBox.textContent = td.textContent || '无内容';

                            const copyButton = document.createElement('button');
                            copyButton.textContent = '复制到剪贴板';
                            copyButton.style.marginTop = '10px';
                            copyButton.style.display = 'block';

                            copyButton.addEventListener('click', async () => {
                                const tempTextarea = document.createElement('textarea');
                                tempTextarea.value = td.textContent || '';
                                document.body.appendChild(tempTextarea);
                                tempTextarea.select();

                                try {
                                    document.execCommand('copy');
                                    alert('内容已复制到剪贴板');
                                } catch (err) {
                                    console.error('无法复制内容', err);
                                }

                                document.body.removeChild(tempTextarea);
                            });

                            contentBox.appendChild(copyButton);
                            fullContentModal.appendChild(contentBox);

                            fullContentModal.addEventListener('click', () => {
                                document.body.removeChild(fullContentModal);
                            });

                            document.body.appendChild(fullContentModal);
                        });
                    }

                    row.appendChild(td);
                });

                tbody.appendChild(row);
            });

            table.appendChild(tbody);
            tableContainer.appendChild(table);

            // 全选复选框事件
            document.getElementById('select-all').addEventListener('change', function() {
                const isChecked = this.checked;
                const checkboxes = table.querySelectorAll('tbody input[type="checkbox"]');
                checkboxes.forEach(checkbox => checkbox.checked = isChecked);
            });


            // 创建分页按钮并添加到表格容器
            updatePagination(tableContainer);
        }

        function updatePagination(container) {
            const pagination = document.createElement('div');
            pagination.classList.add('pagination');

            // Function to change page without reloading data
            function changePage(newPage) {
                currentPage = newPage;
                updatePagination(container); // Refresh pagination buttons only
                displayPage(currentPage); // Update the display for the selected page
            }

            // Function to change page range and adjust current page
            function changePageRange(step) {
                let newPage = currentPage + step;
                if (newPage < 1) newPage = 1; // Ensure newPage does not go below 1
                if (newPage > pages.length) newPage = pages.length; // Ensure newPage does not exceed numPages
                changePage(newPage);
            }

            // Create the '<<' button (jump to first page)
            const firstPageButton = document.createElement('button');
            firstPageButton.textContent = '<<';
            firstPageButton.disabled = currentPage === 1; // Disable if on the first page
            firstPageButton.addEventListener('click', () => changePage(1));
            pagination.appendChild(firstPageButton);

            // Create the '<' button (move to previous page range)
            const prevRangeButton = document.createElement('button');
            prevRangeButton.textContent = '<';
            prevRangeButton.disabled = currentPage === 1; // Disable if on the first page
            prevRangeButton.addEventListener('click', () => changePageRange(-10)); // Adjust -10 based on range
            pagination.appendChild(prevRangeButton);

            // Calculate the number of pages and determine start and end for display
            const numPages = pages.length;
            let startPage, endPage;

            if (numPages <= 10) {
                // Show all pages if total pages are 10 or less
                startPage = 1;
                endPage = numPages;
            } else {
                // Show pages around the current page with a range of 10
                if (currentPage <= 5) {
                    startPage = 1;
                    endPage = 10;
                } else if (currentPage + 4 >= numPages) {
                    startPage = numPages - 9;
                    endPage = numPages;
                } else {
                    startPage = currentPage - 5;
                    endPage = currentPage + 4;
                }
            }

            // Add page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.disabled = i === currentPage; // Disable the current page button
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    displayPage(i); // Update the display for the selected page
                });
                pagination.appendChild(pageButton);
            }

            // Create the '>' button (move to next page range)
            const nextRangeButton = document.createElement('button');
            nextRangeButton.textContent = '>';
            nextRangeButton.disabled = currentPage === numPages; // Disable if on the last page
            nextRangeButton.addEventListener('click', () => changePageRange(10)); // Adjust +10 based on range
            pagination.appendChild(nextRangeButton);

            // Create the '>>' button (jump to last page)
            const lastPageButton = document.createElement('button');
            lastPageButton.textContent = '>>';
            lastPageButton.disabled = currentPage === numPages; // Disable if on the last page
            lastPageButton.addEventListener('click', () => changePage(numPages));
            pagination.appendChild(lastPageButton);

            // Create the '编辑' button
            const editButton = document.createElement('button');
            editButton.textContent = '编辑';
            editButton.classList.add('edit-button'); // 为按钮添加样式类
            editButton.addEventListener('click', () => {
                editClickBtn();
            });
            pagination.appendChild(editButton);

            // Remove the previous pagination and add the new one
            const existingPagination = container.querySelector('.pagination');
            if (existingPagination) {
                container.removeChild(existingPagination);
            }

            // Insert the new pagination at the beginning of the container
            container.insertBefore(pagination, container.firstChild);
        }

        function editClickBtn() {
            // 使用 fetch 发起 AJAX 请求
            fetch('/problemMoudle/editClickBtn', {
                method: 'POST', // 使用 POST 方法
                headers: {
                    'Content-Type': 'application/json' // 设置请求头
                },
                body: JSON.stringify(selectedIds) // 将 selectedIds 数组作为请求体发送
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('网络响应错误'); // 处理响应错误
                    }
                    return response.json(); // 解析 JSON 响应
                })
                .then(data => {
                    // 处理成功响应的数据
                    const modal = document.getElementById('testIssuesModal');
                    const contentDiv = document.getElementById('testIssuesContent');

                    // 清空之前的内容
                    contentDiv.innerHTML = '';

                    // 遍历返回的 TestIssues 数据，并用中文格式化展示
                    data.forEach(item => {
                        const issueDiv = document.createElement('div');
                        issueDiv.className = 'issue-container';
                        issueDiv.innerHTML = `
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>ID:</strong></div>
                        <div class="value">${item.id}</div>
                    </div>
                    <div>
                        <div class="label"><strong>样品型号:</strong></div>
                        <div class="value">${item.full_model}</div>
                    </div>
                    <div>
                        <div class="label"><strong>样品阶段:</strong></div>
                        <div class="value">${item.sample_stage}</div>
                    </div>
                    <div>
                        <div class="label"><strong>版本:</strong></div>
                        <div class="value">${item.version}</div>
                    </div>
                    <div>
                        <div class="label"><strong>问题时间:</strong></div>
                        <div class="value">${item.problem_time}</div>
                    </div>
                </div>
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>测试人员:</strong></div>
                        <div class="value">${item.tester}</div>
                    </div>
                    <div>
                        <div class="label"><strong>问题图片:</strong></div>
                        <div class="value">${item.problem_image_or_video}</div>
                    </div>
                    <div>
                        <div class="label"><strong>复现方法:</strong></div>
                        <div class="value">${item.reproduction_method}</div>
                    </div>
                    <div>
                        <div class="label"><strong>恢复方法:</strong></div>
                        <div class="value">${item.recovery_method}</div>
                    </div>
                    <div>
                        <div class="label"><strong>复现概率:</strong></div>
                        <div class="value">${item.reproduction_probability}</div>
                    </div>

                </div>
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>测试平台:</strong></div>
                        <div class="value">${item.test_platform}</div>
                    </div>
                    <div>
                        <div class="label"><strong>显示设备:</strong></div>
                        <div class="value">${item.test_device}</div>
                    </div>
                    <div>
                        <div class="label"><strong>其他设备:</strong></div>
                        <div class="value">${item.other_device}</div>
                    </div>
                    <div>
                        <div class="label"><strong>问题描述:</strong></div>
                        <div class="value">${item.problem}</div>
                    </div>

                </div>
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>缺陷等级:</strong></div>
                        <div class="value">${item.defect_level || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>当前状态:</strong></div>
                        <div class="value">${item.current_status || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>对比上一版或竞品:</strong></div>
                        <div class="value">${item.comparison_with_previous || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>DQE&研发确认:</strong></div>
                        <div class="value">${item.dqe_and_development_confirm || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>改善对策（研发回复）:</strong></div>
                        <div class="value">${item.improvement_plan || '无'}</div>
                    </div>
                </div>
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>分析责任人:</strong></div>
                        <div class="value">${item.responsible_person || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>改善后风险:</strong></div>
                        <div class="value">${item.post_improvement_risk || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>下一版回归测试:</strong></div>
                        <div class="value">${item.next_version_regression_test || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>备注:</strong></div>
                        <div class="value">${item.remark || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>创建时间:</strong></div>
                        <div class="value">${item.created_at || '无'}</div>
                    </div>
                </div>
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>历史ID:</strong></div>
                        <div class="value">${item.history_id || '无'}</div>
                    </div>

                    <div>
                        <div class="label"><strong>最终状态:</strong></div>
                        <div class="value">${item.final_status || '无'}</div>
                    </div>
                </div>
                <div class="issue-row">
                    <div>
                        <div class="label"><strong>DQE确认状态:</strong></div>
                        <div class="value">${item.dqe_status || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>DQE评论:</strong></div>
                        <div class="value">${item.dqe_comments || '无'}</div>
                    </div>
                    <div>
                        <div class="label"><strong>DQE审核时间:</strong></div>
                        <div class="value">${item.dqe_reviewed_at || '无'}</div>
                    </div>
                </div>
                <hr>
            `;
                        contentDiv.appendChild(issueDiv);
                    });

                    // 显示模态框
                    modal.style.display = 'block';
                })
                .catch(error => {
                    // 处理错误
                    console.error('提交失败:', error);
                    alert('提交失败，请检查网络连接或稍后重试。');
                });

            // 获取模态框元素
            const modal = document.getElementById('testIssuesModal');
            const span = document.getElementsByClassName('close')[0];

            // 点击关闭按钮时关闭模态框
            span.onclick = function () {
                modal.style.display = 'none';
            };

            // 点击模态框外部时关闭模态框
            window.onclick = function (event) {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            };
        }

    });




</script>

</body>
</html>
